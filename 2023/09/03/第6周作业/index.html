

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="[TOC] 1.简述DDL,DML,DCL,DQL，并且说明mysql各个关键字查询时候的先后顺序1.1 简述DDL,DML,DCL,DQL DDL：数据定义语言 CREATE（创建数据库，数据表..），DROP（删除数据库，数据表），ALTER（修改数据库，数据表）  DML：数据操纵语言 INSERT(插入数据)，DELETE（删除数据），UPDATE（修改数据） 软件开发：CRUD  DQL">
<meta property="og:type" content="article">
<meta property="og:title" content="第6周作业">
<meta property="og:url" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/index.html">
<meta property="og:site_name" content="5-12 23:30">
<meta property="og:description" content="[TOC] 1.简述DDL,DML,DCL,DQL，并且说明mysql各个关键字查询时候的先后顺序1.1 简述DDL,DML,DCL,DQL DDL：数据定义语言 CREATE（创建数据库，数据表..），DROP（删除数据库，数据表），ALTER（修改数据库，数据表）  DML：数据操纵语言 INSERT(插入数据)，DELETE（删除数据），UPDATE（修改数据） 软件开发：CRUD  DQL">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230908172835517.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230906214723545.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230907205610664.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904164206456.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904164639710.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230906214103238.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904174321716.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904212604430.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904212455979.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904221013868.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904221143994.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904221315766.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904222355073.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904222532863.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904223446322.png">
<meta property="og:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230904223734992.png">
<meta property="article:published_time" content="2023-09-03T21:01:45.000Z">
<meta property="article:modified_time" content="2023-11-21T13:07:39.243Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/09/03/%E7%AC%AC6%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20230908172835517.png">
  
  
  <title>第6周作业 - 5-12 23:30</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第6周作业">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-09-03 21:01" pubdate>
        September 3, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      80k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      670 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第6周作业</h1>
            
            <div class="markdown-body">
              <p>[TOC]</p>
<h1 id="1-简述DDL-DML-DCL-DQL，并且说明mysql各个关键字查询时候的先后顺序"><a href="#1-简述DDL-DML-DCL-DQL，并且说明mysql各个关键字查询时候的先后顺序" class="headerlink" title="1.简述DDL,DML,DCL,DQL，并且说明mysql各个关键字查询时候的先后顺序"></a>1.简述DDL,DML,DCL,DQL，并且说明mysql各个关键字查询时候的先后顺序</h1><h2 id="1-1-简述DDL-DML-DCL-DQL"><a href="#1-1-简述DDL-DML-DCL-DQL" class="headerlink" title="1.1 简述DDL,DML,DCL,DQL"></a>1.1 简述DDL,DML,DCL,DQL</h2><ul>
<li><p>DDL：数据定义语言</p>
<p>CREATE（创建数据库，数据表..），DROP（删除数据库，数据表），ALTER（修改数据库，数据表）</p>
</li>
<li><p>DML：数据操纵语言</p>
<p>INSERT(插入数据)，DELETE（删除数据），UPDATE（修改数据）</p>
<p>软件开发：CRUD</p>
</li>
<li><p>DQL：数据查询语言</p>
<p>SELECT（查询数据）</p>
</li>
<li><p>DCL：数据控制语言</p>
<p>GRANT（授予权限），REVOKE（取消权限）</p>
</li>
</ul>
<h2 id="1-2-说明mysql各个关键字查询时候的先后顺序"><a href="#1-2-说明mysql各个关键字查询时候的先后顺序" class="headerlink" title="1.2  说明mysql各个关键字查询时候的先后顺序"></a>1.2  说明mysql各个关键字查询时候的先后顺序</h2><p>关键字keyword组成子句clause，多条clause组成整个语句</p>
<p>示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><pre><code class="hljs mysql">select *					#SELECT子句<br>from student			 	#FROM子句<br>where stu_name=&#x27;xiaoming&#x27;	#WHERE子句<br></code></pre></td></tr></table></figure>

<p>说明：一组SQL语句由三个子句构成，SELECT ,FROM 和WHERE时关键字</p>
<p>获取SQL 命令使用帮助：<br>官方帮助：<br><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/sql-statements.html">https://dev.mysql.com/doc/refman/8.0/en/sql-statements.html</a></p>
<p>mysql各个关键字执行顺序如下：</p>
<p><img src="image-20230908172835517.png" srcset="/img/loading.gif" lazyload alt="image-20230908172835517"></p>
<p>查询执行路径中的组件：查询缓存、解释器、预处理器、优化器、查询执行引擎、存储引擎</p>
<p>select语句的执行流程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">FROM</span>  clause <span class="hljs-comment">--&gt; WHERE clause --&gt; GROUP BY --&gt; HAVING --&gt; SELECT --&gt; ORDER BY --&gt; LIMIT</span><br></code></pre></td></tr></table></figure>

<h1 id="2-自行设计10个sql查询语句，需要用到关键字-GROUP-BY-HAVING-ORDER-BY-LIMIT-，至少同时用到两个。"><a href="#2-自行设计10个sql查询语句，需要用到关键字-GROUP-BY-HAVING-ORDER-BY-LIMIT-，至少同时用到两个。" class="headerlink" title="2.自行设计10个sql查询语句，需要用到关键字[GROUP BY/HAVING/ORDER BY/LIMIT]，至少同时用到两个。"></a>2.自行设计10个sql查询语句，需要用到关键字[GROUP BY/HAVING/ORDER BY/LIMIT]，至少同时用到两个。</h1><p>示例1：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询teachers表中age<span class="hljs-operator">&gt;</span><span class="hljs-number">20</span>，男女的人数<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),gender <span class="hljs-keyword">from</span> teachers <span class="hljs-keyword">where</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">20</span>  <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> gender;<br><span class="hljs-operator">+</span><span class="hljs-comment">----------+--------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">|</span> gender <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+--------+</span><br><span class="hljs-operator">|</span>        <span class="hljs-number">2</span> <span class="hljs-operator">|</span> F      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>        <span class="hljs-number">2</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">----------+--------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br><br></code></pre></td></tr></table></figure>

<p>示例2：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询teachers表中age<span class="hljs-operator">&lt;</span><span class="hljs-number">90</span>，按age降序排序<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> teachers <span class="hljs-keyword">where</span> age <span class="hljs-operator">&lt;</span> <span class="hljs-number">90</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">desc</span> ;<br><span class="hljs-operator">+</span><span class="hljs-comment">-----+---------------+-----+--------+</span><br><span class="hljs-operator">|</span> TID <span class="hljs-operator">|</span> Name          <span class="hljs-operator">|</span> Age <span class="hljs-operator">|</span> Gender <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----+---------------+-----+--------+</span><br><span class="hljs-operator">|</span>   <span class="hljs-number">3</span> <span class="hljs-operator">|</span> Miejue Shitai <span class="hljs-operator">|</span>  <span class="hljs-number">77</span> <span class="hljs-operator">|</span> F      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>   <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Song Jiang    <span class="hljs-operator">|</span>  <span class="hljs-number">45</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>   <span class="hljs-number">5</span> <span class="hljs-operator">|</span> xiaohexie     <span class="hljs-operator">|</span>  <span class="hljs-number">18</span> <span class="hljs-operator">|</span> F      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----+---------------+-----+--------+</span><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>

<p>示例3：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询teachers表中最大年纪的所有信息<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> teachers <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">desc</span> limit <span class="hljs-number">1</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">-----+---------------+-----+--------+</span><br><span class="hljs-operator">|</span> TID <span class="hljs-operator">|</span> Name          <span class="hljs-operator">|</span> Age <span class="hljs-operator">|</span> Gender <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----+---------------+-----+--------+</span><br><span class="hljs-operator">|</span>   <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Zhang Sanfeng <span class="hljs-operator">|</span>  <span class="hljs-number">94</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-----+---------------+-----+--------+</span><br><span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>

<p>示例4：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询students表中男女的平均年龄<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-built_in">sum</span>(age)<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>),gender <span class="hljs-keyword">from</span> students <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> gender;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+--------+</span><br><span class="hljs-operator">|</span> <span class="hljs-built_in">sum</span>(age)<span class="hljs-operator">/</span><span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">|</span> gender <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+--------+</span><br><span class="hljs-operator">|</span>           <span class="hljs-number">19.0000</span> <span class="hljs-operator">|</span> F      <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>           <span class="hljs-number">33.0000</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------------------+--------+</span><br><span class="hljs-number">2</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>

<p>示例5：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询students表中年龄降序排序前五位的信息<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> students <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">desc</span> limit <span class="hljs-number">5</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------+--------------+-----+--------+---------+-----------+</span><br><span class="hljs-operator">|</span> StuID <span class="hljs-operator">|</span> Name         <span class="hljs-operator">|</span> Age <span class="hljs-operator">|</span> Gender <span class="hljs-operator">|</span> ClassID <span class="hljs-operator">|</span> TeacherID <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+--------------+-----+--------+---------+-----------+</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">25</span> <span class="hljs-operator">|</span> Sun Dasheng  <span class="hljs-operator">|</span> <span class="hljs-number">100</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>    <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">3</span> <span class="hljs-operator">|</span> Xie Yanke    <span class="hljs-operator">|</span>  <span class="hljs-number">53</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">2</span> <span class="hljs-operator">|</span>        <span class="hljs-number">16</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">6</span> <span class="hljs-operator">|</span> Shi Qing     <span class="hljs-operator">|</span>  <span class="hljs-number">46</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">5</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">13</span> <span class="hljs-operator">|</span> Tian Boguang <span class="hljs-operator">|</span>  <span class="hljs-number">33</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">2</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">4</span> <span class="hljs-operator">|</span> Ding Dian    <span class="hljs-operator">|</span>  <span class="hljs-number">32</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">4</span> <span class="hljs-operator">|</span>         <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+--------------+-----+--------+---------+-----------+</span><br><span class="hljs-number">5</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>

<p>示例6：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询students表每个班的人数，只显示人数大于<span class="hljs-number">3</span>的classid<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> classid,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> students <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> classid <span class="hljs-keyword">having</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">&gt;</span><span class="hljs-number">3</span>;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-operator">|</span> classid <span class="hljs-operator">|</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">3</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">4</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">6</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-number">4</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>

<p>示例7：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询students表每个班的人数，只显示人数大于<span class="hljs-number">2</span>的classid，按升序排序<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> classid,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> students <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> classid <span class="hljs-keyword">having</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>)<span class="hljs-operator">&gt;</span><span class="hljs-number">2</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>);<br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-operator">|</span> classid <span class="hljs-operator">|</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">7</span> <span class="hljs-operator">|</span>        <span class="hljs-number">3</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">2</span> <span class="hljs-operator">|</span>        <span class="hljs-number">3</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">6</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">4</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">3</span> <span class="hljs-operator">|</span>        <span class="hljs-number">4</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-number">6</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>

<p>示例8：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询students表age<span class="hljs-operator">&lt;</span><span class="hljs-number">25</span> gender<span class="hljs-operator">=</span><span class="hljs-string">&#x27;M&#x27;</span>的信息，按升序排序<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> students <span class="hljs-keyword">where</span> age <span class="hljs-operator">&lt;</span><span class="hljs-number">25</span> <span class="hljs-keyword">having</span> gender<span class="hljs-operator">=</span><span class="hljs-string">&#x27;M&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age;<br><span class="hljs-operator">+</span><span class="hljs-comment">-------+---------------+-----+--------+---------+-----------+</span><br><span class="hljs-operator">|</span> StuID <span class="hljs-operator">|</span> Name          <span class="hljs-operator">|</span> Age <span class="hljs-operator">|</span> Gender <span class="hljs-operator">|</span> ClassID <span class="hljs-operator">|</span> TeacherID <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+---------------+-----+--------+---------+-----------+</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">15</span> <span class="hljs-operator">|</span> Duan Yu       <span class="hljs-operator">|</span>  <span class="hljs-number">19</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">4</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">16</span> <span class="hljs-operator">|</span> Xu Zhu        <span class="hljs-operator">|</span>  <span class="hljs-number">21</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Shi Zhongyu   <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">2</span> <span class="hljs-operator">|</span>         <span class="hljs-number">3</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">2</span> <span class="hljs-operator">|</span> Shi Potian    <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>         <span class="hljs-number">7</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">11</span> <span class="hljs-operator">|</span> Yuan Chengzhi <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">6</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">18</span> <span class="hljs-operator">|</span> Hua Rong      <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">7</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">23</span> <span class="hljs-operator">|</span> Ma Chao       <span class="hljs-operator">|</span>  <span class="hljs-number">23</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">4</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+---------------+-----+--------+---------+-----------+</span><br><br></code></pre></td></tr></table></figure>

<p>示例9：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询students表平均年龄小于<span class="hljs-number">22</span>的班级<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> classid,<span class="hljs-built_in">avg</span>(age) <span class="hljs-keyword">from</span> students <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> classid <span class="hljs-keyword">having</span> <span class="hljs-built_in">avg</span>(age)<span class="hljs-operator">&lt;</span><span class="hljs-number">22</span> ;<br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-operator">|</span> classid <span class="hljs-operator">|</span> <span class="hljs-built_in">avg</span>(age) <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">1</span> <span class="hljs-operator">|</span>  <span class="hljs-number">20.5000</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">3</span> <span class="hljs-operator">|</span>  <span class="hljs-number">20.2500</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">6</span> <span class="hljs-operator">|</span>  <span class="hljs-number">20.7500</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>       <span class="hljs-number">7</span> <span class="hljs-operator">|</span>  <span class="hljs-number">19.6667</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">---------+----------+</span><br><span class="hljs-number">4</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>

<p>示例10：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql">#查询students表classid<span class="hljs-operator">=</span><span class="hljs-number">2</span>的所有信息，按年龄降序排序显示<br>MariaDB [hellodb]<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> students <span class="hljs-keyword">where</span> classid<span class="hljs-operator">=</span><span class="hljs-number">2</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age; <br><span class="hljs-operator">+</span><span class="hljs-comment">-------+--------------+-----+--------+---------+-----------+</span><br><span class="hljs-operator">|</span> StuID <span class="hljs-operator">|</span> Name         <span class="hljs-operator">|</span> Age <span class="hljs-operator">|</span> Gender <span class="hljs-operator">|</span> ClassID <span class="hljs-operator">|</span> TeacherID <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+--------------+-----+--------+---------+-----------+</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">1</span> <span class="hljs-operator">|</span> Shi Zhongyu  <span class="hljs-operator">|</span>  <span class="hljs-number">22</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">2</span> <span class="hljs-operator">|</span>         <span class="hljs-number">3</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>    <span class="hljs-number">13</span> <span class="hljs-operator">|</span> Tian Boguang <span class="hljs-operator">|</span>  <span class="hljs-number">33</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">2</span> <span class="hljs-operator">|</span>      <span class="hljs-keyword">NULL</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">|</span>     <span class="hljs-number">3</span> <span class="hljs-operator">|</span> Xie Yanke    <span class="hljs-operator">|</span>  <span class="hljs-number">53</span> <span class="hljs-operator">|</span> M      <span class="hljs-operator">|</span>       <span class="hljs-number">2</span> <span class="hljs-operator">|</span>        <span class="hljs-number">16</span> <span class="hljs-operator">|</span><br><span class="hljs-operator">+</span><span class="hljs-comment">-------+--------------+-----+--------+---------+-----------+</span><br><span class="hljs-number">3</span> <span class="hljs-keyword">rows</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">0.000</span> sec)<br><br></code></pre></td></tr></table></figure>



<h1 id="3-xtrabackup备份和还原数据库练习"><a href="#3-xtrabackup备份和还原数据库练习" class="headerlink" title="3.xtrabackup备份和还原数据库练习"></a>3.xtrabackup备份和还原数据库练习</h1><p>利用xtrabackup8.0进行完全备份和增量备份以及还原MySQL8.0</p>
<h2 id="3-1-xtrabackup进行完全备份和还原"><a href="#3-1-xtrabackup进行完全备份和还原" class="headerlink" title="3.1 xtrabackup进行完全备份和还原"></a>3.1 xtrabackup进行完全备份和还原</h2><h3 id="3-1-1下载并安装xtrabackup"><a href="#3-1-1下载并安装xtrabackup" class="headerlink" title="3.1.1下载并安装xtrabackup"></a>3.1.1下载并安装xtrabackup</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">percona下载地址：</span><br>https://www.percona.com/downloads<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">percona-xtrabackup下载链接：</span><br>https://downloads.percona.com/downloads/Percona-XtraBackup-8.0/Percona-XtraBackup-8.0.34-29/binary/redhat/8/x86_64/percona-xtrabackup-80-8.0.34-29.1.el8.x86_64.rpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装percona-xtrabackup</span><br>[20:50:10 root@rocky8 ~]#yum install -y  percona-xtrabackup-80-8.0.34-29.1.el8.x86_64.rpm <br></code></pre></td></tr></table></figure>

<h3 id="3-1-2-备份和还原过程"><a href="#3-1-2-备份和还原过程" class="headerlink" title="3.1.2 备份和还原过程"></a>3.1.2 备份和还原过程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell">1 在原主机上做完全备份到/backup<br>[21:12:21 root@rocky8 ~]#mkdir /backup<br>[21:12:21 root@rocky8 ~]#xtrabackup -uroot --backup --target-dir=/backup/base<br><br>2 目标主机无需创建/backup目录，直接复制目录<br>[21:12:21 root@rocky8 ~]#scp -r /backup/ 10.0.0.3:/<br><br><br>3 在目标主机上还原<br>注意：需要恢复主机MySQL服务停止，并且数据目录为空<br>1）预准备：确保数据一致，提交完成的事务，回滚未完成的事务<br>[21:34:45 root@rocky ~]#yum install -y percona-xtrabackup-80-8.0.34-29.1.el8.x86_64.rpm <br>[21:34:45 root@rocky ~]#xtrabackup --prepare --target-dir=/backup/base<br>2）复制到数据目录<br>注意：需要恢复主机MySQL服务停止，并且数据目录为空<br>[21:34:45 root@rocky ~]#xtrabackup --copy-back --target-dir=/backup/base<br>3）还原属性<br>[21:34:45 root@rocky ~]#chown -R mysql:mysql  /var/lib/mysql<br>4）启动服务<br>[21:34:45 root@rocky ~]#service  mysqld start <br><br><br>4 验证数据<br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show databases;</span><br>+--------------------+<br>| Database           |<br>+--------------------+<br>| hellodb            |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>+--------------------+<br><br></code></pre></td></tr></table></figure>

<h2 id="3-2-xtrabackup进行增量备份和还原"><a href="#3-2-xtrabackup进行增量备份和还原" class="headerlink" title="3.2 xtrabackup进行增量备份和还原"></a>3.2 xtrabackup进行增量备份和还原</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装percona-xtrabackup</span><br>[20:50:10 root@rocky8 ~]#yum install -y  percona-xtrabackup-80-8.0.34-29.1.el8.x86_64.rpm <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">备份过程</span><br>1） 在原主机上做完全备份到/backup<br>[21:12:21 root@rocky8 ~]#mkdir /backup<br>[21:12:21 root@rocky8 ~]#xtrabackup -uroot --backup --target-dir=/backup/base<br><br>2）第一次修改数据<br>[21:12:21 root@rocky8 ~]#mysql &lt; hellodb_innodb.sql<br>3）第一次增量备份<br>[21:12:21 root@rocky8 ~]#xtrabackup -uroot --backup --target-dir=/backup/inc1 --incremental-basedir=/backup/base<br>4）第二次修改数据<br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">insert teachers (name,age,gender) values(<span class="hljs-string">&#x27;aa&#x27;</span>,10,<span class="hljs-string">&#x27;M&#x27;</span>);</span><br><br><br>5）第二次增量备份<br>[21:12:21 root@rocky8 ~]#xtrabackup -uroot --backup --target-dir=/backup/inc2 --incremental-basedir=/backup/inc1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">还原过程</span><br>1）预准备完成备份，此选项--apply-log-only阻止回滚未完成的事务<br>[21:12:21 root@rocky8 ~]#yum install -y  percona-xtrabackup-80-8.0.34-29.1.el8.x86_64.rpm <br>[21:12:21 root@rocky8 ~]# xtrabackup --prepare --apply-log-only --target-dir=/backup/base<br>2）合并第1次增量备份到完全备份<br>[21:12:21 root@rocky8 ~]#xtrabackup --prepare --apply-log-only --target-dir=/backup/base --incremental-dir=/backup/inc1<br>3）合并第2次增量备份到完全备份：最后一次还原不需要加选项--apply-log-only<br>[21:12:21 root@rocky8 ~]#xtrabackup --prepare --target-dir=/backup/base --incremental-dir=/backup/inc2<br><br>4）复制到数据目录<br>注意：需要恢复主机MySQL服务停止，并且数据目录为空<br>[21:12:21 root@rocky8 ~]#xtrabackup --copy-back --target-dir=/backup/base<br>[21:12:21 root@rocky8 ~]#xtrabackup --copy-back --target-dir=/backup/base<br>5）还原属性<br>[21:34:45 root@rocky ~]#chown -R mysql:mysql  /var/lib/mysql<br>6）启动服务<br>[21:34:45 root@rocky ~]#service  mysqld start <br></code></pre></td></tr></table></figure>







<h1 id="4-实现mysql主从复制，主主复制和半同步复制"><a href="#4-实现mysql主从复制，主主复制和半同步复制" class="headerlink" title="4.实现mysql主从复制，主主复制和半同步复制"></a>4.实现mysql主从复制，主主复制和半同步复制</h1><h2 id="4-1-mysql主从复制"><a href="#4-1-mysql主从复制" class="headerlink" title="4.1 mysql主从复制"></a>4.1 mysql主从复制</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">主节点</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装MySQL</span><br>[22:30:32 root@rocky ~]#yum install -y mariadb-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改master主节点的配置</span><br>[22:30:32 root@rocky ~]#vim /etc/my.cnf.d/mariadb-server.cnf<br>[mysqld]<br>log_bin   			#启用二进制日志，mysql8.0之后版本默认开启<br>server-id=4			#设置全局唯一的ID号<br><br>[22:33:05 root@rocky ~]#systemctl restart mariadb.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看二进制文件和位置</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">show master logs;</span><br>+-------------------+-----------+-----------+<br>| Log_name          | File_size | Encrypted |<br>+-------------------+-----------+-----------+<br>| rocky8-bin.000001 |       157 | No        |<br>+-------------------+-----------+-----------+<br>1 row in set (0.00 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建复制用户</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">MySQL8.0需要分成下面两步实现</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">create user repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> ;</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">从节点</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装MySQL</span><br>[22:30:32 root@rocky ~]#yum install -y mariadb-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改从节点的配置</span><br>[22:30:32 root@rocky ~]#vim /etc/my.cnf.d/mariadb-server.cnf<br>[mysqld]<br>log_bin   			#启用二进制日志，mysql8.0之后版本默认开启<br>server-id=3<br>[22:33:05 root@rocky ~]#systemctl restart mariadb.service<br>[22:33:05 root@rocky ~]#mysql<br>MariaDB [(none)]&gt; help change master to<br>MariaDB [(none)]&gt; CHANGE MASTER TO<br>    -&gt;   MASTER_HOST=&#x27;10.0.0.4&#x27;,<br>    -&gt;   MASTER_USER=&#x27;repluser&#x27;,<br>    -&gt;   MASTER_PASSWORD=&#x27;123456&#x27;,<br>    -&gt;   MASTER_PORT=3306,<br>    -&gt;   MASTER_LOG_FILE=&#x27;mariadb-bin.000001&#x27;,<br>    -&gt;   MASTER_LOG_POS=330;<br>Query OK, 0 rows affected (0.005 sec)<br><br>MariaDB [(none)]&gt; start slave;<br>Query OK, 0 rows affected (0.001 sec)<br><br>MariaDB [(none)]&gt; show slave status \G<br>ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near &#x27;stattus&#x27; at line 1<br>MariaDB [(none)]&gt; show slave status \G<br>*************************** 1. row ***************************<br>                Slave_IO_State: Waiting for master to send event<br>                   Master_Host: 10.0.0.4<br>                   Master_User: repluser<br>                   Master_Port: 3306<br>                 Connect_Retry: 60<br>               Master_Log_File: mariadb-bin.000001<br>           Read_Master_Log_Pos: 330<br>                Relay_Log_File: mariadb-relay-bin.000002<br>                 Relay_Log_Pos: 557<br>         Relay_Master_Log_File: mariadb-bin.000001<br>              Slave_IO_Running: Yes<br>             Slave_SQL_Running: Yes<br>               Replicate_Do_DB: <br>           Replicate_Ignore_DB: <br>            Replicate_Do_Table: <br>        Replicate_Ignore_Table: <br>       Replicate_Wild_Do_Table: <br>   Replicate_Wild_Ignore_Table: <br>                    Last_Errno: 0<br>                    Last_Error: <br>                  Skip_Counter: 0<br>           Exec_Master_Log_Pos: 330<br>               Relay_Log_Space: 868<br>               Until_Condition: None<br>                Until_Log_File: <br>                 Until_Log_Pos: 0<br>            Master_SSL_Allowed: No<br>            Master_SSL_CA_File: <br>            Master_SSL_CA_Path: <br>               Master_SSL_Cert: <br>             Master_SSL_Cipher: <br>                Master_SSL_Key: <br>         Seconds_Behind_Master: 0<br> Master_SSL_Verify_Server_Cert: No<br>                 Last_IO_Errno: 0<br>                 Last_IO_Error: <br>                Last_SQL_Errno: 0<br>                Last_SQL_Error: <br>   Replicate_Ignore_Server_Ids: <br>              Master_Server_Id: 4<br>                Master_SSL_Crl: <br>            Master_SSL_Crlpath: <br>                    Using_Gtid: No<br>                   Gtid_IO_Pos: <br>       Replicate_Do_Domain_Ids: <br>   Replicate_Ignore_Domain_Ids: <br>                 Parallel_Mode: conservative<br>                     SQL_Delay: 0<br>           SQL_Remaining_Delay: NULL<br>       Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it<br>              Slave_DDL_Groups: 0<br>Slave_Non_Transactional_Groups: 0<br>    Slave_Transactional_Groups: 0<br>1 row in set (0.000 sec)<br><br></code></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在master上修改数据</span><br>MariaDB [hellodb]&gt; insert teachers (name,age,gender) values(&#x27;aa&#x27;,17,&#x27;M&#x27;);<br>Query OK, 1 row affected (0.002 sec)<br><br>MariaDB [hellodb]&gt; select * from teachers;<br>+-----+---------------+-----+--------+<br>| TID | Name          | Age | Gender |<br>+-----+---------------+-----+--------+<br>|   1 | Song Jiang    |  45 | M      |<br>|   2 | Zhang Sanfeng |  94 | M      |<br>|   3 | Miejue Shitai |  77 | F      |<br>|   4 | Lin Chaoying  |  93 | F      |<br>|   5 | aa            |  17 | M      |<br>+-----+---------------+-----+--------+<br>5 rows in set (0.000 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#在slave上查看数据是否同步</span></span><br>MariaDB [hellodb]&gt; select * from teachers;<br>+-----+---------------+-----+--------+<br>| TID | Name          | Age | Gender |<br>+-----+---------------+-----+--------+<br>|   1 | Song Jiang    |  45 | M      |<br>|   2 | Zhang Sanfeng |  94 | M      |<br>|   3 | Miejue Shitai |  77 | F      |<br>|   4 | Lin Chaoying  |  93 | F      |<br>|   5 | aa            |  17 | M      |<br>+-----+---------------+-----+--------+<br>5 rows in set (0.000 sec)<br><br></code></pre></td></tr></table></figure>

<h2 id="4-2-实现主主复制"><a href="#4-2-实现主主复制" class="headerlink" title="4.2 实现主主复制"></a>4.2 实现主主复制</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在第一个master节点上实现</span><br>[15:02:02 root@rocky ~]#vim /etc/my.cnf.d/mariadb-server.cnf <br>[mysqld]<br>log-bin<br>server-id=4<br>auto_increment_offset=1			#开始点<br>auto_increment_increment=2		#增长幅度<br><br>[15:03:29 root@rocky ~]#systemctl start mariadb<br>[15:03:29 root@rocky ~]#mysql<br>MariaDB [hellodb]&gt; show master logs;<br>+--------------------+-----------+<br>| Log_name           | File_size |<br>+--------------------+-----------+<br>| mariadb-bin.000001 |      9199 |<br>| mariadb-bin.000002 |       344 |<br>+--------------------+-----------+<br>2 rows in set (0.000 sec)<br>MariaDB [(none)]&gt; grant replication slave on *.* to repluser@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在第二个master节点上实现</span><br>[15:02:02 root@rocky ~]#vim /etc/my.cnf.d/mariadb-server.cnf <br>[mysqld]<br>log-bin<br>server-id=3<br>auto_increment_offset=2		#开始点<br>auto_increment_increment=2		#增长幅度<br><br>[15:03:29 root@rocky ~]#systemctl start mariadb<br>[15:03:29 root@rocky ~]#mysql<br>MariaDB [(none)]&gt; CHANGE MASTER TO<br>    MASTER_HOST=&#x27;10.0.0.4&#x27;,<br>  	MASTER_USER=&#x27;repluser&#x27;,<br>    MASTER_PASSWORD=&#x27;123456&#x27;,<br>	MASTER_PORT=3306,<br> 	MASTER_LOG_FILE=&#x27;mariadb-bin.000002&#x27;,<br>	MASTER_LOG_POS=684;<br>Query OK, 0 rows affected (0.005 sec)<br>MariaDB [(none)]&gt; show master logs;<br>+--------------------+-----------+<br>| Log_name           | File_size |<br>+--------------------+-----------+<br>| mariadb-bin.000001 |      1127 |<br>+--------------------+-----------+<br>1 row in set (0.000 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在第一个master节点上实现</span><br>MariaDB [(none)]&gt; CHANGE MASTER TO<br>	MASTER_HOST=&#x27;10.0.0.3&#x27;,<br>	MASTER_USER=&#x27;repluser&#x27;,<br>	MASTER_PASSWORD=&#x27;123456&#x27;,<br>	MASTER_PORT=3306,<br>  	MASTER_LOG_FILE=&#x27;mariadb-bin.000001&#x27;,<br>	MASTER_LOG_POS=1127;<br><br>MariaDB [mysql]&gt; start slave;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">两个节点上分别插入数据</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在第一个节点上执行</span><br>MariaDB [db1]&gt; create table  db1.t1(id int auto_increment primary key,name char(10));<br>Query OK, 0 rows affected (0.004 sec)<br><br>MariaDB [db1]&gt; insert t1 (name) values(&#x27;xiaohexie1&#x27;);<br>Query OK, 1 row affected (0.003 sec)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">在第二个节点上执行</span><br>MariaDB [db1]&gt; insert t1 (name) values(&#x27;xiaohexie2&#x27;);<br>Query OK, 1 row affected (0.002 sec)<br><br>MariaDB [db1]&gt; select * from t1;<br>+----+------------+<br>| id | name       |<br>+----+------------+<br>|  2 | xiaohexie1 |<br>|  3 | xiaohexie2 |<br>+----+------------+<br>2 rows in set (0.000 sec)<br><br></code></pre></td></tr></table></figure>



<h2 id="4-3-半同步复制"><a href="#4-3-半同步复制" class="headerlink" title="4.3 半同步复制"></a>4.3 半同步复制</h2><p>示例：在mariadb上实现半同步复制</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看插件文件</span><br>[16:33:20 root@rocky8 ~]#rpm -ql mysql-server | grep semisync<br>/usr/lib64/mysql/plugin/semisync_master.so<br>/usr/lib64/mysql/plugin/semisync_replica.so<br>/usr/lib64/mysql/plugin/semisync_slave.so<br>/usr/lib64/mysql/plugin/semisync_source.so<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">master服务器10.0.0.4上配置</span><br>[20:18:48 root@rocky ~]#vim /etc/my.cnf.d/mariadb-server.cnf<br>[mysqld]<br>server-id=4<br>log-bin<br>plugin-load-add=semisync_master<br>rpl_semi_sync_master_enabled=ON		#修改此行，需要先安装semisync_master.so插件后，再重启，否则无法启动<br>rpl_semi_sync_master_timeout=30000	#设置3s内无法同步，也将返回成功的信息给客户端<br>[20:23:26 root@rocky ~]#systemctl restart mariadb.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建复制用户</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">MySQL8.0需要分成下面两步实现</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">create user repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;</span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span>;</span><br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">备份数据</span><br>[20:23:58 root@rocky ~]#mysqldump -A -F --single-transaction --master-data=2 &gt;/data/all.sql<br><span class="hljs-meta prompt_">#</span><span class="language-bash">复制到从服务器上</span><br>[20:38:51 root@rocky ~]#vim  /data/all.sql <br>CHANGE MASTER TO<br>        MASTER_HOST=&#x27;10.0.0.4&#x27;,<br>        MASTER_USER=&#x27;repluser&#x27;,<br>        MASTER_PASSWORD=&#x27;123456&#x27;,<br>        MASTER_PORT=3306,<br>MASTER_LOG_FILE=&#x27;mariadb-bin.000003&#x27;, MASTER_LOG_POS=389;<br>[20:46:02 root@rocky ~]#scp /data/all.sql 10.0.0.128:<br>[20:46:02 root@rocky ~]#scp /data/all.sql 10.0.0.3:<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">slave1服务器配置</span><br>[20:18:48 root@rocky ~]#vim /etc/my.cnf.d/mariadb-server.cnf<br>[mysqld]<br>server-id=3<br>plugin-load-add=semisync_slave<br>rpl_semi_sync_slave_enabled=ON		#修改此行，需要先安装semisync_slave.so插件后，再重启，否则无法启动<br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务</span><br>[20:23:26 root@rocky ~]#systemctl restart mariadb.service<br><span class="hljs-meta prompt_">#</span><span class="language-bash">将恢复主服务器上备份的数据恢复进行恢复</span><br>[20:36:50 root@ORG-DNS ~]#mysql &lt; all.sql <br>[20:36:50 root@ORG-DNS ~]#mysql<br>MariaDB [(none)]&gt; start slave;<br>MariaDB [(none)]&gt; show slave status \G;<br>MariaDB [(none)]&gt; show global variables like &#x27;%semi%&#x27;;<br>+---------------------------------------+--------------+<br>| Variable_name                         | Value        |<br>+---------------------------------------+--------------+<br>| rpl_semi_sync_master_enabled          | OFF          |<br>| rpl_semi_sync_master_timeout          | 10000        |<br>| rpl_semi_sync_master_trace_level      | 32           |<br>| rpl_semi_sync_master_wait_no_slave    | ON           |<br>| rpl_semi_sync_master_wait_point       | AFTER_COMMIT |<br>| rpl_semi_sync_slave_delay_master      | OFF          |<br>| rpl_semi_sync_slave_enabled           | ON           |<br>| rpl_semi_sync_slave_kill_conn_timeout | 5            |<br>| rpl_semi_sync_slave_trace_level       | 32           |<br>+---------------------------------------+--------------+<br>9 rows in set (0.010 sec)<br><br>MariaDB [(none)]&gt; show global status  like &#x27;%semi%&#x27;;<br>+--------------------------------------------+-------+<br>| Variable_name                              | Value |<br>+--------------------------------------------+-------+<br>| Rpl_semi_sync_master_clients               | 0     |<br>| Rpl_semi_sync_master_get_ack               | 0     |<br>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |<br>| Rpl_semi_sync_master_net_wait_time         | 0     |<br>| Rpl_semi_sync_master_net_waits             | 0     |<br>| Rpl_semi_sync_master_no_times              | 0     |<br>| Rpl_semi_sync_master_no_tx                 | 0     |<br>| Rpl_semi_sync_master_request_ack           | 0     |<br>| Rpl_semi_sync_master_status                | OFF   |<br>| Rpl_semi_sync_master_timefunc_failures     | 0     |<br>| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |<br>| Rpl_semi_sync_master_tx_wait_time          | 0     |<br>| Rpl_semi_sync_master_tx_waits              | 0     |<br>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |<br>| Rpl_semi_sync_master_wait_sessions         | 0     |<br>| Rpl_semi_sync_master_yes_tx                | 0     |<br>| Rpl_semi_sync_slave_send_ack               | 0     |<br>| Rpl_semi_sync_slave_status                 | ON    |<br>+--------------------------------------------+-------+<br>18 rows in set (0.004 sec)<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">slave2服务器10.0.0.128配置</span><br>[20:18:48 root@rocky ~]#vim /etc/my.cnf.d/mariadb-server.cnf<br>[mysqld]<br>server-id=128<br>plugin-load-add=semisync_slave<br>rpl_semi_sync_slave_enabled=ON	#修改此行，需要先安装semisync_slave.so插件后，再重启，否则无法启动<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务</span><br>[20:23:26 root@rocky ~]#systemctl restart mariadb.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">将恢复主服务器上备份的数据恢复进行恢复</span><br>[20:36:50 root@ORG-DNS ~]#mysql &lt; all.sql <br>[20:36:50 root@ORG-DNS ~]#mysql<br>MariaDB [(none)]&gt; start slave;<br>MariaDB [(none)]&gt; show slave status \G;<br>MariaDB [(none)]&gt; show global variables like &#x27;%semi%&#x27;;<br>+---------------------------------------+--------------+<br>| Variable_name                         | Value        |<br>+---------------------------------------+--------------+<br>| rpl_semi_sync_master_enabled          | OFF          |<br>| rpl_semi_sync_master_timeout          | 10000        |<br>| rpl_semi_sync_master_trace_level      | 32           |<br>| rpl_semi_sync_master_wait_no_slave    | ON           |<br>| rpl_semi_sync_master_wait_point       | AFTER_COMMIT |<br>| rpl_semi_sync_slave_delay_master      | OFF          |<br>| rpl_semi_sync_slave_enabled           | ON           |<br>| rpl_semi_sync_slave_kill_conn_timeout | 5            |<br>| rpl_semi_sync_slave_trace_level       | 32           |<br>+---------------------------------------+--------------+<br>9 rows in set (0.002 sec)<br>MariaDB [(none)]&gt; show global status  like &#x27;%semi%&#x27;;<br>+--------------------------------------------+-------+<br>| Variable_name                              | Value |<br>+--------------------------------------------+-------+<br>| Rpl_semi_sync_master_clients               | 0     |<br>| Rpl_semi_sync_master_get_ack               | 0     |<br>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |<br>| Rpl_semi_sync_master_net_wait_time         | 0     |<br>| Rpl_semi_sync_master_net_waits             | 0     |<br>| Rpl_semi_sync_master_no_times              | 0     |<br>| Rpl_semi_sync_master_no_tx                 | 0     |<br>| Rpl_semi_sync_master_request_ack           | 0     |<br>| Rpl_semi_sync_master_status                | OFF   |<br>| Rpl_semi_sync_master_timefunc_failures     | 0     |<br>| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |<br>| Rpl_semi_sync_master_tx_wait_time          | 0     |<br>| Rpl_semi_sync_master_tx_waits              | 0     |<br>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |<br>| Rpl_semi_sync_master_wait_sessions         | 0     |<br>| Rpl_semi_sync_master_yes_tx                | 0     |<br>| Rpl_semi_sync_slave_send_ack               | 0     |<br>| Rpl_semi_sync_slave_status                 | ON    |<br>+--------------------------------------------+-------+<br>18 rows in set (0.001 sec)<br><br><br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主服务器</span><br>MariaDB [(none)]&gt; show global variables like &#x27;%semi%&#x27;;<br>+---------------------------------------+--------------+<br>| Variable_name                         | Value        |<br>+---------------------------------------+--------------+<br>| rpl_semi_sync_master_enabled          | ON           |<br>| rpl_semi_sync_master_timeout          | 30000        |<br>| rpl_semi_sync_master_trace_level      | 32           |<br>| rpl_semi_sync_master_wait_no_slave    | ON           |<br>| rpl_semi_sync_master_wait_point       | AFTER_COMMIT |<br>| rpl_semi_sync_slave_delay_master      | OFF          |<br>| rpl_semi_sync_slave_enabled           | OFF          |<br>| rpl_semi_sync_slave_kill_conn_timeout | 5            |<br>| rpl_semi_sync_slave_trace_level       | 32           |<br>+---------------------------------------+--------------+<br>9 rows in set (0.001 sec)<br><br>MariaDB [(none)]&gt; show global status  like &#x27;%semi%&#x27;;<br>+--------------------------------------------+-------+<br>| Variable_name                              | Value |<br>+--------------------------------------------+-------+<br>| Rpl_semi_sync_master_clients               | 2     |<br>| Rpl_semi_sync_master_get_ack               | 0     |<br>| Rpl_semi_sync_master_net_avg_wait_time     | 0     |<br>| Rpl_semi_sync_master_net_wait_time         | 0     |<br>| Rpl_semi_sync_master_net_waits             | 0     |<br>| Rpl_semi_sync_master_no_times              | 0     |<br>| Rpl_semi_sync_master_no_tx                 | 0     |<br>| Rpl_semi_sync_master_request_ack           | 0     |<br>| Rpl_semi_sync_master_status                | ON    |<br>| Rpl_semi_sync_master_timefunc_failures     | 0     |<br>| Rpl_semi_sync_master_tx_avg_wait_time      | 0     |<br>| Rpl_semi_sync_master_tx_wait_time          | 0     |<br>| Rpl_semi_sync_master_tx_waits              | 0     |<br>| Rpl_semi_sync_master_wait_pos_backtraverse | 0     |<br>| Rpl_semi_sync_master_wait_sessions         | 0     |<br>| Rpl_semi_sync_master_yes_tx                | 0     |<br>| Rpl_semi_sync_slave_send_ack               | 0     |<br>| Rpl_semi_sync_slave_status                 | OFF   |<br>+--------------------------------------------+-------+<br>18 rows in set (0.001 sec)<br><br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">测试</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在master实现，创建数据库，立即成功</span><br>MariaDB [(none)]&gt; create database db11;<br>Query OK, 1 row affected (0.001 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在所有salve节点实现，停止复制线程</span><br>MariaDB [(none)]&gt; stop slave;<br>Query OK, 0 rows affected (0.004 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在master实现，创建数据库，等待3S成功</span><br>MariaDB [(none)]&gt; create database db12;<br>Query OK, 1 row affected (3.006 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在任意一个salve节点实现，恢复复制线程</span><br>MariaDB [(none)]&gt; start slave;<br>Query OK, 0 rows affected (0.001 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在master实现，创建数据库，立即成功</span><br>MariaDB [(none)]&gt; create database db13;<br>Query OK, 1 row affected (0.001 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在所有从节点停止同步线程，在主节点可以看到以下日志信息</span><br>MariaDB [(none)]&gt; stop slave;<br>[21:22:06 root@rocky ~]#tail  /var/log/mariadb/mariadb.log <br>2023-09-06 21:14:57 11 [Note] Stop semi-sync binlog_dump to slave (server_id: 128)<br>2023-09-06 21:15:05 12 [Note] Stop semi-sync binlog_dump to slave (server_id: 3)<br>2023-09-06 21:15:13 10 [Warning] Timeout waiting for reply of binlog (file: mariadb-bin.000004, pos: 856), semi-sync up to file mariadb-bin.000004, position 727.<br>2023-09-06 21:15:13 10 [Note] Semi-sync replication switched OFF.<br>2023-09-06 21:15:20 15 [Note] Start binlog_dump to slave_server(128), pos(mariadb-bin.000004, 727), using_gtid(0), gtid(&#x27;&#x27;)<br>2023-09-06 21:15:20 15 [Note] Start semi-sync binlog_dump to slave (server_id: 128), pos(./mariadb-bin.000004, 727)<br>2023-09-06 21:15:20 6 [Note] Semi-sync replication switched ON with slave (server_id: 128) at (mariadb-bin.000004, 856)<br>2023-09-06 21:19:58 15 [Note] Stop semi-sync binlog_dump to slave (server_id: 128)<br>2023-09-06 21:20:41 10 [Warning] Timeout waiting for reply of binlog (file: mariadb-bin.000004, pos: 1114), semi-sync up to file mariadb-bin.000004, position 985.<br>2023-09-06 21:20:41 10 [Note] Semi-sync replication switched OFF.<br><br><br></code></pre></td></tr></table></figure>



<h1 id="5-用mycat实现mysql的读写分离"><a href="#5-用mycat实现mysql的读写分离" class="headerlink" title="5.用mycat实现mysql的读写分离"></a>5.用mycat实现mysql的读写分离</h1><p><img src="image-20230906214723545.png" srcset="/img/loading.gif" lazyload alt="image-20230906214723545"></p>
<h2 id="5-1-主机环境："><a href="#5-1-主机环境：" class="headerlink" title="5.1 主机环境："></a>5.1 主机环境：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">mycat-server 10.0.0.128  	CentOS8.5<br>mysql-master 10.0.0.4   	rocky8.5 , mariadb10.3.35<br>mysql-slave 10.0.0.3  		rocky8.5 , mariadb10.3.35<br></code></pre></td></tr></table></figure>

<p><strong>关闭selinux和防火墙</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:37:52 root@rocky ~]#systemctl stop firewalld<br>[21:53:06 root@rocky ~]#setenforce 0<br>setenforce: SELinux is disabled<br><br></code></pre></td></tr></table></figure>

<h2 id="5-2-创建MySQL主从数据库"><a href="#5-2-创建MySQL主从数据库" class="headerlink" title="5.2 创建MySQL主从数据库"></a>5.2 创建MySQL主从数据库</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##在mysql-master 10.0.0.4 上:</span></span><br>1 #在master上安装mariadb，并修改配置文件<br>[22:12:20 root@mysql-master ~]#yum install -y mariadb-server<br>[22:12:20 root@mysql-master ~]#vim /etc/my.cnf.d/mariadb-server.cnf<br>[mysqld]<br>log_bin   			#启用二进制日志，mysql8.0之后版本默认开启<br>server-id=4			#设置全局唯一的ID号<br><br>[22:12:20 root@mysql-master ~]#systemctl restart mariadb.service<br><br>2 #在master上创建复制用户<br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">grant replication slave on *.* to repluser@<span class="hljs-string">&#x27;10.0.0.%&#x27;</span> identified by <span class="hljs-string">&#x27;123456&#x27;</span>;</span><br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##在mysql-slave 10.0.0.3上:</span></span><br>1 #在slave上安装mariadb，并修改配置文件<br>[22:12:45 root@mysql-slave ~]#yum install -y mariadb-server<br>[22:12:45 root@mysql-slave ~]#vim /etc/my.cnf.d/mariadb-server.cnf<br>[mysqld]<br>server-id=3			#设置全局唯一的ID号<br><br>[22:12:45 root@mysql-slave ~]#systemctl restart mariadb.service<br><br>2 #在slave配置<br>[22:12:45 root@mysql-slave ~]#mysql<br>MariaDB [(none)]&gt; CHANGE MASTER TO<br>	MASTER_HOST=&#x27;10.0.0.4&#x27;,<br>	MASTER_USER=&#x27;repluser&#x27;,<br>	MASTER_PASSWORD=&#x27;123456&#x27;,<br>	MASTER_PORT=3306,<br>	MASTER_LOG_FILE=&#x27;mariadb-bin.000001&#x27;,<br>	MASTER_LOG_POS=9176;<br>MariaDB [mysql]&gt; start slave;<br>MariaDB [(none)]&gt; show slave status \G;<br>*************************** 1. row ***************************<br>                Slave_IO_State: Waiting for master to send event<br>                   Master_Host: 10.0.0.4<br>                   Master_User: repluser<br>                   Master_Port: 3306<br>                 Connect_Retry: 60<br>               Master_Log_File: mariadb-bin.000001<br>           Read_Master_Log_Pos: 9176<br>                Relay_Log_File: mariadb-relay-bin.000003<br>                 Relay_Log_Pos: 557<br>         Relay_Master_Log_File: mariadb-bin.000001<br>              Slave_IO_Running: Yes<br>             Slave_SQL_Running: Yes<br>               Replicate_Do_DB: <br>           Replicate_Ignore_DB: <br>            Replicate_Do_Table: <br>        Replicate_Ignore_Table: <br>       Replicate_Wild_Do_Table: <br>   Replicate_Wild_Ignore_Table: <br>                    Last_Errno: 0<br>                    Last_Error: <br>                  Skip_Counter: 0<br>           Exec_Master_Log_Pos: 9176<br>               Relay_Log_Space: 10015<br>               Until_Condition: None<br>                Until_Log_File: <br>                 Until_Log_Pos: 0<br>            Master_SSL_Allowed: No<br>            Master_SSL_CA_File: <br>            Master_SSL_CA_Path: <br>               Master_SSL_Cert: <br>             Master_SSL_Cipher: <br>                Master_SSL_Key: <br>         Seconds_Behind_Master: 0<br> Master_SSL_Verify_Server_Cert: No<br>                 Last_IO_Errno: 0<br>                 Last_IO_Error: <br>                Last_SQL_Errno: 0<br>                Last_SQL_Error: <br>   Replicate_Ignore_Server_Ids: <br>              Master_Server_Id: 4<br>                Master_SSL_Crl: <br>            Master_SSL_Crlpath: <br>                    Using_Gtid: No<br>                   Gtid_IO_Pos: <br>       Replicate_Do_Domain_Ids: <br>   Replicate_Ignore_Domain_Ids: <br>                 Parallel_Mode: conservative<br>                     SQL_Delay: 0<br>           SQL_Remaining_Delay: NULL<br>       Slave_SQL_Running_State: Slave has read all relay log; waiting for the slave I/O thread to update it<br>              Slave_DDL_Groups: 29<br>Slave_Non_Transactional_Groups: 0<br>    Slave_Transactional_Groups: 7<br>1 row in set (0.002 sec)<br></code></pre></td></tr></table></figure>

<h2 id="5-3-在MySQL代理服务器上10-0-0-128上安装mycat并启动"><a href="#5-3-在MySQL代理服务器上10-0-0-128上安装mycat并启动" class="headerlink" title="5.3 在MySQL代理服务器上10.0.0.128上安装mycat并启动"></a>5.3 在MySQL代理服务器上10.0.0.128上安装mycat并启动</h2><p>mycat下载地址：</p>
<p><a target="_blank" rel="noopener" href="http://dl.mycat.org.cn/">http://dl.mycat.org.cn/</a></p>
<p><a target="_blank" rel="noopener" href="http://mycatone.top/">http://mycatone.top/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/MyCATApache/Mycat-Server">https://github.com/MyCATApache/Mycat-Server</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装java环境</span><br>[22:17:59 root@Mycat-server ~]#yum install -y java<br>[22:18:31 root@Mycat-server ~]#java -version<br>openjdk version &quot;1.8.0_312&quot;<br>OpenJDK Runtime Environment (build 1.8.0_312-b07)<br>OpenJDK 64-Bit Server VM (build 25.312-b07, mixed mode)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载并安装</span><br>[22:18:37 root@Mycat-server ~]#wget http://dl.mycat.org.cn/1.6.7.6/20220524101549/Mycat-server-1.6.7.6-release-20220524173810-linux.tar.gz<br><br>[22:27:00 root@Mycat-server ~]#mkdir /apps<br>[22:29:37 root@Mycat-server ~]#tar xvf Mycat-server-1.6.7.6-release-20220524173810-linux.tar.gz -C /apps/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置环境变量</span><br>[22:31:29 root@Mycat-server ~]#echo &#x27;PATH=/apps/mycat/bin:$PATH&#x27; &gt; /etc/profile.d/mycat.sh<br>[22:32:21 root@Mycat-server ~]#source /etc/profile.d/mycat.sh <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动mycat</span>                          <br>[22:33:52 root@Mycat-server ~]#file /apps/mycat/bin/mycat <br>/apps/mycat/bin/mycat: a /usr/bin/env sh script, ASCII text executable<br>[22:34:17 root@Mycat-server ~]#mycat <br>Usage: /apps/mycat/bin/mycat &#123; console | start | stop | restart | status | dump &#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：此步骤启动较慢，需要等一会儿，另外如果内存太小会导致无法启动</span><br>[22:34:26 root@Mycat-server ~]#mycat start<br>Starting Mycat-server...<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">可以看到打开多个端口，其中8066端口用于连接mycat</span><br>[11:31:09 root@localhost ~]#ss -ntlp<br>State       Recv-Q      Send-Q           Local Address:Port            Peer Address:Port     Process                              <br>LISTEN      0           128                    0.0.0.0:22                   0.0.0.0:*         users:((&quot;sshd&quot;,pid=903,fd=4))       <br>LISTEN      0           1                    127.0.0.1:32000                0.0.0.0:*         users:((&quot;java&quot;,pid=2616,fd=4))      <br>LISTEN      0           100                          *:9066                       *:*         users:((&quot;java&quot;,pid=2616,fd=84))     <br>LISTEN      0           50                           *:42157                      *:*         users:((&quot;java&quot;,pid=2616,fd=68))     <br>LISTEN      0           50                           *:39027                      *:*         users:((&quot;java&quot;,pid=2616,fd=66))     <br>LISTEN      0           128                       [::]:22                      [::]:*         users:((&quot;sshd&quot;,pid=903,fd=6))       <br>LISTEN      0           50                           *:1984                       *:*         users:((&quot;java&quot;,pid=2616,fd=67))     <br>LISTEN      0           100                          *:8066                       *:*         users:((&quot;java&quot;,pid=2616,fd=88)) <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看日志，确认成功，可能需要等一会才能拿看到成功的提示</span><br>[11:31:03 root@localhost ~]#tail -f /apps/mycat/logs/wrapper.log <br>STATUS | wrapper  | 2023/09/06 11:31:02 | --&gt; Wrapper Started as Daemon<br>STATUS | wrapper  | 2023/09/06 11:31:02 | Launching a JVM...<br>INFO   | jvm 1    | 2023/09/06 11:31:03 | Wrapper (Version 3.2.3) http://wrapper.tanukisoftware.org<br>INFO   | jvm 1    | 2023/09/06 11:31:03 |   Copyright 1999-2006 Tanuki Software, Inc.  All Rights Reserved.<br>INFO   | jvm 1    | 2023/09/06 11:31:03 | <br>INFO   | jvm 1    | 2023/09/06 11:31:03 | MyCAT Server startup successfully. see logs in logs/mycat.log<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">用默认密码123456来连接mycat</span><br>[23:22:57 root@mysql-master ~]#mysql -uroot -p123456 -h 10.0.0.128 -P8066<br>Welcome to the MariaDB monitor.  Commands end with ; or \g.<br>Your MySQL connection id is 1<br>Server version: 5.6.29-mycat-1.6.7.4-release-20200105164103 MyCat Server (OpenCloudDB)<br><br>Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.<br><br>Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.<br><br>MySQL [(none)]&gt; show databases;<br>+----------+<br>| DATABASE |<br>+----------+<br>| TESTDB   |<br>+----------+<br>1 row in set (0.002 sec)<br><br>MySQL [(none)]&gt; use TESTDB;<br>Reading table information for completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br><br>Database changed<br>MySQL [TESTDB]&gt; show tables;<br>+------------------+<br>| Tables in TESTDB |<br>+------------------+<br>| address          |<br>| travelrecord     |<br>+------------------+<br>2 rows in set (0.001 sec)<br><br>MySQL [TESTDB]&gt; select *from tavelrecord;<br>ERROR 1064 (HY000): can&#x27;t find table define in schema TAVELRECORD schema:TESTDB<br>MySQL [TESTDB]&gt; select * from tavelrecord;<br>ERROR 1064 (HY000): can&#x27;t find table define in schema TAVELRECORD schema:TESTDB<br>MySQL [TESTDB]&gt; select * from address;<br>ERROR 1105 (HY000): backend connect: java.lang.IllegalArgumentException: Invalid DataSource:0<br></code></pre></td></tr></table></figure>

<h2 id="5-4-在mycat服务器上修改server-xml文件配置mycat的连接信息"><a href="#5-4-在mycat服务器上修改server-xml文件配置mycat的连接信息" class="headerlink" title="5.4 在mycat服务器上修改server.xml文件配置mycat的连接信息"></a>5.4 在mycat服务器上修改server.xml文件配置mycat的连接信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">[11:38:48 root@localhost ~]#vim /apps/mycat/conf/server.xml <br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除注释，并修改下面行的8066为3306</span><br> &lt;!--<br>                        &lt;property name=&quot;serverPort&quot;&gt;3306&lt;/property&gt; &lt;property name=&quot;managerPort&quot;&gt;9066&lt;/property&gt; <br>                        &lt;property name=&quot;idleTimeout&quot;&gt;300000&lt;/property&gt; &lt;property name=&quot;bindIp&quot;&gt;0.0.0.0&lt;/property&gt;<br>                        &lt;property name=&quot;dataNodeIdleCheckPeriod&quot;&gt;300000&lt;/property&gt; #5 * 60 * 1000L; //连接空闲检查 删除#后面部分<br>                        &lt;property name=&quot;frontWriteQueueSize&quot;&gt;4096&lt;/property&gt; &lt;property name=&quot;processors&quot;&gt;32&lt;/property&gt;# --&gt; 删除#后面部分<br><br><br>&lt;user name=&quot;user&quot;&gt;<br>&lt;property name=&quot;password&quot;&gt;user&lt;/property&gt;	#连接<br>&lt;property name=&quot;schemas&quot;&gt;TESTDB&lt;/property&gt;<br><br>        &lt;/user&gt;<br><br></code></pre></td></tr></table></figure>

<h2 id="5-5-修改schema-xml实现读写分离策略"><a href="#5-5-修改schema-xml实现读写分离策略" class="headerlink" title="5.5 修改schema.xml实现读写分离策略"></a>5.5 修改schema.xml实现读写分离策略</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs shell">[07:58:27 root@localhost ~]#vim /apps/mycat/conf/schema.xml<br>&lt;?xml version=&quot;1.0&quot;?&gt;<br>  2 &lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;<br>  3 &lt;mycat:schema xmlns:mycat=&quot;http://io.mycat/&quot;&gt;<br>  4 <br>  5         &lt;schema name=&quot;TESTDB&quot; checkSQLschema=&quot;****false***&quot; sqlMaxLimit=&quot;100&quot; randomDataNode=&quot;dn1&quot; dataNode=&quot;**dn1**&quot;&gt; ##dataNode=&quot;dn1&quot;是添加的内容<br> 11         &lt;/schema&gt;<br> 14         &lt;dataNode name=&quot;dn1&quot; dataHost=&quot;localhost1&quot; database=&quot;**mycat**&quot; /&gt;<br> 21         &lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;**1**&quot; ##balance=&quot;1&quot;表示读写分离<br> 22                           writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot;  slaveThreshold=&quot;100&quot;&gt;<br> 23                 &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;<br> 24                 &lt;!-- can have multi write hosts --&gt;<br> 25  *** &lt;writeHost host=&quot;host1&quot; url=&quot;10.0.0.4:3306&quot; user=&quot;root&quot;                              password=&quot;123456&quot;&gt;****##10.0.0.4为主库<br> <br> 26	*** &lt;readHost host=&quot;host2&quot; url=&quot;10.0.0.3:3306&quot; user=&quot;root&quot;                              password=&quot;123456&quot;&gt;***##10.0.0.3为从库<br> 27                 &lt;/writeHost&gt;<br>					&lt;/dataHost&gt;<br>					&lt;/mycat:schema&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#以上***部分表示原配置文件中需要修改的内容</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意大小写</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">最终文件内容</span><br>[07:58:27 root@localhost ~]#vim /apps/mycat/conf/schema.xml<br>&lt;?xml version=&quot;1.0&quot;?&gt;<br>&lt;!DOCTYPE mycat:schema SYSTEM &quot;schema.dtd&quot;&gt;<br>&lt;mycat:schema xmlns:mycat=&quot;http://io.mycat/&quot;&gt;<br>    &lt;schema name=&quot;TESTDB&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;dn1&quot;&gt;<br>    &lt;/schema&gt;<br>    &lt;dataNode name=&quot;dn1&quot; dataHost=&quot;localhost1&quot; database=&quot;hellodb&quot; /&gt;<br>    &lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;<br>              writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot;  slaveThreshold=&quot;100&quot;&gt;<br>        &lt;heartbeat&gt;select user()&lt;/heartbeat&gt;<br>        &lt;writeHost host=&quot;host1&quot; url=&quot;10.0.0.4:3306&quot; user=&quot;admin&quot;<br>                   password=&quot;123456&quot;&gt;<br>         &lt;readHost host=&quot;host2&quot; url=&quot;10.0.0.3:3306&quot; user=&quot;admin&quot; password=&quot;123456&quot; /&gt;<br>        &lt;/writeHost&gt;<br>    &lt;/dataHost&gt;<br>&lt;/mycat:schema&gt;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启启动mycat</span><br>[20:51:20 root@localhost ~]#mycat restart<br></code></pre></td></tr></table></figure>

<p>注意：要保证使用root/123456权限成功登录10.0.0.4和10.0.0.3机器上面的mysql数据库。同时也要授权mycat机器能使用root/123456权限成功登录10.0.0.4和10.0.0.3机器上面的mysql数据库否则会导致登录mycat后，对数据库和表的操作失败。</p>
<p>示例：schema.xml</p>
<p><img src="image-20230907205610664.png" srcset="/img/loading.gif" lazyload alt="image-20230907205610664"></p>
<h2 id="5-6-在后端主服务器上创建用户并对mycat授权"><a href="#5-6-在后端主服务器上创建用户并对mycat授权" class="headerlink" title="5.6 在后端主服务器上创建用户并对mycat授权"></a>5.6 在后端主服务器上创建用户并对mycat授权</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在master上创建用于mycat连接的admin用户</span><br>MariaDB [(none)]&gt; create user admin@&#x27;10.0.0.%&#x27; identified by &#x27;123456&#x27;;<br>MariaDB [(none)]&gt; grant all on hellodb.* to admin@&#x27;10.0.0.%&#x27;;<br></code></pre></td></tr></table></figure>

<h2 id="5-7-在主机上连接并测试"><a href="#5-7-在主机上连接并测试" class="headerlink" title="5.7 在主机上连接并测试"></a>5.7 在主机上连接并测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:14:39 root@ROOT-DNS ~]#mysql -uroot -p123456 -h 10.0.0.128 TESTDB<br>MySQL [TESTDB]&gt; select * from teachers ;<br>+-----+---------------+-----+--------+<br>| TID | Name          | Age | Gender |<br>+-----+---------------+-----+--------+<br>|   1 | Song Jiang    |  45 | M      |<br>|   2 | Zhang Sanfeng |  94 | M      |<br>|   3 | Miejue Shitai |  77 | F      |<br>|   4 | Lin Chaoying  |  93 | F      |<br>|   5 | aa            |  17 | M      |<br>|   6 | bb            |  22 | M      |<br>|   7 | cc            |  22 | M      |<br>+-----+---------------+-----+--------+<br><br></code></pre></td></tr></table></figure>

<h2 id="5-8-通过查看通用日志确认实现读写分离"><a href="#5-8-通过查看通用日志确认实现读写分离" class="headerlink" title="5.8 通过查看通用日志确认实现读写分离"></a>5.8 通过查看通用日志确认实现读写分离</h2><p>在mariadb上查看通用日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">MariaDB [(none)]&gt; show  variables like &#x27;general_log&#x27;; #查看日志是否开启<br>MariaDB [(none)]&gt; set global general_log=on;	#开启日志功能<br>MariaDB [(none)]&gt; show  variables like &#x27;general_log_file&#x27;; #查看日志保存位置名称<br>MariaDB [(none)]&gt; set global general_log_file=&#x27;rocky.log&#x27;;#设置日志文件名称<br></code></pre></td></tr></table></figure>

<p>在主和从服务器上分别开启通用日志，查看读写分离</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:56:26 root@mysql-master ~]#vim /etc/my.cnf.d/mariadb-server.cnf <br>[mysqld]<br>general_log=ON<br><br>[21:57:03 root@mysql-master ~]#systemctl restart mariadb.service <br>[21:54:07 root@mysql-master ~]#tail -f /var/lib/mysql/rocky.log<br></code></pre></td></tr></table></figure>

<p>验证结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在客户端上执行下面两条sql语句</span><br>MySQL [TESTDB]&gt; insert teachers (name,age,gender) values(&#x27;hh&#x27;,22,&#x27;M&#x27;);<br>MySQL [TESTDB]&gt; select * from teachers where name = &#x27;bb&#x27; ;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主节点上10.0.0.4查看通用日志</span><br>[21:57:44 root@mysql-master ~]#tail -f /var/lib/mysql/rocky.log <br>230907 21:59:11	    29 Query	select user()<br>230907 21:59:21	    21 Query	select user()<br>230907 21:59:28	    31 Query	SET names utf8<br>insert teachers (name,age,gender) values(&#x27;hh&#x27;,22,&#x27;M&#x27;)<br>230907 21:59:31	    33 Connect	admin@10.0.0.128 as anonymous on hellodb<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">从节点上10.0.0.3查看通用日志</span><br>[22:02:17 root@mysql-slave ~]#tail -f /var/lib/mysql/rocky.log <br>230907 22:01:41	    44 Query	select user()<br>230907 22:01:49	    45 Query	SET names utf8;show tables<br>		    39 Query	select * from teachers where name = &#x27;bb&#x27;<br>230907 22:01:51	    41 Query	select user()<br><br></code></pre></td></tr></table></figure>

<h2 id="5-9-停止从节点，mycat自动调度至主节点"><a href="#5-9-停止从节点，mycat自动调度至主节点" class="headerlink" title="5.9 停止从节点，mycat自动调度至主节点"></a>5.9 停止从节点，mycat自动调度至主节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:11:01 root@mysql-slave ~]#systemctl stop mariadb<br>MySQL [TESTDB]&gt; show variables like &#x27;server_id&#x27;;<br>+---------------+-------+<br>| Variable_name | Value |<br>+---------------+-------+<br>| server_id     | 4     |<br>+---------------+-------+<br>1 row in set (0.002 sec)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">停止主节点后，mycat不会自动调度写请求至从节点，查询也不行</span><br>MySQL [TESTDB]&gt; insert teachers (name,age,gender) values(&#x27;jj&#x27;,22,&#x27;M&#x27;);<br>ERROR 1184 (HY000): java.net.ConnectException: Connection refused<br>MySQL [TESTDB]&gt; show variables like &#x27;server_id&#x27;;<br>ERROR 1184 (HY000): java.net.ConnectException: Connection refused<br></code></pre></td></tr></table></figure>



<h1 id="6-实现openvpn部署，并且测试通过，输出博客或者自己的文档存档。"><a href="#6-实现openvpn部署，并且测试通过，输出博客或者自己的文档存档。" class="headerlink" title="6.实现openvpn部署，并且测试通过，输出博客或者自己的文档存档。"></a>6.实现openvpn部署，并且测试通过，输出博客或者自己的文档存档。</h1><h2 id="6-1-准备阿里云网络实验环境"><a href="#6-1-准备阿里云网络实验环境" class="headerlink" title="6.1 准备阿里云网络实验环境"></a>6.1 准备阿里云网络实验环境</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs markdown">1 阿里云创建专有网络<br>指定城市和可用区：华北3（张家口）可用区A<br>网段名xiaohexie-net1和地址段172.16.0.0/12，默认资源组<br>交换机名xiaohexie-net1-sw1 可用区A IPV4地址段172.30.0.0/24<br>安全组开放端口22，3389，1194/tcp/udp<br><br><br>2 创建VPN服务器有公网IP地址的实例1个<br>指定城市和可用区：华北3（张家口）可用区A<br>计算型 2核(vCPU) 4GiB<br>网络：xiaohexie-net1 交换机：xiaohexie-net1-sw1 <br>公网IP   按量收费 5M<br>默认安全组	默认配置	开放端口22，3389，1194/tcp/udp，icmp<br>rocky8.5<br>系统盘 存储默认高校云盘40G<br><br><br>3 创建VPN服务器有公网IP地址的实例第2个<br>按量付费<br>指定城市和可用区：华北3（张家口）可用区A<br>计算型 1核(vCPU) 2GiB<br>网络：xiaohexie-net1 交换机：xiaohexie-net1-sw1 <br>默认安全组	默认配置	开放端口22，3389，1194/tcp/udp，icmp<br>rocky8.5<br>系统盘 存储默认高校云盘40G<br><br>4 打开安全组端口  1194/tcp/udp<br></code></pre></td></tr></table></figure>

<p><img src="image-20230904164206456.png" srcset="/img/loading.gif" lazyload alt="image-20230904164206456"></p>
<p>修改安全组规则：</p>
<p><img src="image-20230904164639710.png" srcset="/img/loading.gif" lazyload alt="image-20230904164639710"></p>
<h2 id="6-2-环境：局域网OpenVPN实战环境"><a href="#6-2-环境：局域网OpenVPN实战环境" class="headerlink" title="6.2 环境：局域网OpenVPN实战环境"></a>6.2 环境：局域网OpenVPN实战环境</h2><p><img src="image-20230906214103238.png" srcset="/img/loading.gif" lazyload alt="image-20230906214103238"></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs http">共四台主机<br>1 openvpn server;<br>rocky8.5<br>eth0:10.0.0.8  NAT模式，模拟公网IP<br>eth1:172.30.0.228  NAT模式，模拟公网IP<br><br><br>2 内网主机两台<br>第1台主机<br>eth0:172.30.0.229  仅主机模式，私网IP<br>第2台主机<br>eth0:172.30.0.230  仅主机模式，私网IP<br><br><br>3 Windows 客户端<br></code></pre></td></tr></table></figure>

<h2 id="6-2-安装OpenVPN软件包"><a href="#6-2-安装OpenVPN软件包" class="headerlink" title="6.2 安装OpenVPN软件包"></a>6.2 安装OpenVPN软件包</h2><h3 id="6-2-1-查看版本"><a href="#6-2-1-查看版本" class="headerlink" title="6.2.1 查看版本"></a>6.2.1 查看版本</h3><h4 id="6-2-1-1-查看官网版本OpenVPN版本"><a href="#6-2-1-1-查看官网版本OpenVPN版本" class="headerlink" title="6.2.1.1 查看官网版本OpenVPN版本"></a>6.2.1.1 查看官网版本OpenVPN版本</h4><p><a target="_blank" rel="noopener" href="https://openvpn.net/community-downloads/">https://openvpn.net/community-downloads/</a></p>
<p><img src="image-20230904174321716.png" srcset="/img/loading.gif" lazyload alt="image-20230904174321716"></p>
<h4 id="6-2-1-2-在不同OS上查看"><a href="#6-2-1-2-在不同OS上查看" class="headerlink" title="6.2.1.2 在不同OS上查看"></a>6.2.1.2 在不同OS上查看</h4><p>范例：rocky8.5查看OpenVPN版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server yum.repos.d]# yum list openvpn<br>Last metadata expiration check: 0:07:01 ago on Mon 04 Sep 2023 05:33:46 PM CST.<br>Installed Packages<br>openvpn.x86_64                                                 2.4.12-1.el8     <br><br><br>[root@openvpn-server yum.repos.d]# yum list easy-rsa<br>Last metadata expiration check: 0:10:32 ago on Mon 04 Sep 2023 05:33:46 PM CST.<br>Installed Packages<br>easy-rsa.noarch                                                 3.0.8-1.el8                               <br></code></pre></td></tr></table></figure>



<h3 id="6-2-2-安装OpenVPN"><a href="#6-2-2-安装OpenVPN" class="headerlink" title="6.2.2 安装OpenVPN"></a>6.2.2 安装OpenVPN</h3><p>后面环境以Rocky8.5上基于EPEL源安装OpenVPN</p>
<h4 id="6-2-2-1-安装OpenVPN和证书工具"><a href="#6-2-2-1-安装OpenVPN和证书工具" class="headerlink" title="6.2.2.1 安装OpenVPN和证书工具"></a>6.2.2.1 安装OpenVPN和证书工具</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">安装OpenVPN服务器端</span><br>[root@openvpn-server ~]# yum install -y openvpn<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装证书管理工具</span><br>[root@openvpn-server ~]# yum -y install easy-rsa<br></code></pre></td></tr></table></figure>

<h4 id="6-2-2-2-准备相关配置文件"><a href="#6-2-2-2-准备相关配置文件" class="headerlink" title="6.2.2.2 准备相关配置文件"></a>6.2.2.2 准备相关配置文件</h4><p>#生成服务器配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成服务器配置文件</span><br>[root@openvpn-server ~]# cp /usr/share/doc/openvpn/sample/sample-config-files/server.conf  /etc/openvpn/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">准备证书颁发相关文件</span><br>[root@openvpn-server ~]# cp -r /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">准备证书颁发相关变量的配置文件</span><br>[root@openvpn-server ~]# cp /usr/share/doc/easy-rsa/vars.example /etc/openvpn/easy-rsa-server/3/vars<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">建议修改给CA和OpenVPN服务器颁发的证书的有效期，可适当加长</span><br>[root@openvpn-server ~]# vim /etc/openvpn/easy-rsa-server/3/vars <br><span class="hljs-meta prompt_">#</span><span class="language-bash">CA的证书默认有效期为10年，可以适当延长，比如：36500天</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">set_var EASYRSA_CA_EXPIRE      3650</span><br>set_var EASYRSA_CA_EXPIRE       36500<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">服务器证书默认有效期为825天，可以适当延长，比如：3650天</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">set_var EASYRSA_CERT_EXPIRE    825</span><br>set_var EASYRSA_CERT_EXPIRE     3650<br><br>[root@openvpn-server ~]# tree /etc/openvpn<br>/etc/openvpn<br>├── client<br>├── easy-rsa-server<br>│   ├── 3 -&gt; 3.0.8<br>│   ├── 3.0 -&gt; 3.0.8<br>│   └── 3.0.8<br>│       ├── easyrsa<br>│       ├── openssl-easyrsa.cnf<br>│       ├── vars<br>│       └── x509-types<br>│           ├── ca<br>│           ├── client<br>│           ├── code-signing<br>│           ├── COMMON<br>│           ├── email<br>│           ├── kdc<br>│           ├── server<br>│           └── serverClient<br>├── server<br>└── server.conf<br><br>7 directories, 12 files<br></code></pre></td></tr></table></figure>

<h2 id="6-3-准备证书相关文件"><a href="#6-3-准备证书相关文件" class="headerlink" title="6.3 准备证书相关文件"></a>6.3 准备证书相关文件</h2><h3 id="6-3-1-初始化PKI和CA颁发机构环境"><a href="#6-3-1-初始化PKI和CA颁发机构环境" class="headerlink" title="6.3.1 初始化PKI和CA颁发机构环境"></a>6.3.1 初始化PKI和CA颁发机构环境</h3><h4 id="6-3-1-1-脚本easyrsa帮助用法"><a href="#6-3-1-1-脚本easyrsa帮助用法" class="headerlink" title="6.3.1.1 脚本easyrsa帮助用法"></a>6.3.1.1 脚本easyrsa帮助用法</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server ~]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# ls<br>easyrsa  openssl-easyrsa.cnf  vars  x509-types<br>[root@openvpn-server 3]# file easyrsa <br>easyrsa: POSIX shell script, ASCII text executable<br>[root@openvpn-server 3]# ./easyrsa <br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br><br>Easy-RSA 3 usage and overview<br><br>USAGE: easyrsa [options] COMMAND [command-options]<br><br>A list of commands is shown below. To get detailed usage and help for a<br>command, run:<br>  ./easyrsa help COMMAND<br><br>For a listing of options that can be supplied before the command, use:<br>  ./easyrsa help options<br><br>Here is the list of commands available with a short syntax reminder. Use the<br>&#x27;help&#x27; command above to get full usage details.<br><br>  init-pki<br>  build-ca [ cmd-opts ]<br>  gen-dh<br>  gen-req &lt;filename_base&gt; [ cmd-opts ]<br>  sign-req &lt;type&gt; &lt;filename_base&gt;<br>  build-client-full &lt;filename_base&gt; [ cmd-opts ]<br>  build-server-full &lt;filename_base&gt; [ cmd-opts ]<br>  revoke &lt;filename_base&gt; [cmd-opts]<br>  renew &lt;filename_base&gt; [cmd-opts]<br>  build-serverClient-full &lt;filename_base&gt; [ cmd-opts ]<br>  gen-crl<br>  update-db<br>  show-req &lt;filename_base&gt; [ cmd-opts ]<br>  show-cert &lt;filename_base&gt; [ cmd-opts ]<br>  show-ca [ cmd-opts ]<br>  import-req &lt;request_file_path&gt; &lt;short_basename&gt;<br>  export-p7 &lt;filename_base&gt; [ cmd-opts ]<br>  export-p8 &lt;filename_base&gt; [ cmd-opts ]<br>  export-p12 &lt;filename_base&gt; [ cmd-opts ]<br>  set-rsa-pass &lt;filename_base&gt; [ cmd-opts ]<br>  set-ec-pass &lt;filename_base&gt; [ cmd-opts ]<br>  upgrade &lt;type&gt;<br><br>DIRECTORY STATUS (commands would take effect on these locations)<br>  EASYRSA: /etc/openvpn/easy-rsa-server/3.0.8<br>      PKI: /etc/openvpn/easy-rsa-server/3/pki<br><br></code></pre></td></tr></table></figure>



<h4 id="6-3-1-2-初始化PKI生成PKI相关目录和文件"><a href="#6-3-1-2-初始化PKI生成PKI相关目录和文件" class="headerlink" title="6.3.1.2 初始化PKI生成PKI相关目录和文件"></a>6.3.1.2 初始化PKI生成PKI相关目录和文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# pwd<br>/etc/openvpn/easy-rsa-server/3<br>[root@openvpn-server 3]# ls<br>easyrsa  openssl-easyrsa.cnf  vars  x509-types<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化数据，在当前目录下生成pki目录及相关文件</span><br>[root@openvpn-server 3]# ./easyrsa init-pki<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br><br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /etc/openvpn/easy-rsa-server/3/pki<br><br>[root@openvpn-server 3]# tree<br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki<br>│   ├── openssl-easyrsa.cnf<br>│   ├── private<br>│   ├── reqs<br>│   └── safessl-easyrsa.cnf<br>├── vars<br>└── x509-types<br>    ├── ca<br>    ├── client<br>    ├── code-signing<br>    ├── COMMON<br>    ├── email<br>    ├── kdc<br>    ├── server<br>    └── serverClient<br><br>4 directories, 13 files<br></code></pre></td></tr></table></figure>

<h3 id="6-3-2-创建CA机构环境"><a href="#6-3-2-创建CA机构环境" class="headerlink" title="6.3.2 创建CA机构环境"></a>6.3.2 创建CA机构环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# tree pki<br>pki<br>├── openssl-easyrsa.cnf<br>├── private<br>├── reqs<br>└── safessl-easyrsa.cnf<br><br>2 directories, 2 files<br><br><br>[root@openvpn-server 3]# ./easyrsa build-ca nopass <br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br>Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021<br>Generating RSA private key, 2048 bit long modulus (2 primes)<br>..................+++++<br>...................................................................................................................................................................+++++<br>e is 65537 (0x010001)<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter &#x27;.&#x27;, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [Easy-RSA CA]:#回车接受默认值<br><br>CA creation complete and you may now import and sign cert requests.<br>Your new CA certificate file for publishing is at:<br>/etc/openvpn/easy-rsa-server/3/pki/ca.crt #生成自签名的证书文件<br><br>[root@openvpn-server 3]# tree pki<br>pki<br>├── ca.crt					#生成的自签名文件<br>├── certs_by_serial<br>├── index.txt<br>├── index.txt.attr<br>├── issued<br>├── openssl-easyrsa.cnf<br>├── private<br>│   └── ca.key				#生成的私钥文件<br>├── renewed<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── reqs<br>├── revoked<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>└── serial<br><br>12 directories, 7 files<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看生成CA相关的文件</span><br>[root@openvpn-server 3]# cat pki/serial <br>01<br>[root@openvpn-server 3]# ll pki/index.txt<br>-rw------- 1 root root 0 Sep  4 18:12 pki/index.txt<br>[root@openvpn-server 3]# ll pki/ca.crt pki/private/ca.key <br>-rw------- 1 root root 1204 Sep  4 18:12 pki/ca.crt<br>-rw------- 1 root root 1679 Sep  4 18:12 pki/private/ca.key<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看生成的自签名证书</span><br>[root@openvpn-server 3]# cat pki/ca.crt <br>-----BEGIN CERTIFICATE-----<br>MIIDTTCCAjWgAwIBAgIUOCaT1RijSDoXn2mRgqIKjhJ96eUwDQYJKoZIhvcNAQEL<br>BQAwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0EwIBcNMjMwOTA0MTAxMjUwWhgPMjEy<br>MzA4MTExMDEyNTBaMBYxFDASBgNVBAMMC0Vhc3ktUlNBIENBMIIBIjANBgkqhkiG<br>9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvO2NEDFksJ0zZiXv9oZUPL7JNiYhx5f3UixE<br>9RCc+2mJ6B/fluxD5GnSWTbaXHZQ/HREeZ+SQaf4aaw4q4FpjnIOfRhDvA55D2xI<br>jf6tLLZX/SOmxhKEvRZOv7rHPdkjepcwq9Rr1IGFmE/2qE48MQdeveErwYiwruus<br>72nuE7//ZPPtv5VX8Hjz+si4rUcwn0caG5UXiFPdocXPjkQeOubQb73OmyJlvSWF<br>p4GZaya8yW1rcPzynZCdhfnNt9J8CVjLzkoL/jlt1uds2h28OGaMQKQSkny5kA3O<br>leOIvnqFGEqLahhTTeGLYkiNoNLD1KuHnamYp/uKk1a/m6rarwIDAQABo4GQMIGN<br>MB0GA1UdDgQWBBQ7XFYbRvlasglx8Y1P0qjdkGmuTzBRBgNVHSMESjBIgBQ7XFYb<br>Rvlasglx8Y1P0qjdkGmuT6EapBgwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0GCFDgm<br>k9UYo0g6F59pkYKiCo4SfenlMAwGA1UdEwQFMAMBAf8wCwYDVR0PBAQDAgEGMA0G<br>CSqGSIb3DQEBCwUAA4IBAQAT8I4o+HGU6r+dsErNxPlk0IfHhMcbWtlYfb5ydRj3<br>SfRe2Aa0H3mbSWF5QOckD4pr1rCBWLVFLNN0MV/NjNUefqDIDsO8D2K07CHFnJVB<br>ZGc2Zoo0qNW55HISTpSlbtmjHv4cRgN8C/EI05OUNPkFlarJoHF3iOkJlHH6KzUu<br>HFzPYuA+XgfAS0tezEYs84gGVFEQNe0SJ/ZXMtVK4Pg/6nNqbITLz/nbN5ZmsyQE<br>lyZLaw1AuD9LSmib6hNiNVF4w+HHGor49KptOYxGp3DlzAc8rgfp74lQw1BurWQm<br>8lWvfxusDttvBYbG/QIdogpgFEWx+/4V837nKEbavLv3<br>-----END CERTIFICATE-----<br>[root@openvpn-server 3]# openssl x509 -in pki/ca.crt -noout -text<br>Certificate:<br>    Data:<br>        Version: 3 (0x2)<br>        Serial Number:<br>            38:26:93:d5:18:a3:48:3a:17:9f:69:91:82:a2:0a:8e:12:7d:e9:e5<br>        Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: CN = Easy-RSA CA<br>        Validity<br>            Not Before: Sep  4 10:12:50 2023 GMT<br>            Not After : Aug 11 10:12:50 2123 GMT<br>        Subject: CN = Easy-RSA CA<br>        Subject Public Key Info:<br>            Public Key Algorithm: rsaEncryption<br>                RSA Public-Key: (2048 bit)<br>                Modulus:<br>                    00:bc:ed:8d:10:31:64:b0:9d:33:66:25:ef:f6:86:<br>                    54:3c:be:c9:36:26:21:c7:97:f7:52:2c:44:f5:10:<br>                    9c:fb:69:89:e8:1f:df:96:ec:43:e4:69:d2:59:36:<br>                    da:5c:76:50:fc:74:44:79:9f:92:41:a7:f8:69:ac:<br>                    38:ab:81:69:8e:72:0e:7d:18:43:bc:0e:79:0f:6c:<br>                    48:8d:fe:ad:2c:b6:57:fd:23:a6:c6:12:84:bd:16:<br>                    4e:bf:ba:c7:3d:d9:23:7a:97:30:ab:d4:6b:d4:81:<br>                    85:98:4f:f6:a8:4e:3c:31:07:5e:bd:e1:2b:c1:88:<br>                    b0:ae:eb:ac:ef:69:ee:13:bf:ff:64:f3:ed:bf:95:<br>                    57:f0:78:f3:fa:c8:b8:ad:47:30:9f:47:1a:1b:95:<br>                    17:88:53:dd:a1:c5:cf:8e:44:1e:3a:e6:d0:6f:bd:<br>                    ce:9b:22:65:bd:25:85:a7:81:99:6b:26:bc:c9:6d:<br>                    6b:70:fc:f2:9d:90:9d:85:f9:cd:b7:d2:7c:09:58:<br>                    cb:ce:4a:0b:fe:39:6d:d6:e7:6c:da:1d:bc:38:66:<br>                    8c:40:a4:12:92:7c:b9:90:0d:ce:95:e3:88:be:7a:<br>                    85:18:4a:8b:6a:18:53:4d:e1:8b:62:48:8d:a0:d2:<br>                    c3:d4:ab:87:9d:a9:98:a7:fb:8a:93:56:bf:9b:aa:<br>                    da:af<br>                Exponent: 65537 (0x10001)<br>        X509v3 extensions:<br>            X509v3 Subject Key Identifier: <br>                3B:5C:56:1B:46:F9:5A:B2:09:71:F1:8D:4F:D2:A8:DD:90:69:AE:4F<br>            X509v3 Authority Key Identifier: <br>                keyid:3B:5C:56:1B:46:F9:5A:B2:09:71:F1:8D:4F:D2:A8:DD:90:69:AE:4F<br>                DirName:/CN=Easy-RSA CA<br>                serial:38:26:93:D5:18:A3:48:3A:17:9F:69:91:82:A2:0A:8E:12:7D:E9:E5<br><br>            X509v3 Basic Constraints: <br>                CA:TRUE<br>            X509v3 Key Usage: <br>                Certificate Sign, CRL Sign<br>    Signature Algorithm: sha256WithRSAEncryption<br>         13:f0:8e:28:f8:71:94:ea:bf:9d:b0:4a:cd:c4:f9:64:d0:87:<br>         c7:84:c7:1b:5a:d9:58:7d:be:72:75:18:f7:49:f4:5e:d8:06:<br>         b4:1f:79:9b:49:61:79:40:e7:24:0f:8a:6b:d6:b0:81:58:b5:<br>         45:2c:d3:74:31:5f:cd:8c:d5:1e:7e:a0:c8:0e:c3:bc:0f:62:<br>         b4:ec:21:c5:9c:95:41:64:67:36:66:8a:34:a8:d5:b9:e4:72:<br>         12:4e:94:a5:6e:d9:a3:1e:fe:1c:46:03:7c:0b:f1:08:d3:93:<br>         94:34:f9:05:95:aa:c9:a0:71:77:88:e9:09:94:71:fa:2b:35:<br>         2e:1c:5c:cf:62:e0:3e:5e:07:c0:4b:4b:5e:cc:46:2c:f3:88:<br>         06:54:51:10:35:ed:12:27:f6:57:32:d5:4a:e0:f8:3f:ea:73:<br>         6a:6c:84:cb:cf:f9:db:37:96:66:b3:24:04:97:26:4b:6b:0d:<br>         40:b8:3f:4b:4a:68:9b:ea:13:62:35:51:78:c3:e1:c7:1a:8a:<br>         f8:f4:aa:6d:39:8c:46:a7:70:e5:cc:07:3c:ae:07:e9:ef:89:<br>         50:c3:50:6e:ad:64:26:f2:55:af:7f:1b:ac:0e:db:6f:05:86:<br>         c6:fd:02:1d:a2:0a:60:14:45:b1:fb:fe:15:f3:7e:e7:28:46:<br>         da:bc:bb:f7<br><br><br></code></pre></td></tr></table></figure>

<h3 id="6-3-3-创建服务端证书申请"><a href="#6-3-3-创建服务端证书申请" class="headerlink" title="6.3.3 创建服务端证书申请"></a>6.3.3 创建服务端证书申请</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3<br>[root@openvpn-server 3]# pwd<br>/etc/openvpn/easy-rsa-server/3<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建服务器证书申请文件，其中server是文件前缀</span><br>[root@openvpn-server 3]# ./easyrsa gen-req server nopass<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br>Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021<br>Generating a RSA private key<br>..........................................................................+++++<br>...........................................+++++<br>writing new private key to &#x27;/etc/openvpn/easy-rsa-server/3/pki/easy-rsa-27759.n56kQe/tmp.msQzao&#x27;<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter &#x27;.&#x27;, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [server]:#接受默认值，直接回车<br><br>Keypair and certificate request completed. Your files are:<br>req: /etc/openvpn/easy-rsa-server/3/pki/reqs/server.req		#生成请求文件<br>key: /etc/openvpn/easy-rsa-server/3/pki/private/server.key	#生成私钥文件<br><br><br>[root@openvpn-server 3]# tree pki<br>pki<br>├── ca.crt<br>├── certs_by_serial<br>├── index.txt<br>├── index.txt.attr<br>├── issued<br>├── openssl-easyrsa.cnf<br>├── private<br>│   ├── ca.key<br>│   └── server.key			#生成私钥文件<br>├── renewed<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── reqs<br>│   └── server.req			#生成请求文件<br>├── revoked<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>└── serial<br><br>12 directories, 9 files<br><br><br></code></pre></td></tr></table></figure>

<h3 id="6-3-4-颁发服务器端证书"><a href="#6-3-4-颁发服务器端证书" class="headerlink" title="6.3.4 颁发服务器端证书"></a>6.3.4 颁发服务器端证书</h3><h3 id="6-3-4-查看颁发证书命令用法"><a href="#6-3-4-查看颁发证书命令用法" class="headerlink" title="6.3.4 查看颁发证书命令用法"></a>6.3.4 查看颁发证书命令用法</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# ./easyrsa help sign<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br><br>  sign-req &lt;type&gt; &lt;filename_base&gt;<br>      Sign a certificate request of the defined type. &lt;type&gt; must be a known<br>      type such as &#x27;client&#x27;, &#x27;server&#x27;, &#x27;serverClient&#x27;, or &#x27;ca&#x27; (or a user-added type.)<br><br>      This request file must exist in the reqs/ dir and have a .req file<br>      extension. See import-req below for importing reqs from other sources.<br></code></pre></td></tr></table></figure>

<h4 id="6-3-4-2-颁发服务器端证书"><a href="#6-3-4-2-颁发服务器端证书" class="headerlink" title="6.3.4.2 颁发服务器端证书"></a>6.3.4.2 颁发服务器端证书</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">将上面server.req的申请，颁发server类型的证书</span><br>[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">第一个server表示证书的类型，第二个server表示请求文件名的前缀</span><br>[root@openvpn-server 3]# ./easyrsa help sign<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br><br>  sign-req &lt;type&gt; &lt;filename_base&gt;<br>      Sign a certificate request of the defined type. &lt;type&gt; must be a known<br>      type such as &#x27;client&#x27;, &#x27;server&#x27;, &#x27;serverClient&#x27;, or &#x27;ca&#x27; (or a user-added type.)<br><br>      This request file must exist in the reqs/ dir and have a .req file<br>      extension. See import-req below for importing reqs from other sources.<br><br>[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# ./easyrsa sign server server<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br>Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021<br><br><br>You are about to sign the following certificate.<br>Please check over the details shown below for accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br>source or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a server certificate for 3650 days:	#可以看到vars文件指定的有效期<br><br>subject=<br>    commonName                = server<br><br><br>Type the word &#x27;yes&#x27; to continue, or any other input to abort.<br>  Confirm request details: yes 	#输入yes回车<br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-27817.CoQzG6/tmp.AdoNNL<br>Check that the request matches the signature<br>Signature ok<br>The Subject&#x27;s Distinguished Name is as follows<br>commonName            :ASN.1 12:&#x27;server&#x27;<br>Certificate is to be certified until Sep  1 10:34:57 2033 GMT (3650 days)<br><br>Write out database with 1 new entries<br>Data Base Updated<br><br>Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt	#生成服务器证书文件<br><br><br></code></pre></td></tr></table></figure>

<h4 id="6-3-4-3-验证结果"><a href="#6-3-4-3-验证结果" class="headerlink" title="6.3.4.3 验证结果"></a>6.3.4.3 验证结果</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><code class="hljs shell"><br>[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# tree pki<br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│   └── B4E4DEFE67EDAB91F2133984E939A6BD.pem  #生成服务器证书文件<br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── issued<br>│   └── server.crt			#生成服务器证书文件<br>├── openssl-easyrsa.cnf<br>├── private<br>│   ├── ca.key<br>│   └── server.key<br>├── renewed<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── reqs<br>│   └── server.req<br>├── revoked<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>├── serial<br>└── serial.old<br><br>12 directories, 14 files<br><br><br>[root@openvpn-server 3]# diff pki/certs_by_serial/B4E4DEFE67EDAB91F2133984E939A6BD.pem pki/issued/server.crt <br>[root@openvpn-server 3]# ll !*<br>ll pki/certs_by_serial/B4E4DEFE67EDAB91F2133984E939A6BD.pem pki/issued/server.crt<br>-rw------- 1 root root 4608 Sep  4 18:34 pki/certs_by_serial/B4E4DEFE67EDAB91F2133984E939A6BD.pem<br>-rw------- 1 root root 4608 Sep  4 18:34 pki/issued/server.crt<br><br>[root@openvpn-server 3]# cat pki/issued/server.crt <br>Certificate:<br>    Data:<br>        Version: 3 (0x2)<br>        Serial Number:<br>            b4:e4:de:fe:67:ed:ab:91:f2:13:39:84:e9:39:a6:bd<br>        Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: CN=Easy-RSA CA<br>        Validity<br>            Not Before: Sep  4 10:34:57 2023 GMT<br>            Not After : Sep  1 10:34:57 2033 GMT<br>        Subject: CN=server<br>        Subject Public Key Info:<br>            Public Key Algorithm: rsaEncryption<br>                RSA Public-Key: (2048 bit)<br>                Modulus:<br>                    00:df:27:8e:88:3d:91:df:98:2a:e4:c3:02:88:ef:<br>                    61:32:cf:ac:6d:13:ab:69:7c:f6:9f:78:e0:23:9b:<br>                    43:04:f6:32:f5:61:75:d0:3f:9d:fb:a9:a0:ab:ba:<br>                    c7:d3:f7:28:68:13:68:ab:e9:0c:ca:a6:a4:83:08:<br>                    c7:8a:53:87:d4:af:af:42:32:46:9f:7c:4a:b2:e6:<br>                    c2:ec:8f:90:c1:2a:22:d4:33:45:67:8f:51:9a:cd:<br>                    81:9b:9f:96:92:d1:00:67:5e:a7:11:ca:43:8a:d4:<br>                    a4:4b:f6:71:c1:47:0f:58:5c:a2:6b:c5:43:d4:4d:<br>                    71:bd:a8:c3:40:b6:03:d6:ec:0f:ae:09:e1:15:8d:<br>                    04:c7:06:e3:de:b5:f6:1a:d3:ab:ba:70:6a:e0:16:<br>                    a2:2d:7f:fe:fe:87:00:9d:af:4d:a8:0f:fe:23:8f:<br>                    29:ff:a5:42:e4:cf:b7:f5:2b:a6:b0:42:19:de:85:<br>                    45:6e:67:c7:e5:b9:47:2f:f4:5a:1a:48:b9:ab:fe:<br>                    a1:c0:0a:6b:b9:13:85:b2:95:35:c8:9c:2a:27:cc:<br>                    c5:0a:62:68:c3:f7:c6:c3:53:e2:d4:05:8d:b1:16:<br>                    eb:6c:52:73:a9:5a:7b:af:1c:5b:ec:2c:8d:aa:32:<br>                    cb:33:38:db:78:f1:9a:93:11:92:07:fa:f1:0e:a1:<br>                    2b:af<br>                Exponent: 65537 (0x10001)<br>        X509v3 extensions:<br>            X509v3 Basic Constraints: <br>                CA:FALSE<br>            X509v3 Subject Key Identifier: <br>                58:E5:55:6A:4F:DE:64:F4:7A:11:E1:C9:CD:20:E1:95:0B:AB:BC:3A<br>            X509v3 Authority Key Identifier: <br>                keyid:3B:5C:56:1B:46:F9:5A:B2:09:71:F1:8D:4F:D2:A8:DD:90:69:AE:4F<br>                DirName:/CN=Easy-RSA CA<br>                serial:38:26:93:D5:18:A3:48:3A:17:9F:69:91:82:A2:0A:8E:12:7D:E9:E5<br><br>            X509v3 Extended Key Usage: <br>                TLS Web Server Authentication<br>            X509v3 Key Usage: <br>                Digital Signature, Key Encipherment<br>            X509v3 Subject Alternative Name: <br>                DNS:server<br>    Signature Algorithm: sha256WithRSAEncryption<br>         15:e3:96:9c:c6:99:39:89:34:45:bf:f4:6b:b6:24:88:a6:a0:<br>         55:bc:5a:d5:f1:3f:dd:8e:f6:53:2d:42:57:6c:64:61:38:4d:<br>         7a:00:f8:0a:55:15:25:2d:eb:bd:bf:61:31:88:82:51:1e:e7:<br>         15:62:0c:ab:20:b8:2e:29:59:94:3f:cd:bc:a9:8c:7a:c7:fa:<br>         87:a6:3d:40:5c:80:4d:9d:e0:b2:1e:7f:c2:b6:76:5a:7b:10:<br>         ef:84:e1:98:93:85:0b:4a:28:4c:3f:0c:55:45:3f:16:11:e5:<br>         80:6d:07:e0:42:73:b1:17:ee:12:94:53:57:88:b2:d9:04:78:<br>         25:1e:8c:03:6a:3f:08:8a:f1:a6:72:d9:2a:08:f1:b7:d8:1f:<br>         b9:b6:b3:80:e4:4e:69:b9:d7:59:26:c8:3a:21:8b:6c:54:14:<br>         b9:1a:70:05:e0:74:ff:9c:a4:55:8d:93:c3:31:fc:0a:b0:75:<br>         12:2c:80:1d:64:dc:60:44:3a:eb:9e:49:57:75:65:f4:30:7a:<br>         f9:41:c6:5f:ec:05:ae:53:b6:8c:6f:4f:85:f1:dc:16:92:89:<br>         e4:9c:6e:a5:c6:54:ad:11:27:7f:cb:97:43:e5:59:04:ef:a1:<br>         ba:6a:12:c6:af:c1:1f:4e:76:4b:92:4e:d8:fa:4a:61:83:68:<br>         19:ca:f3:01<br>-----BEGIN CERTIFICATE-----<br>MIIDaDCCAlCgAwIBAgIRALTk3v5n7auR8hM5hOk5pr0wDQYJKoZIhvcNAQELBQAw<br>FjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0EwHhcNMjMwOTA0MTAzNDU3WhcNMzMwOTAx<br>MTAzNDU3WjARMQ8wDQYDVQQDDAZzZXJ2ZXIwggEiMA0GCSqGSIb3DQEBAQUAA4IB<br>DwAwggEKAoIBAQDfJ46IPZHfmCrkwwKI72Eyz6xtE6tpfPafeOAjm0ME9jL1YXXQ<br>P537qaCrusfT9yhoE2ir6QzKpqSDCMeKU4fUr69CMkaffEqy5sLsj5DBKiLUM0Vn<br>j1GazYGbn5aS0QBnXqcRykOK1KRL9nHBRw9YXKJrxUPUTXG9qMNAtgPW7A+uCeEV<br>jQTHBuPetfYa06u6cGrgFqItf/7+hwCdr02oD/4jjyn/pULkz7f1K6awQhnehUVu<br>Z8fluUcv9FoaSLmr/qHACmu5E4WylTXInConzMUKYmjD98bDU+LUBY2xFutsUnOp<br>WnuvHFvsLI2qMsszONt48ZqTEZIH+vEOoSuvAgMBAAGjgbUwgbIwCQYDVR0TBAIw<br>ADAdBgNVHQ4EFgQUWOVVak/eZPR6EeHJzSDhlQurvDowUQYDVR0jBEowSIAUO1xW<br>G0b5WrIJcfGNT9Ko3ZBprk+hGqQYMBYxFDASBgNVBAMMC0Vhc3ktUlNBIENBghQ4<br>JpPVGKNIOhefaZGCogqOEn3p5TATBgNVHSUEDDAKBggrBgEFBQcDATALBgNVHQ8E<br>BAMCBaAwEQYDVR0RBAowCIIGc2VydmVyMA0GCSqGSIb3DQEBCwUAA4IBAQAV45ac<br>xpk5iTRFv/RrtiSIpqBVvFrV8T/djvZTLUJXbGRhOE16APgKVRUlLeu9v2ExiIJR<br>HucVYgyrILguKVmUP828qYx6x/qHpj1AXIBNneCyHn/CtnZaexDvhOGYk4ULSihM<br>PwxVRT8WEeWAbQfgQnOxF+4SlFNXiLLZBHglHowDaj8IivGmctkqCPG32B+5trOA<br>5E5puddZJsg6IYtsVBS5GnAF4HT/nKRVjZPDMfwKsHUSLIAdZNxgRDrrnklXdWX0<br>MHr5QcZf7AWuU7aMb0+F8dwWkonknG6lxlStESd/y5dD5VkE76G6ahLGr8EfTnZL<br>kk7Y+kphg2gZyvMB<br>-----END CERTIFICATE-----<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看证书相关文件</span><br>[root@openvpn-server 3]# cat pki/serial<br>B4E4DEFE67EDAB91F2133984E939A6BE<br>[root@openvpn-server 3]# cat pki/index.txt<br>V	330901103457Z		B4E4DEFE67EDAB91F2133984E939A6BD	unknown	/CN=server<br>[root@openvpn-server 3]# cat pki/serial.old <br>b4e4defe67edab91f2133984e939a6bd<br><br></code></pre></td></tr></table></figure>

<h3 id="6-3-5-创建Diffie-Hellman-密钥"><a href="#6-3-5-创建Diffie-Hellman-密钥" class="headerlink" title="6.3.5 创建Diffie-Hellman 密钥"></a>6.3.5 创建Diffie-Hellman 密钥</h3><h4 id="6-3-5-1-Diffie-Hellman-算法说明"><a href="#6-3-5-1-Diffie-Hellman-算法说明" class="headerlink" title="6.3.5.1 Diffie-Hellman 算法说明"></a>6.3.5.1 Diffie-Hellman 算法说明</h4><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">wiki参考链接：<br>https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange<br></code></pre></td></tr></table></figure>

<h4 id="6-3-5-2-创建Diffie-Hellman-密钥"><a href="#6-3-5-2-创建Diffie-Hellman-密钥" class="headerlink" title="6.3.5.2 创建Diffie-Hellman 密钥"></a>6.3.5.2 创建Diffie-Hellman 密钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# pwd<br>/etc/openvpn/easy-rsa-server/3<br>[root@openvpn-server 3]# ./easyrsa gen-dh<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br>Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021<br>Generating DH parameters, 2048 bit long safe prime, generator 2<br>This is going to take a long time<br>...........................................+.+...............................................................+...................................................+...................++*++*++*++*<br><br>DH parameters of size 2048 created at /etc/openvpn/easy-rsa-server/3/pki/dh.pem<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看生成的文件</span><br>[root@openvpn-server 3]# ll pki/dh.pem <br>-rw------- 1 root root 424 Sep  4 18:45 pki/dh.pem<br>[root@openvpn-server 3]# cat !*<br>cat pki/dh.pem<br>-----BEGIN DH PARAMETERS-----<br>MIIBCAKCAQEAn3wYaDPpyvNEpGKujpDiCJ3IAIZkATK2Ud76DzXBl4UUYxLBaMGN<br>I9tbdN0gCIIhrhZb4FVZX6wNqg+XSUJUbJCMiBTHVvPOEuS5Gun7fm3iUVmqfd8d<br>xnVxwm/OW5hVLIf9pxZlUtyjPZu+GPDG4r2rH6gPWdw/bBwhHnvBylSwd4d1UxnR<br>LSEjlDgMHk+Nsd0TsXDMeLDDJFRxA76sTwHXNzQqcEl06FQ5d1JWdVpVoDsTaVFq<br>ta+PRKlZWGzdvROG0Jxm/sHMLlP+RXBp9xZxhAMJ8L5Cw4VTm4riujeLTz5Ik0xu<br>bewSuoErPy1AGqzi92dMrkuXrlPcemblowIBAg==<br>-----END DH PARAMETERS-----<br></code></pre></td></tr></table></figure>

<h3 id="6-3-6-准备客户端证书环境"><a href="#6-3-6-准备客户端证书环境" class="headerlink" title="6.3.6 准备客户端证书环境"></a>6.3.6 准备客户端证书环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cp -a /usr/share/easy-rsa/ /etc/openvpn/easy-rsa-client<br><br>[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-client/3/<br>[root@openvpn-server 3]# pwd<br>/etc/openvpn/easy-rsa-client/3<br>[root@openvpn-server 3]# ls<br>easyrsa  openssl-easyrsa.cnf  x509-types<br>[root@openvpn-server 3]# tree<br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>└── x509-types<br>    ├── ca<br>    ├── client<br>    ├── code-signing<br>    ├── COMMON<br>    ├── email<br>    ├── kdc<br>    ├── server<br>    └── serverClient<br><br>1 directory, 10 files<br><br>[root@openvpn-server 3]# ./easyrsa init-pki<br><br>init-pki complete; you may now create a CA or requests.<br>Your newly created PKI dir is: /etc/openvpn/easy-rsa-client/3/pki	#生成新目录<br><br><br>[root@openvpn-server 3]# ls<br>easyrsa  openssl-easyrsa.cnf  pki  x509-types<br>[root@openvpn-server 3]# tree<br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki							#生成新目录<br>│   ├── openssl-easyrsa.cnf<br>│   ├── private<br>│   ├── reqs<br>│   └── safessl-easyrsa.cnf<br>└── x509-types<br>    ├── ca<br>    ├── client<br>    ├── code-signing<br>    ├── COMMON<br>    ├── email<br>    ├── kdc<br>    ├── server<br>    └── serverClient<br><br>4 directories, 12 files<br><br></code></pre></td></tr></table></figure>

<h3 id="6-3-7创建客户端证书申请"><a href="#6-3-7创建客户端证书申请" class="headerlink" title="6.3.7创建客户端证书申请"></a>6.3.7创建客户端证书申请</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cd /etc/openvpn//easy-rsa-client/3/<br>[root@openvpn-server 3]# pwd<br>/etc/openvpn/easy-rsa-client/3<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成客户端的证书申请</span><br>[root@openvpn-server 3]# ./easyrsa gen-req xiaohexie nopass<br>Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021<br>Generating a RSA private key<br>..+++++<br>..+++++<br>writing new private key to &#x27;/etc/openvpn/easy-rsa-client/3/pki/easy-rsa-28110.7vV12J/tmp.PSN65o&#x27;<br>-----<br>You are about to be asked to enter information that will be incorporated<br>into your certificate request.<br>What you are about to enter is what is called a Distinguished Name or a DN.<br>There are quite a few fields but you can leave some blank<br>For some fields there will be a default value,<br>If you enter &#x27;.&#x27;, the field will be left blank.<br>-----<br>Common Name (eg: your user, host, or server name) [xiaohexie]:<br><br>Keypair and certificate request completed. Your files are:		#接受默认值，直接回车<br>req: /etc/openvpn/easy-rsa-client/3/pki/reqs/xiaohexie.req		#私钥文件<br>key: /etc/openvpn/easy-rsa-client/3/pki/private/xiaohexie.key	#证书申请文件<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成两个新文件</span><br>[root@openvpn-server 3]# tree<br>.<br>├── easyrsa<br>├── openssl-easyrsa.cnf<br>├── pki<br>│   ├── openssl-easyrsa.cnf<br>│   ├── private<br>│   │   └── xiaohexie.key			#证书申请文件<br>│   ├── reqs<br>│   │   └── xiaohexie.req			#私钥文件<br>│   └── safessl-easyrsa.cnf<br>└── x509-types<br>    ├── ca<br>    ├── client<br>    ├── code-signing<br>    ├── COMMON<br>    ├── email<br>    ├── kdc<br>    ├── server<br>    └── serverClient<br><br>4 directories, 14 files<br></code></pre></td></tr></table></figure>

<h3 id="2-3-8-颁发客户端证书"><a href="#2-3-8-颁发客户端证书" class="headerlink" title="2.3.8 颁发客户端证书"></a>2.3.8 颁发客户端证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server 3]# cd /etc/openvpn/easy-rsa-server/3/<br>[root@openvpn-server 3]# pwd<br>/etc/openvpn/easy-rsa-server/3<br><br><br>[root@openvpn-server 3]# ./easyrsa import-req /etc/openvpn/easy-rsa-client/3/pki/reqs/xiaohexie.req xiaohexie<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br>Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021<br><br>The request has been successfully imported with a short name of: xiaohexie<br>You may now use this name to perform signing operations on this request.<br><br><br>[root@openvpn-server 3]# tree pki<br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│   └── B4E4DEFE67EDAB91F2133984E939A6BD.pem<br>├── dh.pem<br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── issued<br>│   └── server.crt<br>├── openssl-easyrsa.cnf<br>├── private<br>│   ├── ca.key<br>│   └── server.key<br>├── renewed<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── reqs<br>│   ├── server.req<br>│   └── xiaohexie.req<br>├── revoked<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>├── serial<br>└── serial.old<br><br>12 directories, 16 files<br><br><br>[root@openvpn-server 3]# ll pki/reqs/xiaohexie.req /etc/openvpn/easy-rsa-client/3/pki/reqs/xiaohexie.req <br>-rw------- 1 root root 891 Sep  4 19:30 /etc/openvpn/easy-rsa-client/3/pki/reqs/xiaohexie.req<br>-rw------- 1 root root 891 Sep  4 19:35 pki/reqs/xiaohexie.req<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改给客户端颁发的证书的有效期</span><br>[root@openvpn-server 3]# vim vars<br><span class="hljs-meta prompt_">#</span><span class="language-bash">建议修改给客户端颁发证书的有效期，可适当减少，比如：90天</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">set_var EASYRSA_CERT_EXPIRE    825</span><br>set_var EASYRSA_CERT_EXPIRE     90<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">颁发客户端证书</span><br>[root@openvpn-server 3]# ./easyrsa sign client xiaohexie<br><br>Note: using Easy-RSA configuration from: /etc/openvpn/easy-rsa-server/3.0.8/vars<br>Using SSL: openssl OpenSSL 1.1.1k  FIPS 25 Mar 2021<br><br><br>You are about to sign the following certificate.<br>Please check over the details shown below for accuracy. Note that this request<br>has not been cryptographically verified. Please be sure it came from a trusted<br>source or that you have verified the request checksum with the sender.<br><br>Request subject, to be signed as a client certificate for 90 days:<br><br>subject=<br>    commonName                = xiaohexie<br><br><br>Type the word &#x27;yes&#x27; to continue, or any other input to abort.<br>  Confirm request details: yes  #输入yes回车<br>Using configuration from /etc/openvpn/easy-rsa-server/3/pki/easy-rsa-28223.M1On8J/tmp.BVobq1<br>Check that the request matches the signature<br>Signature ok<br>The Subject&#x27;s Distinguished Name is as follows<br>commonName            :ASN.1 12:&#x27;xiaohexie&#x27;<br>Certificate is to be certified until Dec  3 11:42:34 2023 GMT (90 days)<br><br>Write out database with 1 new entries<br>Data Base Updated<br><br>Certificate created at: /etc/openvpn/easy-rsa-server/3/pki/issued/xiaohexie.crt  #证书文件<br><br>[root@openvpn-server 3]# tree pki<br>pki<br>├── ca.crt<br>├── certs_by_serial<br>│   ├── 6AAE9FE9052567C602C035116B1764C2.pem<br>│   └── B4E4DEFE67EDAB91F2133984E939A6BD.pem<br>├── dh.pem<br>├── index.txt<br>├── index.txt.attr<br>├── index.txt.attr.old<br>├── index.txt.old<br>├── issued<br>│   ├── server.crt<br>│   └── xiaohexie.crt		#证书文件<br>├── openssl-easyrsa.cnf<br>├── private<br>│   ├── ca.key<br>│   └── server.key<br>├── renewed<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── reqs<br>│   ├── server.req<br>│   └── xiaohexie.req<br>├── revoked<br>│   ├── certs_by_serial<br>│   ├── private_by_serial<br>│   └── reqs_by_serial<br>├── safessl-easyrsa.cnf<br>├── serial<br>└── serial.old<br><br>12 directories, 18 files<br><br><br>[root@openvpn-server 3]# cat pki/index.txt<br>V	330901103457Z		B4E4DEFE67EDAB91F2133984E939A6BD	unknown	/CN=server<br>V	231203114234Z		6AAE9FE9052567C602C035116B1764C2	unknown	/CN=xiaohexie<br>[root@openvpn-server 3]# ll pki/issued/<br>total 16<br>-rw------- 1 root root 4608 Sep  4 18:34 server.crt<br>-rw------- 1 root root 4499 Sep  4 19:42 xiaohexie.crt<br>[root@openvpn-server 3]# ll pki/certs_by_serial/<br>total 16<br>-rw------- 1 root root 4499 Sep  4 19:42 6AAE9FE9052567C602C035116B1764C2.pem<br>-rw------- 1 root root 4608 Sep  4 18:34 B4E4DEFE67EDAB91F2133984E939A6BD.pem<br>[root@openvpn-server 3]# cat pki/issued/xiaohexie.crt <br>Certificate:<br>    Data:<br>        Version: 3 (0x2)<br>        Serial Number:<br>            6a:ae:9f:e9:05:25:67:c6:02:c0:35:11:6b:17:64:c2<br>        Signature Algorithm: sha256WithRSAEncryption<br>        Issuer: CN=Easy-RSA CA<br>        Validity<br>            Not Before: Sep  4 11:42:34 2023 GMT<br>            Not After : Dec  3 11:42:34 2023 GMT<br>        Subject: CN=xiaohexie<br>        Subject Public Key Info:<br>            Public Key Algorithm: rsaEncryption<br>                RSA Public-Key: (2048 bit)<br>                Modulus:<br>                    00:ae:6e:4b:76:a9:62:45:4d:73:f9:af:b6:f1:e9:<br>                    eb:76:5e:08:f3:59:1d:f4:a6:57:9a:a7:20:13:92:<br>                    36:0a:af:77:b0:e1:d9:00:c0:47:26:bd:67:4c:4a:<br>                    d1:44:ac:e3:e1:3b:3f:d9:de:b5:f6:04:d0:70:93:<br>                    e6:15:1f:76:4b:35:f9:9b:74:81:7b:3a:ef:9f:0c:<br>                    40:cd:4e:f9:9f:7a:0e:9c:79:f8:4f:f9:ed:7b:fd:<br>                    92:df:c6:91:71:fb:5b:87:97:66:16:e0:a1:1e:8a:<br>                    cc:dd:e7:a0:94:85:51:6a:0d:7c:b2:df:df:68:81:<br>                    1a:0d:13:b9:48:53:61:4c:a2:90:9c:15:24:1e:e7:<br>                    9d:ff:54:f4:77:64:4b:48:8c:82:4b:02:33:40:ff:<br>                    35:c3:a1:c3:e2:c3:f0:e0:61:a0:b4:91:d7:88:22:<br>                    3e:29:8b:92:c6:f0:c7:5c:54:88:e7:91:6a:76:27:<br>                    be:2e:ae:64:0b:01:87:23:6b:82:fd:0b:f5:df:47:<br>                    d7:9f:06:3c:7e:d4:e5:d2:e4:cb:0e:58:45:87:ea:<br>                    a8:0d:0d:ac:ee:d8:f3:c9:ae:fa:71:c0:1c:d4:93:<br>                    44:13:3a:b5:07:a2:9b:03:1f:5a:86:ed:31:56:cc:<br>                    5f:bc:b8:86:3e:ef:b7:56:4b:05:f9:f2:99:40:31:<br>                    79:af<br>                Exponent: 65537 (0x10001)<br>        X509v3 extensions:<br>            X509v3 Basic Constraints: <br>                CA:FALSE<br>            X509v3 Subject Key Identifier: <br>                87:59:5C:82:2D:94:52:45:F0:39:5F:FF:19:33:19:1D:07:26:E8:40<br>            X509v3 Authority Key Identifier: <br>                keyid:3B:5C:56:1B:46:F9:5A:B2:09:71:F1:8D:4F:D2:A8:DD:90:69:AE:4F<br>                DirName:/CN=Easy-RSA CA<br>                serial:38:26:93:D5:18:A3:48:3A:17:9F:69:91:82:A2:0A:8E:12:7D:E9:E5<br><br>            X509v3 Extended Key Usage: <br>                TLS Web Client Authentication<br>            X509v3 Key Usage: <br>                Digital Signature<br>    Signature Algorithm: sha256WithRSAEncryption<br>         97:08:7a:15:bc:46:45:1e:5d:ba:9f:3b:ae:01:54:9e:32:1b:<br>         c9:78:58:59:dd:9b:9b:05:fd:96:5f:74:39:9b:55:a7:a2:e5:<br>         0c:a9:1b:cd:85:6a:6c:47:4d:e0:2d:a9:40:02:c4:23:cc:70:<br>         34:cf:6b:f2:1d:33:c5:cf:ae:08:56:0e:d1:6e:ca:ac:90:20:<br>         52:f3:f9:4b:a9:02:f1:bb:51:28:b7:3e:4d:79:6c:cc:92:97:<br>         47:d1:28:e8:5b:6b:92:cf:10:c1:b9:9f:69:e8:c3:20:7a:e7:<br>         61:0b:5b:58:a6:03:c8:9b:4f:24:7e:34:50:35:db:43:60:c5:<br>         4e:21:0f:2e:06:06:29:73:33:eb:f3:68:6a:2e:36:66:2a:65:<br>         86:68:df:2c:92:59:d6:34:eb:da:33:5b:5a:80:4c:73:1a:98:<br>         da:53:56:ea:ca:eb:54:55:33:03:dc:0f:80:ad:e4:c7:b0:1a:<br>         7a:56:e8:f7:03:76:5d:aa:47:1c:f2:72:35:59:da:30:02:a9:<br>         b4:83:c1:1b:71:f6:c4:b6:7c:d4:b7:71:75:97:fb:47:13:31:<br>         fb:29:44:34:b2:56:3b:a1:31:ea:a3:fb:ba:46:c5:09:cb:68:<br>         b3:d2:fb:4a:d1:55:63:0e:23:87:86:07:57:ad:28:25:be:e5:<br>         42:ae:71:21<br>-----BEGIN CERTIFICATE-----<br>MIIDVzCCAj+gAwIBAgIQaq6f6QUlZ8YCwDURaxdkwjANBgkqhkiG9w0BAQsFADAW<br>MRQwEgYDVQQDDAtFYXN5LVJTQSBDQTAeFw0yMzA5MDQxMTQyMzRaFw0yMzEyMDMx<br>MTQyMzRaMBQxEjAQBgNVBAMMCXhpYW9oZXhpZTCCASIwDQYJKoZIhvcNAQEBBQAD<br>ggEPADCCAQoCggEBAK5uS3apYkVNc/mvtvHp63ZeCPNZHfSmV5qnIBOSNgqvd7Dh<br>2QDARya9Z0xK0USs4+E7P9netfYE0HCT5hUfdks1+Zt0gXs6758MQM1O+Z96Dpx5<br>+E/57Xv9kt/GkXH7W4eXZhbgoR6KzN3noJSFUWoNfLLf32iBGg0TuUhTYUyikJwV<br>JB7nnf9U9HdkS0iMgksCM0D/NcOhw+LD8OBhoLSR14giPimLksbwx1xUiOeRanYn<br>vi6uZAsBhyNrgv0L9d9H158GPH7U5dLkyw5YRYfqqA0NrO7Y88mu+nHAHNSTRBM6<br>tQeimwMfWobtMVbMX7y4hj7vt1ZLBfnymUAxea8CAwEAAaOBojCBnzAJBgNVHRME<br>AjAAMB0GA1UdDgQWBBSHWVyCLZRSRfA5X/8ZMxkdByboQDBRBgNVHSMESjBIgBQ7<br>XFYbRvlasglx8Y1P0qjdkGmuT6EapBgwFjEUMBIGA1UEAwwLRWFzeS1SU0EgQ0GC<br>FDgmk9UYo0g6F59pkYKiCo4SfenlMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAsGA1Ud<br>DwQEAwIHgDANBgkqhkiG9w0BAQsFAAOCAQEAlwh6FbxGRR5dup87rgFUnjIbyXhY<br>Wd2bmwX9ll90OZtVp6LlDKkbzYVqbEdN4C2pQALEI8xwNM9r8h0zxc+uCFYO0W7K<br>rJAgUvP5S6kC8btRKLc+TXlszJKXR9Eo6Ftrks8QwbmfaejDIHrnYQtbWKYDyJtP<br>JH40UDXbQ2DFTiEPLgYGKXMz6/Noai42ZiplhmjfLJJZ1jTr2jNbWoBMcxqY2lNW<br>6srrVFUzA9wPgK3kx7Aaelbo9wN2XapHHPJyNVnaMAKptIPBG3H2xLZ81LdxdZf7<br>RxMx+ylENLJWO6Ex6qP7ukbFCctos9L7StFVYw4jh4YHV60oJb7lQq5xIQ==<br>-----END CERTIFICATE-----<br></code></pre></td></tr></table></figure>

<h3 id="6-3-8-将CA和服务器证书相关文件复制到服务器相应的目录"><a href="#6-3-8-将CA和服务器证书相关文件复制到服务器相应的目录" class="headerlink" title="6.3.8 将CA和服务器证书相关文件复制到服务器相应的目录"></a>6.3.8 将CA和服务器证书相关文件复制到服务器相应的目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server ~]# mkdir /etc/openvpn/certs<br>[root@openvpn-server ~]# cp /etc/openvpn/easy-rsa-server/3/pki/ca.crt  /etc/openvpn/certs/<br>[root@openvpn-server ~]# cp /etc/openvpn/easy-rsa-server/3/pki/issued/server.crt  /etc/openvpn/certs/<br>[root@openvpn-server ~]# cp /etc/openvpn/easy-rsa-server/3/pki/private/server.key  /etc/openvpn/certs/<br>[root@openvpn-server ~]# cp /etc/openvpn/easy-rsa-server/3/pki/dh.pem  /etc/openvpn/certs/<br>[root@openvpn-server ~]# ll /etc/openvpn/certs/<br>total 20<br>-rw------- 1 root root 1204 Sep  4 19:48 ca.crt<br>-rw------- 1 root root  424 Sep  4 19:49 dh.pem<br>-rw------- 1 root root 4608 Sep  4 19:49 server.crt<br>-rw------- 1 root root 1704 Sep  4 19:49 server.key<br><br></code></pre></td></tr></table></figure>

<p>6.3.9 将客户端私钥和证书相关文件复制到服务器相应的目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server ~]# find /etc/openvpn/ -name &quot;xiaohexie.key&quot; -o -name &quot;xiaohexie.crt&quot; -o -name ca.crt<br>/etc/openvpn/easy-rsa-server/3.0.8/pki/issued/xiaohexie.crt<br>/etc/openvpn/easy-rsa-server/3.0.8/pki/ca.crt<br>/etc/openvpn/easy-rsa-client/3.0.8/pki/private/xiaohexie.key<br>/etc/openvpn/certs/ca.crt<br><br><br>[root@openvpn-server ~]# find /etc/openvpn/ \( -name &quot;xiaohexie.key&quot; -o -name &quot;xiaohexie.crt&quot; -o -name ca.crt \) -exec cp &#123;&#125; /etc/openvpn/client/xiaohexie \;<br>[root@openvpn-server ~]# ll /etc/openvpn/client/xiaohexie/<br>total 16<br>-rw------- 1 root root 1204 Sep  4 19:54 ca.crt<br>-rw------- 1 root root 4499 Sep  4 19:54 xiaohexie.crt<br>-rw------- 1 root root 1704 Sep  4 19:54 xiaohexie.key<br><br></code></pre></td></tr></table></figure>

<h2 id="6-4-准备OpenVPN服务器配置文件"><a href="#6-4-准备OpenVPN服务器配置文件" class="headerlink" title="6.4 准备OpenVPN服务器配置文件"></a>6.4 准备OpenVPN服务器配置文件</h2><h3 id="6-4-1-OpenVPN服务器配置文件说明"><a href="#6-4-1-OpenVPN服务器配置文件说明" class="headerlink" title="6.4 .1 OpenVPN服务器配置文件说明"></a>6.4 .1 OpenVPN服务器配置文件说明</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">服务器配置文件server.conf文件中以<span class="hljs-comment">#或；开头的行都为注释</span></span><br>[root@openvpn-server ~]# grep -Ev &quot;^#|^$&quot; /etc/openvpn/server.conf <br>;local a.b.c.d	#本机监听IP，默认为本机所有IP<br>port 1194		#端口<br>;proto tcp		#推荐使用生产TCP<br>proto udp		#默认为UDP<br>;dev tap		#创建以太网隧道设备，tap设备实现以太网帧通过openvpn隧道，可提供非IP协议如IPX和AppleTalk等的支持，tap等当于一个以太网设备，它操作第二层数据包如以太网数据帧。<br>dev tun			#创建IP路由隧道，生产推存使用tun.互联网使用tun，一个tun设备大多时候被用于基于IP协议的通讯。tun模拟了网络层设备，操作第三层数据包比如IP数据封包。<br>;dev-node MyTap	#TAP-Win32的设备驱动。非windows系统不需要<br>ca ca.crt		#ca证书文件<br>cert server.crt	#服务器证书文件<br>key server.key  #服务器私钥文件<br>dh dh2048.pem	#dh参数文件<br>;topology subnet<br>server 10.8.0.0 255.255.255.0	#客户端连接后自动分配的IP网段，默认会给服务器分配此网段的第一个IP将做为客户端的网关，注意不要和内网网段相同<br>ifconfig-pool-persist ipp.txt	#记录客户端和虚拟ip地址分配的文件；<br>;server-bridge 10.8.0.4 255.255.255.0 10.8.0.50 10.8.0.100	#配置网桥模式,无需配置,建议注释<br>;server-bridge<br>;push &quot;route 192.168.10.0 255.255.255.0&quot;	#推送给客户端的到达服务器后面网段的静态路由，网关是服务器地址10.8.0.1<br>;push &quot;route 192.168.20.0 255.255.255.0&quot;	#推送路由信息到客户端，以允许客户端能够连接到服务器背后的其它私有网络<br>;client-config-dir ccd	#为特定客户端添加路由信息，此路由是客户端后面的网段而非服务端的网段，无需设置<br>;route 192.168.40.128 255.255.255.248<br>;client-config-dir ccd<br>;route 10.9.0.0 255.255.255.252<br>;learn-address ./script	#指定外部脚本文件，实现创建不同组的iptables规则，无需配置<br>;push &quot;redirect-gateway def1 bypass-dhcp&quot;	#启用此配置后客户端所有流量都将通过VpN服务器进行转发，因此生产一般无需配置此项<br>;push &quot;dhcp-option DNS 208.67.222.222&quot;		#推送DNS服务器地址，无需配置<br>;push &quot;dhcp-option DNS 208.67.220.220&quot;<br>;client-to-client	#允许不同的客户端直接通信，不安全，生产环境一般无需配置#多个用户共用一个证书，一般用于测试环境，生产环境建议一个用户一个证<br>;duplicate-cn		#多个用户共用一个证书，一般用于测试环境，生产环境建议一个用户一个证书，无需开启<br>keepalive 10 120	#设置服务端活动的检测的间隔和超时时间，每隔10秒ping一次，120秒没有回应则认为已经断线<br>tls-auth ta.key 0 	#访止DoS等攻击的安全增强配置，服务器和每个客户端都需要拥有此密钥文件。第二个参数在服务器端为0，客户端为1<br>cipher AES-256-CBC	#加密算法<br>;compress lz4-v2	#启用openvpn2.4.x新版压缩算法<br>;push &quot;compress lz4-v2&quot;	#推送客户端使用新版压缩算法，和下面的comp-lzo不要同时使用<br>;comp-lzo	#旧户端兼容的压缩配置，需要客户端配置开启压缩，openvpn2.4.x等新版可以不用开启<br>;max-clients 100	#最多支持的客户端数量<br>;user nobody		#指定openvpn服务的用户<br>;group nobody		#指定openvpn服务的组<br>persist-key			#重启服务时默认会重新读取key文件，开启此配置后保持使用第一次的key文件，生产环境无需开启<br>persist-tun			#Don&#x27;t close and reopen TUN/TAP device or run up/downscripts across SIGuSR1 or--ping-restart restarts,生产环境建议无需开启<br>status openvpn-status.log	#服务器状态记录文件，每分钟记录一次相关信息<br>;log         openvpn.log	#第一种日志记录方式，并指定日志路径，log会在openvpn启动的时候清空日志文件，不建议使用<br>;log-append  openvpn.log	#第二种日志记录方式，并指定日志路径，重启openvpn后在之前的日志后面追加新的日志，生产环境建议使用<br>verb 3			#设置日志级别，0-9，级别越高记录的内容越详细，0表示静默运行，只记录致命错误，4表示合理的常规用法，5和6可以帮助调试连接错误。9表示极度冗余，输出非常详细的日志信息<br>;mute 20		#对相同类别的信息只记录前20条到日志文件中;<br>explicit-exit-notify 1	#当服务端重启后通知客户端自动重新连接服务器，此项配置仅能用于udp模式，tcp模式无需配置即能实现重新连接功能，且开启此项后tcp配置后将导致openvpn服务无法启动，所以tcp时必须不能开启此项<br><br></code></pre></td></tr></table></figure>

<h3 id="6-4-2-修改服务器端配置文件"><a href="#6-4-2-修改服务器端配置文件" class="headerlink" title="6.4.2 修改服务器端配置文件"></a>6.4.2 修改服务器端配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server ~]# vim /etc/openvpn/server.conf <br>[root@openvpn-server ~]# grep &#x27;^[a-Z].*&#x27; /etc/openvpn/server.conf <br>port 1194<br>proto tcp<br>dev tun<br>ca /etc/openvpn/certs/ca.crt<br>cert /etc/openvpn/certs/server.crt<br>key /etc/openvpn/certs/server.key  # This file should be kept secret<br>dh /etc/openvpn/certs/dh.pem<br>server 10.8.0.0 255.255.255.0  #VPN分配的虚拟地址段<br>push &quot;route 172.30.0.0 255.255.255.0&quot;<br>keepalive 10 120<br>cipher AES-256-CBC<br>compress lz4-v2<br>push &quot;compress lz4-v2&quot;<br>max-clients 2048<br>user openvpn<br>group openvpn<br>status /var/log/openvpn/openvpn-status.log<br>log-append  /var/log/openvpn/openvpn.log<br>verb 3<br>mute 20<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">准备日志相关目录</span><br>[root@openvpn-server ~]# getent passwd openvpn<br>openvpn:x:990:986:OpenVPN:/etc/openvpn:/sbin/nologin<br>[root@openvpn-server ~]# mkdir /var/log/openvpn<br>[root@openvpn-server ~]# chown openvpn.openvpn  /var/log/openvpn<br>[root@openvpn-server ~]# ll -d /var/log/openvpn/<br>drwxr-xr-x 2 openvpn openvpn 6 Sep  4 20:47 /var/log/openvpn/<br></code></pre></td></tr></table></figure>

<h2 id="2-5-启动Openvpn服务"><a href="#2-5-启动Openvpn服务" class="headerlink" title="2.5 启动Openvpn服务"></a>2.5 启动Openvpn服务</h2><h3 id="2-5-1启动Openvpn服务"><a href="#2-5-1启动Openvpn服务" class="headerlink" title="2.5.1启动Openvpn服务"></a>2.5.1启动Openvpn服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#centos8缺失unit文件从centos7复制文件/usr/lib/systemd/system/openvpn@.service</span></span><br><br>[root@localhost ~]#rpm -ql openvpn | grep systemd<br>/usr/lib/systemd/system/openvpn-client@.service<br>/usr/lib/systemd/system/openvpn-server@.service<br>/usr/lib/systemd/system/openvpn@.service<br>/usr/share/doc/openvpn-2.4.12/README.systemd<br>[root@localhost ~]# vim /usr/lib/systemd/system/openvpn@.service<br><br>[Unit]<br>Description=OpenVPN Robust And Highly Flexible Tunneling Application On %I<br>After=network.target<br><br>[Service]<br>Type=notify<br>PrivateTmp=true<br>ExecStart=/usr/sbin/openvpn --cd /etc/openvpn/ --config %i.conf<br><br>[Install]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动openvpn服务，注意service名称和文件名不一致</span><br>[root@openvpn-server ~]# systemctl daemon-reload<br>[root@openvpn-server ~]# systemctl enable --now openvpn@server<br>[root@openvpn-server ~]# systemctl status openvpn@server<br><br></code></pre></td></tr></table></figure>

<h3 id="6-5-2-查看服务状态"><a href="#6-5-2-查看服务状态" class="headerlink" title="6.5.2 查看服务状态"></a>6.5.2 查看服务状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server ~]# systemctl status openvpn@server<br>● openvpn@server.service - OpenVPN Robust And Highly Flexible Tunneling Application On server<br>   Loaded: loaded (/usr/lib/systemd/system/openvpn@.service; enabled; vendor preset: disabled)<br>   Active: active (running) since Mon 2023-09-04 20:58:44 CST; 7s ago<br> Main PID: 28604 (openvpn)<br>   Status: &quot;Initialization Sequence Completed&quot;<br>    Tasks: 1 (limit: 22976)<br>   Memory: 1.2M<br>   CGroup: /system.slice/system-openvpn.slice/openvpn@server.service<br>           └─28604 /usr/sbin/openvpn --cd /etc/openvpn/ --config server.conf<br><br>Sep 04 20:58:44 openvpn-server systemd[1]: Starting OpenVPN Robust And Highly Flexible Tunneling Application On server...<br>Sep 04 20:58:44 openvpn-server systemd[1]: Started OpenVPN Robust And Highly Flexible Tunneling Application On server.<br>root@openvpn-server ~]# ss -nltp<br>State      Recv-Q     Send-Q           Local Address:Port           Peer Address:Port     Process                                 <br>LISTEN     0          32                     0.0.0.0:1194                0.0.0.0:*         users:((&quot;openvpn&quot;,pid=28604,fd=8))     <br>LISTEN     0          128                    0.0.0.0:22                  0.0.0.0:*  <br><br><br>[root@openvpn-server ~]# cat /var/log/openvpn/openvpn<br>cat: /var/log/openvpn/openvpn: No such file or directory<br>[root@openvpn-server ~]# cat /var/log/openvpn/openvpn.log <br>Mon Sep  4 20:58:44 2023 OpenVPN 2.4.12 x86_64-redhat-linux-gnu [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on Mar 17 2022<br>Mon Sep  4 20:58:44 2023 library versions: OpenSSL 1.1.1k  FIPS 25 Mar 2021, LZO 2.08<br>Mon Sep  4 20:58:44 2023 WARNING: you are using user/group/chroot/setcon without persist-tun -- this may cause restarts to fail<br>Mon Sep  4 20:58:44 2023 WARNING: you are using user/group/chroot/setcon without persist-key -- this may cause restarts to fail<br>Mon Sep  4 20:58:44 2023 Diffie-Hellman initialized with 2048 bit key<br>Mon Sep  4 20:58:44 2023 ROUTE_GATEWAY 172.30.0.253/255.255.255.0 IFACE=eth0 HWADDR=00:16:3e:10:1c:c0<br>Mon Sep  4 20:58:44 2023 TUN/TAP device tun0 opened<br>Mon Sep  4 20:58:44 2023 TUN/TAP TX queue length set to 100<br>Mon Sep  4 20:58:44 2023 /sbin/ip link set dev tun0 up mtu 1500<br>Mon Sep  4 20:58:44 2023 /sbin/ip addr add dev tun0 local 10.8.0.1 peer 10.8.0.2<br>Mon Sep  4 20:58:44 2023 /sbin/ip route add 10.8.0.0/24 via 10.8.0.2<br>Mon Sep  4 20:58:44 2023 Could not determine IPv4/IPv6 protocol. Using AF_INET<br>Mon Sep  4 20:58:44 2023 Socket Buffers: R=[87380-&gt;87380] S=[16384-&gt;16384]<br>Mon Sep  4 20:58:44 2023 Listening for incoming TCP connection on [AF_INET][undef]:1194<br>Mon Sep  4 20:58:44 2023 TCPv4_SERVER link local (bound): [AF_INET][undef]:1194<br>Mon Sep  4 20:58:44 2023 TCPv4_SERVER link remote: [AF_UNSPEC]<br>Mon Sep  4 20:58:44 2023 GID set to openvpn<br>Mon Sep  4 20:58:44 2023 UID set to openvpn<br>Mon Sep  4 20:58:44 2023 MULTI: multi_init called, r=256 v=256<br>Mon Sep  4 20:58:44 2023 IFCONFIG POOL: base=10.8.0.4 size=62, ipv6=0<br>Mon Sep  4 20:58:44 2023 MULTI: TCP INIT maxclients=2048 maxevents=2052<br>Mon Sep  4 20:58:44 2023 Initialization Sequence Completed<br><br><br>[root@openvpn-server ~]# ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:16:3e:10:1c:c0 brd ff:ff:ff:ff:ff:ff<br>    inet 172.30.0.228/24 brd 172.30.0.255 scope global dynamic noprefixroute eth0<br>       valid_lft 315342050sec preferred_lft 315342050sec<br>    inet6 fe80::216:3eff:fe10:1cc0/64 scope link <br>       valid_lft forever preferred_lft forever<br>3: tun0: &lt;POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UNKNOWN group default qlen 100<br>    link/none <br>    inet 10.8.0.1 peer 10.8.0.2/32 scope global tun0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::721f:1358:937e:8c14/64 scope link stable-privacy <br>       valid_lft forever preferred_lft forever<br><br>[root@openvpn-server ~]# route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         172.30.0.253    0.0.0.0         UG    100    0        0 eth0<br>10.8.0.0        10.8.0.2        255.255.255.0   UG    0      0        0 tun0<br>10.8.0.2        0.0.0.0         255.255.255.255 UH    0      0        0 tun0<br>172.30.0.0      0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证tun网卡设备：</span><br>[root@openvpn-server ~]# ifconfig tun0<br>tun0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500<br>        inet 10.8.0.1  netmask 255.255.255.255  destination 10.8.0.2<br>        inet6 fe80::721f:1358:937e:8c14  prefixlen 64  scopeid 0x20&lt;link&gt;<br>        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 100  (UNSPEC)<br>        RX packets 0  bytes 0 (0.0 B)<br>        RX errors 0  dropped 0  overruns 0  frame 0<br>        TX packets 7  bytes 336 (336.0 B)<br>        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0<br><br></code></pre></td></tr></table></figure>

<h2 id="6-6-准备OpenVPN客户端配置文件"><a href="#6-6-准备OpenVPN客户端配置文件" class="headerlink" title="6.6 准备OpenVPN客户端配置文件"></a>6.6 准备OpenVPN客户端配置文件</h2><h3 id="6-6-1-客户端默认范例配置文件说明"><a href="#6-6-1-客户端默认范例配置文件说明" class="headerlink" title="6.6.1 客户端默认范例配置文件说明"></a>6.6.1 客户端默认范例配置文件说明</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server ~]# grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn/sample/sample-config-files/client.conf <br>client		#指明客户端<br>dev tun		#指定和服务端一致的接口类型<br>proto udp	#指定和服务端一致的协议类型<br>remote my-server-1 1194	#服务器端的ip或FQDN及端口<br>resolv-retry infinite	#指定服务器端FQDN而非IP时，当客户端重新连接后会重新解FQDN对应的IP<br>nobind	#客户端不绑定监听端口，随机打开端口连接到服务端的端口<br>persist-key<br>persist-tun<br>ca ca.crt<br>cert client.crt<br>key client.key<br>remote-cert-tls server	#使用服务器证书校验方式<br>tls-auth ta.key 1		#安全加强<br>cipher AES-256-CBC<br>verb 3<br><br></code></pre></td></tr></table></figure>

<h3 id="6-6-2-生成客户端用户的配置文件"><a href="#6-6-2-生成客户端用户的配置文件" class="headerlink" title="6.6.2 生成客户端用户的配置文件"></a>6.6.2 生成客户端用户的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">生成客户端用户的配置文件，文件后缀必须为.ovpn</span><br>[root@openvpn-server ~]# grep &#x27;^[[:alpha:]].*&#x27; /usr/share/doc/openvpn/sample/sample-config-files/client.conf &gt; /etc/openvpn/client/xiaohexie/client.ovpn<br>[root@openvpn-server ~]# vim /etc/openvpn/client/xiaohexie/client.ovpn <br>[root@openvpn-server ~]# cat  /etc/openvpn/client/xiaohexie/client.ovpn <br>client<br>dev tun<br>proto tcp<br>remote 47.92.6.54 1194	#生产中为OpenVPN公网IP或者FQDN<br>resolv-retry infinite<br>nobind<br><span class="hljs-meta prompt_">#</span><span class="language-bash">persist-key</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">persist-tun</span><br>ca ca.crt<br>cert xiaohexie.crt<br>key xiaohexie.key<br>remote-cert-tls server<br><span class="hljs-meta prompt_">#</span><span class="language-bash">tls-auth ta.key 1</span><br>cipher AES-256-CBC<br>verb 3		<br>compress lz4-v2	#压缩模式，需要与服务端保持一致，默认使用comp-lz压缩<br><br><br></code></pre></td></tr></table></figure>

<h2 id="6-7-实现OpenVPN客户端"><a href="#6-7-实现OpenVPN客户端" class="headerlink" title="6.7 实现OpenVPN客户端"></a>6.7 实现OpenVPN客户端</h2><h3 id="6-7-1-Windows配置部署OpenVPN客户端"><a href="#6-7-1-Windows配置部署OpenVPN客户端" class="headerlink" title="6.7.1 Windows配置部署OpenVPN客户端"></a>6.7.1 Windows配置部署OpenVPN客户端</h3><h3 id="6-7-1-1Windows安装OpenVPN客户端"><a href="#6-7-1-1Windows安装OpenVPN客户端" class="headerlink" title="6.7.1.1Windows安装OpenVPN客户端"></a>6.7.1.1Windows安装OpenVPN客户端</h3><p>官方客户端下载地址：</p>
<p><a target="_blank" rel="noopener" href="https://openvpn.net/community-downloads/">https://openvpn.net/community-downloads/</a></p>
<p><img src="image-20230904212604430.png" srcset="/img/loading.gif" lazyload alt="image-20230904212604430"></p>
<p><img src="image-20230904212455979.png" srcset="/img/loading.gif" lazyload alt="image-20230904212455979"></p>
<h4 id="6-7-1-2-Windows客户端配置准备"><a href="#6-7-1-2-Windows客户端配置准备" class="headerlink" title="6.7.1.2 Windows客户端配置准备"></a>6.7.1.2 Windows客户端配置准备</h4><p>保持证书到openvpn客户端安装目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在服务器打包证书并下载发送给Windows客户端</span><br>[root@openvpn-server ~]# cd /etc/openvpn/client/xiaohexie/<br>[root@openvpn-server xiaohexie]# ls<br>ca.crt  client.ovpn  xiaohexie.crt  xiaohexie.key<br>[root@openvpn-server xiaohexie]# tar cf xiaohexie.tar ./<br>tar: ./xiaohexie.tar: file is the archive; not dumped<br>[root@openvpn-server xiaohexie]# ls<br>ca.crt  client.ovpn  xiaohexie.crt  xiaohexie.key  xiaohexie.tar<br></code></pre></td></tr></table></figure>

<p>放到Windows客户端默认安装目录下C:\Program Files\OpenVPN\config目录</p>
<p><img src="image-20230904221013868.png" srcset="/img/loading.gif" lazyload alt="image-20230904221013868"></p>
<h4 id="6-7-1-3-Windows客户端运行openVPN客户端进行连接"><a href="#6-7-1-3-Windows客户端运行openVPN客户端进行连接" class="headerlink" title="6.7.1.3 Windows客户端运行openVPN客户端进行连接"></a>6.7.1.3 Windows客户端运行openVPN客户端进行连接</h4><p><img src="image-20230904221143994.png" srcset="/img/loading.gif" lazyload alt="image-20230904221143994"></p>
<h4 id="6-7-1-4Windows客户端验证通信"><a href="#6-7-1-4Windows客户端验证通信" class="headerlink" title="6.7.1.4Windows客户端验证通信"></a>6.7.1.4Windows客户端验证通信</h4><h5 id="6-7-1-4-1Windows客户端测试访问OpenVPN服务器"><a href="#6-7-1-4-1Windows客户端测试访问OpenVPN服务器" class="headerlink" title="6.7.1.4.1Windows客户端测试访问OpenVPN服务器"></a>6.7.1.4.1Windows客户端测试访问OpenVPN服务器</h5><p>Windows服务器到到OpenVPN服务器的连接：</p>
<p><img src="image-20230904221315766.png" srcset="/img/loading.gif" lazyload alt="image-20230904221315766"></p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@openvpn</span>-server xiaohexie]<span class="hljs-meta"># echo net.ipv4.ip_forword = 1 &gt;&gt; /etc/sysctl.conf </span><br>[root<span class="hljs-symbol">@openvpn</span>-server xiaohexie]<span class="hljs-meta"># sysctl -p</span><br></code></pre></td></tr></table></figure>



<h5 id="6-7-1-4-2-观察OpenVPN服务器日志"><a href="#6-7-1-4-2-观察OpenVPN服务器日志" class="headerlink" title="6.7.1.4.2 观察OpenVPN服务器日志"></a>6.7.1.4.2 观察OpenVPN服务器日志</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server xiaohexie]# tail -f /var/log/openvpn/openvpn.log <br>Mon Sep  4 21:29:00 2023 182.150.134.136:21440 Control Channel: TLSv1.3, cipher TLSv1.3 TLS_AES_256_GCM_SHA384, 2048 bit RSA<br>Mon Sep  4 21:29:00 2023 182.150.134.136:21440 [xiaohexie] Peer Connection Initiated with [AF_INET]182.150.134.136:21440<br>Mon Sep  4 21:29:00 2023 xiaohexie/182.150.134.136:21440 MULTI_sva: pool returned IPv4=10.8.0.6, IPv6=(Not enabled)<br>Mon Sep  4 21:29:00 2023 xiaohexie/182.150.134.136:21440 MULTI: Learn: 10.8.0.6 -&gt; xiaohexie/182.150.134.136:21440<br>Mon Sep  4 21:29:00 2023 xiaohexie/182.150.134.136:21440 MULTI: primary virtual IP for xiaohexie/182.150.134.136:21440: 10.8.0.6<br>Mon Sep  4 21:29:01 2023 xiaohexie/182.150.134.136:21440 PUSH: Received control message: &#x27;PUSH_REQUEST&#x27;<br>Mon Sep  4 21:29:01 2023 xiaohexie/182.150.134.136:21440 SENT CONTROL [xiaohexie]: &#x27;PUSH_REPLY,route 172.30.0.0 255.255.255.0,compress lz4-v2,route 10.8.0.1,topology net30,ping 10,ping-restart 120,ifconfig 10.8.0.6 10.8.0.5,peer-id 0,cipher AES-256-GCM&#x27; (status=1)<br>Mon Sep  4 21:29:01 2023 xiaohexie/182.150.134.136:21440 Data Channel: using negotiated cipher &#x27;AES-256-GCM&#x27;<br>Mon Sep  4 21:29:01 2023 xiaohexie/182.150.134.136:21440 Outgoing Data Channel: Cipher &#x27;AES-256-GCM&#x27; initialized with 256 bit key<br>Mon Sep  4 21:29:01 2023 xiaohexie/182.150.134.136:21440 Incoming Data Channel: Cipher &#x27;AES-256-GCM&#x27; initialized with 256 bit key<br><br><br>[root@openvpn-server xiaohexie]# cat /var/log/openvpn/openvpn-status.log <br>OpenVPN CLIENT LIST<br>Updated,Mon Sep  4 22:19:40 2023<br>Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since<br>xiaohexie,182.150.134.136:21440,117932,57841,Mon Sep  4 21:28:58 2023<br>ROUTING TABLE<br>Virtual Address,Common Name,Real Address,Last Ref<br>10.8.0.6,xiaohexie,182.150.134.136:21440,Mon Sep  4 22:16:49 2023<br>GLOBAL STATS<br>Max bcast/mcast queue length,1<br>END<br><br></code></pre></td></tr></table></figure>

<h5 id="6-7-1-4-3-验证OpenVPN服务器连接状态"><a href="#6-7-1-4-3-验证OpenVPN服务器连接状态" class="headerlink" title="6.7.1.4.3 验证OpenVPN服务器连接状态"></a>6.7.1.4.3 验证OpenVPN服务器连接状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@openvpn-server xiaohexie]# ss -nt<br>State        Recv-Q        Send-Q                 Local Address:Port                     Peer Address:Port         Process        <br>ESTAB        0             0                       172.30.0.228:1194                  182.150.134.136:21440                       <br>ESTAB        0             0                       172.30.0.228:22                    182.150.134.136:21378                       <br>ESTAB        0             52                      172.30.0.228:22                    182.150.134.136:21312                       <br>ESTAB        0             0                       172.30.0.228:22                    182.150.134.136:22848                       <br>ESTAB        0             0                       172.30.0.228:36690                    172.30.0.230:22                          <br>ESTAB        0             0                       172.30.0.228:55192                    172.30.0.229:22                          <br>ESTAB        0             0                       172.30.0.228:45160                   100.100.30.25:80    <br></code></pre></td></tr></table></figure>

<h5 id="6-7-1-4-4-验证Windows客户端的IP状态"><a href="#6-7-1-4-4-验证Windows客户端的IP状态" class="headerlink" title="6.7.1.4.4 验证Windows客户端的IP状态"></a>6.7.1.4.4 验证Windows客户端的IP状态</h5><p><img src="image-20230904222355073.png" srcset="/img/loading.gif" lazyload alt="image-20230904222355073"></p>
<h5 id="6-7-1-4-5验证Windows客户端的路由表"><a href="#6-7-1-4-5验证Windows客户端的路由表" class="headerlink" title="6.7.1.4.5验证Windows客户端的路由表"></a>6.7.1.4.5验证Windows客户端的路由表</h5><p><img src="image-20230904222532863.png" srcset="/img/loading.gif" lazyload alt="image-20230904222532863"></p>
<h2 id="6-8-实现访问VPN服务器内网主机"><a href="#6-8-实现访问VPN服务器内网主机" class="headerlink" title="6.8 实现访问VPN服务器内网主机"></a>6.8 实现访问VPN服务器内网主机</h2><h3 id="6-8-1-OpenVPN服务器打开ip-forward功能"><a href="#6-8-1-OpenVPN服务器打开ip-forward功能" class="headerlink" title="6.8.1 OpenVPN服务器打开ip_forward功能"></a>6.8.1 OpenVPN服务器打开ip_forward功能</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在服务器开启ip_forward转发功能</span><br>[root@openvpn-server xiaohexie]# echo net.ipv4.ip_forward=1 &gt;&gt; /etc/sysctl.conf<br>[root@openvpn-server xiaohexie]# /etc/sysctl.conf<br>-bash: /etc/sysctl.conf: Permission denied<br>[root@openvpn-server xiaohexie]# sysctl -p<br>vm.swappiness = 0<br>kernel.sysrq = 1<br>net.ipv4.neigh.default.gc_stale_time = 120<br>net.ipv4.conf.all.rp_filter = 0<br>net.ipv4.conf.default.rp_filter = 0<br>net.ipv4.conf.default.arp_announce = 2<br>net.ipv4.conf.lo.arp_announce = 2<br>net.ipv4.conf.all.arp_announce = 2<br>net.ipv4.tcp_max_tw_buckets = 5000<br>net.ipv4.tcp_syncookies = 1<br>net.ipv4.tcp_max_syn_backlog = 1024<br>net.ipv4.tcp_synack_retries = 2<br>net.ipv4.tcp_slow_start_after_idle = 0<br>net.ipv4.ip_forward = 1<br><br></code></pre></td></tr></table></figure>



<h3 id="6-8-2-配置实现内网服务器回应外网的请求的路由"><a href="#6-8-2-配置实现内网服务器回应外网的请求的路由" class="headerlink" title="6.8.2 配置实现内网服务器回应外网的请求的路由"></a>6.8.2 配置实现内网服务器回应外网的请求的路由</h3><h4 id="6-8-2-1-在每个主机上添加路由"><a href="#6-8-2-1-在每个主机上添加路由" class="headerlink" title="6.8.2.1 在每个主机上添加路由"></a>6.8.2.1 在每个主机上添加路由</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">阿里云服务器不支持修改路由</span><br>[root@web-server ~]# route add -net 10.8.0.0/24 gw 172.30.0.228<br></code></pre></td></tr></table></figure>

<h4 id="6-8-2-2-在OpenVPN服务器上配置IPtables规则"><a href="#6-8-2-2-在OpenVPN服务器上配置IPtables规则" class="headerlink" title="6.8.2.2 在OpenVPN服务器上配置IPtables规则"></a>6.8.2.2 在OpenVPN服务器上配置IPtables规则</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">添加SNAT规则</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash">[root@openvpn-server xiaohexie]<span class="hljs-comment"># iptables -t nat -A POSTROUTING -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to 172.30.0.228</span></span><br><br>[root@openvpn-server xiaohexie]# iptables -vnL -t nat<br>Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain INPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br><br>Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination         <br>    0     0 SNAT       all  --  *      *       10.8.0.0/24         !10.8.0.0/24          to:172.30.0.228<br><br>Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)<br> pkts bytes target     prot opt in     out     source               destination       <br></code></pre></td></tr></table></figure>

<h4 id="6-8-2-3-测试-VPN访问内网主机"><a href="#6-8-2-3-测试-VPN访问内网主机" class="headerlink" title="6.8.2.3 测试 VPN访问内网主机"></a>6.8.2.3 测试 VPN访问内网主机</h4><p><img src="image-20230904223446322.png" srcset="/img/loading.gif" lazyload alt="image-20230904223446322"></p>
<p><img src="image-20230904223734992.png" srcset="/img/loading.gif" lazyload alt="image-20230904223734992"></p>
<h1 id="7-mysql如何实现崩溃后恢复？"><a href="#7-mysql如何实现崩溃后恢复？" class="headerlink" title="7.mysql如何实现崩溃后恢复？"></a>7.mysql如何实现崩溃后恢复？</h1><p>1、如果有从节点，可以将从节点提升为主节点</p>
<p>2、可以通过备份数据和二进制日志在新建的数据库上恢复</p>
<h1 id="8-myisam和innodb各自在什么场景使用？"><a href="#8-myisam和innodb各自在什么场景使用？" class="headerlink" title="8.myisam和innodb各自在什么场景使用？"></a>8.myisam和innodb各自在什么场景使用？</h1><h2 id="8-1-myisam存储引擎"><a href="#8-1-myisam存储引擎" class="headerlink" title="8.1 myisam存储引擎"></a>8.1 myisam存储引擎</h2><p><strong>myisam存储引擎特点：</strong></p>
<ul>
<li>不支持事务</li>
<li>表级锁定</li>
<li>读写相互阻塞，写入时不能读，读时不能写</li>
<li>只缓存索引</li>
<li>不支持外键约束</li>
<li>不支持聚簇索引</li>
<li>读取数据较快，占用资源较少</li>
<li>不支持MVCC（多版本并发控制机制）高并发</li>
<li>崩溃恢复性较差</li>
<li>MySQL5.5.5前默认的数据库引擎</li>
</ul>
<p><strong>myisam存储引擎适用场景：</strong></p>
<ul>
<li>只读（或者写较少）</li>
<li>表较小（可以接受长时间进行修复操作）</li>
</ul>
<h2 id="8-2-innodb存储引擎"><a href="#8-2-innodb存储引擎" class="headerlink" title="8.2 innodb存储引擎"></a>8.2 innodb存储引擎</h2><p><strong>innodb存储引擎特点：</strong></p>
<ul>
<li>行级锁</li>
<li>支持事务，适合处理大量短期事务</li>
<li>读写阻塞与事务隔离级别相关</li>
<li>可缓存数据和索引</li>
<li>支持聚簇索引</li>
<li>崩溃恢复性更好</li>
<li>支持MVCC高并发</li>
<li>从MySQL5.5后支持全文索引</li>
<li>从MySQL5.5开始为默认的数据库引擎</li>
</ul>
<p><strong>innodb存储引擎适用场景：</strong></p>
<ul>
<li><p>高并发性</p>
</li>
<li><p>有事务处理需求</p>
</li>
<li><p>对数据完整性和可靠性要求较高</p>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/09/11/%E7%AC%AC%E4%B8%83%E5%91%A8%E4%BD%9C%E4%B8%9A/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第七周作业</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/08/23/14-%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9Fdns%E8%A7%A3%E6%9E%90%E6%9C%8D%E5%8A%A1/">
                        <span class="hidden-mobile">14.域名系统dns解析服务</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
