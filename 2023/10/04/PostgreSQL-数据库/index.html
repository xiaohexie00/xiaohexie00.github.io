

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="PostgeSQL 数据库*[TOC]  1 PostgreSQL 介绍和特性1.1 PostgreSQL 介绍PostgreSQL是当前功能最强大的开源的关系型数据库系统，支持跨平台的多种操作系统，基于C语言开发。通常简称为PG或PGSQL。 PostgreSQL宣称是世界上最先进的开源数据库。PostgreSQL的狂热者认为它的性能缺Oracle不分上下，而且没有高成本的负担。 Postgre">
<meta property="og:type" content="article">
<meta property="og:title" content="PostgreSQL 数据库">
<meta property="og:url" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/index.html">
<meta property="og:site_name" content="5-12 23:30">
<meta property="og:description" content="PostgeSQL 数据库*[TOC]  1 PostgreSQL 介绍和特性1.1 PostgreSQL 介绍PostgreSQL是当前功能最强大的开源的关系型数据库系统，支持跨平台的多种操作系统，基于C语言开发。通常简称为PG或PGSQL。 PostgreSQL宣称是世界上最先进的开源数据库。PostgreSQL的狂热者认为它的性能缺Oracle不分上下，而且没有高成本的负担。 Postgre">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915162934970.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915163427723.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915163612123.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915163912418.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915164949794.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915165253502.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915170109653.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915170144794.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915172334940.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915172716961.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230916175616026.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928215842789.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928220535120.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928222624337.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928222451914.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928222852782.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928223010570.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928224114461.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928225410387.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928225531109.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928225841837.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230928230020677.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20231002221940237.png">
<meta property="og:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20231002222230041.png">
<meta property="article:published_time" content="2023-10-04T00:54:47.000Z">
<meta property="article:modified_time" content="2023-11-21T13:07:39.225Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/image-20230915162934970.png">
  
  
  <title>PostgreSQL 数据库 - 5-12 23:30</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="PostgreSQL 数据库">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-10-04 00:54" pubdate>
        October 4, 2023 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      131k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      1089 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">PostgreSQL 数据库</h1>
            
            <div class="markdown-body">
              <h1 id="PostgeSQL-数据库"><a href="#PostgeSQL-数据库" class="headerlink" title="PostgeSQL 数据库*"></a><em><strong>PostgeSQL 数据库</strong></em>*</h1><p>[TOC]</p>
<hr>
<h1 id="1-PostgreSQL-介绍和特性"><a href="#1-PostgreSQL-介绍和特性" class="headerlink" title="1 PostgreSQL 介绍和特性"></a>1 PostgreSQL 介绍和特性</h1><h2 id="1-1-PostgreSQL-介绍"><a href="#1-1-PostgreSQL-介绍" class="headerlink" title="1.1 PostgreSQL 介绍"></a>1.1 PostgreSQL 介绍</h2><p>PostgreSQL是当前功能最强大的开源的关系型数据库系统，支持跨平台的多种操作系统，基于C语言开发。通常简称为PG或PGSQL。</p>
<p>PostgreSQL宣称是世界上最先进的开源数据库。PostgreSQL的狂热者认为它的性能缺Oracle不分上下，而且没有高成本的负担。</p>
<p>PostgreSQL拥有看悠久的历史，可以追搠到1985年的加州大学伯克利分校的项目POSTGRES，是1977年的由数据库科学家Michael Stonebraker领导的Ingres项目的衍生品，为了专注于数据库理论的研究，在版本4.2时伯克利正式终止了POSTGRES项目。</p>
<p>1994年，来自中国香港的两名伯克利的研究生Andrew Yu和JollyChen向 POSTGRES中增加了现在SQL语言的解释器，将Postgres改名为Postgres95，并将其源代码发布到互联网上，成为一个开源的数据库管理系统。</p>
<p>1996年，Postgres95名称已经不合时宜，被更改为PostgreSQL，表示它支持查询语言标准，同时版本号也重新从6.0开始。自从版本6.0之后，出现了很多后续发行版本。</p>
<p>PostgreSQL是100%社区驱动的开源项自，由全球范围内千人以上的社区责献者共同维护。PostgreSQL提供了一个完整功能的瓶本，而不像MySQL那样提供多个不同的瓶本，如社区版、商业版及企业版。PostgreSQL的开源协议采用自由的BSD,MTT类型，这种开源协议允许任何人在保留版权声明的情况下使用，戛制，修改或者分享代码。</p>
<p>可靠性是PostgreSQL最优先关注的特性。普遍认为PostgreSQL坚如磐石并且设计精密，能够支持事务处理和关键任务应用。PostgreSQL提供一流的文档服务，包括全面的免费在线手册，以及旧版本手册的存档。社区的支持非常出色，并且有独立厂商提供商业支持。</p>
<p>数据一致性和完整性也是PostgeSQL的高度优先事项。PostgreSQL是完全符合ACID原则（原子性、一致性、隔离性，持久性）的数据库：PostgresQL对数据库访问提供强大的安全控制，不仅能够利用企业安全工具，如：Kerberos和OpenSSL等，还可以根据自己的业务规则自定义核对方法，以确保数据的质量。数据库管理员最喜欢的功能是时间点恢复(point-in-time recovery 简称PITR)期能，它具有灵活性，高可用性特征，能够打造快速故障的热备份服务器，以及快照和恢复到特定时间点等。但这还不是全部.该项目提供了很多方法来管理PostgreSQL，使PostgreSQL具有高可用性、负载均衡和同步功能，因此可以利用这些功能来满足特定需求。</p>
<p>官网:<a target="_blank" rel="noopener" href="http://www.postgresql.org/">www.postgresql.org</a></p>
<p>中文社区:<a target="_blank" rel="noopener" href="http://www.postgres.cn/">http://www.postgres.cn</a></p>
<p>中文手册:<a target="_blank" rel="noopener" href="http://www.postgres.cn/docs/12/index.html">http://www.postgres.cn/docs/12/index.html</a></p>
<p>参考网站：</p>
<figure class="highlight http"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs http">https://www.runoob.com/postgresql/postgresql-tutorial.htm1<br>https://www.runoob.com/manual/PostgreSQL/index.htm1<br></code></pre></td></tr></table></figure>

<p>PostgreSQL开源许可（PostgreSQL Licence)</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/about/licence/<br></code></pre></td></tr></table></figure>

<p><img src="image-20230915162934970.png" srcset="/img/loading.gif" lazyload alt="image-20230915162934970"></p>
<p>MySQL开源许可（GPLv2 with exceptions and LGPLv2 and BSD)</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">MySQL&#x27;s soure code is available under terms of the GNU General Public License,which also fits the Free Software and Opensource definitions and conforms to theDebian Free Software Guidelines (but not to the Copyfree Standard). lt is alsoavailable under a proprietary license agreement, which is typically intended foruse by those who wish to release software incorporatin:MysQL code without havingto release the source code for the entire application. In practical terms, thismeans that MysQL can be distributed with or without source code, as canPostgresQL, but to distribute without source code in the case of MysQL requirespaying Oracle for a MySQL Commercial License.<br></code></pre></td></tr></table></figure>

<h2 id="1-2-数据库排名"><a href="#1-2-数据库排名" class="headerlink" title="1.2 数据库排名"></a>1.2 数据库排名</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://db-engines.com/en/ranking<br></code></pre></td></tr></table></figure>

<p><img src="image-20230915163427723.png" srcset="/img/loading.gif" lazyload alt="image-20230915163427723"></p>
<p><img src="image-20230915163612123.png" srcset="/img/loading.gif" lazyload alt="image-20230915163612123"></p>
<p><img src="image-20230915163912418.png" srcset="/img/loading.gif" lazyload alt="image-20230915163912418"></p>
<h2 id="1-3-PostgresQL与-MySQL对比"><a href="#1-3-PostgresQL与-MySQL对比" class="headerlink" title="1.3 PostgresQL与 MySQL对比"></a>1.3 PostgresQL与 MySQL对比</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://bbs.chinaunix.net/thread-1688208-1-1.html<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>特性</th>
<th>MySQL</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody><tr>
<td>实例</td>
<td>通过执行 MySQL 命令（mysqld）启动实例。一个实例可以管理一个或多个数据库。一台服务器可以运行多个 mysqld 实例。一个实例管理器可以监视 mysqld 的各个实例。</td>
<td>通过执行 Postmaster 进程（pg_ctl）启动实例。一个实例可以管理一个或多个数据库，这些数据库组成一个集群。集群是磁盘上的一个区域，这个区域在安装时初始化并由一个目录组成，所有数据都存储在这个目录中。使用 initdb 创建第一个数据库。一台机器上可以启动多个实例。</td>
</tr>
<tr>
<td>数据库</td>
<td>数据库是命名的对象集合，是与实例中的其他数据库分离的实体。一个 MySQL 实例中的所有数据库共享同一个系统编目。</td>
<td>数据库是命名的对象集合，每个数据库是与其他数据库分离的实体。每个数据库有自己的系统编目，但是所有数据库共享 pg_databases。</td>
</tr>
<tr>
<td>数据缓冲区</td>
<td>通过 <strong>innodb_buffer_pool_size</strong> 配置参数设置数据缓冲区。这个参数是内存缓冲区的字节数，InnoDB 使用这个缓冲区来缓存表的数据和索引。在专用的数据库服务器上，这个参数最高可以设置为机器物理内存量的 80%。</td>
<td><strong>Shared_buffers</strong> 缓存。在默认情况下分配 64 个缓冲区。默认的块大小是 8K。可以通过设置 postgresql.conf 文件中的 shared_buffers 参数来更新缓冲区缓存。</td>
</tr>
<tr>
<td>数据库连接</td>
<td>客户机使用 CONNECT 或 USE 语句连接数据库，这时要指定数据库名，还可以指定用户 id 和密码。使用角色管理数据库中的用户和用户组。</td>
<td>客户机使用 connect 语句连接数据库，这时要指定数据库名，还可以指定用户 id 和密码。使用角色管理数据库中的用户和用户组。</td>
</tr>
<tr>
<td>身份验证</td>
<td>MySQL 在数据库级管理身份验证。 基本只支持密码认证。</td>
<td>PostgreSQL 支持丰富的认证方法：信任认证、口令认证、Kerberos 认证、基于 Ident 的认证、LDAP 认证、PAM 认证</td>
</tr>
<tr>
<td>加密</td>
<td>可以在表级指定密码来对数据进行加密。还可以使用 AES_ENCRYPT 和 AES_DECRYPT 函数对列数据进行加密和解密。可以通过 SSL 连接实现网络加密。</td>
<td>可以使用 pgcrypto 库中的函数对列进行加密/解密。可以通过 SSL 连接实现网络加密。</td>
</tr>
<tr>
<td>审计</td>
<td>可以对 querylog 执行 grep。</td>
<td>可以在表上使用 PL/pgSQL 触发器来进行审计。</td>
</tr>
<tr>
<td>查询解释</td>
<td>使用 EXPLAIN 命令查看查询的解释计划。</td>
<td>使用 EXPLAIN 命令查看查询的解释计划。</td>
</tr>
<tr>
<td>备份、恢复和日志</td>
<td>InnoDB 使用写前（write-ahead）日志记录。支持在线和离线完全备份以及崩溃和事务恢复。需要第三方软件才能支持热备份。</td>
<td>在数据目录的一个子目录中维护写前日志。支持在线和离线完全备份以及崩溃、时间点和事务恢复。 可以支持热备份。</td>
</tr>
<tr>
<td>JDBC 驱动程序</td>
<td>可以从 <a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0606khatri/index.html#Resources">参考资料</a> 下载 JDBC 驱动程序。</td>
<td>可以从 <a target="_blank" rel="noopener" href="http://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0606khatri/index.html#Resources">参考资料</a> 下载 JDBC 驱动程序。</td>
</tr>
<tr>
<td>表类型</td>
<td>取决于存储引擎。例如，NDB 存储引擎支持分区表，内存引擎支持内存表。</td>
<td>支持临时表、常规表以及范围和列表类型的分区表。不支持哈希分区表。 由于PostgreSQL的表分区是通过表继承和规则系统完成了，所以可以实现更复杂的分区方式。</td>
</tr>
<tr>
<td>索引类型</td>
<td>取决于存储引擎。MyISAM：BTREE，InnoDB：BTREE。</td>
<td>支持 B-树、哈希、R-树和 Gist 索引。</td>
</tr>
<tr>
<td>约束</td>
<td>支持主键、外键、惟一和非空约束。对检查约束进行解析，但是不强制实施。</td>
<td>支持主键、外键、惟一、非空和检查约束。</td>
</tr>
<tr>
<td>存储过程和用户定义函数</td>
<td>支持 CREATE PROCEDURE 和 CREATE FUNCTION 语句。存储过程可以用 SQL 和 C++ 编写。用户定义函数可以用 SQL、C 和 C++ 编写。</td>
<td>没有单独的存储过程，都是通过函数实现的。用户定义函数可以用 PL/pgSQL（专用的过程语言）、PL/Tcl、PL/Perl、PL/Python 、SQL 和 C 编写。</td>
</tr>
<tr>
<td>触发器</td>
<td>支持行前触发器、行后触发器和语句触发器，触发器语句用过程语言复合语句编写。</td>
<td>支持行前触发器、行后触发器和语句触发器，触发器过程用 C 编写。</td>
</tr>
<tr>
<td>系统配置文件</td>
<td>my.conf</td>
<td>Postgresql.conf</td>
</tr>
<tr>
<td>数据库配置</td>
<td>my.conf</td>
<td>Postgresql.conf</td>
</tr>
<tr>
<td>客户机连接文件</td>
<td>my.conf</td>
<td>pg_hba.conf</td>
</tr>
<tr>
<td>XML 支持</td>
<td>有限的 XML 支持。</td>
<td>有限的 XML 支持。</td>
</tr>
<tr>
<td>数据访问和管理服务器</td>
<td><strong>OPTIMIZE TABLE</strong> —— 回收未使用的空间并消除数据文件的碎片 <strong>myisamchk -analyze</strong> —— 更新查询优化器所使用的统计数据（MyISAM 存储引擎） <strong>mysql</strong> —— 命令行工具 <strong>MySQL Administrator</strong> —— 客户机 GUI 工具</td>
<td><strong>Vacuum</strong> —— 回收未使用的空间 <strong>Analyze</strong> —— 更新查询优化器所使用的统计数据 <strong>psql</strong> —— 命令行工具 <strong>pgAdmin</strong> —— 客户机 GUI 工具</td>
</tr>
<tr>
<td>并发控制</td>
<td>支持表级和行级锁。InnoDB 存储引擎支持 READ_COMMITTED、READ_UNCOMMITTED、REPEATABLE_READ 和 SERIALIZABLE。使用 SET TRANSACTION ISOLATION LEVEL 语句在事务级设置隔离级别。</td>
<td>支持表级和行级锁。支持的 ANSI 隔离级别是 Read Committed（默认 —— 能看到查询启动时数据库的快照）和 Serialization（与 Repeatable Read 相似 —— 只能看到在事务启动之前提交的结果）。使用 SET TRANSACTION 语句在事务级设置隔离级别。使用 SET SESSION 在会话级进行设置。</td>
</tr>
</tbody></table>
<p>**MySQL相对于PostgreSQL的劣势：</p>
<p>**</p>
<table>
<thead>
<tr>
<th><strong>MySQL</strong></th>
<th><strong>PostgreSQL</strong></th>
</tr>
</thead>
<tbody><tr>
<td>最重要的引擎InnoDB很早就由Oracle公司控制。目前整个MySQL数据库都由Oracle控制。</td>
<td>BSD协议，没有被大公司垄断。</td>
</tr>
<tr>
<td>对复杂查询的处理较弱，查询优化器不够成熟</td>
<td>很强大的查询优化器，支持很复杂的查询处理。</td>
</tr>
<tr>
<td>只有一种表连接类型:嵌套循环连接(nested-loop),不支持排序-合并连接(sort-merge join)与散列连接(hash join)。</td>
<td>都支持</td>
</tr>
<tr>
<td>性能优化工具与度量信息不足</td>
<td>提供了一些性能视图，可以方便的看到发生在一个表和索引上的select、delete、update、insert统计信息，也可以看到cache命中率。网上有一个开源的pgstatspack工具。</td>
</tr>
<tr>
<td>InnoDB的表和索引都是按相同的方式存储。也就是说表都是索引组织表。这一般要求主键不能太长而且插入时的主键最好是按顺序递增，否则对性能有很大影响。</td>
<td>不存在这个问题。</td>
</tr>
<tr>
<td>大部分查询只能使用表上的单一索引;在某些情况下，会存在使用多个索引的查询,但是查询优化器通常会低估其成本,它们常常比表扫描还要慢。</td>
<td>不存在这个问题</td>
</tr>
<tr>
<td>表增加列，基本上是重建表和索引，会花很长时间。</td>
<td>表增加列，只是在数据字典中增加表定义，不会重建表</td>
</tr>
<tr>
<td>存储过程与触发器的功能有限。可用来编写存储过程、触发器、计划事件以及存储函数的语言功能较弱</td>
<td>除支持pl/pgsql写存储过程，还支持perl、python、Tcl类型的存储过程：pl/perl，pl/python，pl/tcl。 也支持用C语言写存储过程。</td>
</tr>
<tr>
<td>不支持Sequence。</td>
<td>支持</td>
</tr>
<tr>
<td>不支持函数索引，只能在创建基于具体列的索引。 不支持物化视图。</td>
<td>支持函数索引，同时还支持部分数据索引，通过规则系统可以实现物化视图的功能。</td>
</tr>
<tr>
<td>执行计划并不是全局共享的, 仅仅在连接内部是共享的。</td>
<td>执行计划共享</td>
</tr>
<tr>
<td>MySQL支持的SQL语法(ANSI SQL标准)的很小一部分。不支持递归查询、通用表表达式（Oracle的with 语句）或者窗口函数（分析函数）。</td>
<td>都 支持</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>不支持用户自定义类型或域(domain)</th>
<th>支持。</th>
</tr>
</thead>
<tbody><tr>
<td>对于时间、日期、间隔等时间类型没有秒以下级别的存储类型</td>
<td>可以精确到秒以下。</td>
</tr>
<tr>
<td>身份验证功能是完全内置的，不支持操作系统认证、PAM认证，不支持LDAP以及其它类似的外部身份验证功能。</td>
<td>支持OS认证、Kerberos 认证 、Ident 的认证、LDAP 认证、PAM 认证</td>
</tr>
<tr>
<td>不支持database link。有一种叫做Federated的存储引擎可以作为一个中转将查询语句传递到远程服务器的一个表上,不过,它功能很粗糙并且漏洞很多</td>
<td>有dblink，同时还有一个dbi-link的东西，可以连接到oracle和mysql上。</td>
</tr>
<tr>
<td>Mysql Cluster可能与你的想象有较大差异。开源的cluster软件较少。 复制(Replication)功能是异步的,并且有很大的局限性.例如,它是单线程的(single-threaded),因此一个处理能力更强的Slave的恢复速度也很难跟上处理能力相对较慢的Master.</td>
<td>有丰富的开源cluster软件支持。</td>
</tr>
<tr>
<td>explain看执行计划的结果简单。</td>
<td>explain返回丰富的信息。</td>
</tr>
<tr>
<td>类似于ALTER TABLE或CREATE TABLE一类的操作都是非事务性的.它们会提交未提交的事务，并且不能回滚也不能做灾难恢复</td>
<td>DDL也是有事务的。</td>
</tr>
</tbody></table>
<p>PostgreSQL主要优势：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs http">　　1. PostgreSQL完全免费，而且是BSD协议，如果你把PostgreSQL改一改，然后再拿去卖钱，也没有人管你，这一点很重要，这表明了PostgreSQL数据库不会被其它公司控制。oracle数据库不用说了，是商业数据库，不开放。而MySQL数据库虽然是开源的，但现在随着SUN被oracle公司收购，现在基本上被oracle公司控制，其实在SUN被收购之前，MySQL中最重要的InnoDB引擎也是被oracle公司控制的，而在MySQL中很多重要的数据都是放在InnoDB引擎中的，反正我们公司都是这样的。所以如果MySQL的市场范围与oracle数据库的市场范围冲突时，oracle公司必定会牺牲MySQL，这是毫无疑问的。<br>　　2. 与PostgreSQl配合的开源软件很多，有很多分布式集群软件，如pgpool、pgcluster、slony、plploxy等等，很容易做读写分离、负载均衡、数据水平拆分等方案，而这在MySQL下则比较困难。<br>3. PostgreSQL源代码写的很清晰，易读性比MySQL强太多了，怀疑MySQL的源代码被混淆过。所以很多公司都是基本PostgreSQL做二次开发的。<br>4. PostgreSQL在很多方面都比MySQL强，如复杂SQL的执行、存储过程、触发器、索引。同时PostgreSQL是多进程的，而MySQL是线程的，虽然并发不高时，MySQL处理速度快，但当并发高的时候，对于现在多核的单台机器上，MySQL的总体处理性能不如PostgreSQL，原因是MySQL的线程无法充分利用CPU的能力。<br></code></pre></td></tr></table></figure>

<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://blog.csdn.net/dqcfkyqdxym3f8rb0/article/details/121804125<br></code></pre></td></tr></table></figure>

<p><img src="image-20230915164949794.png" srcset="/img/loading.gif" lazyload alt="image-20230915164949794"></p>
<h2 id="1-4各种数据库性能比较"><a href="#1-4各种数据库性能比较" class="headerlink" title="1.4各种数据库性能比较"></a>1.4各种数据库性能比较</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://github.com/digoal<br></code></pre></td></tr></table></figure>

<p><img src="image-20230915165253502.png" srcset="/img/loading.gif" lazyload alt="image-20230915165253502"></p>
<h2 id="1-5-PostgreSQL各版本的特性矩阵"><a href="#1-5-PostgreSQL各版本的特性矩阵" class="headerlink" title="1.5 PostgreSQL各版本的特性矩阵"></a>1.5 PostgreSQL各版本的特性矩阵</h2><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/about/featurematrix/<br></code></pre></td></tr></table></figure>

<p><img src="image-20230915170109653.png" srcset="/img/loading.gif" lazyload alt="image-20230915170109653"></p>
<p><img src="image-20230915170144794.png" srcset="/img/loading.gif" lazyload alt="image-20230915170144794"></p>
<p><strong>PostgreSQL的优势</strong></p>
<ul>
<li>PostgreSQL数据库是目前功能最强大的开源数据库，它是最接近工业标准SQL92的查询语言，并且正在实现新的功能以兼容最新的SQL标准SQL2003。</li>
<li>稳定可靠：PostgreSQL是唯一能做到数据零丢失的开源数据库。有报道称国外的部分银行也在使用PostgreSQL数据库。</li>
<li>开源免费：PostgreSQL数据库是开源的、免费的，而且是BSD协议，在使用和二次开发上基本没有限制。</li>
<li>支持广泛：PostgreSQL数据库支持大量的主流开发语言，包括C、C++、Perl、Python、Java、Tcl,PHP等。</li>
<li>PostgreSQL社区活跃：PostgreSQL基本上每三个月推出一个补丁版本，这意味着已知的BUG很快会被修复，有应用场景的需求也会及时得到响应。</li>
</ul>
<h1 id="2-PostgreSQL安装"><a href="#2-PostgreSQL安装" class="headerlink" title="2 PostgreSQL安装"></a>2 PostgreSQL安装</h1><p>安装方法分为两种：</p>
<ul>
<li><p>二进制安装包进行安装</p>
<p>各个Linux的发行版本中，很多都内置了PostgreSQL的二进制安装包，但内置的版本可能较旧。对于二进制包安装的方法是通过不同发行版本的Linux下的包管理器进行的，如在RHEL系统相关版本下用yum 命令，在Debian或Ubuntu下使用apt命令</p>
</li>
<li><p>源码编译安装</p>
<p>使用源码编译安装相对更灵活，用户可以有更多的选择，可以选择较新的版本、配置不同的编译选项,编译出用户需要的功能。</p>
</li>
</ul>
<p>官方安装文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/download/<br></code></pre></td></tr></table></figure>

<p><img src="image-20230915172334940.png" srcset="/img/loading.gif" lazyload alt="image-20230915172334940"></p>
<h2 id="2-1-二进制包安装"><a href="#2-1-二进制包安装" class="headerlink" title="2.1 二进制包安装"></a>2.1 二进制包安装</h2><p>PostgreSQL支持各种操作系统，并提供相关二进制包包的安装方法</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/download/linux/redhat/<br>https://www.postgresql.org/download/linux/ubuntu/<br></code></pre></td></tr></table></figure>

<h3 id="2-1-1-RHEL-CentOS-Rocky安装PostgreSQL"><a href="#2-1-1-RHEL-CentOS-Rocky安装PostgreSQL" class="headerlink" title="2.1.1 RHEL/CentOS/Rocky安装PostgreSQL"></a>2.1.1 RHEL/CentOS/Rocky安装PostgreSQL</h3><p><img src="image-20230915172716961.png" srcset="/img/loading.gif" lazyload alt="image-20230915172716961"></p>
<p>范例：Rocky8利用官方源安装PostgreSQL12</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell">[20:12:15 root@rocky8 ~]#sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">禁用内置的postgresq1</span><br>[20:14:26 root@rocky8 ~]#dnf -qy module disable postgresql<br>[20:17:43 root@rocky8 ~]#dnf install -y postgresql12-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化数据库</span><br>[20:17:43 root@rocky8 ~]#/usr/pgsql-12/bin/postgresql-12-setup initdb<br>[20:17:43 root@rocky8 ~]#systemctl enable --now   postgresql-12 <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证成功</span><br>[20:19:23 root@rocky8 ~]#sudo -u postgres psql -c &quot;select version();&quot;<br>could not change directory to &quot;/root&quot;: Permission denied<br>                                                 version                                                  <br>----------------------------------------------------------------------------------------------------------<br> PostgreSQL 12.16 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18), 64-bit<br>(1 row)<br><br>[20:21:17 root@rocky8 ~]#su - postgres<br>[20:21:50 postgres@rocky8 ~]$psql<br>psql (12.16)<br>Type &quot;help&quot; for help.<br><br>postgres=# help<br>You are using psql, the command-line interface to PostgreSQL.<br>Type:  \copyright for distribution terms<br>       \h for help with SQL commands<br>       \? for help with psql commands<br>       \g or terminate with semicolon to execute query<br>       \q to quit<br>postgres=# <br><br><br></code></pre></td></tr></table></figure>

<p>范例：Rocky8利用官方源安装PostgreSQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs shell">[20:24:59 root@rocky8 ~]#yum install -y postgresql-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">默认无法启动</span><br>[20:26:45 root@rocky8 ~]#systemctl start postgresql<br>Job for postgresql.service failed because the control process exited with error code.<br>See &quot;systemctl status postgresql.service&quot; and &quot;journalctl -xe&quot; for details.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看日志提示初始化</span><br>[20:27:14 root@rocky8 ~]#tail /var/log/messages<br>Sep 15 20:26:45 Master-DNS systemd[1]: Started man-db-cache-update.service.<br>Sep 15 20:26:45 Master-DNS systemd[1]: run-rabcb67bb52ac458d8ea95e6aa2faae32.service: Succeeded.<br>Sep 15 20:27:14 Master-DNS systemd[1]: Starting PostgreSQL database server...<br>Sep 15 20:27:14 Master-DNS postgresql-check-db-dir[3679]: Directory &quot;/var/lib/pgsql/data&quot; is missing or empty.<br>Sep 15 20:27:14 Master-DNS postgresql-check-db-dir[3679]: Use &quot;/usr/bin/postgresql-setup --initdb&quot;<br>Sep 15 20:27:14 Master-DNS postgresql-check-db-dir[3679]: to initialize the database cluster.<br>Sep 15 20:27:14 Master-DNS postgresql-check-db-dir[3679]: See /usr/share/doc/postgresql/README.rpm-dist for more information.<br>Sep 15 20:27:14 Master-DNS systemd[1]: postgresql.service: Control process exited, code=exited status=1<br>Sep 15 20:27:14 Master-DNS systemd[1]: postgresql.service: Failed with result &#x27;exit-code&#x27;.<br>Sep 15 20:27:14 Master-DNS systemd[1]: Failed to start PostgreSQL database server.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化数据库</span><br>[20:27:47 root@rocky8 ~]#ls /var/lib/pgsql/data/<br>[20:28:39 root@rocky8 ~]#/usr/bin/postgresql-setup --initdb<br> * Initializing database in &#x27;/var/lib/pgsql/data&#x27;<br> * Initialized, logs are in /var/lib/pgsql/initdb_postgresql.log<br>[20:28:47 root@rocky8 ~]#ls /var/lib/pgsql/data/<br>base    pg_commit_ts  pg_ident.conf  pg_notify    pg_snapshots  pg_subtrans  PG_VERSION  postgresql.auto.conf<br>global  pg_dynshmem   pg_logical     pg_replslot  pg_stat       pg_tblspc    pg_wal      postgresql.conf<br>log     pg_hba.conf   pg_multixact   pg_serial    pg_stat_tmp   pg_twophase  pg_xact<br><br><br>[20:28:53 root@rocky8 ~]#systemctl enable --now postgresql<br>Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service → /usr/lib/systemd/system/postgresql.service.<br>[20:29:49 root@rocky8 ~]#su - postgres<br>[20:29:59 postgres@rocky8 ~]$psql<br>psql (10.23)<br>Type &quot;help&quot; for help.<br><br>postgres=# <br><br></code></pre></td></tr></table></figure>

<h3 id="2-1-2-Ubuntu-安装PostgreSQL"><a href="#2-1-2-Ubuntu-安装PostgreSQL" class="headerlink" title="2.1.2  Ubuntu 安装PostgreSQL"></a>2.1.2  Ubuntu 安装PostgreSQL</h3><p>范例：Ubuntu利用官方源安装PostgreSQL-12</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu:~# sh -c &#x27;echo &quot;deb https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg mai              n&quot; &gt; /etc/apt/sources.list.d/pgdg.list&#x27;<br>root@ubuntu:~# wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key a              dd -<br>root@ubuntu:~# apt-get update<br>root@ubuntu:~# apt-get -y install postgresql-12<br><br><br></code></pre></td></tr></table></figure>

<p>范例：Ubuntu20.04利用系统源安装PostgreSQL-12</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu:~# apt update<br><br>root@ubuntu:~# apt -y install postgresql<br>root@ubuntu:~# su - postgres<br>postgres@ubuntu:~$ psql<br>psql (12.16 (Ubuntu 12.16-0ubuntu0.20.04.1))<br>Type &quot;help&quot; for help.<br><br>postgres=# exit<br></code></pre></td></tr></table></figure>

<h2 id="2-2-源码编译安装"><a href="#2-2-源码编译安装" class="headerlink" title="2.2 源码编译安装"></a>2.2 源码编译安装</h2><h3 id="2-2-1-编译安装过程说明"><a href="#2-2-1-编译安装过程说明" class="headerlink" title="2.2.1 编译安装过程说明"></a>2.2.1 编译安装过程说明</h3><p>官方帮助</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/docs/current/installation.html<br>http://www.postgres.cn/v2/download<br></code></pre></td></tr></table></figure>

<p>第一步：下载源代码</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/ftp/source/<br>https://mirrors.aliyun.com/postgresql/source/<br></code></pre></td></tr></table></figure>

<p>第二步：编译安装。过程与Linux下其他软件的编译安装过程相同</p>
<ul>
<li>./configure</li>
<li>make</li>
<li>make install</li>
</ul>
<p>第三步：编译安装完成后执行如下步骤</p>
<ul>
<li>使用initdb命令初使用化数据库</li>
<li>启动数据库实例</li>
</ul>
<h3 id="2-2-2-系统初始化和优化配置"><a href="#2-2-2-系统初始化和优化配置" class="headerlink" title="2.2.2 系统初始化和优化配置"></a>2.2.2 系统初始化和优化配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭防火墙和SELinux等</span><br>systemctl disable firewalld<br>sed -i &#x27;/^SELINUX=/c SELINUX=Disabled&#x27;  /etc/selinux/config<br><span class="hljs-meta prompt_">#</span><span class="language-bash">内核参数优化</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">vi /etc/sysctl.conf</span><br>kernel.shmmax=68719476736（CentosS6以前版本默认值，CentoS7默认为18446744073692774399)<br>kernel.shma11 = 4294967296（CentoS6以前版本默认值，CentoS7默认为18446744073692774399)<br>kernel.shmmni = 4096<br>kernel.sem = 50100 64128000 50100 1280<br>fs.file-max = 7672460<br>net.ipv4.ip_local_port_range = 9000 65000<br>net.core.rmem_default = 1048576<br>net.core.rmem_max = 4194304<br>net.core.wmem_default = 262144<br>net.core.wmem_max = 1048576<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">vim /etc/security/limits.conf</span><br>* - nofile 100000<br>* - nproc 100000<br>* - memlock 60000<br></code></pre></td></tr></table></figure>

<h3 id="2-2-3-安装依赖包"><a href="#2-2-3-安装依赖包" class="headerlink" title="2.2.3 安装依赖包"></a>2.2.3 安装依赖包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">RHEL系统</span><br>yum install -y gcc make readline-devel zlib-devel<br><span class="hljs-meta prompt_">#</span><span class="language-bash">ubuntu</span><br>apt update<br>apt install -y gcc make libreadline-dev zlib1g-dev<br></code></pre></td></tr></table></figure>

<h3 id="2-2-4-源码编译安装"><a href="#2-2-4-源码编译安装" class="headerlink" title="2.2.4 源码编译安装"></a>2.2.4 源码编译安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">下载解压缩</span><br>[21:41:20 root@rocky8 ~]#wget https://mirrors.aliyun.com/postgresql/source/v12.9/postgresql-12.9.tar.gz<br>[21:45:00 root@rocky8 ~]#tar xf postgresql-12.9.tar.gz <br>[21:45:10 root@rocky8 ~]#cd postgresql-12.9/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看安装说明</span><br>[21:47:48 root@rocky8 postgresql-12.9]#cat /root/postgresql-12.9/INSTALL<br> 	./configure<br>    make<br>    su<br>    make install<br>    adduser postgres<br>    mkdir /usr/local/pgsql/data<br>    chown postgres /usr/local/pgsql/data<br>    su - postgres<br>    /usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data<br>    /usr/local/pgsql/bin/pg_ctl -D /usr/local/pgsql/data -l logfile start<br>    /usr/local/pgsql/bin/createdb test<br>    /usr/local/pgsql/bin/psql test<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">开始编译三步曲，默认安装在/usr/local/pgsq1</span><br>[21:52:14 root@rocky8 postgresql-12.9]#./configure --prefix=/apps/pgsql --with-pgport=5432<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看编译选项（可选）</span><br><br><br>[21:57:11 root@rocky8 postgresql-12.9]#make -j 3 world  #默认make不包括文档和其他模块<br>[22:00:16 root@rocky8 postgresql-12.9]#make install-world  #默认make install不包括文档和其他模块<br></code></pre></td></tr></table></figure>

<h3 id="2-2-5-创建数据库用户和组"><a href="#2-2-5-创建数据库用户和组" class="headerlink" title="2.2.5  创建数据库用户和组"></a>2.2.5  创建数据库用户和组</h3><p>PostgreSQL默认不支持以root身份启动服务，虽然也可修改源码实现root启动，但基于安全考虑不建议，因此必须创建一个用于启动PostgrepSQL的普通用户</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建数据库用户和组，注意此用户需要可以交互登录</span><br>[22:07:25 root@rocky8 ~]#useradd -s /bin/bash -m -d /home/postgres postgres<br>[22:08:47 root@rocky8 ~]#echo -e &#x27;123456\n123456&#x27; | passwd postgres<br>[22:11:34 root@rocky8 ~]#echo postgres:123456 | chpasswd<br></code></pre></td></tr></table></figure>

<h3 id="2-2-6创建数据目录并授权"><a href="#2-2-6创建数据目录并授权" class="headerlink" title="2.2.6创建数据目录并授权"></a>2.2.6创建数据目录并授权</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:11:46 root@rocky8 ~]#mkdir -pv /pgsql/data/<br>[22:13:28 root@rocky8 ~]#chown postgres. /pgsql/data/<br></code></pre></td></tr></table></figure>

<h3 id="2-2-7设置环境变量"><a href="#2-2-7设置环境变量" class="headerlink" title="2.2.7设置环境变量"></a>2.2.7设置环境变量</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:14:38 root@rocky8 ~]#vim /etc/profile.d/pgsql.sh<br>[22:19:11 root@rocky8 ~]#cat /etc/profile.d/pgsql.sh<br>export PGHOME=/apps/pgsql<br>export PATH=$PGHOME/bin/:$PATH<br>export PGDATA=/pgsql/data<br>export PGUSER=postgres<br>export MANPATH=/apps/pgsql/share/man:$MANPATH<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证</span><br>[22:19:15 root@rocky8 ~]#su - postgres<br>[22:20:22 postgres@rocky8 ~]$psql --version<br>psql (PostgreSQL) 12.9<br></code></pre></td></tr></table></figure>

<h3 id="2-2-8初始化数据库"><a href="#2-2-8初始化数据库" class="headerlink" title="2.2.8初始化数据库"></a>2.2.8初始化数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:19:15 root@rocky8 ~]#su - postgres<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化</span><br>[22:20:45 postgres@rocky8 ~]$initdb  #前面加了环境变量，所以这里可以不加其他选项<br><br>initdb -D $PGDATA<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果没有指定选项-D&lt;datadir&gt;，按环境变量<span class="hljs-variable">$PGDATA</span>指定的路径进行初始化</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生产建议初始化方式</span><br>initdb -A md5 -D $PGDATA -E utf8 --locale=C -U postgres -W<br>-A	#指定local connections默认的身份验证方法<br>-D	#指定数据目录<br>-E 	#指定字符集<br>--locale=C	#指定语言环境<br>-U 	#指定数据库superuser用户名<br>-W	#指定数据库superuser的用户密码<br></code></pre></td></tr></table></figure>

<h3 id="2-2-9-启动和关闭服务"><a href="#2-2-9-启动和关闭服务" class="headerlink" title="2.2.9 启动和关闭服务"></a>2.2.9 启动和关闭服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">启动</span><br>[22:22:34 postgres@rocky8 ~]$pg_ctl -l logfile start <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">停止</span><br>[22:28:42 postgres@rocky8 ~]$pg_ctl stop<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动命令：</span><br>pg_ctl -D /pgsq1/data -1 logfile start<br>postgres -D /pgsq1/data &amp;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">停止数据库的命令如下：</span><br>pg_ct1 stop -D $PGDATA [-m SHUTDOWN-MODE]<br>其中-m是指定数据库的停止方法，有以下三种：<br>smart：等所有的连接中止后，关闭数据库。如果客户端连接不终止，则无法关闭数据库。<br>fast：快速关闭数据库，断开客户端的连接，让已有的事务回滚，然后正常关闭数据库。相当于oracle数据库关闭时的immediate模式。此为默认值，建议使用<br>immediate：立即关闭数据库，相当于数据库进程立即停止，直接退出，下次启动数据库需要进行恢复。相当于oracle数据库关闭时的 abort模式<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">smart关闭</span><br>pg_ctl stop -D /pgsq1/data/ -ms<br><span class="hljs-meta prompt_">#</span><span class="language-bash">fast关闭，推荐使用，也是默认模式</span><br>pg_ctl stop -D /pgsq1/data/ -mf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">immediate 相当于ki11-9</span><br>pg_ctl stop -D /pgsq1/data/ -mi<br><span class="hljs-meta prompt_">#</span><span class="language-bash">或者发送信号，直接向数据库主进程发送的signal信号有以下三种。</span><br>SIGTERM:发送此信号为Smart Shutdown关机模式。<br>SIGINT：发送此信号为Fast Shutdown关机模式。<br>SIGQUIT：发送此信号为Immediate Shutdown关机模式。<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启</span><br>pg_ctl restart -mf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">源码目录中内置PostgresQL的启动脚本</span><br>postgresql-12.9/contrib/start-scripts/linux<br></code></pre></td></tr></table></figure>

<p>范例：实现开机自启动PostgreSQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:49:16 root@rocky8 ~]#cp  postgresql-12.9/contrib/start-scripts/linux /etc/init.d/postgressql<br>[22:53:09 root@rocky8 ~]#chmod +x /etc/init.d/postgressql <br>[22:53:50 root@rocky8 ~]#chkconfig --add postgressql<br><br>[22:51:44 root@rocky8 ~]#vim /etc/init.d/postgressql <br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改下面两行</span><br>prefix=/apps/pgsql<br>PGDATA=&quot;/pgsql/data&quot;<br><br><br>[22:54:28 root@rocky8 ~]#service postgressql start <br></code></pre></td></tr></table></figure>

<p>范例：创建 service 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建新的service文件</span><br>[23:00:02 root@rocky8 ~]#vim /lib/systemd/system/postgresql.service<br>[23:07:25 root@rocky8 ~]#cat /lib/systemd/system/postgresql.service <br>[23:14:29 root@rocky8 ~]#cat /lib/systemd/system/postgresql.service <br>[Unit]<br>Description=PostgreSQL database server<br>After=network.target<br><br><br>[Service]<br>User=postgres<br>Group=postgres<br><br>ExecStart=/apps/pgsql/bin/postmaster -D /pgsql/data<br>ExecReload=/bin/kill -HUP<br><br><br>[Install]<br>WantedBy=multi-user.target<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">确认文件内容</span><br>[23:09:34 root@rocky8 ~]#systemctl daemon-reload<br>[23:09:47 root@rocky8 ~]#systemctl cat postgresql.service<br><span class="hljs-meta prompt_"># </span><span class="language-bash">/usr/lib/systemd/system/postgresql.service</span><br>[23:14:29 root@rocky8 ~]#cat /lib/systemd/system/postgresql.service <br>[Unit]<br>Description=PostgreSQL database server<br>After=network.target<br><br><br>[Service]<br>User=postgres<br>Group=postgres<br><br>ExecStart=/apps/pgsql/bin/postmaster -D /pgsql/data<br>ExecReload=/bin/kill -HUP<br><br><br>[Install]<br>WantedBy=multi-user.target<br><br><br>[23:25:49 root@rocky8 ~]#systemctl enable --now postgresql<br><br></code></pre></td></tr></table></figure>

<h3 id="2-2-10-查看编译和相关信息"><a href="#2-2-10-查看编译和相关信息" class="headerlink" title="2.2.10 查看编译和相关信息"></a>2.2.10 查看编译和相关信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell">[14:42:03 root@rocky8 ~]#pg_config<br>BINDIR = /apps/pgsql/bin<br>DOCDIR = /apps/pgsql/share/doc<br>HTMLDIR = /apps/pgsql/share/doc<br>INCLUDEDIR = /apps/pgsql/include<br>PKGINCLUDEDIR = /apps/pgsql/include<br>INCLUDEDIR-SERVER = /apps/pgsql/include/server<br>LIBDIR = /apps/pgsql/lib<br>PKGLIBDIR = /apps/pgsql/lib<br>LOCALEDIR = /apps/pgsql/share/locale<br>MANDIR = /apps/pgsql/share/man<br>SHAREDIR = /apps/pgsql/share<br>SYSCONFDIR = /apps/pgsql/etc<br>PGXS = /apps/pgsql/lib/pgxs/src/makefiles/pgxs.mk<br>CONFIGURE = &#x27;--prefix=/apps/pgsql&#x27; &#x27;--with-pgport=5432&#x27;<br>CC = gcc<br>CPPFLAGS = -D_GNU_SOURCE<br>CFLAGS = -Wall -Wmissing-prototypes -Wpointer-arith -Wdeclaration-after-statement -Werror=vla -Wendif-labels -Wmissing-format-attribute -Wformat-security -fno-strict-aliasing -fwrapv -fexcess-precision=standard -Wno-format-truncation -Wno-stringop-truncation -O2<br>CFLAGS_SL = -fPIC<br>LDFLAGS = -Wl,--as-needed -Wl,-rpath,&#x27;/apps/pgsql/lib&#x27;,--enable-new-dtags<br>LDFLAGS_EX = <br>LDFLAGS_SL = <br>LIBS = -lpgcommon -lpgport -lpthread -lz -lreadline -lrt -lcrypt -ldl -lm <br>VERSION = PostgreSQL 12.9<br></code></pre></td></tr></table></figure>

<h3 id="2-2-11-源码编译一键安装脚本"><a href="#2-2-11-源码编译一键安装脚本" class="headerlink" title="2.2.11 源码编译一键安装脚本"></a>2.2.11 源码编译一键安装脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#***************************************************************************</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Author:		tangbeiting</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">QQ:			306876058</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Date:			2023-09-16</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">FileName:		postgresql_src_install.sh</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">URL:			https://xiaohexie00.github.io/</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Description:		The <span class="hljs-built_in">test</span> script</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Copyright (C):	2023 ALL rights reserved</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">**************************************************************************</span><br>POSTGRESQL_VERSION=12.9<br>INSTALL_DIR=/aaps/pgsql<br>DATA_DIR=/pgsql/data/<br>PORT=5432<br>CPUS=4<br>DB_USER=postgres<br><br>. /etc/os-release<br><br>color () &#123;<br>    RES_COL=60<br>    MOVE_TO_COL=&quot;echo -en \\033[$&#123;RES_COL&#125;G&quot;<br>    SETCOLOR_SUCCESS=&quot;echo -en \\033[1;32m&quot;<br>    SETCOLOR_FAILURE=&quot;echo -en \\033[1;31m&quot;<br>    SETCOLOR_WARNING=&quot;echo -en \\033[1;33m&quot;<br>    SETCOLOR_NORMAL=&quot;echo -en \E[0m&quot;<br>    echo -n &quot;$1&quot; &amp;&amp; $MOVE_TO_COL<br>    echo -n &quot;[&quot;<br>    if [ $2 = &quot;success&quot; -o $2 = &quot;0&quot; ] ;then<br>        $&#123;SETCOLOR_SUCCESS&#125;<br>        echo -n $&quot;  OK  &quot;    <br>    elif [ $2 = &quot;failure&quot; -o $2 = &quot;1&quot;  ] ;then <br>        $&#123;SETCOLOR_FAILURE&#125;<br>        echo -n $&quot;FAILED&quot;<br>    else<br>        $&#123;SETCOLOR_WARNING&#125;<br>        echo -n $&quot;WARNING&quot;<br>    fi<br>    $&#123;SETCOLOR_NORMAL&#125;<br>    echo -n &quot;]&quot;<br>    echo <br>&#125;<br><br>install_postgresql () &#123;<br>    if [ $ID = &#x27;rocky&#x27; -o $ID = &#x27;centos&#x27; ] ; then<br>        yum install -y gcc make readline-devel zlib-devel wget<br>    elif [ $ID = &#x27;ubuntu&#x27; ] ;then<br>        apt update<br>        apt install -y gcc make libreadline-dev zlib1g-dev wget<br>    else<br>        color &quot;不支持此操作系统，退出！&quot; 1<br>        exit<br>    fi<br>    <br>    if [ ! -f postgresql-$&#123;POSTGRESQL_VERSION&#125;.tar.gz  ] ; then<br>        wget https://mirrors.aliyun.com/postgresql/source/v$&#123;POSTGRESQL_VERSION&#125;/postgresql-$&#123;POSTGRESQL_VERSION&#125;.tar.gz<br>    fi<br>    <br>    tar xf postgresql-$&#123;POSTGRESQL_VERSION&#125;.tar.gz<br>    cd postgresql-$&#123;POSTGRESQL_VERSION&#125;/<br>    ./configure --prefix=$&#123;INSTALL_DIR&#125;  --with-pgport=$PORT<br>    make -j $CPUS world<br>    make install-world<br>    <br>    useradd -s /bin/bash -m -d /home/$DB_USER $DB_USER<br>    echo -e &#x27;123456\n123456&#x27; | passwd $DB_USER<br>    <br>    mkdir -pv $&#123;DATA_DIR&#125;<br>    chown $DB_USER.$DB_USER $&#123;DATA_DIR&#125;<br>    <br>    cat &gt; /etc/profile.d/pgsql.sh &lt;&lt;EOF<br>export PGHOME=$&#123;INSTALL_DIR&#125;<br>export PATH=$&#123;INSTALL_DIR&#125;/bin/:\$PATH<br>export PGDATA=/pgsql/data<br>export PGUSER=postgres<br>export MANPATH=$&#123;INSTALL_DIR&#125;/share/man:$MANPATH<br>EOF<br>    <br>   su - $DB_USER -c &#x27;initdb&#x27;  <br>&#125;    <br> <br><br><br>start_service () &#123; <br>    cat &gt; /lib/systemd/system/postgresql.service &lt;&lt;EOF    <br>[Unit]<br>Description=PostgreSQL database server<br>After=network.target<br><br>[Service]<br>User=postgres<br>Group=postgres<br><br>ExecStart=$&#123;INSTALL_DIR&#125;/bin/postmaster -D $&#123;DATA_DIR&#125;<br>ExecReload=/bin/kill -HUP $MAINPID<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><br>    systemctl daemon-reload<br>    systemctl enable --now postgresql<br>    systemctl is-active postgresql.service<br>    if [ $? -eq 0 ] ; then<br>        color &quot;PostgreSQL 安装成功!&quot; 0<br>    else<br>        color &quot;PostgreSQL 安装失败!&quot; 1<br>        exit 1<br>    fi<br>&#125;<br><br>install_postgresql<br>start_service<br></code></pre></td></tr></table></figure>



<h2 id="2-3-pg-ctl-命令管理PostgreSQL"><a href="#2-3-pg-ctl-命令管理PostgreSQL" class="headerlink" title="2.3 pg_ctl 命令管理PostgreSQL"></a>2.3 pg_ctl 命令管理PostgreSQL</h2><p>pg_ctl是一个实用的命令行工具，有以下常见功能：</p>
<ul>
<li>初始化 PostgresQL数据库实例</li>
<li>启动、终止或重启PostgresQL数据库服务。</li>
<li>查看PostgreSQL数据库服务的状态</li>
<li>让数据库实例重新读取配置文件。允许给一个指定的PostgresQL进程发送信号</li>
<li>控制 standby 服务器为可读写</li>
<li>在Windows平台下允许为数据库实例注册或取消一个系统服务</li>
</ul>
<p>pc_ctl 命令格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">[16:58:00 root@rocky8 ~]#pg_ctl --help<br>pg_ctl is a utility to initialize, start, stop, or control a PostgreSQL server.<br><br>Usage:<br>  pg_ctl init[db]   [-D DATADIR] [-s] [-o OPTIONS]<br>  pg_ctl start      [-D DATADIR] [-l FILENAME] [-W] [-t SECS] [-s]<br>                    [-o OPTIONS] [-p PATH] [-c]<br>  pg_ctl stop       [-D DATADIR] [-m SHUTDOWN-MODE] [-W] [-t SECS] [-s]<br>  pg_ctl restart    [-D DATADIR] [-m SHUTDOWN-MODE] [-W] [-t SECS] [-s]<br>                    [-o OPTIONS] [-c]<br>  pg_ctl reload     [-D DATADIR] [-s]<br>  pg_ctl status     [-D DATADIR]<br>  pg_ctl promote    [-D DATADIR] [-W] [-t SECS] [-s]<br>  pg_ctl logrotate  [-D DATADIR] [-s]<br>  pg_ctl kill       SIGNALNAME PID<br><br></code></pre></td></tr></table></figure>

<h3 id="2-3-1初始化实例"><a href="#2-3-1初始化实例" class="headerlink" title="2.3.1初始化实例"></a>2.3.1初始化实例</h3><p>初始化PostgresQL数据库实例的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">先切换用户</span><br>su - postgres<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化数据库</span><br>initdb [DATADIR]<br>pg_ctl init[db] [-s] [-D DATADIR] [-o options]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">pg_ctl命令调用initdb命令创建了一个新的PostgresQL数据库实例，参数说明如下。</span><br>-s	#只打印错误和警告信息，不打印提示性信息。<br>-D DATADIR	#指定数据库实例的数据目录。如果没有指定DATADIR，使用环境变量PGDATA指定的路径<br>-o options 	#为直接传递给initdb命令的参数<br></code></pre></td></tr></table></figure>

<p>范例：创建新的数据库实例数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell">[17:31:01 root@Master-DNS ~]#chown postgres: /pgsql/<br>[17:31:38 root@Master-DNS ~]#ls -dl /pgsql<br>drwxr-xr-x 3 postgres postgres 18 Sep 16 16:51 /pgsql<br>[17:31:48 root@Master-DNS ~]#su - postgres<br>Last login: Sat Sep 16 17:30:43 CST 2023 on pts/2<br>[17:31:57 postgres@Master-DNS ~]$pg_ctl init -D /pgsql/data2<br>The files belonging to this database system will be owned by user &quot;postgres&quot;.<br>This user must also own the server process.<br><br>The database cluster will be initialized with locale &quot;en_US.UTF-8&quot;.<br>The default database encoding has accordingly been set to &quot;UTF8&quot;.<br>The default text search configuration will be set to &quot;english&quot;.<br><br>Data page checksums are disabled.<br><br>creating directory /pgsql/data2 ... ok<br>creating subdirectories ... ok<br>selecting dynamic shared memory implementation ... posix<br>selecting default max_connections ... 100<br>selecting default shared_buffers ... 128MB<br>selecting default time zone ... Asia/Shanghai<br>creating configuration files ... ok<br>running bootstrap script ... ok<br>performing post-bootstrap initialization ... ok<br>syncing data to disk ... ok<br><br>initdb: warning: enabling &quot;trust&quot; authentication for local connections<br>You can change this by editing pg_hba.conf or using the option -A, or<br>--auth-local and --auth-host, the next time you run initdb.<br><br>Success. You can now start the database server using:<br><br>    /aaps/pgsql/bin/pg_ctl -D /pgsql/data2 -l logfile start<br><br><br>[17:34:20 postgres@Master-DNS ~]$ls /pgsql/data2<br>base          pg_dynshmem    pg_logical    pg_replslot   pg_stat      pg_tblspc    pg_wal                postgresql.conf<br>global        pg_hba.conf    pg_multixact  pg_serial     pg_stat_tmp  pg_twophase  pg_xact<br>pg_commit_ts  pg_ident.conf  pg_notify     pg_snapshots  pg_subtrans  PG_VERSION   postgresql.auto.conf<br></code></pre></td></tr></table></figure>

<h3 id="2-3-2服务管理"><a href="#2-3-2服务管理" class="headerlink" title="2.3.2服务管理"></a>2.3.2服务管理</h3><h4 id="2-3-2-1查看服务状态"><a href="#2-3-2-1查看服务状态" class="headerlink" title="2.3.2.1查看服务状态"></a>2.3.2.1查看服务状态</h4><p>查询数据库实例状态的命令如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">pg_ctl status [-D datadir]<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">[17:34:55 postgres@Master-DNS ~]$pg_ctl status -D /pgsql/data2<br>pg_ctl: no server running<br><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-2启动服务"><a href="#2-3-2-2启动服务" class="headerlink" title="2.3.2.2启动服务"></a>2.3.2.2启动服务</h4><p>启动PostgreSQL服务的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">pg_ctl start [-w] [-t seconds] [-s] [-D datadir] [-1 filename] [-o options] [-ppath] [-c]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">参数说明如下。</span><br>start	#启动数据库实例<br>-w	#等待启动完成-t#等待启动完成的等待秒数，默认为60秒<br>-s	#只打印错误和警告信息，不打印提示性信息<br>-D datadir	#指定数据库实例的数据目录<br>-l	#服务器日志输出附加在“filename”文件上，如果该文件不存在则创建它<br>-o options #声明要直接传递给postgres的选项，具体可见postgres命令的帮助<br>-p path #指定postgres可执行文件的位置。默认情况下postgres可执行文件来自和pg_ct1相同的目录,不必使用该选项。除非要进行一些不同寻常的操作，或者产生了postgres执行文件找不到的错误<br>-c	#提高服务器的软限制（ulimit-c），尝试允许数据库实例在有异常时产生一个coredump文件，以便于问题定位和故障分析<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[17:40:57 postgres@Master-DNS ~]$pg_ctl status -D /pgsql/data2<br>[17:41:42 postgres@Master-DNS ~]$pg_ctl start -D /pgsql/data2<br>waiting for server to start....2023-09-16 17:41:47.177 CST [14233] LOG:  starting PostgreSQL 12.9 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18), 64-bit<br>2023-09-16 17:41:47.178 CST [14233] LOG:  listening on IPv6 address &quot;::1&quot;, port 5432<br>2023-09-16 17:41:47.178 CST [14233] LOG:  listening on IPv4 address &quot;127.0.0.1&quot;, port 5432<br>2023-09-16 17:41:47.178 CST [14233] LOG:  listening on Unix socket &quot;/tmp/.s.PGSQL.5432&quot;<br>2023-09-16 17:41:47.185 CST [14234] LOG:  database system was shut down at 2023-09-16 17:32:32 CST<br>2023-09-16 17:41:47.186 CST [14233] LOG:  database system is ready to accept connections<br> done<br>server started<br><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-3停止服务"><a href="#2-3-2-3停止服务" class="headerlink" title="2.3.2.3停止服务"></a>2.3.2.3停止服务</h4><p>停止PostgresQL数据库的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">pg_ctl stop [-w] [-t seconds] [-s] [-D datadir] [-m s[mart] 1 f[ast] | i[mmediate] ]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">参数说明如下。</span><br>-W	#不等待数据库停下来，命令就返回。<br>-m	#指定停止的模式。前面已叙述过停止的几种模式了。#其它未说明的参数，其含义与启动数据库命令中的参数相同。<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[17:42:00 postgres@Master-DNS ~]$pg_ctl stop -D /pgsql/data2<br>waiting for server to shut down....2023-09-16 17:44:45.968 CST [14233] LOG:  received fast shutdown request<br>2023-09-16 17:44:45.969 CST [14233] LOG:  aborting any active transactions<br>2023-09-16 17:44:45.969 CST [14233] LOG:  background worker &quot;logical replication launcher&quot; (PID 14240) exited with exit code 1<br>2023-09-16 17:44:45.970 CST [14235] LOG:  shutting down<br>2023-09-16 17:44:45.974 CST [14233] LOG:  database system is shut down<br> done<br>server stopped<br>[17:44:46 postgres@Master-DNS ~]$pg_ctl status -D /pgsql/data2<br>pg_ctl: no server running<br><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-4重启服务"><a href="#2-3-2-4重启服务" class="headerlink" title="2.3.2.4重启服务"></a>2.3.2.4重启服务</h4><p>重启PostgresQL数据库的命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">pg_ctl restart [-w] [-t seconds][-s] [-D datadir] [-c] [-m s[mart] [ f[ast] [i[mmediate] ] [-o &quot;options ]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">此命令中的参数与启动或停止命令中的参数含义相同</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-2-5加载配置"><a href="#2-3-2-5加载配置" class="headerlink" title="2.3.2.5加载配置"></a>2.3.2.5加载配置</h4><p>在配置文件中改变参数后，需要使用上面这条命令使参数生效</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">修改配置文件 postgresql.conf后，让修改生效的方法有两种</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法一：在操作系统使用下面命令</span><br>pg_ctl reload [-s] [-D datadir]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法二：在psql中使用如下命令</span><br>postgres=# select pg_reload_conf();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：加载配置操作只针对一些配置的修改生效，有些配置需要重新启动服务才能生效</span><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：修改端口不支持reload,只能restart</span><br>[17:49:29 postgres@Master-DNS ~]$vim /pgsql/data2/postgresql.conf <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改端口</span><br>[17:50:14 postgres@Master-DNS ~]$echo port=5433 &gt;&gt; /pgsql/data2/postgresql.conf <br>[17:50:33 postgres@Master-DNS ~]$pg_ctl reload -D /pgsql/data2<br>pg_ctl: PID file &quot;/pgsql/data2/postmaster.pid&quot; does not exist<br>Is server running?<br>[17:50:43 postgres@Master-DNS ~]$pg_ctl start -D /pgsql/data2<br>waiting for server to start....2023-09-16 17:50:55.079 CST [14276] LOG:  starting PostgreSQL 12.9 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18), 64-bit<br>2023-09-16 17:50:55.079 CST [14276] LOG:  listening on IPv6 address &quot;::1&quot;, port 5433<br>2023-09-16 17:50:55.079 CST [14276] LOG:  listening on IPv4 address &quot;127.0.0.1&quot;, port 5433<br>2023-09-16 17:50:55.080 CST [14276] LOG:  listening on Unix socket &quot;/tmp/.s.PGSQL.5433&quot;<br>2023-09-16 17:50:55.090 CST [14277] LOG:  database system was shut down at 2023-09-16 17:44:45 CST<br>2023-09-16 17:50:55.091 CST [14276] LOG:  database system is ready to accept connections<br> done<br>server started<br>[17:50:55 postgres@Master-DNS ~]$ss -ntl<br>State          Recv-Q         Send-Q                 Local Address:Port                 Peer Address:Port         Process         <br>LISTEN         0              128                          0.0.0.0:22                        0.0.0.0:*                            <br>LISTEN         0              244                        127.0.0.1:5432                      0.0.0.0:*                            <br>LISTEN         0              244                        127.0.0.1:5433                      0.0.0.0:*                                                      <br>LISTEN         0              244                            [::1]:5432                         [::]:*                            <br>LISTEN         0              244                            [::1]:5433                         [::]:*  <br></code></pre></td></tr></table></figure>

<h3 id="2-3-3-promote模式"><a href="#2-3-3-promote模式" class="headerlink" title="2.3.3 promote模式"></a>2.3.3 promote模式</h3><p>在流复制架构中，在standby主机执行promote提升操作，恢复正常的读写操作</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">pg_ct1	promote	[-D DATADIR]	[-W]	[-t SECS]	[-s]<br></code></pre></td></tr></table></figure>

<p>备用服务器在指定数据目录中运行提升模式命令，结束备用模式并开始读写操作</p>
<h1 id="3-PostgreSQL管理"><a href="#3-PostgreSQL管理" class="headerlink" title="3 PostgreSQL管理"></a>3 PostgreSQL管理</h1><h2 id="3-1配置文件介绍"><a href="#3-1配置文件介绍" class="headerlink" title="3.1配置文件介绍"></a>3.1配置文件介绍</h2><p>PostgreSQL使用环境变量PGDATA指向的目录做为数据存放的目录。这个目录是在安装时指定的，所以在安装时需要指定一个合适的目录作为数据目录的根目录，而且，每一个PG数据库实例都需要有这样的一个目录。此数据目录的初始化是使用命令initdb来完成的。</p>
<p>初始化完成后，PGDATA数据目录下就会生成三个配置文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgresql.conf	#数据库实例的主配置文件，基本上所有的配置参数都在此文件中。<br>pg_hba.conf	#认证配置文件，配置了允许哪些IP的主机访问数据库，认证的方法是什么等信息。<br>pg_ident.conf #认证方式ident的用户映射文件。<br></code></pre></td></tr></table></figure>

<h2 id="3-2数据库相关概念"><a href="#3-2数据库相关概念" class="headerlink" title="3.2数据库相关概念"></a>3.2数据库相关概念</h2><h3 id="3-2-1数据库的结构组织"><a href="#3-2-1数据库的结构组织" class="headerlink" title="3.2.1数据库的结构组织"></a>3.2.1数据库的结构组织</h3><p><img src="image-20230916175616026.png" srcset="/img/loading.gif" lazyload alt="image-20230916175616026"></p>
<p>在一个PostgreSQL数据库系统中，数据的组织结构可以分为以下五层：</p>
<ul>
<li><p>实例：一个PostgreSQL对应一个安装的数据目录$PGDATA,即一个instance实例</p>
</li>
<li><p>数据库：一个PostgresQL数据库服务下可以管理多个数据库，当应用连接到一个数据库时，一般只能访问这个数据库中的数据，而不能访问其他数据库中的内容</p>
<p>默认情况下初始实例只有三个数据库：postgres、templateo、template1</p>
</li>
<li><p>模式：一个数据库可以创建多个不同的名称空间即Schema,用于分隔不同的业务数据</p>
</li>
<li><p>表和索引：一个数据库可以有多个表和索引。在PostgreSQL中表的术语称为Relation，而在其他数据库中通常叫Table</p>
</li>
<li><p>行和列：每张表中有很多列和行数据。在PostgreSQL中行的术语一般为“Tuple”，而在其他数据库中则叫”Row”。</p>
</li>
</ul>
<h3 id="3-2-2-PostgreSQL中的术语"><a href="#3-2-2-PostgreSQL中的术语" class="headerlink" title="3.2.2 PostgreSQL中的术语"></a>3.2.2 PostgreSQL中的术语</h3><p>PostgreSQL有一些术语与其他数据库中不一样，了解了这些术语的意思，就能更好地看懂PostgreSQL中的文档。</p>
<p>与其他数据库不同的术语如下。</p>
<ul>
<li>Relation:表示表table或索引index,具体表示的是Table还是Index需要看具体情况</li>
<li>Tuple：表示表中的行，在其他数据库中使ROW来表示</li>
<li>Segment:每个表和索引都单独对应一个文件,即为segment,如果文件大小超过1GB,会创建多个相同名称但后缀不同的文件</li>
<li>Page：表示在磁盘中的数据块。在文件中以块为单位存放数据，默认值为8KB,最大可以为32KB</li>
<li>Buffer：表示在内存中的数据块。</li>
</ul>
<p>范例：编译时可以指定segment大小</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[18:00:19 root@rocky8 postgresql-12.9]#./configure --help | grep segment<br>  --with-segsize=SEGSIZE  set table segment size in GB [1]<br><br></code></pre></td></tr></table></figure>

<h3 id="3-2-3模版数据库template0和template1"><a href="#3-2-3模版数据库template0和template1" class="headerlink" title="3.2.3模版数据库template0和template1"></a>3.2.3模版数据库template0和template1</h3><p>template1和template0是PostgreSQL的模板数据库。所谓模板数据库就是创建新database时,PostgreSQL会基于模板数据库制作一份副本，其中会包含所有的数据库设置和数据文件。</p>
<p>PostgreSQL安装好以后会默认附带两个模板数据库：默认模板库为template1和template1。</p>
<p>默认模板库为template1,也可以指定template0</p>
<p>比如:create database db1 template template0</p>
<p>不要对templateo模板数据库进行任何修改，因为这是原始的干净模板</p>
<p>如果其它模板数据库被搞坏了，基于这个数据库做一个副本就可以了。</p>
<p>如果希望定制自己的模板数据库，那么请基于template1进行修改，或者自己另外创建一个模板数据库再修改。</p>
<p>template1和template0的区别主要有两点：</p>
<ol>
<li>template1可以连接,template0不可以连接。</li>
<li>使用template1模板库建库时不可指定新的encoding和locale,而template0可以。</li>
</ol>
<p>注意：template0和template1都不能被删除。</p>
<h3 id="3-2-4模式schema"><a href="#3-2-4模式schema" class="headerlink" title="3.2.4模式schema"></a>3.2.4模式schema</h3><p>模式schema是数据库中的一个概念，可以将其理解为一个命名空间。不同的模式下可以有相同名称的表、函数等对象且互相不冲突。提出模式的概念是为了便于管理，只要有权限，每个模式(schema)的对象可以互相调用。</p>
<p>在PostgreSQL中，一个数据库包含一个或多个模式，一个模式中又包含了表、函数及操作符等数据库对象。</p>
<p>在PostgresQL中，不能同时访问不同数据库中的对象，当要访问另一个数据库中的表或其他对象时，需要重新连接到这个新的数据库，而模式没有此限制。一个用户在连接到一个数据库后，就可以同时访问这个数据库中多个模式的对象。</p>
<p>通常情况下，创建和访问表的时候都不用指定模式，实际上这时访问的都是public模式。每当我们创建一个新的数据库时，PostgreSQL都会自动创建一个名为public的模式。当登录到该数据库时，如果没有特殊的指定，都是以该模式public操作各种数据对象的。</p>
<p>我们需要使用模式有以下几个主要原因：</p>
<ul>
<li>允许多个用户在使用同一个数据库时彼此互不干扰。</li>
<li>把数据库对象放在不同的模式下，然后组织成逻辑组，让它们更便于管理。</li>
<li>第三方的应用可以放在不同的模式中，这样就不会和其他对象的名字冲突了。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建模式</span><br>create schema schema_name;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除模式</span><br>drop schema schema_name;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看模式</span><br>\dn<br></code></pre></td></tr></table></figure>

<p>要访问指定模式中的对象，需要先指定一个包含模式名及表名的名字，模式和表之间用一个“点”分开，</p>
<p>如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">schema_name.table_name<br></code></pre></td></tr></table></figure>

<h2 id="3-3psql工具介绍和基本用法"><a href="#3-3psql工具介绍和基本用法" class="headerlink" title="3.3psql工具介绍和基本用法"></a>3.3psql工具介绍和基本用法</h2><p>psql是PostgreSQL中的一个命令行交互式客户端工具，类似MySQL的mysql和Oracle中的命令行工具sqlplus，它允许你交互地输入SQL或命令，然后把它们发出给PostgreSQL服务器，再显示SQL或命令的结果。而且，输入的内容还可以来自于一个文件。此外，它还提供了一些命令和多种类似shell的特性来实现书写脚本，从而实现对大量任务的自动化工作。</p>
<p>虽然也可以使用PostgreSQL中图形化的客户端工具（如pgadmin）来实现上述功能。但如果掌握了psql的使用方法，将会体会到它的方便之处。因为psql是一个字符界面的工具，没有图形化工具使用上的一些限制。psql 与 pgAdminlll之间的关系类似于vi与某些图形化工具的关系。</p>
<p><strong>psql 的历史命令与补全的功能</strong></p>
<ul>
<li>可以使用上下键把以前使用过的命令或SQL语句调出来</li>
<li>连续按两个tab键表示把命令补全或给出提示输入</li>
</ul>
<p><strong>psql 命令格式</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">psq1 -h &lt;hostname or ip&gt;-p&lt;端口&gt;[数据库名称]-u[用户名称]<br><br>-h 	#指定要连接的数据库主机名或IP地址，默认local socket登录(由配置项unix_socket_directories指定)<br>-p	#指定连接的数据库端口<br><span class="hljs-meta prompt_">#</span><span class="language-bash">最后两个参数是数据库名和用户名</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">这些连接参数也可以用环境变量指定，比如：</span><br>export PGDATABASE=testdb<br>export PGHOST=10.0.0.200<br>export PGPORT=5432<br>export PGUSER=postgres<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">然后运行psq1即可,其效果与运行psq1-h 10.0.0.200-p5432 testdb postgres相同。</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">可通过下面命令查看详细帮助：man /apps/pgsq1/share/man/manl/psq1.1</span><br></code></pre></td></tr></table></figure>

<p>范例：psql本地登录PGSQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">方法1</span><br>[20:50:58 root@rocky8 ~]#psql -d postgres -U postgres<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>postgres=# <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法2</span><br>[20:51:40 root@rocky8 ~]#su - postgres<br>Last login: Fri Sep 15 23:00:00 CST 2023 on pts/0<br>[20:52:24 postgres@rocky8 ~]$psql<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>postgres=# <br><br></code></pre></td></tr></table></figure>

<p>范例：远程登录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：默认PostgresQL不支持远程登录，需要修改配置和授权才可以</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果不指定he11odb数据库，默认连接和用户名同名的数据库</span><br>vim /pgsql/data/postgresql.conf<br>listen_addresses = &#x27;*&#x27;  <br><br><br><br>vim /pgsql/data/pg_hba.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">IPv4 <span class="hljs-built_in">local</span> connections:</span><br>host    all             all             127.0.0.1/32            trust<br>host    all             all             10.0.0.0/24             trust<br><br><br><br><br>[21:30:55 root@rocky8 ~]#psql -h 10.0.0.3 -p 5432 postgres postgres<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>postgres=# <br><br></code></pre></td></tr></table></figure>

<p>范例：psql命令中直接执行SQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:50:45 root@rocky8 ~]#psql -U postgres -h 10.0.0.3 -p 5432 -d postgres -c &quot;select current_time&quot;<br>   current_time    <br>-------------------<br> 21:51:59.64304+08<br>(1 row)<br><br></code></pre></td></tr></table></figure>

<p>范例：psql 命令中执行文件中的SQL</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:54:53 root@rocky8 ~]#psql -U postgres -h 10.0.0.3 -p 5432 -d postgres -f test.sql <br>                                   List of roles<br> Role name |                         Attributes                         | Member of <br>-----------+------------------------------------------------------------+-----------<br> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;<br><br>    current_time    <br>--------------------<br> 21:55:07.835346+08<br>(1 row)<br><br></code></pre></td></tr></table></figure>

<h2 id="3-4连接管理"><a href="#3-4连接管理" class="headerlink" title="3.4连接管理"></a>3.4连接管理</h2><h3 id="3-4-1访问控制配置文件介绍"><a href="#3-4-1访问控制配置文件介绍" class="headerlink" title="3.4.1访问控制配置文件介绍"></a>3.4.1访问控制配置文件介绍</h3><p>在PostgreSQL中，带有一个网络防火墙的功能的文件pg_hba.conf,可以控制允许设置哪些IP的机器访问数据库服务器。</p>
<p>HBA的意思是host-based authentication,也就是基于主机的认证,即实现PostgreSQL防火墙功能</p>
<p>initdb初始化数据目录时，会生成一个默认的pg_hba.conf文件。</p>
<p>pg_hba.conf 文件的格式由很多记录组成，每条记录占一行。</p>
<p>以#开头的行为注释及空白行会被忽略。</p>
<p>一条记录由若干个空格或由制表符分隔的字段组成，如果字段用引号包围，那么它可以包含空白。</p>
<p>每条记录声明一种连接类型、一个客户端IP地址范围(如果和连接类型相关）、一个数据库名、一个用户名字，以及对匹配这些参数的连接所使用的认证方法。</p>
<p>第一条匹配连接类型、客户端地址、连接请求的数据库名和用户名的记录将用于执行认证。如果选择了一条记录而且认证失败，那么将不再考虑后面的记录；如果没有匹配的记录，访问将被拒绝。即从上向下匹配，一旦匹配则不会再向下检查</p>
<p>每条记录可以是下面七种格式之一：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">1) local &lt;dbname&gt; &lt;user&gt; &lt;auth-method&gt;[auth-options]<br>2) host &lt;dbname&gt; &lt;user&gt; &lt;ip/masklen&gt; &lt;auth-method&gt;auth-options]<br>3) hostssl &lt;dbname&gt;&lt;user&gt; &lt;ip/masklen&gt; &lt;auth-method&gt;[auth-options]<br>4) hostnoss1 &lt;dbname&gt; &lt;user&gt; &lt;ip/masklen&gt; &lt;auth-method&gt;[auth-options]<br>5) host &lt;dbname&gt; &lt;user&gt; &lt;ip&gt;&lt;mask&gt; &lt;auth-method&gt; [auth-options]<br>6] hostssl &lt;dbname&gt; &lt;user&gt; &lt;ip&gt; &lt;mask&gt; &lt;auth-method&gt;[ auth-options]<br>7) hostnossl &lt;dbname&gt;&lt;user&gt;&lt;ip&gt;&lt;mask&gt; &lt;auth-method&gt;[auth-options]<br></code></pre></td></tr></table></figure>

<p>pg_hba.conf文件为pg实例的防火墙配置文件。配置文件格式分为5部分：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">TYPE	DATABASE		USER		ADDRESS		METHOD<br></code></pre></td></tr></table></figure>

<ul>
<li>·第1个字段只能是下面的取值。<ul>
<li>local：这条记录匹配通过UNIX域套接字的连接认证。没有这种类型的记录，就不允许有UNIX域套接字的连接。当 psq后面不指定主机名或IP地址时，即用UNIX域套接字的方式连接数据库。</li>
<li>host:这条记录匹配通过TCP/IP进行的连接。包括了SSL和非SS的连接。</li>
<li>hostssl:这条记录匹配使用TCP/IP的SSL连接。必须是使用SSL加密的连接，且要使用这个选项，编译服务器时必须打开SSL支持，启动服务器时必须打开SSL配置选项。</li>
<li>hostnossl：这条记录与hostssl相反，它只匹配那些在TCP/IP上不使用SSL的连接请求。</li>
</ul>
</li>
<li>第2个字段用于设置一个数据库名称，如果设置为all，表示可以匹配任何数据库，注意：如果设置为replication时比较特殊，表示允许流复制连接，而不是允许连接到一个名为”replication”的数据库上。</li>
<li>第3个字段用于设置一个用户的名称，如果设置为all，表示可以匹配任何用户。</li>
<li>第4个字段&lt;ip/masklen&gt;表示允许哪些IP地址来访问此服务器，如192.168.1.10/32表示只允许192.168.1.10这台主机访问数据库，192.168.1.0/24表示IP地址前缀为192.168.1.X的主机都允许访问数据库服务器。</li>
<li>第5个字段表示验证方法，PostgreSQL支持的认证配置方式很多，最常用的认证方法是trust、reject、md5和ident方法。</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs http">#METHOD有如下值可选<br>md5：执行SCRAM-SHA-256或MD5身份验证加密密码来验证，是推荐使用的安全验证的方法<br>peer：从操作系统获取客户端的操作系统用户名，并检查它是否与请求的数据库用户名匹配。这仅适用于本地socket连接。<br>trust：允许无条件连接，允许任何PostgresQL用户身份登录，而无需密码或任何其他身份验证。<br>reject：拒绝任何条件连接，这对于从组中“过滤掉”某些主机非常有用。scram-sha-256：执行<br>SCRAM-SHA-256身份验证以验证用户的密码。<br>password：要提供未加密的密码以进行身份验证。由于密码是通过网络以明文形式发送的，因此不建议使用<br>gSS：使用GSSAPI对用户进行身份验证，这仅适用于TCP/IP连接。<br>sspi：使用SSPI对用户进行身份验证，这仅适用于windows。<br>ident：允许客户端上的特定操作系统用户连接到数据库。这种认证方式的使用场景是，客户端是主机上的某个操作系统用户，已经通过了操作系统的身份认证，是数据库服务器可以信任的用户，不需要在数据库层面再次检测身份。比如，如果配置了这种认证方式（配置中允许的用户名为dba)、这时在操作系统用户dba下，就能以数据库用户dba 的身份连接到数据库。服务器为了确定接收到的连接请求确实是客户端机器上的dba用户发起的，而不是这台机器上其他用户发起的假冒请求，会向客户端机器上的ident服务发起请求，让 ident服务查看此TCP连接是否是dba用户发起的，如果不是，说明是假冒，则认证失败。如果客户端通过本地连接到服务器，因为客户端与服务器在一台机器上，数据库服务器可以直接检查客户端用户的操作系统用户身份，就不需要向ident服务发送请求进行判断了。<br>1dap：使用LDAP服务器进行身份验证。<br>radiuS：使用RADIUS服务器进行身份验证。<br>cert：使用ssL客户端证书进行身份验证。<br>pam：使用操作系统提供的可插入身份验证模块（PAM）服务进行身份验证。bsd:使用操作系统提供的BSD身份验证服务进行身份验证。<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">如果一台机器只给数据库使用，而没有其他用途，则可以在pg_hba.conf中加上下面一行配置：</span><br>local all all trust<br><span class="hljs-meta prompt_">#</span><span class="language-bash">该配置表示在这台机器上，任何操作系统的用户都可以使用任何数据库用户(包括数据库超级用户)连接到数据库而不需要任何密码。因为这台主机只供数据库使用，可以把不用的操作系统用户都禁止掉，以保证安全性。</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果数据库中有一个用户“dba”，操作系统中也有一个用户“dba”</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在操作系统<span class="hljs-string">&quot;dba”用户下连接数据库不需要密码验证的设置方法：</span></span><br>local all dba ident<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">如果想在数据库主机上使用密码验证，可以使用下面的配置项：</span></span><br>local all all md5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">如果想让其他主机的连接都使用md5密码验证，则使用如下配置：</span></span><br>host al1 all 0.0.0.0/0 md5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">允许用户通过10.0.0.0/24的远程主机进行md5验证登录</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">TYPE	DATABASE	USER	ADDRESS				METHOD</span></span>	<br>host	all			all		10.0.0.0/24 		md5<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">允许用户wang通过任意远程主机进行md5验证登录test数据库</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-string">TYPE	DATABASE	USER	ADDRESS			METHOD</span></span>	<br>host	test		wang	0.0.0.0/0		md5<br></code></pre></td></tr></table></figure>

<h3 id="3-4-2打开远程连接"><a href="#3-4-2打开远程连接" class="headerlink" title="3.4.2打开远程连接"></a>3.4.2打开远程连接</h3><p>默认安装完的PG只监听1ocal。如果要远程连接，需要监听对外提供服务的IP地址。</p>
<p>范例：实现远程连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">修改用户postgres密码</span><br>[22:09:36 root@Master-DNS ~]#psql<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>postgres=# alter user postgres with password &#x27;123456&#x27;;<br>ALTER ROLE<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看监听地址和端口，默认为127.0.0.1：5432</span><br>[22:12:56 postgres@Master-DNS ~]$ss -tnl<br>State          Recv-Q         Send-Q                 Local Address:Port                 Peer Address:Port         Process         <br>LISTEN         0              128                          0.0.0.0:22                        0.0.0.0:*                            <br>LISTEN         0              244                          0.0.0.0:5432                      0.0.0.0:*                            <br>LISTEN         0              244                        127.0.0.1:5433                      0.0.0.0:*  <br><br><br><br>[22:18:17 root@Master-DNS ~]#vim /pgsql/data/pg_hba.conf <br><span class="hljs-meta prompt_"># </span><span class="language-bash">IPv4 <span class="hljs-built_in">local</span> connections:</span><br>host    all             all             127.0.0.1/32            trust<br>host    all             all             10.0.0.0/24             md5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务生效</span><br>[22:18:45 root@Master-DNS ~]#pg_ctl restart -D /pgsql/data<br>或者<br>pg_ctl restart -mf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">测试远程登录</span><br>[22:15:57 root@rocky8 ~]#psql -h 10.0.0.3 -p 5432 postgres postgres<br></code></pre></td></tr></table></figure>

<p>范例：利用.pgpass文件实现免密码连接远程posgresql</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:31:43 root@rocky8 ~]#vim .pgpass<br><span class="hljs-meta prompt_">#</span><span class="language-bash">格式：hostname:port:database:username:password</span><br>10.0.0.3:5432:postgres:postgres:123456<br><br>[22:32:48 root@rocky8 ~]#chmod 600 .pgpass <br>[22:33:07 root@rocky8 ~]#ll .pgpass <br>-rw------- 1 root root 39 Sep 16 22:32 .pgpass<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">psq1默认连接本机，需要指定和.pgpass文件内容相匹配信息才可以使用.pgpass文件连接</span><br>[22:39:29 root@rocky8 ~]#psql -h 10.0.0.3 <br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>postgres=# \l<br>                                  List of databases<br>   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   <br>-----------+----------+----------+-------------+-------------+-----------------------<br> db1       | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br> postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br> template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br> template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br>(4 rows)<br><br>postgres=# \c<br>You are now connected to database &quot;postgres&quot; as user &quot;postgres&quot;.<br><br><br></code></pre></td></tr></table></figure>

<h2 id="3-5常用操作"><a href="#3-5常用操作" class="headerlink" title="3.5常用操作"></a>3.5常用操作</h2><h3 id="3-5-1查看psql帮助"><a href="#3-5-1查看psql帮助" class="headerlink" title="3.5.1查看psql帮助"></a>3.5.1查看psql帮助</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">列出psq1帮助用法</span><br>help<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出以\开头的命令，即psq1的命令</span><br>\?<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有SQL命令的帮助，注意：SQL语句必须以；结束</span><br>\h<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看指定SQL的帮助</span><br>\h create database<br>\help create user<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# help<br>You are using psql, the command-line interface to PostgreSQL.<br>Type:  \copyright for distribution terms<br>       \h for help with SQL commands<br>       \? for help with psql commands<br>       \g or terminate with semicolon to execute query<br>       \q to quit<br>postgres=# \?<br>General<br>  \copyright             show PostgreSQL usage and distribution terms<br>  \crosstabview [COLUMNS] execute query and display results in crosstab<br>  \errverbose            show most recent error message at maximum verbosity<br>  \g [FILE] or ;         execute query (and send results to file or |pipe)<br>  \gdesc                 describe result of query, without executing it<br>  \gexec                 execute query, then execute each value in its result<br>  \gset [PREFIX]         execute query and store results in psql variables<br>  \gx [FILE]             as \g, but forces expanded output mode<br>  \q                     quit psql<br>  \watch [SEC]           execute query every SEC seconds<br><br><br><br>postgres=# \h create database<br>Command:     CREATE DATABASE<br>Description: create a new database<br>Syntax:<br>CREATE DATABASE name<br>    [ [ WITH ] [ OWNER [=] user_name ]<br>           [ TEMPLATE [=] template ]<br>           [ ENCODING [=] encoding ]<br>           [ LC_COLLATE [=] lc_collate ]<br>           [ LC_CTYPE [=] lc_ctype ]<br>           [ TABLESPACE [=] tablespace_name ]<br>           [ ALLOW_CONNECTIONS [=] allowconn ]<br>           [ CONNECTION LIMIT [=] connlimit ]<br>           [ IS_TEMPLATE [=] istemplate ] ]<br><br>URL: https://www.postgresql.org/docs/12/sql-createdatabase.html<br><br>postgres=# \h create user<br>Command:     CREATE USER<br>Description: define a new database role<br>Syntax:<br>CREATE USER name [ [ WITH ] option [ ... ] ]<br><br>where option can be:<br><br>      SUPERUSER | NOSUPERUSER<br>    | CREATEDB | NOCREATEDB<br>    | CREATEROLE | NOCREATEROLE<br>    | INHERIT | NOINHERIT<br>    | LOGIN | NOLOGIN<br>    | REPLICATION | NOREPLICATION<br>    | BYPASSRLS | NOBYPASSRLS<br>    | CONNECTION LIMIT connlimit<br>    | [ ENCRYPTED ] PASSWORD &#x27;password&#x27; | PASSWORD NULL<br>    | VALID UNTIL &#x27;timestamp&#x27;<br>    | IN ROLE role_name [, ...]<br>    | IN GROUP role_name [, ...]<br>    | ROLE role_name [, ...]<br>    | ADMIN role_name [, ...]<br>    | USER role_name [, ...]<br>    | SYSID uid<br><br>URL: https://www.postgresql.org/docs/12/sql-createuser.html<br></code></pre></td></tr></table></figure>

<h3 id="3-5-2设置显示信息的格式"><a href="#3-5-2设置显示信息的格式" class="headerlink" title="3.5.2设置显示信息的格式"></a>3.5.2设置显示信息的格式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">后续查询将坚着显示，类似于MySQL中的\G</span><br>\x<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">开启命令执行时长提示</span><br>\timing on<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">显示详细的信息，可以打印出报出问题的源代码位置</span><br>\set VERBOSITY verbose<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# select pg_sleep(5);<br>-[ RECORD 1 ]<br>pg_sleep | <br><br>Time: 5007.283 ms (00:05.007)<br><br></code></pre></td></tr></table></figure>

<p>范例：查看出错对应的源代码位置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# \set VERBOSITY verbose<br>postgres=# select wang;<br>ERROR:  42703: column &quot;wang&quot; does not exist<br>LINE 1: select wang;<br>               ^<br>LOCATION:  errorMissingColumn, parse_relation.c:3359<br>Time: 1.357 ms<br><span class="hljs-meta prompt_">#</span><span class="language-bash">说明：错误对应的是parse_relation.c文件中的3349行中errorMissingColumn函数</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">找到错误位置</span><br>[22:50:54 postgres@Master-DNS ~]$find -name parse_relation.c<br>[22:50:56 postgres@Master-DNS ~]$vim +3349  `find -name parse_relation.c`<br></code></pre></td></tr></table></figure>

<h3 id="3-5-3数据库的创建和删除"><a href="#3-5-3数据库的创建和删除" class="headerlink" title="3.5.3数据库的创建和删除"></a>3.5.3数据库的创建和删除</h3><p>创建数据库可以使用SQL语句create database实现，也可以利用createdb命令创建数据库</p>
<p>createdb是一个SQL命令CREATE DATABASE的封装。</p>
<p>createdb 命令语法格式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">createdb [option...] [dbname [description]]<br>参数说明：<br>options：参数可选项，可以是以下值：<br>-D tablespace指定数据库默认表空间。<br>-e 将createdb 生成的命令发送到服务端。<br>-E encoding指定数据库的编码。<br>-1 1ocale指定数据库的语言环境。<br>-T template指定创建此数据库的模板。<br>--help显示 createdb 命令的帮助信息。<br>-h host指定服务器的主机名。<br>-p port指定服务器监听的端口，或者 socket文件。<br>-U username连接数据库的用户名。<br>-w忽略输入密码。<br>-w连接时强制要求输入密码<br><br>dbname：要创建的数据库名。<br>description：关于新创建的数据库相关的说明。<br></code></pre></td></tr></table></figure>

<p>删除数据库可以使用SQL语句drop database 实现</p>
<p>范例：创建数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">方法1</span><br>[20:44:03 root@rocky8 ~]#createdb -h 10.0.0.3 -p 5432 -U postgres db2<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法2</span><br>[20:44:36 root@Master-DNS ~]#psql<br>postgres=# create database db1;<br>CREATE DATABASE<br>postgres=# \l<br>                                  List of databases<br>   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   <br>-----------+----------+----------+-------------+-------------+-----------------------<br> db1       | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br> postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br> template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br> template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br>(4 rows)<br><br><br></code></pre></td></tr></table></figure>

<p>范例：删除数据库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[20:44:36 root@Master-DNS ~]#psql<br>postgres=# drop database db1;<br></code></pre></td></tr></table></figure>

<p>范例：查看数据库存放目录的路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# select oid,datname from pg_database;<br>  oid  |  datname  <br>-------+-----------<br> 12726 | postgres<br>     1 | template1<br> 12725 | template0<br> 16385 | testdb<br> 16386 | db2<br>(5 rows)<br><br>[20:49:55 root@Master-DNS ~]#ls /pgsql/data/base/<br>1  12725  12726  16385  16386<br><br></code></pre></td></tr></table></figure>

<h3 id="3-5-4管理和查看模式"><a href="#3-5-4管理和查看模式" class="headerlink" title="3.5.4管理和查看模式"></a>3.5.4管理和查看模式</h3><p>一个数据库包含一个或多个已命名的模式，模式又包含表。模式还可以包含其它对象，包括数据类型、函数、操作符等。同一个对象名可以在不同的模式里使用而不会导致冲突；比如，schema1和schema2都可以包含一个名为test的表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建模式</span><br>create schema schema_name;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除模式</span><br>drop schema schema_name;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有schema</span><br>postgres=# create table public.t1(id int);<br>postgres=# \dt<br>        List of relations<br> Schema | Name | Type  |  Owner   <br>--------+------+-------+----------<br> public | t1   | table | postgres<br>(1 row)<br><br>postgres=# create table public.t2(id int);<br>postgres=# \dn<br>  List of schemas<br>  Name  |  Owner   <br>--------+----------<br> public | postgres<br>(1 row)<br><br>postgres=# \dt<br>        List of relations<br> Schema | Name | Type  |  Owner   <br>--------+------+-------+----------<br> public | t1   | table | postgres<br> public | t2   | table | postgres<br>(2 rows)<br><br><br>postgres=# create schema xiaohexie;<br>CREATE SCHEMA<br>postgres=# create table xiaohexie.t2(id int);<br>CREATE TABLE<br>postgres=# \dt<br>        List of relations<br> Schema | Name | Type  |  Owner   <br>--------+------+-------+----------<br> public | t1   | table | postgres<br> public | t2   | table | postgres<br>(2 rows)<br><br>postgres=# \dn<br>   List of schemas<br>   Name    |  Owner   <br>-----------+----------<br> public    | postgres<br> xiaohexie | postgres<br>(2 rows)<br><br><br>postgres=# \dt xiaohexie.*;<br>          List of relations<br>  Schema   | Name | Type  |  Owner   <br>-----------+------+-------+----------<br> xiaohexie | t2   | table | postgres<br>(1 row)<br></code></pre></td></tr></table></figure>

<h3 id="3-5-5查看和连接数据库"><a href="#3-5-5查看和连接数据库" class="headerlink" title="3.5.5查看和连接数据库"></a>3.5.5查看和连接数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有数据库名，相当于MySQL中的show databases;</span><br>postgres=# \l<br>                                  List of databases<br>   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   <br>-----------+----------+----------+-------------+-------------+-----------------------<br> db2       | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br> postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br> template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br> template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br> testdb    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br>(5 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">显示数据库详细信息，比如大小</span><br>postgres=# \l+<br>                                                                    List of databases<br>   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   |  Size   | Tablespace |                Descr<br>iption                 <br>-----------+----------+----------+-------------+-------------+-----------------------+---------+------------+---------------------<br>-----------------------<br> db2       | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 7513 kB | pg_default | <br> postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 7665 kB | pg_default | default administrati<br>ve connection database<br> template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +| 7513 kB | pg_default | unmodifiable empty d<br>atabase<br>           |          |          |             |             | postgres=CTc/postgres |         |            | <br> template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +| 7513 kB | pg_default | default template for<br> new databases<br>           |          |          |             |             | postgres=CTc/postgres |         |            | <br> testdb    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 |                       | 7513 kB | pg_default | <br>(5 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前连接信息</span><br>postgres=# \c<br>You are now connected to database &quot;postgres&quot; as user &quot;postgres&quot;.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前来南京详细信息</span><br>postgres=# \conninfo <br>You are connected to database &quot;postgres&quot; as user &quot;postgres&quot; via socket in &quot;/tmp&quot; at port &quot;5432&quot;.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">连接数据库，相当于use</span><br><br><br>postgres=# \c db2<br>You are now connected to database &quot;db2&quot; as user &quot;postgres&quot;.<br><br></code></pre></td></tr></table></figure>

<h3 id="3-5-6管理表"><a href="#3-5-6管理表" class="headerlink" title="3.5.6管理表"></a>3.5.6管理表</h3><p>PostgreSQL支持多种数据类型实现表结构的创建</p>
<p>范例：查看支持数据类型</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">db2=# select typname from pg_type;<br>                typname                <br>---------------------------------------<br> bool<br> bytea<br> char<br> name<br> int8<br> int2<br> int2vector<br> int4<br> regproc<br> text<br> oid<br> tid<br> xid<br> cid<br> oidvector<br> pg_type<br> pg_attribute<br> pg_proc<br>............<br></code></pre></td></tr></table></figure>

<p>范例：管理表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# \c testdb <br>You are now connected to database &quot;testdb&quot; as user &quot;postgres&quot;.<br>testdb=# \d<br>Did not find any relations.<br>testdb=# create table tb1 (id serial primary key,name text );<br>CREATE TABLE<br>testdb=# \d<br>             List of relations<br> Schema |    Name    |   Type   |  Owner   <br>--------+------------+----------+----------<br> public | tb1        | table    | postgres<br> public | tb1_id_seq | sequence | postgres<br>(2 rows)<br><br><br>testdb=# insert into tb1 (name) select (md5(random()::text)) from generate_series(2,10);<br>INSERT 0 9<br>testdb=# select * from tb1; <br> id |               name               <br>----+----------------------------------<br>  1 | 132e3fcc509eac22115b11f105289c94<br>  2 | a49fef866f321e05a8de6711115b58c5<br>  3 | 92b46b11da21239a005d0a8a566b50fd<br>  4 | c471f760e94e2bf8774fbe63b4125fb2<br>  5 | be6dab02ab4dadf31ee9b6cfdf5018a2<br>  6 | ede4d47ca3326f8ef76d7eacb25bae44<br>  7 | 1a3cad7de238e4668201aa2d1a98bde5<br>  8 | 990a9c4e924be586da2e2b6886aa62ed<br>  9 | 6cfa64ea77ece1c0318eb8873d0914a9<br>(9 rows)<br><br><br><br><br>testdb=# insert  into  tb1 (name) values(&#x27;bb&#x27;) ;<br>INSERT 0 1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#PostgreSQL中插入100万条记录只需要花3s</span></span><br>testdb=# \timing on <br>Timing is on.<br>testdb=# insert into tb1 (name) select (md5(random()::text)) from generate_series (1,1000000);<br>INSERT 0 1000000<br>Time: 3184.463 ms (00:03.184)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">复制表结构，不复制数据</span><br>testdb=# create table tb2 (like tb1);<br>CREATE TABLE<br>Time: 7.417 ms<br>testdb=# \d tb2<br>                Table &quot;public.tb2&quot;<br> Column |  Type   | Collation | Nullable | Default <br>--------+---------+-----------+----------+---------<br> id     | integer |           | not null | <br> name   | text    |           |          | <br><br>testdb=# select * from tb2;<br> id | name <br>----+------<br>(0 rows)<br><br>Time: 0.494 ms<br>testdb=# drop table tb2;<br>DROP TABLE<br>testdb=# \d <br>             List of relations<br> Schema |    Name    |   Type   |  Owner   <br>--------+------------+----------+----------<br> public | tb1        | table    | postgres<br> public | tb1_id_seq | sequence | postgres<br><br></code></pre></td></tr></table></figure>



<h3 id="3-5-7查看表和表信息"><a href="#3-5-7查看表和表信息" class="headerlink" title="3.5.7查看表和表信息"></a>3.5.7查看表和表信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有表，视图，序列</span><br>\d<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出public的schema中所有的表名,相当于show tables;</span><br>\dt<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看t1的表信息</span><br>\dt tl<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">支持通配符*和？，以下显示所有t开头的表</span><br>\dt t*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出myschema模式的表结构</span><br>\dt myschema.*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看t1的表结构，相当于desc</span><br>\d tl<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有表信息，包括大小</span><br>testdb=# \dt+<br>                    List of relations<br> Schema | Name | Type  |  Owner   |  Size  | Description <br>--------+------+-------+----------+--------+-------------<br> public | tb1  | table | postgres | 130 MB | <br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出表信息</span><br>testdb=# \dt tb1<br>        List of relations<br> Schema | Name | Type  |  Owner   <br>--------+------+-------+----------<br> public | tb1  | table | postgres<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出表大小信息</span><br>testdb=# \dt+ tb1<br>                    List of relations<br> Schema | Name | Type  |  Owner   |  Size  | Description <br>--------+------+-------+----------+--------+-------------<br> public | tb1  | table | postgres | 130 MB | <br>(1 row)<br><br><br>testdb=# select * from pg_tables;<br>     schemaname     |        tablename        | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity <br>--------------------+-------------------------+------------+------------+------------+----------+-------------+-------------<br> public             | tb1                     | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_statistic            | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_type                 | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_foreign_server       | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_authid               | postgres   | pg_global  | t          | f        | f           | f<br> pg_catalog         | pg_statistic_ext_data   | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_user_mapping         | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_subscription         | postgres   | pg_global  | t          | f        | f           | f<br> pg_catalog         | pg_attribute            | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_proc                 | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_class                | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_attrdef              | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_constraint           | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_inherits             | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_index                | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_operator             | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_opfamily             | postgres   |            | t          | f        | f           | f<br> pg_catalog         | pg_opclass              | postgre<br> <br> <br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"> #</span><span class="language-bash">查看表大小</span><br> testdb=# select pg_total_relation_size(&#x27;tb1&#x27;);<br> pg_total_relation_size <br>------------------------<br>              181542912<br>(1 row)<br><br>Time: 0.463 ms<br>testdb=# select pg_total_relation_size(&#x27;tb1&#x27;)/1024/1024||&#x27;MB&#x27;;<br> ?column? <br>----------<br> 173MB<br>(1 row)<br><br>Time: 0.676 ms<br><br></code></pre></td></tr></table></figure>

<p>范例：查看表对应的文件径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看testdb数据库文件夹路径OID</span><br>testdb=#  select oid,datname  from pg_database where datname=&#x27;testdb&#x27;;<br>  oid  | datname <br>-------+---------<br> 16385 | testdb<br>(1 row)<br><br>Time: 0.292 ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看tb1表文件relid</span><br>testdb=# select relid from pg_stat_all_tables where relname=&#x27;tb1&#x27;;<br> relid <br>-------<br> 16399<br>(1 row)<br><br>Time: 0.503 ms<br><br><br>[21:49:19 root@Master-DNS ~]#ll /pgsql/data/base/16385/16399<br>-rw------- 1 postgres postgres 136536064 Sep 18 21:40 /pgsql/data/base/16385/16399<br></code></pre></td></tr></table></figure>

<p>范例：查看当前库中的所有表的统计信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# select * from pg_stat_all_tables;<br>testdb=# select * from pg_stat_all_tables;<br>-[ RECORD 1 ]-------+------------------------------<br>relid               | 2830<br>schemaname          | pg_toast<br>relname             | pg_toast_2604<br>seq_scan            | 0<br>seq_tup_read        | 0<br>idx_scan            | 0<br>idx_tup_fetch       | 0<br>n_tup_ins           | 0<br>n_tup_upd           | 0<br>n_tup_del           | 0<br>n_tup_hot_upd       | 0<br>n_live_tup          | 0<br>n_dead_tup          | 0<br>n_mod_since_analyze | 0<br>last_vacuum         | <br>last_autovacuum     | <br>last_analyze        | <br>last_autoanalyze    | <br>vacuum_count        | 0<br>autovacuum_count    | 0<br>analyze_count       | 0<br>autoanalyze_count   | 0<br>-[ RECORD 2 ]-------+------------------------------<br>relid               | 826<br>schemaname          | pg_catalog<br>relname             | pg_default_acl<br>seq_scan            | 0<br>seq_tup_read        | 0<br><br><br><br>testdb=# select * from pg_stat_all_tables where relname=&#x27;tb1&#x27;;<br>-[ RECORD 1 ]-------+------------------------------<br>relid               | 16399<br>schemaname          | public<br>relname             | tb1<br>seq_scan            | 3<br>seq_tup_read        | 19<br>idx_scan            | 0<br>idx_tup_fetch       | 0<br>n_tup_ins           | 2000010<br>n_tup_upd           | 0<br>n_tup_del           | 0<br>n_tup_hot_upd       | 0<br>n_live_tup          | 2000010<br>n_dead_tup          | 0<br>n_mod_since_analyze | 0<br>last_vacuum         | <br>last_autovacuum     | <br>last_analyze        | <br>last_autoanalyze    | 2023-09-18 21:33:24.583405+08<br>vacuum_count        | 0<br>autovacuum_count    | 0<br>analyze_count       | 0<br>autoanalyze_count   | 1<br><br>Time: 12.034 ms<br></code></pre></td></tr></table></figure>

<h3 id="3-5-8系统表-system-catalogs"><a href="#3-5-8系统表-system-catalogs" class="headerlink" title="3.5.8系统表(system catalogs)"></a>3.5.8系统表(system catalogs)</h3><p>官方文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/docs/14/catalogs.html<br>http://www.postgres.cn/docs/12/catalogs.html<br></code></pre></td></tr></table></figure>

<p><strong>系统表的定义：</strong></p>
<p>系统表也称为系统目录(system catalogs)，是关系型数据库存放模式元数据的地方，比如表和列的信息，以及内部统计信息等。PostgreSQL的系统表也就是普通表。虽然可以删除并重建这些表、增加列、插入和更新数值，但会导致系统损坏。通常情况下，不应该手工修改系统目录，通过相关SQL命令去实现。例如：当执行CREATE DATABASE时会向系统表pg_database中插入一行记录，并且实际上在磁盘上创建该数据库。</p>
<p>系统表包括存放系统信息的普通表或者视图，系统视图建立在系统表之上</p>
<p><strong>系统表的创建</strong></p>
<p>pg的每一个数据库中都有一套自己的系统表，其中大多数系统表都是在数据库创建时从模板数据库中拷贝过来的</p>
<p><strong>系统表的维护</strong></p>
<p>系统表中的信息由相的SQL命令关联至系统表自动维护</p>
<p><strong>系统表的存储方式</strong>和数</p>
<p>据库相关的系统表保存在$PGDATA/base目录下相应数据库的文件夹下,文件夹命名为pg_database里记录的数据库oid(Object identifiers),系统表都有一个列名为对象标识符oid,用于标识postgres里各个对象，如表、序列、索引等，以前版本是隐藏的</p>
<p>所有数据库共享的系统表,如pg_database,保存在$PGDATA/global下</p>
<p>范例：查看系统表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# \dS<br>                         List of relations<br>   Schema   |              Name               |   Type   |  Owner   <br>------------+---------------------------------+----------+----------<br> pg_catalog | pg_aggregate                    | table    | postgres<br> pg_catalog | pg_am                           | table    | postgres<br> pg_catalog | pg_amop                         | table    | postgres<br> pg_catalog | pg_amproc                       | table    | postgres<br> pg_catalog | pg_attrdef                      | table    | postgres<br> pg_catalog | pg_attribute                    | table    | postgres<br> pg_catalog | pg_auth_members                 | table    | postgres<br> pg_catalog | pg_authid                       | table    | postgres<br> pg_catalog | pg_available_extension_versions | view     | postgres<br> pg_catalog | pg_available_extensions         | view     | postgres<br><br><br><br>testdb=# \dS+<br>                                       List of relations<br>   Schema   |              Name               |   Type   |  Owner   |    Size    | Description <br>------------+---------------------------------+----------+----------+------------+-------------<br> pg_catalog | pg_aggregate                    | table    | postgres | 56 kB      | <br> pg_catalog | pg_am                           | table    | postgres | 40 kB      | <br> pg_catalog | pg_amop                         | table    | postgres | 80 kB      | <br> pg_catalog | pg_amproc                       | table    | postgres | 56 kB      | <br> pg_catalog | pg_attrdef                      | table    | postgres | 16 kB      | <br> pg_catalog | pg_attribute                    | table    | postgres | 464 kB     | <br> pg_catalog | pg_auth_members                 | table    | postgres | 40 kB      | <br> pg_catalog | pg_authid                       | table    | postgres | 48 kB      | <br> pg_catalog | pg_available_extension_versions | view     | postgres | 0 bytes    | <br> pg_catalog | pg_available_extensions         | view     | postgres | 0 bytes    | <br> pg_catalog | pg_cast                         | table    | postgres | 48 kB      | <br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有PG开头的系统表</span><br>testdb=# \dt pg_*<br>                    List of relations<br>   Schema   |          Name           | Type  |  Owner   <br>------------+-------------------------+-------+----------<br> pg_catalog | pg_aggregate            | table | postgres<br> pg_catalog | pg_am                   | table | postgres<br> pg_catalog | pg_amop                 | table | postgres<br> pg_catalog | pg_amproc               | table | postgres<br> pg_catalog | pg_attrdef              | table | postgres<br> <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有pg开头的系统视图</span><br>testdb=# \dv pg_*<br>                       List of relations<br>   Schema   |              Name               | Type |  Owner   <br>------------+---------------------------------+------+----------<br> pg_catalog | pg_available_extension_versions | view | postgres<br> pg_catalog | pg_available_extensions         | view | postgres<br> pg_catalog | pg_config                       | view | postgres<br> pg_catalog | pg_cursors                      | view | postgres<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看系统表pg_database</span><br>testdb=# \d pg_database<br>               Table &quot;pg_catalog.pg_database&quot;<br>    Column     |   Type    | Collation | Nullable | Default <br>---------------+-----------+-----------+----------+---------<br> oid           | oid       |           | not null | <br> datname       | name      |           | not null | <br> datdba        | oid       |           | not null | <br> encoding      | integer   |           | not null | <br> datcollate    | name      |           | not null | <br> datctype      | name      |           | not null | <br> datistemplate | boolean   |           | not null | <br> datallowconn  | boolean   |           | not null | <br> datconnlimit  | integer   |           | not null | <br> datlastsysoid | oid       |           | not null | <br> datfrozenxid  | xid       |           | not null | <br> datminmxid    | xid       |           | not null | <br> dattablespace | oid       |           | not null | <br> datacl        | aclitem[] |           |          | <br>Indexes:<br>    &quot;pg_database_datname_index&quot; UNIQUE, btree (datname), tablespace &quot;pg_global&quot;<br>    &quot;pg_database_oid_index&quot; UNIQUE, btree (oid), tablespace &quot;pg_global&quot;<br>Tablespace: &quot;pg_global&quot;<br><br>testdb=# \d pg_tables<br>              View &quot;pg_catalog.pg_tables&quot;<br>   Column    |  Type   | Collation | Nullable | Default <br>-------------+---------+-----------+----------+---------<br> schemaname  | name    |           |          | <br> tablename   | name    |           |          | <br> tableowner  | name    |           |          | <br> tablespace  | name    |           |          | <br> hasindexes  | boolean |           |          | <br> hasrules    | boolean |           |          | <br> hastriggers | boolean |           |          | <br> rowsecurity | boolean |           |          | <br><br></code></pre></td></tr></table></figure>

<p>范例：查看指定表对应的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# select * from pg_relation_filepath(&#x27;tb1&#x27;);<br> pg_relation_filepath <br>----------------------<br> base/16385/16399<br>(1 row)<br><br>Time: 0.850 ms<br><br>[21:49:19 root@Master-DNS ~]#ll /pgsql/data/base/16385/16399<br>-rw------- 1 postgres postgres 136536064 Sep 18 21:40 /pgsql/data/base/16385/16399<br></code></pre></td></tr></table></figure>

<h3 id="3-5-9表的CRUD"><a href="#3-5-9表的CRUD" class="headerlink" title="3.5.9表的CRUD"></a>3.5.9表的CRUD</h3><p>SQL的CRUD,即Insert,update,delete,select 四条语句范例:：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# create table tb2 (id serial ,name varchar(10));<br>CREATE TABLE<br>Time: 1.782 ms<br>testdb=# \d tb2;<br>                                   Table &quot;public.tb2&quot;<br> Column |         Type          | Collation | Nullable |             Default             <br>--------+-----------------------+-----------+----------+---------------------------------<br> id     | integer               |           | not null | nextval(&#x27;tb2_id_seq&#x27;::regclass)<br> name   | character varying(10) |           |          | <br><br>testdb=# insert into tb2 (name) values(&#x27;a&#x27;);<br>INSERT 0 1<br>Time: 0.863 ms<br>testdb=# insert into tb2 (name) values(&#x27;b&#x27;);<br>INSERT 0 1<br>Time: 0.939 ms<br><br><br>testdb=#select *from tb2;<br> id | name <br>----+------<br>  1 | a<br>  2 | b<br>(2 rows)<br><br>Time: 0.753 ms<br><br>testdb=# update tb2 set name=&#x27;c&#x27; where id=&#x27;2&#x27;;<br>UPDATE 1<br>Time: 1.908 ms<br>testdb=# select *from tb2;<br> id | name <br>----+------<br>  1 | a<br>  2 | c<br>(2 rows)<br><br>Time: 0.696 ms<br><br>testdb=# delete from tb2 where id=1;<br>DELETE 1<br>Time: 1.343 ms<br>testdb=# select *from tb2;<br> id | name <br>----+------<br>  2 | c<br>(1 row)<br><br>Time: 0.369 ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">清空表</span><br>testdb=# truncate tb1;<br>TRUNCATE TABLE<br>Time: 17.382 ms<br>testdb=# select *from tb1;<br> id | name <br>----+------<br>(0 rows)<br><br>Time: 0.492 ms<br></code></pre></td></tr></table></figure>

<p>范例：查看表的列信息及大小</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# \d tb2;<br>                                   Table &quot;public.tb2&quot;<br> Column |         Type          | Collation | Nullable |             Default             <br>--------+-----------------------+-----------+----------+---------------------------------<br> id     | integer               |           | not null | nextval(&#x27;tb2_id_seq&#x27;::regclass)<br> name   | character varying(10) |           |          | <br><br>testdb=# select pg_column_size(name),name from tb2;<br> pg_column_size | name <br>----------------+------<br>              2 | c<br>(1 row)<br><br>Time: 0.657 ms<br><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# select generate_series(3,6);<br> generate_series <br>-----------------<br>               3<br>               4<br>               5<br>               6<br>(4 rows)<br><br>Time: 0.396 ms<br><br></code></pre></td></tr></table></figure>

<h3 id="3-5-10索引管理"><a href="#3-5-10索引管理" class="headerlink" title="3.5.10索引管理"></a>3.5.10索引管理</h3><p>范例：创建和删除索引</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# create table tb3(id int ,info text,crt_time timestamp);<br>CREATE TABLE<br>Time: 1.983 ms<br>Time: 0.156 ms<br>testdb=# insert into tb3 select generate_series(1,100000),md5(random()::text),clock_timestamp();<br>INSERT 0 100000<br>Time: 89.557 ms<br>testdb=# select * from tb3 limit<br><br>testdb=# select * from tb3 limit<br><br>testdb=# select * from tb3 limit 3;<br> id |               info               |          crt_time          <br>----+----------------------------------+----------------------------<br>  1 | 807fa46a88b8ab5e45bd61be7b18e9e9 | 2023-09-18 22:35:03.679105<br>  2 | 63915e1784a5097c2f283252c488092e | 2023-09-18 22:35:03.679251<br>  3 | ccfb37b70d8be4c5de76debf6fabd1bd | 2023-09-18 22:35:03.679254<br>(3 rows)<br><br>Time: 0.354 ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建索引</span><br>testdb=# create index idx_tb3_id on tb3(id);<br>CREATE INDEX<br>Time: 20.280 ms<br>testdb=# \d tb3<br>                           Table &quot;public.tb3&quot;<br>  Column  |            Type             | Collation | Nullable | Default <br>----------+-----------------------------+-----------+----------+---------<br> id       | integer                     |           |          | <br> info     | text                        |           |          | <br> crt_time | timestamp without time zone |           |          | <br>Indexes:<br>    &quot;idx_tb3_id&quot; btree (id)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除索引</span><br>testdb=# drop index idx_tb3_id ;<br>DROP INDEX<br>Time: 1.694 ms<br>testdb=# \d tb3<br>                           Table &quot;public.tb3&quot;<br>  Column  |            Type             | Collation | Nullable | Default <br>----------+-----------------------------+-----------+----------+---------<br> id       | integer                     |           |          | <br> info     | text                        |           |          | <br> crt_time | timestamp without time zone |           |          | <br><br></code></pre></td></tr></table></figure>

<p>范例：使用索引</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">打开时间</span><br>testdb=# \timing on<br>Timing is on.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询条件是索引列</span><br>testdb=# explain analyze select * from tb3 where id = 99999;<br>                                                   QUERY PLAN                                                    <br>-----------------------------------------------------------------------------------------------------------------<br> Index Scan using idx_tb3_id on tb3  (cost=0.29..8.31 rows=1 width=45) (actual time=0.008..0.008 rows=1 loops=1)<br>   Index Cond: (id = 99999)<br> Planning Time: 0.129 ms<br> Execution Time: 0.026 ms<br>(4 rows)<br><br>Time: 0.406 ms<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询条件不是索引列</span><br>testdb=# explain analyze select * from tb3 where id = 99999;<br>                                           QUERY PLAN                                            <br>-------------------------------------------------------------------------------------------------<br> Seq Scan on tb3  (cost=0.00..2185.00 rows=1 width=45) (actual time=3.982..3.983 rows=1 loops=1)<br>   Filter: (id = 99999)<br>   Rows Removed by Filter: 99999<br> Planning Time: 0.085 ms<br> Execution Time: 3.997 ms<br>(5 rows)<br><br>Time: 4.599 ms<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭索引</span><br>testdb=# set enable_indexscan =off;<br>SET<br>Time: 0.144 ms<br>testdb=# set enable_bitmapscan =off;<br>SET<br>Time: 0.122 ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">再次查询全表扫描</span><br>testdb=# explain analyze select * from tb3 where id = 99999;<br>                                           QUERY PLAN                                            <br>-------------------------------------------------------------------------------------------------<br> Seq Scan on tb3  (cost=0.00..2185.00 rows=1 width=45) (actual time=3.849..3.850 rows=1 loops=1)<br>   Filter: (id = 99999)<br>   Rows Removed by Filter: 99999<br> Planning Time: 0.042 ms<br> Execution Time: 3.861 ms<br>(5 rows)<br><br>Time: 4.155 ms<br><br>testdb=# explain (analyze,verbose,costs,buffers,timing) select * from tb3 where id = 99999;<br>                                               QUERY PLAN                                               <br>--------------------------------------------------------------------------------------------------------<br> Seq Scan on public.tb3  (cost=0.00..2185.00 rows=1 width=45) (actual time=4.357..4.358 rows=1 loops=1)<br>   Output: id, info, crt_time<br>   Filter: (tb3.id = 99999)<br>   Rows Removed by Filter: 99999<br>   Buffers: shared hit=935<br> Planning Time: 0.039 ms<br> Execution Time: 4.370 ms<br>(7 rows)<br><br>Time: 4.730 ms<br><br></code></pre></td></tr></table></figure>



<h3 id="3-5-11表空间"><a href="#3-5-11表空间" class="headerlink" title="3.5.11表空间"></a>3.5.11表空间</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">列出所有表空间，实际上PostgresQL中的表空间就是对应一个目录，放在这个表空间的表，就是把表的数据文件放到这个表空间下。</span><br>hellodb=# select * from teachers;<br> tid |     name      | age | gender <br>-----+---------------+-----+--------<br>   1 | Song Jiang    |  45 | M<br>   2 | Zhang Sanfeng |  94 | M<br>   3 | Miejue Shitai |  77 | F<br>   4 | Lin Chaoying  |  93 | F<br>(4 rows)<br><br>hellodb=# copy teachers to &#x27;/tmp/teachers1.txt&#x27;;<br>COPY 4<br><br>[22:19:46 root@Master-DNS ~]#cat /tmp/teachers1.txt<br>1	Song Jiang	45	M<br>2	Zhang Sanfeng	94	M<br>3	Miejue Shitai	77	F<br>4	Lin Chaoying	93	F<br><br></code></pre></td></tr></table></figure>

<p>范例：表空间pg_tblspc目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:52:08 postgres@Master-DNS ~]$mkdir ts1<br>[22:52:16 postgres@Master-DNS ~]$psql testdb<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>testdb=# create tablespace ts1 location &#x27;/home/postgres/ts1/&#x27;;<br>CREATE TABLESPACE<br>testdb=# \db<br>            List of tablespaces<br>    Name    |  Owner   |      Location      <br>------------+----------+--------------------<br> pg_default | postgres | <br> pg_global  | postgres | <br> ts1        | postgres | /home/postgres/ts1<br>(3 rows)<br>[22:54:24 postgres@Master-DNS ~]$readlink /pgsql/data/pg_tblspc/16472/ /home/postgres/ts1/<br><br></code></pre></td></tr></table></figure>

<p>范例：查看表空间对应的文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:58:03 postgres@Master-DNS ~]$mkdir /tmp/tbs1<br>[22:58:08 postgres@Master-DNS ~]$psql<br>testdb=# create tablespace tbs1 location &#x27;/tmp/tbs1&#x27;;<br>CREATE TABLESPACE<br>testdb=# create table tbs1 (id int ) tablespace tbs1;<br>CREATE TABLE<br>testdb=# select * from pg_relation_filepath (&#x27;tbs1&#x27;);<br>            pg_relation_filepath             <br>---------------------------------------------<br> pg_tblspc/16480/PG_12_201909212/16385/16481<br>(1 row)<br><br><br>[23:03:25 root@Master-DNS ~]#tree /pgsql/data/pg_tblspc/<br>/pgsql/data/pg_tblspc/<br>├── 16472 -&gt; /home/postgres/ts1<br>└── 16480 -&gt; /tmp/tbs1<br><br>2 directories, 0 files<br>[23:03:27 root@Master-DNS ~]#tree /tmp/tbs1/<br>/tmp/tbs1/<br>└── PG_12_201909212<br>    └── 16385<br>        └── 16481<br><br>2 directories, 1 file<br><br></code></pre></td></tr></table></figure>

<h3 id="3-5-12查看系统信息"><a href="#3-5-12查看系统信息" class="headerlink" title="3.5.12查看系统信息"></a>3.5.12查看系统信息</h3><p>可以通过系统函数查看系统信息，也可以通过show/set查看和修改配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看版本信息</span><br>testdb=# select version ();<br>                                                 version                                                 <br>---------------------------------------------------------------------------------------------------------<br> PostgreSQL 12.9 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 8.5.0 20210514 (Red Hat 8.5.0-18), 64-bit<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看数据库启动时间</span><br>testdb=# select pg_postmaster_start_time();<br>  pg_postmaster_start_time   <br>-----------------------------<br> 2023-09-18 15:02:06.5084+08<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看加载配置文件时间</span><br>testdb=# select pg_conf_load_time();<br>       pg_conf_load_time       <br>-------------------------------<br> 2023-09-18 23:09:33.130267+08<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看时区和时间</span><br>testdb=# show timezone;<br>   TimeZone    <br>---------------<br> Asia/Shanghai<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">临时修改</span><br>testdb=# set timezone=&#x27;Africa/Abidjan&#x27;;<br>SET<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">永久修改</span><br>[23:14:23 root@Master-DNS ~]#vim /pgsql/data/postgresql.conf<br>timezone = &#x27;Asia/Shanghai&#x27;<br>[23:19:17 postgres@Master-DNS ~]$pg_ctl reload<br>server signaled<br><br>postgres=# select now();<br>             now              <br>------------------------------<br> 2023-09-18 23:20:10.35019+08<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前用户</span><br>postgres=# select user;<br>   user   <br>----------<br> postgres<br>(1 row)<br><br>postgres=# select current_user;<br> current_user <br>--------------<br> postgres<br>(1 row)<br><br>postgres=# select session_user;<br> session_user <br>--------------<br> postgres<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前数据库</span><br>postgres=# \c <br>You are now connected to database &quot;postgres&quot; as user &quot;postgres&quot;.<br>postgres=# select current_database();<br> current_database <br>------------------<br> postgres<br>(1 row)<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前session所在的客户端IP和端口</span><br>postgres=# select inet_client_addr(),inet_client_port();<br> inet_client_addr | inet_client_port <br>------------------+------------------<br>                  |                 <br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前session所连接的数据库服务器的IP和端口</span><br>postgres=# select inet_server_addr(),inet_server_port();<br> inet_server_addr | inet_server_port <br>------------------+------------------<br>                  |                 <br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查询当前session对应的后台服务时进程PID</span><br>postgres=# select pg_backend_pid();<br> pg_backend_pid <br>----------------<br>           1671<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前内置变量</span><br>postgres=# \set<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前指定配置</span><br>postgres=# show max_connections ;<br> max_connections <br>-----------------<br> 100<br>(1 row)<br><br>postgres=# select current_setting(&#x27;max&#x27;)<br><br>postgres=# select current_setting(&#x27;max_connections&#x27;);<br> current_setting <br>-----------------<br> 100<br>(1 row)<br><br>postgres=# select current_setting(&#x27;listen_addresses&#x27;);<br> current_setting <br>-----------------<br> *<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看系统函数</span><br>postgres=# \dfS+<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看连接数</span><br>postgres=# select count(*) from pg_stat_activity;<br>count<br>7<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看最大连接数</span><br>postgres=# select setting from pg_settings where name = &#x27;max_connections&#x27;;<br>setting<br>100<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看所有设置名称</span><br>postgres=# select name from pg_settings;<br>name<br>allow_system_table_mods<br>application_name<br>archive_cleanup_command<br>archive_command<br>archive_mode<br>archive_timeout<br>array_nulls<br>authentication_timeout<br>autovacuum<br>autovacuum_analyze_scale_factor<br>autovacuum_analyze_threshold<br>autovacuum_freeze_max_age<br>autovacuum_max_workers<br>..........<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前设置名和值</span><br>postgres=# select name,setting from pg_settings;<br>                  name                  |            setting             <br>----------------------------------------+--------------------------------<br> allow_system_table_mods                | off<br> application_name                       | psql<br> archive_cleanup_command                | <br> archive_command                        | (disabled)<br> archive_mode                           | off<br> archive_timeout                        | 0<br> array_nulls                            | on<br> authentication_timeout                 | 60<br> autovacuum                             | on<br> autovacuum_analyze_scale_factor        | 0.1<br> autovacuum_analyze_threshold           | 50<br> autovacuum_freeze_max_age              | 200000000<br> autovacuum_max_workers                 | 3<br> autovacuum_multixact_freeze_max_age    | 400000000<br> autovacuum_naptime                     | 60<br> autovacuum_vacuum_cost_delay           | 2<br> autovacuum_vacuum_cost_limit           | -1<br> autovacuum_vacuum_scale_factor         | 0.2<br><br>.......<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看指定的当前额参数和设置</span><br>postgres=# show port;<br> port <br>------<br> 5432<br>(1 row)<br><br>postgres=# show archive_mode;<br> archive_mode <br>--------------<br> off<br>(1 row)<br><br></code></pre></td></tr></table></figure>

<p>范例：show和set查看和修改配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看参数</span><br>postgres=# show all;<br>                  name                  |            setting             |                                                        <br>  description                                                          <br>----------------------------------------+--------------------------------+--------------------------------------------------------<br>-----------------------------------------------------------------------<br> allow_system_table_mods                | off                            | Allows modifications of the structure of system tables.<br> application_name                       | psql                           | Sets the application name to be reported in statistics <br>and logs.<br> archive_cleanup_command                |                                | Sets the shell command that will be executed at every r<br>estart point.<br> archive_command                        | (disabled)                     | Sets the shell command that will be called to archive a<br> WAL file.<br> archive_mode                           | off                            | Allows archiving of WAL files using archive_command.<br> archive_timeout                        | 0                              | Forces a switch to the next WAL file if a new file has <br>not been started within N seconds.<br> array_nulls                            | on                             | Enable input of NULL elements in arrays.<br> authentication_timeout                 | 1min                           | Sets the maximum allowed time to complete client authen<br>tication.<br><br><br>postgres=# show maintenance_work_mem ;<br> maintenance_work_mem <br>----------------------<br> 64MB<br>(1 row)<br><br>postgres=# set maintenance_work_mem to &#x27;128MB&#x27;;<br>SET<br>postgres=# show maintenance_work_mem ;<br> maintenance_work_mem <br>----------------------<br> 128MB<br>(1 row)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：不是所有的配置都可以直接修改的</span><br>postgres=# set max_connections to &#x27;200&#x27;;<br>ERROR:  parameter &quot;max_connections&quot; cannot be changed without restarting the server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看数据库的大学，pg_size_pretty函数会把数字以MB，GB等易读格式显示</span><br>postgres=# select pg_database_size(&#x27;hellodb&#x27;),pg_size_pretty(pg_database_size(&#x27;hellodb&#x27;));<br> pg_database_size | pg_size_pretty <br>------------------+----------------<br>          7897603 | 7713 kB<br>(1 row)<br></code></pre></td></tr></table></figure>

<p>范例：explain可以查看SQL的执行计划</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">explain可以查看SQL的执行计划</span><br>hellodb=#explain select * from students;<br>                         QUERY PLAN                          <br>-------------------------------------------------------------<br> Seq Scan on students  (cost=0.00..14.90 rows=490 width=138)<br>(1 row)<br><br><br>hellodb=# explain analyze select * from students;<br>                                               QUERY PLAN                                               <br>--------------------------------------------------------------------------------------------------------<br> Seq Scan on students  (cost=0.00..14.90 rows=490 width=138) (actual time=4.891..4.894 rows=25 loops=1)<br> Planning Time: 0.027 ms<br> Execution Time: 4.903 ms<br>(3 rows)<br><br>hellodb=# explain analyze verbose select * from students;<br>                                                  QUERY PLAN                                                   <br>---------------------------------------------------------------------------------------------------------------<br> Seq Scan on public.students  (cost=0.00..14.90 rows=490 width=138) (actual time=0.005..0.007 rows=25 loops=1)<br>   Output: stuid, name, age, gender, classid, teacherid<br> Planning Time: 0.026 ms<br> Execution Time: 0.015 ms<br>(4 rows)<br><br></code></pre></td></tr></table></figure>

<h3 id="3-5-13查看用户和权限"><a href="#3-5-13查看用户和权限" class="headerlink" title="3.5.13查看用户和权限"></a>3.5.13查看用户和权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看所有用户\<span class="hljs-built_in">du</span>或者\dg</span><br><span class="hljs-meta prompt_">hellodb-# </span><span class="language-bash">\<span class="hljs-built_in">du</span></span><br>                                   List of roles<br> Role name |                         Attributes                         | Member of <br>-----------+------------------------------------------------------------+-----------<br> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">hellodb-# </span><span class="language-bash">\dg</span><br>                                   List of roles<br> Role name |                         Attributes                         | Member of <br>-----------+------------------------------------------------------------+-----------<br> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;<br><br><br><br>hellodb=# select user;<br>   user   <br>----------<br> postgres<br>(1 row)<br><br>hellodb=# select current<br><br>hellodb=# select current_user;<br> current_user <br>--------------<br> postgres<br>(1 row)<br><br>hellodb=# \z<br>                              Access privileges<br> Schema |   Name   | Type  | Access privileges | Column privileges | Policies <br>--------+----------+-------+-------------------+-------------------+----------<br> public | classes  | table |                   |                   | <br> public | coc      | table |                   |                   | <br> public | courses  | table |                   |                   | <br> public | scores   | table |                   |                   | <br> public | students | table |                   |                   | <br> public | teachers | table |                   |                   | <br> public | toc      | table |                   |                   | <br>(7 rows)<br><br>hellodb=# \z t1<br>                            Access privileges<br> Schema | Name | Type | Access privileges | Column privileges | Policies <br>--------+------+------+-------------------+-------------------+----------<br>(0 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">和\z功能相同</span><br>hellodb=# \dp<br>                              Access privileges<br> Schema |   Name   | Type  | Access privileges | Column privileges | Policies <br>--------+----------+-------+-------------------+-------------------+----------<br> public | classes  | table |                   |                   | <br> public | coc      | table |                   |                   | <br> public | courses  | table |                   |                   | <br><br></code></pre></td></tr></table></figure>

<h3 id="3-5-14事务管理和锁"><a href="#3-5-14事务管理和锁" class="headerlink" title="3.5.14事务管理和锁"></a>3.5.14事务管理和锁</h3><p>PGSQL的事务中支持DML,DDL(除了create database,create tablespace),DCL</p>
<p>在psql中事务是自动提交的。和MySQL相同，执行完一条delete或update语句后，事务就自动提交了如果不想自动提交，方法有两种。</p>
<p>方法一：运行begin;命令,然后执行DML,DDL,DCL等语句，最后再执行commit或rollback语句。</p>
<p>方法二：直接使用psql中的命令关闭自动提交的功能。\set AUTOCOMMIT off,注意，命令中的AUTOCOMMIT是大写的，不能使用小写，如果使用小写、虽然不会报错，但会导致关闭自动提交的操作不起作用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">开始事务</span><br>BEGIN [ISOLATION LEVEL &#123; SERIALIZABLE | REPEATABLE READ | READ COMMITTED | READUNCOMMITTED &#125;]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">提交和取消事务</span><br>COMMIT|ENDROLLBACK<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭自动提交，可以用ro11back取消DML语句</span><br>\set AUTOCOMMIT off<br>\set AUTOCOMMIT on<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看AUTOCOMMIT状态</span><br>\echo :AUTOCOMMIT<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看事务ID</span><br>select txid_current();<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs shell">testdb=# begin;<br>BEGIN<br>testdb=# create table tb5 (id int);<br>CREATE TABLE<br>testdb=# insert into tb5 values (1);<br>INSERT 0 1<br>testdb=# select * from tb5;<br> id <br>----<br>  1<br>(1 row)<br><br>testdb=# commit ;<br>COMMIT<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看事务<span class="hljs-built_in">id</span></span><br>testdb=# select txid_current();<br> txid_current <br>--------------<br>          544<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">事务块中不支持create database</span><br>testdb=# begin;<br>BEGIN<br>testdb=# create database db55;<br>ERROR:  CREATE DATABASE cannot run inside a transaction block<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看ctid（数据所在的数据块的编号及位移），Xmin（插入事务XID），Xmax（删除记录的事务XID）</span><br>testdb=# select ctid,xmin,xmax,* from tb3;<br>   ctid    | xmin | xmax |   id   |               info               |          crt_time          <br>-----------+------+------+--------+----------------------------------+----------------------------<br> (0,1)     |  527 |    0 |      1 | 807fa46a88b8ab5e45bd61be7b18e9e9 | 2023-09-18 22:35:03.679105<br> (0,2)     |  527 |    0 |      2 | 63915e1784a5097c2f283252c488092e | 2023-09-18 22:35:03.679251<br> (0,3)     |  527 |    0 |      3 | ccfb37b70d8be4c5de76debf6fabd1bd | 2023-09-18 22:35:03.679254<br> (0,4)     |  527 |    0 |      4 | 714f28197e1563a941936812dfcd8326 | 2023-09-18 22:35:03.679255<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看锁信息</span><br>testdb=# select relation::regclass,* from  pg_locks;<br> relation |  locktype  | database | relation | page | tuple | virtualxid | transactionid | classid | objid<br> | objsubid | virtualtransaction | pid  |      mode       | granted | fastpath <br>----------+------------+----------+----------+------+-------+------------+---------------+---------+------<br>-+----------+--------------------+------+-----------------+---------+----------<br> pg_locks | relation   |    16385 |    12143 |      |       |            |               |         |      <br> |          | 4/7                | 2832 | AccessShareLock | t       | t<br>          | virtualxid |          |          |      |       | 4/7        |               |         |      <br> |          | 4/7                | 2832 | ExclusiveLock   | t       | t<br>(2 rows)<br><br></code></pre></td></tr></table></figure>

<h3 id="3-5-15常用的系统函数"><a href="#3-5-15常用的系统函数" class="headerlink" title="3.5.15常用的系统函数"></a>3.5.15常用的系统函数</h3><p>官方内置系统函数帮助</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">#通过内置函数实现<br>http://postgres.cn/docs/12/functions-info.htm1<br>http://postgres.cn/docs/12/functions-admin.html<br></code></pre></td></tr></table></figure>

<p>常用系统函数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前日志文件1sn位置；</span><br>select pg_current_wal_lsn();<br>select pg_current_xlog_location();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">当前xlog buffer中的insert位置,注意和上面pg_current_xlog_location(O的区别：</span><br>SELECT pg_current_wal_insert_lsn();<br>select pg_current_xlog_insert_location();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看某个1sn对应的日志名：</span><br>select pg_walfile_name(lsn) ;<br>select pg_xlogfile_name(1sn);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看某个1sn在日志中的偏移量：</span><br>select pg_walfile_name_offset(&#x27;lsn号&#x27;);<br>select pg_xlogfile_name_offset(&#x27;1sn号&#x27;);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看两个1sn位置的差距；</span><br>select pg_wal_1sn_diff(&#x27;1sn号&#x27;,&#x27;1sn号&#x27;);<br>select pg_xlog_location_diff(&#x27;1sn号&#x27;,&#x27;1sn号&#x27;);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看备库接收到的1sn位置：</span><br>select pg_last_wal_receive_lsn0;<br>select pg_last_xlog_receive_location();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看备库回放的1sn位置：</span><br>select pg_last_xact_replay_timestamp();<br>select pg_last_xlog_relay_locationO;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建还原点：</span><br>select pg_create_restore_point(nowO::text);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看表的数据文件路径，filenode：</span><br>select pg_relation_filenode(&#x27;表名&#x27;);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看表students的oid:</span><br>select &#x27;students&#x27;::regclass::oid;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前会话pid：</span><br>select pg_backend_pid();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成序列：</span><br>select generate_series (1,8,2);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">生成uuid（pg13新特性）：</span><br>select gen_random_uuid();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重载配置文件信息：</span><br>select pg_reload_conf();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看数据库启动时间：</span><br>select pg_postmaster_start_time();<br></code></pre></td></tr></table></figure>





<h2 id="3-6用户和角色"><a href="#3-6用户和角色" class="headerlink" title="3.6用户和角色"></a>3.6用户和角色</h2><p>PostgresQL使用角色role的概念来管理数据库访问权限。角色是一系列相关权限的集合。为了管理方便，通常会把一系列相关的数据库权限赋给一个角色，如果哪个用户需要这些权限，就把角色赋给相应的用户。由于用户也拥有一系列的相关权限，为了简化管理，在PostgreSQL中，角色与用户是没有区别的，一个用户也是一个角色，因此可以把一个用户的权限赋给另一个用户。</p>
<p>用户和角色在整个数据库实例中都是全局的，即在同一个实例中的不同数据库中，看到的用户也都是相同的。</p>
<p>在初始化数据库实例时，会创建一个预定义的超级用户，这个用户的名称与初始化该数据库实例的操作系统用户名相同。比如：如果数据库实例是建立在操作系统用户dba（通常使用postgres 用户)下的，这个数据库超级用户的名称也会叫dba。可以用这个超级用户连接数据库，注意：dba默认会连接同名的数据库dba，而默认dba不存在，所以需要登录时指定连接数据库postgres进行登录，然后再创建其它的用户</p>
<h3 id="3-6-1创建用户和角色"><a href="#3-6-1创建用户和角色" class="headerlink" title="3.6.1创建用户和角色"></a>3.6.1创建用户和角色</h3><p>在PostgreSQL中，用户与角色是没有区别的。</p>
<p>用户和角色可以用来实现以下功能：</p>
<ul>
<li>用来登录数据库实例、</li>
<li>管理数据库对象</li>
</ul>
<p>创建用户与角色的语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">CREATE USER name [[WITH] option [ ...]]<br>CREATE ROLE name [[WITH] option [ ...]]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">上面两个命令都可以创建用户，不同的是CREATE USER创建的用户默认可以登录，而CREATE ROLE不可以登录</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">除了CREATE USER默认创建出来的用户有LOGIN的权限，而CREATE ROLE 创建出来的用户没有“LOGIN”的权限之外，CREATE RULE 与 CREATE USER没有其他任何的区别。</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">上面语法中的“option”可以是如下内容。</span><br>SUPERUSER|NOSUPERUSER：表示创建出来的用户是否为超级用户。只有超级用户才能创建超级用户。<br>CREATEDB /NOCREATEDB：指定创建出来的用户是否有执行“CREATE DATABASE&#x27;的权限。<br>CREATEROLE NOCREATEROLE：指定创建出来的用户是否有创建其他角色的权限。<br>CREATEUSER NOCREATEUSER：指定创建出来的用户是否有创建其他用户的权限。<br>INHERIT |NOINHERIT：如果创建的一个用户拥有某一个或某几个角色，这时若指定INHERIT，则表示用户自动拥有相应角色的权限，否则这个用户没有该角色的权限。<br>LOGIN|NOLOGIN：指定创建出来的用户是否有“LOGIN”的权限，可以临时地禁止一个用户的“LOGIN”权限，这时此用户就不能连接到数据库<br>CONNECTION LIMIT connlimit：指定该用户可以使用的并发连接数量。默认值是-1，表示没有限制。<br>[ENCRYPTED | UNENCRYPTED ] PASSWORD&#x27;paSSWord&#x27;：用于控制存储在系统表里面的口令是否加密。<br>VALID UNTIL&#x27;timestamp&#x27;：密码失效时间，如果不指定这个子句，那么口令将永远有效。<br>INROLE role name [，...]：指定用户成为哪些角色的成员，请注意没有任何选项可以把新角色添加为管理员，必须使用独立的GRANT命令来做这件事情。<br>IN GROUP role_name [,...]:与IN ROLE相同,是已过时的语法。<br>ROLE role_name [,...]:role_name将成为这个新建的角色的成员。<br>ADMIN role_name[,...]:role_name将有这个新建角色的WITH ADMIN OPTION权限。<br>USER role_name[,…]:与ROLE子句相同,但已过时。<br>SYSID uid：此子句主要是为了SQL向下兼容，实际没有什么用处。<br></code></pre></td></tr></table></figure>

<h3 id="3-6-2用户管理案例"><a href="#3-6-2用户管理案例" class="headerlink" title="3.6.2用户管理案例"></a>3.6.2用户管理案例</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看帮助</span><br>\h create user<br>\h alter user<br>\h drop user<br>\h create role<br>\h alter role<br>\h drop role<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">以下两个命令用法相似</span><br>create user	#创建的用户默认可以连接<br>create role	#创建的用户默认无法连接<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改用户</span><br>alter user<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除用户</span><br>drop user<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">显出所有用户和角色</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">\<span class="hljs-built_in">du</span>和\dg命令等价。原因是在PostgreSQL数据库中用户和角色不分的。</span><br>\du<br>\dg<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">创建可以登录的用户和密码</span><br>create user wang with password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建不可登录用户</span><br>create role zhao with password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建可以连接的用户</span><br>create role li with login password &#x27;123456&#x27; valid until &#x27;2025-12-31&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建管理员</span><br>create role admin with superuser login password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建复制用户</span><br>create role repl replication login  encrypted password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改密码</span><br>alter user admin with password &#x27;12345678&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改权限和密码</span><br>alter user wang with nologin password &#x27;123&#x27;;<br>alter user zhao with login ;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除用户</span><br>drop user zhao ;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看用户信息</span><br>\du<br><br>                                   List of roles<br> Role name |                         Attributes                         | Member of <br>-----------+------------------------------------------------------------+-----------<br> admin     | Superuser                                                  | &#123;&#125;<br> li        | Password valid until 2025-12-31 00:00:00+08                | &#123;&#125;<br> postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS | &#123;&#125;<br> repl      | Replication                                                | &#123;&#125;<br> wang      | Cannot login                                               | &#123;&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看指定用户信息</span><br>\du wang<br><br>            List of roles<br> Role name |  Attributes  | Member of <br>-----------+--------------+-----------<br> wang      | Cannot login | &#123;&#125;<br><br></code></pre></td></tr></table></figure>

<p>范例：修改 postgres用户密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">使用postgres用户登录（PostgresSQL安装后会自动创建postgres用户）</span><br>[root@rocky8 ~]#su -postgres<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">登录postgresq1数据库</span><br>[root@rocky8 ~]# psql -U postgres<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安全起见，修改数据库管理员postgres用户的密码</span><br>postgres=# ALTER USER postgres WITH ENCRYPTED PASSWORD &#x27;123456&#x27;;<br>ALTER ROLE<br></code></pre></td></tr></table></figure>

<h3 id="3-6-3权限管理"><a href="#3-6-3权限管理" class="headerlink" title="3.6.3权限管理"></a>3.6.3权限管理</h3><p>在PostgreSQL数据库中，每个数据库的对象（包括数据库）都有一个所有者，也就是说任何数据库对象都是属于某个用户的，所有者默认就拥有所有权限。所以不需要把对象的权限再赋给所有者。自己创建的数据库对象，自己当然有全部的权限。当然，所有者出于安全考虑也可以选择废弃一些自己的权限。在PostsgreSQL数据库中，删除一个对象及任意修改它的权利是所有者固有的，不能被赋予或撤销。所有者也隐含地拥有把操作该对象的权限赋给别人的权利。</p>
<p>一个用户的权限分为两类，一类是在创建用户时就指定的权限，这些权限如下：</p>
<ul>
<li>超级用户的权限</li>
<li>创建数据库的权限</li>
<li>是否允许LOGIN的权限</li>
</ul>
<p>以上这些权限是创建用户时指定的，后续可使用ALTER ROLE命令来修改。</p>
<p>还有一类权限，是由命令GRANT和REVOKE来管理的，这些权限如下：</p>
<ul>
<li>在数据库中创建模式（SCHEMA)</li>
<li>允许在指定的数据库中创建临时表连接某个数据库</li>
<li>在模式中创建数据库对象，如创建表、视图函数等</li>
<li>在一些表中做SELECT、UPDATE、INSERRDELETE等操作等</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">GRANT命令有两个作用</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">1.让某个用户成为某个角色的成员，从而使其拥有角色的权限：</span><br>GRANT role_name [, ...] T0 role_name [, ...] [ WITH ADMIN OPTION ];<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">2.把某些数据库逻辑结构对象的操作权限赋予某个用户(或角色)，命令的格式如下：</span><br>GRANT some_privileqes ON database_object_type object_name TO role_name;<br>其中,“some_privileges”表示在这个数据库对象中的权限,“database_object_type”是数据库对象的类型，如“TABLE”、“SEQUENCE”、“SCHEMA”，等。<br></code></pre></td></tr></table></figure>

<p><strong>PostgresQL中的权限是按以下几个层次进行管理的：</strong></p>
<ul>
<li>cluster权限：实例权限通过pg_hba.conf配置</li>
<li>管理赋在用户特殊属性上的权限，如超级用户的权限、创建数据库的权限、创建用户的权限、Login权限等</li>
<li>在数据库中创建模式的权限</li>
<li>表空间权限：通过grant/revoke控制权限操作表，物化视图，索引等</li>
<li>在模式中创建数据库对象的权限，如创建表、创建索引，等等</li>
<li>查询表、往表中插入数据、更新表、删除表中数据的权限</li>
<li>操作表中某些字段的权限</li>
</ul>
<h3 id="3-6-4权限案例"><a href="#3-6-4权限案例" class="headerlink" title="3.6.4权限案例"></a>3.6.4权限案例</h3><p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">授权创建新数据库</span><br>postgres=# alter user wang with createdb;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">database权限设置</span><br>grant create on DATABASE testdb to wang ;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">schema权限</span><br>alter schema wang owner to wang ;<br>grant SELECT,insert,update,delete on all tables in schema wang to wang ;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建<span class="hljs-built_in">test</span>的schema指定所有者为joe</span><br>create schema if not exists test authorization joe;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">object权限</span><br>GRANT select,insert,update,delete ON testdb.t1 TO wang;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建数据库并指定所有者的用户</span><br>create user wang with password &#x27;123456&#x27;;<br>create database zabbix owner wang ;<br></code></pre></td></tr></table></figure>

<p>范例：创建业务用户和授权</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# create database pinxixi;<br>postgres=#\c pinxixi<br>pinxixi=#create user wanrentuan with password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法1</span><br>pinxixi=#create schema wanrentuan;<br>pinxixi=#ALTER SCHEMA wanrentuan OWNER to wanrentuan;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法2</span><br>pinxixi=#CREATE SCHEMA AUTHORIZATION wanrentuan;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法3</span><br>pinxixi=#GRANT select, insert,update,delete oN ALL TABLES IN SCHEMA wanrentuanto wanrentuan;<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">将创建一个名为“<span class="hljs-built_in">readonly</span>”的用户</span><br>CREATE USER readonly with password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">把在public的schema下现有的所有表的SELECT 权限赋给用户<span class="hljs-built_in">readonly</span></span><br>GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;<br></code></pre></td></tr></table></figure>

<h2 id="3-7安装使用图形化工具pgadmin"><a href="#3-7安装使用图形化工具pgadmin" class="headerlink" title="3.7安装使用图形化工具pgadmin"></a>3.7安装使用图形化工具pgadmin</h2><h3 id="3-7-1-pgadmin介绍"><a href="#3-7-1-pgadmin介绍" class="headerlink" title="3.7.1 pgadmin介绍"></a>3.7.1 pgadmin介绍</h3><p>pgAdmin是一个免费的开源图形数据库管理工具，用于管理PostgreSQL和衍生的关系数据库，如EnterpriseDB的EDB Advanced Server。pgAdmin可以以两种模式安装：服务器模式和桌面模式。服务器模式下的pgAdmin可以部署在不同的Web服务器中,如:Apache,Nginx等</p>
<p>pgAdmin是一个在PostgreSQL许可下发布的免费软件项目。该软件可从PostgreSQL镜像网络以源代码和二进制格式获得。因为从源代码编译比较繁琐，建议尽可能使用安装二进制包。</p>
<p>pgAdmin 4是对pgAdmin的完全重写，使用Python和Javascript/jQuery构建</p>
<p>官网：<a target="_blank" rel="noopener" href="https://www.pgadmin.org/">https://www.pgadmin.org/</a></p>
<p>下载：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.pgadmin.org/download/<br>#容器版本<br>https://www.pgadmin.org/download/pgadmin-4-container/<br>#windows版本<br>https://www.postgresql.org/ftp/pgadmin/pgadmin4/v7.5/windows/<br>#阿里云<br>https://mirrors.aliyun.com/postgresql/pgadmin/pgadmin4<br></code></pre></td></tr></table></figure>

<h3 id="3-7-2安装pgadmin"><a href="#3-7-2安装pgadmin" class="headerlink" title="3.7.2安装pgadmin"></a>3.7.2安装pgadmin</h3><p>范例：安装Windows版本的pgadmin</p>
<p><img src="image-20230928215842789.png" srcset="/img/loading.gif" lazyload alt="image-20230928215842789"></p>
<p><img src="image-20230928220535120.png" srcset="/img/loading.gif" lazyload alt="image-20230928220535120"></p>
<p>范例：Ubuntu20.04安装pgadmin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@ubuntu2004:~# apt install pgadmin3 -y<br>root@ubuntu2004:~# pgadmin3<br></code></pre></td></tr></table></figure>

<p><img src="image-20230928222624337.png" srcset="/img/loading.gif" lazyload alt="image-20230928222624337"></p>
<p>范例：基于docker安装pgadmin</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rocky8 ~]#docker run -e PGADMIN_DEFAULT_EMAIL=xiaohexie@qq.com -e PGADMIN_DEFAULT_PASSWORD=123456 -d --name pgadmin -p 80:80   dpage/pgadmin4<br></code></pre></td></tr></table></figure>

<p><img src="image-20230928222451914.png" srcset="/img/loading.gif" lazyload alt="image-20230928222451914"></p>
<h1 id="4-PostgreSQL体系架构"><a href="#4-PostgreSQL体系架构" class="headerlink" title="4 PostgreSQL体系架构"></a>4 PostgreSQL体系架构</h1><h2 id="4-1体系架构概览"><a href="#4-1体系架构概览" class="headerlink" title="4.1体系架构概览"></a>4.1体系架构概览</h2><p>PostgreSQL和MySQL相似,也采用典型的C/S模型。</p>
<p>PostgreSQL体系结构分两部分</p>
<ul>
<li>实例 instance</li>
<li>磁盘存储</li>
</ul>
<p>实例 instance 包括</p>
<ul>
<li>进程</li>
<li>内存存储结构</li>
</ul>
<p><img src="image-20230928222852782.png" srcset="/img/loading.gif" lazyload alt="image-20230928222852782"></p>
<h2 id="4-2进程和内存结构"><a href="#4-2进程和内存结构" class="headerlink" title="4.2进程和内存结构"></a>4.2进程和内存结构</h2><p>PostgreSQL是进程架构模型，MySQL是线程架构模型。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">下图来自《POSTGRESQL修炼之道从小工到专家》<br></code></pre></td></tr></table></figure>

<p><img src="image-20230928223010570.png" srcset="/img/loading.gif" lazyload alt="image-20230928223010570"></p>
<h3 id="4-2-1进程"><a href="#4-2-1进程" class="headerlink" title="4.2.1进程"></a>4.2.1进程</h3><ul>
<li><p>Postmaster主进程</p>
<ul>
<li><p>它是整个数据库实例的主控制进程，负责启动和关闭该数据库实例。</p>
</li>
<li><p>实际上，使用pg ctl来启动数据库时，pg_ctl也是通过运行postgres来启动数据库的，只是它做了一些包装，更容易启动数据库。</p>
</li>
<li><p>它是第一个PostgresQL进程，此主进程还会fork出其他子进程，并管理它们。</p>
</li>
<li><p>当用户和PostgreSQL建立连接时，首先是和Postmaster进程建立连接。首先，客户端会发出身份验证的信息给Postmaster进程，Postmaster进程根据消息中的信息进行身份验证判断，如果验证通过，它会fork出一个会话子进程为这个连接服务。</p>
</li>
<li><p>当某个服务进程出现错误的时候，Postmaster主进程会自动完成系统的恢复。恢复过程中会停掉所有的服务进程，然后进行数据库数据的一致性恢复，等恢复完成后，数据库又可以接受新的连接。</p>
</li>
<li><p>验证功能是通过配置文件pg_hba.conf和用户验证模块来提供。</p>
</li>
<li><p>postmaster程序是指向postgres的软链接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:39:20 root@Master-DNS ~]#ll /aaps/pgsql/bin/postmaster <br>lrwxrwxrwx 1 root root 8 Sep 16 16:51 /aaps/pgsql/bin/postmaster -&gt; postgres<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>BgWriter 后台写进程</p>
<ul>
<li>为了提高插入、删除和更新数据的性能，当往数据库中插入或者更新数据时，并不会马上把数据持久化到数据文件中，而是先写入Buffer中</li>
<li>该辅助进程可以周期性的把内存中的脏数据刷新到磁盘中</li>
</ul>
</li>
<li><p>WalWriter 预写式日志进程</p>
<ul>
<li>WAL是write ahead log的缩写,WAL log旧版中称为xlog,相当于MySQL中Redo log</li>
<li>预写式日志是在修改数据之前，必须把这些修改操作记录到磁盘中，这样后面更新实际数据时，就不需要实时的把数据持久化到文件中了。即使机器突然宕机或者数据库异常退出，导致一部分内存中的脏数据没有及时的刷新到文件中，在数据库重启后，通过读取WAL日志，并把最后一部分WAL日志重新执行一遍，就能恢复到宕机时的状态了</li>
<li>WAL日志保存在pg_wal目录（早期版本为pg_xlog)下。每个xlog文件默认是16MB,为了满足恢复要求，在pg_wal目录下会产生多个WAL日志，这样就可保证在宕机后，未持久化的数据都可以通过WAL日志来恢复，那些不需要的WAL日志将会被自动覆盖</li>
</ul>
</li>
<li><p>Checkpointer 检查点进程</p>
<ul>
<li>检查点（Checkpoints)是事务序列中的点，保证在该点之前的所有日志信息都更新到数据文件中。</li>
<li>在检查点时，所有脏数据页都冲刷到磁盘并且向日志文件中写入一条特殊的检查点记录。在发生崩溃的时候，恢复器就知道应该从日志中的哪个点（称做redo记录）开始做REDO操作，因为在该记录前的对数据文件的任何修改都已经在磁盘上了。在完成检查点处理之后，任何在redo记录之前写的日志段都不再需要，因此可以循环使用或者删除。在进行WAL归档的时候，这些日志在循环利用或者删除之前应该必须先归档保存</li>
<li>检查点进程（CKPT)在特定时间自动执行一个检查点,通过向数据库写入进程(BgWriter)传递消息来启动检查点请求</li>
</ul>
</li>
<li><p>AutoVacuum 自动清理进程</p>
<ul>
<li>执行delete操作时，旧的数据并不会立即被删除，在更新数据时，也不会在旧的数据上做更新，而是新生成一行数据。旧的数据只是被标识为删除状态，在没有并发的其他事务读到这些旧数据时，它们才会被清除掉</li>
<li>autovacuum lanucher负责回收垃圾数据的master进程，如果开启了autovacuum的话，那么postmaster会fork这个进程</li>
<li>autovacuum worker负责回收垃圾数据的worker进程,是lanucher进程fork出来的</li>
</ul>
</li>
<li><p>PgStat统计数据收集进程</p>
<ul>
<li>此进程主要做数据的统计收集工作</li>
<li>收集的信息主要用于查询优化时的代价估算。统计的数据包括对一个表或索引进行的插入、删除、更新操作，磁盘块读写的次数以及行的读次数等。</li>
<li>系统表pg_statistic中存储了PgStat收集的各类统计信息</li>
</ul>
</li>
<li><p>PgArch归档进程</p>
<ul>
<li>默认没有此进程，开启归档功能后才会启动archiver进程</li>
<li>WAL日志文件会被循环使用，也就是说WAL日志会被覆盖，利用PgArch进程会在覆盖前把WAL日志备份出来，类似于binlog,可用于备份功能</li>
<li>PostgreSQL从8.X版本开始提供了PITR(Point-In-Time-Recovery)技术,即就是在对数据厍进行过一次全量备份后，该技术将备份时间点后面的WAL日志通过归档进行备份，将来可以使用数据库的全量备份再加上后面产生的WAL日志，即可把数据库向前恢复到全量备份后的任意一个时间点的状态</li>
</ul>
</li>
<li><p>SysLogger 系统日志进程</p>
<ul>
<li>默认没有此进程，配置文件postgresql.conf 设置参数logging_collect设置为“on”时，主进程才会启动SysLogger辅助进程</li>
<li>它从Postmaster主进程、所有的服务进程以及其他辅助进程收集所有的stderr输出，并将这些输出写入到日志文件中</li>
</ul>
</li>
<li><p>startup启动进程</p>
<ul>
<li>用于数据库恢复的进程</li>
</ul>
</li>
<li><p>Session 会话进程</p>
<ul>
<li>每一个用户发起连接后，一旦验证成功，postmaster进程就会fork一个新的子进程负责连接此用户。</li>
<li>通常表现为进程形式：postgres postgres [local] idle</li>
</ul>
</li>
</ul>
<p>案例：查看进程</p>
<p><img src="image-20230928224114461.png" srcset="/img/loading.gif" lazyload alt="image-20230928224114461"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:44:27 root@Master-DNS ~]#ps auxf|grep ^postgres<br>postgres     843  0.0  0.6 172536 17092 ?        Ss   21:43   0:00 /aaps/pgsql/bin/postmaster -D /pgsql/data/<br>postgres     910  0.0  0.1 172652  5628 ?        Ss   21:43   0:00  \_ postgres: checkpointer   <br>postgres     911  0.0  0.1 172536  4992 ?        Ss   21:43   0:00  \_ postgres: background writer   <br>postgres     912  0.0  0.2 172536  7628 ?        Ss   21:43   0:00  \_ postgres: walwriter   <br>postgres     913  0.0  0.2 173208  6192 ?        Ss   21:43   0:00  \_ postgres: autovacuum launcher   <br>postgres     914  0.0  0.1  27220  3240 ?        Ss   21:43   0:00  \_ postgres: stats collector   <br>postgres     915  0.0  0.1 172960  4968 ?        Ss   21:43   0:00  \_ postgres: logical replication launcher   <br></code></pre></td></tr></table></figure>

<p>范例：开启归档后再查看进程</p>
<p><img src="image-20230928225410387.png" srcset="/img/loading.gif" lazyload alt="image-20230928225410387"></p>
<h3 id="4-2-2内存结构"><a href="#4-2-2内存结构" class="headerlink" title="4.2.2内存结构"></a>4.2.2内存结构</h3><p>PostgreSQL的内存空间包括共享内存和本地内存两部分</p>
<ul>
<li>共享内存<ul>
<li>PostgresQL启动后，会生成一块共享内存，共享内存主要用做数据块的缓冲区，以便提高读写性能。WAL日志缓冲区和CLOG（Commit log）缓冲区也存在于共享内存中。除此以外，一些全局信息也保存在共享内存中，如进程信息、锁的信息、全局统计信息等。</li>
<li>PostgreSQL9.3之前的版本与Oracle数据库一样，都是使用“System V”类型的共享内存，但到PostgreSQL9.3之后，PostgreSQL使用mmap()方式共享内存，好处能使用较大的共享内存。</li>
<li>可以通过配置postgresql.conf文件中shared_buffers指定，默认128M,建议是内存的50%</li>
</ul>
</li>
</ul>
<p><img src="image-20230928225531109.png" srcset="/img/loading.gif" lazyload alt="image-20230928225531109"></p>
<ul>
<li><p>本地内存</p>
<p>后台服务进程除访问共享内存外，还会申请分配一些本地内存，以便暂存一些不需要全局存储的数据。</p>
<p>都可以通过在配置postgresql.conf文件中指定这些内存缓冲区主要有以下几类：</p>
<ul>
<li>temp_buffers：用于访问临时表的本地缓冲区，默认为8M</li>
<li>work_mem:内部排序操作和Hash表在使用临时磁盘文件之前使用的内存缓冲区,默认为4M</li>
<li>maintenance_work_mem:在维护性操作(比如VACUUM、CREATE INDEX和ALTERTABLEADD FOREIGN KEY等）中使用的内存缓冲区，默认为64M</li>
</ul>
</li>
</ul>
<p>范例：查看内存空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# show shared_buffers ;<br> shared_buffers <br>----------------<br> 128MB<br>(1 row)<br><br>postgres=# show maintenance_work_mem ;<br> maintenance_work_mem <br>----------------------<br> 64MB<br>(1 row)<br><br>postgres=# show work_mem ;<br> work_mem <br>----------<br> 4MB<br>(1 row)<br><br></code></pre></td></tr></table></figure>

<h3 id="4-3数据更新过程"><a href="#4-3数据更新过程" class="headerlink" title="4.3数据更新过程"></a>4.3数据更新过程</h3><p><img src="image-20230928225841837.png" srcset="/img/loading.gif" lazyload alt="image-20230928225841837"></p>
<ul>
<li>先将数据库文件中的更改的数据加载至内存</li>
<li>在内存更新数据</li>
<li>将日志写入内存WAL的缓存区</li>
<li>将日志提交，将日志写入操作系统cache</li>
<li>同步日志到磁盘</li>
<li>后台写数据库的更新后的数据到操作系统cache</li>
<li>写完数据后，更新检查点checkpoint</li>
<li>同步数据到磁盘</li>
</ul>
<h2 id="4-4数据库目录结构"><a href="#4-4数据库目录结构" class="headerlink" title="4.4数据库目录结构"></a>4.4数据库目录结构</h2><h3 id="4-4-1数据库目录介绍"><a href="#4-4-1数据库目录介绍" class="headerlink" title="4.4.1数据库目录介绍"></a>4.4.1数据库目录介绍</h3><p><img src="image-20230928230020677.png" srcset="/img/loading.gif" lazyload alt="image-20230928230020677"></p>
<p>数据库数据存放在环境变量PGDATA指向数据目录。这个目录是在安装时指定的，所以在安装时需要指定一个合适的目录作为数据目录的根目录，而且，每一个数据库实例都要有一个对应的目录。目录的初始化是使用initdb来完成的。</p>
<p>初始化完成后，PGDATA数据目录下就会生成三个配置文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgresql.conf#数据库实例的主配置文件，基本上所有的配置参数都在此文件中。<br>pg_hba.conf#认证配置文件，配置了允许哪些IP的主机访问数据库，认证的方法是什么等信息。<br>pg_ident.conf #认证方式ident的用户映射文件。<br></code></pre></td></tr></table></figure>

<p>此外在PGDATA目录下还会生成如下一些子目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">base #默认表空间的目录，每个数据库都对应一个base目录下的子目录，每个表和索引对应一个独立文件<br>global #这个目录对应pg_globa1表空间，存放实例中的共享对象<br><span class="hljs-meta prompt_">pg_clog#</span><span class="language-bash">存储事务提交状态数据</span><br>pg_bba.conf #数据库访问控制文件<br><span class="hljs-meta prompt_">pg_1og#</span><span class="language-bash">数据库系统日志目录，在查询一些系统错误时就可查看此目录下日志文件。(根据配置定义，可能没有这个目录）</span><br>pg_xact #提交日志commit log的目录,pg 9之前叫<br><span class="hljs-meta prompt_">pg_clogpg_multixact#</span><span class="language-bash">共享行锁的事务状态数据</span><br>pg_notify #异步消息相关的状态数据pg_serial #串行隔离级别的事务状态数据<br>pg_snapshots #存储执行了事务snapshot导出的状态数据<br>pg_stat_tmp #统计信息的临时文件<br>pg_subtrans #子事务状态数据<br><span class="hljs-meta prompt_">pg_stat#</span><span class="language-bash">统计信息的存储目录。关闭服务时,将pg_stat_tmp目录中的内容移动至此目录实现保存</span><br>pg_stat_tmp #统计信息的临时存储目录。开启数据库时存放统计信息<br><span class="hljs-meta prompt_">pg_tblsp#</span><span class="language-bash">存储了指向各个用户自建表空间实际目录的链接文件</span><br><span class="hljs-meta prompt_">pg_twophase#</span><span class="language-bash">使用两阶段提交功能时分布式事务的存储目录</span><br>pg_wal #WAL日志的目录，早期版一本目录为<br>pg_xlogPG_VERSION #数据库版本<br>postmaster.opts #记录数据库启动时的命令行选项<br>postmaster.pid#数据库启动的主进程信息文件，包括PID，SPGDATA目录，数据库启动时间，监听端口，socket文件路径，临听地址，共享内存的地址信息(ipsc可查看），主进程状态<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:43:39 root@Master-DNS ~]#ll $PGDATA<br>total 64<br>drwx------ 11 postgres postgres   123 Sep 27 17:48 base<br>drwx------  2 postgres postgres  4096 Sep 28 22:05 global<br>drwx------  2 postgres postgres     6 Sep 16 16:51 pg_commit_ts<br>drwx------  2 postgres postgres     6 Sep 16 16:51 pg_dynshmem<br>-rw-------  1 postgres postgres  4795 Sep 16 22:12 pg_hba.conf<br>-rw-------  1 postgres postgres  1636 Sep 16 16:51 pg_ident.conf<br>drwx------  4 postgres postgres    68 Sep 28 21:48 pg_logical<br>drwx------  4 postgres postgres    36 Sep 16 16:51 pg_multixact<br>drwx------  2 postgres postgres    18 Sep 28 21:43 pg_notify<br>drwx------  2 postgres postgres     6 Sep 16 16:51 pg_replslot<br>drwx------  2 postgres postgres     6 Sep 16 16:51 pg_serial<br>drwx------  2 postgres postgres     6 Sep 16 16:51 pg_snapshots<br>drwx------  2 postgres postgres     6 Sep 28 21:43 pg_stat<br>drwx------  2 postgres postgres   168 Sep 28 23:03 pg_stat_tmp<br>drwx------  2 postgres postgres    18 Sep 16 16:51 pg_subtrans<br>drwx------  2 postgres postgres    32 Sep 18 23:00 pg_tblspc<br>drwx------  2 postgres postgres     6 Sep 16 16:51 pg_twophase<br>-rw-------  1 postgres postgres     3 Sep 16 16:51 PG_VERSION<br>drwx------  3 postgres postgres  4096 Sep 18 22:46 pg_wal<br>drwx------  2 postgres postgres    18 Sep 16 16:51 pg_xact<br>-rw-------  1 postgres postgres    88 Sep 16 16:51 postgresql.auto.conf<br>-rw-------  1 postgres postgres 26808 Sep 16 21:25 postgresql.conf<br>-rw-------  1 postgres postgres    45 Sep 28 21:43 postmaster.opts<br>-rw-------  1 postgres postgres    68 Sep 28 21:43 postmaster.pid<br><br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">[23:03:24 root@Master-DNS ~]#ls /pgsql/data<br>base          pg_hba.conf    pg_notify     pg_stat      pg_twophase  postgresql.auto.conf<br>global        pg_ident.conf  pg_replslot   pg_stat_tmp  PG_VERSION   postgresql.conf<br>pg_commit_ts  pg_logical     pg_serial     pg_subtrans  pg_wal       postmaster.opts<br>pg_dynshmem   pg_multixact   pg_snapshots  pg_tblspc    pg_xact      postmaster.pid<br>[23:04:00 root@Master-DNS ~]#cat /pgsql/data/PG_VERSION <br>12<br>[23:04:17 root@Master-DNS ~]#cat /pgsql/data/postgresql.auto.conf <br><span class="hljs-meta prompt_"># </span><span class="language-bash">Do not edit this file manually!</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">It will be overwritten by the ALTER SYSTEM <span class="hljs-built_in">command</span>.</span><br><br><br>[23:04:33 root@Master-DNS ~]#cat /pgsql/data/postmaster.opts <br>/aaps/pgsql/bin/postgres &quot;-D&quot; &quot;/pgsql/data/&quot;<br>[23:05:05 root@Master-DNS ~]#cat /pgsql/data/postmaster.pid <br>843<br>/pgsql/data<br>1695908629<br>5432<br>/tmp<br>*<br>  5432001         0<br>ready   <br>[23:05:12 root@Master-DNS ~]#find /tmp/ -type s -ls<br>   741700      0 srwxrwxrwx   1  postgres postgres        0 Sep 28 22:41 /tmp/.s.PGSQL.5432<br><br></code></pre></td></tr></table></figure>

<h3 id="4-4-2-postgresql-conf配置项"><a href="#4-4-2-postgresql-conf配置项" class="headerlink" title="4.4.2 postgresql.conf配置项"></a>4.4.2 postgresql.conf配置项</h3><p>PostgresQL的配置参数是在postgresql.conf文件中集中管理的，这个文件位于数据库实例的目录下$PGDATA</p>
<ul>
<li><p>此文件中的每个参数配置项的格式都是“参数名=参数值”</p>
</li>
<li><p>配置文件中可以使用“#”注释。</p>
</li>
<li><p>所有配置项的参数名都是大小写不敏感的</p>
</li>
<li><p>参数值有以下五种类型。</p>
<p>布尔：布尔值都是大小写无关的，可以是on、off、true,false、yes、no、1、0。</p>
<p>整数：数值可以指定单位。如一些内存配置的参数可以指定KB、MB、GB等单位。另外还支持浮点数，字符串,枚举</p>
</li>
<li><p>postgresql.conf文件中可以使用include指令包含其他文件中的配置内容，如：include filename，如果指定被包含的文件名不是绝对路径，那么就相对于当前配置文件所在目录的相对路径。此外，包含还可以被嵌套。</p>
</li>
<li><p>所有的配置参数都在系统视图pg_settings中</p>
</li>
<li><p>$PGDATA目录下如果含有postgresql.conf和postgresql.auto.conf,而postgresql.auto.conf的优先级高于postgresql.conf,即如果一个参数同时存在postgresql.auto.conf和postgresql.conf里面，系统会先读postgresql.auto.conf的参数配置</p>
</li>
</ul>
<p>常用配置说明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">listen_addresses=&#x27;*&#x27;#监听客户端的地址，默认是本地的，需要修改为*或者0.0.0.0<br>port=5432#pg端口，默认是5432<br>max_connections=2000#最大连接数,默认100<br>unix_socket_directories #socket文件的位置,默认在/tmp下面<br>shared_buffers #数据缓存区,建议值1/4--1/2主机内存,和oracle的buffer cache类似<br>aintenance_work_mem #维护工作内存,用于vacuum,create index,reindex等。建议值(1/4主机内存)/autovacuum_max_workers<br>max_worker_processes #总worker数<br>max_para1lel_workers_per_gather #单条QuERY中, 每个node最多允许开启的并行计算wORKER数<br><span class="hljs-meta prompt_">wal_level#</span><span class="language-bash">wal级别，版本11+默认是</span><br>replicawal_buffers #类似oracle的log buffer<br>checkpoint_timeout #checkpoint时间间隔<br>max_wal_size #控制wal的最大数量<br>min_wal_size #控制wal的最小数量<br>archive_command #开启归档命令,示例：&#x27;test!-f /arch/%f &amp;&amp; cp %p /arch/%f&#x27;<br>autovacuum #开启自动vacuum<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# \d pg_settings;<br>               View &quot;pg_catalog.pg_settings&quot;<br>     Column      |  Type   | Collation | Nullable | Default <br>-----------------+---------+-----------+----------+---------<br> name            | text    |           |          | <br> setting         | text    |           |          | <br> unit            | text    |           |          | <br> category        | text    |           |          | <br> short_desc      | text    |           |          | <br> extra_desc      | text    |           |          | <br> context         | text    |           |          | <br> vartype         | text    |           |          | <br> source          | text    |           |          | <br> min_val         | text    |           |          | <br> max_val         | text    |           |          | <br> enumvals        | text[]  |           |          | <br> boot_val        | text    |           |          | <br> reset_val       | text    |           |          | <br> sourcefile      | text    |           |          | <br> sourceline      | integer |           |          | <br> pending_restart | boolean |           |          | <br><br>postgres=# select name,short_desc,setting from pg_settings where name like &#x27;listen_addresses&#x27;;<br>       name       |                     short_desc                     | setting <br>------------------+----------------------------------------------------+---------<br> listen_addresses | Sets the host name or IP address(es) to listen to. | *<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看运行时参数</span><br>postgres=# show listen_addresses ;<br> listen_addresses <br>------------------<br> *<br>(1 row)<br><br></code></pre></td></tr></table></figure>

<p>范例：查看和修改配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# show timezone;<br> TimeZone <br>----------<br> Etc/UTC<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">动态修改配置</span><br>postgres=# set timezone=&quot;Asia/Shanghai&quot;;<br>SET<br>postgres=# show timezone;<br>   TimeZone    <br>---------------<br> Asia/Shanghai<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">有些参数不支持动态修改</span><br>postgres=# set port =1234;<br>ERROR:  parameter &quot;port&quot; cannot be changed without restarting the server<br></code></pre></td></tr></table></figure>

<p>范例：postgresql.auto.conf文件优先于postgresql.conf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">[23:05:31 root@Master-DNS ~]#vim /pgsql/data/postgresql.auto.conf <br>port =1234<br>[23:18:15 root@Master-DNS ~]#vim /pgsql/data/postgresql.conf <br>post=5432<br>[23:18:53 root@Master-DNS ~]#systemctl restart postgresql<br>[23:19:06 root@Master-DNS ~]#ss -ntlp | grep post<br>LISTEN 0      244          0.0.0.0:1234      0.0.0.0:*    users:((&quot;postmaster&quot;,pid=2296,fd=3))<br>LISTEN 0      244             [::]:1234         [::]:*    users:((&quot;postmaster&quot;,pid=2296,fd=4))<br><br>[23:20:23 root@Master-DNS ~]#psql -p1234<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>postgres=# show port;<br> port <br>------<br> 1234<br>(1 row)<br><br></code></pre></td></tr></table></figure>

<h3 id="4-4-3-pg-ident-conf"><a href="#4-4-3-pg-ident-conf" class="headerlink" title="4.4.3 pg_ident.conf"></a>4.4.3 pg_ident.conf</h3><p>pg_ident.conf是用户映射配置文件。结合pg_hba.conf文件，method为ident可以用特定的操作系统用户以指定的数据库用户身份登录数据库。</p>
<p>这个文件记录着与操作系统用户匹配的数据库用户，如果某操作系统用户在本文件中没有映射用户，则默认的映射数据库用户与操作系统用户同名。比如，服务器上有名为user1的操作系统用户，同时数据库上也有同名的数据库用户user1，user1登录操作系统后可以直接输入psql，以user1数据库用户身份登录数据库且不需密码</p>
<p>如果操作系统用户和数据库用户不同名，可以用下面格式进行映射</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">pg_ident.conf如下实现操作系统<span class="hljs-built_in">test</span>用户映射为数据库用户dba</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">MAPNAME	SYSTEM-USERNAME PG-USERNAME</span>	<br>map1	test	dba<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">pg_hba.conf如下:</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">TYPE DATABASE USER CIDR-ADDRESS METHOD</span><br>local	all		all		ident	map=map1<br></code></pre></td></tr></table></figure>

<p>范例：操作系统用户和数据库用户同名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">[23:24:52 root@Master-DNS ~]#useradd -s /bin/bash  -m dba<br>[23:25:28 root@Master-DNS ~]#su - postgres<br>Last login: Mon Sep 18 23:27:06 CST 2023 on pts/1<br>[23:26:05 postgres@Master-DNS ~]$psql<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br>postgres=# create user dba with password &#x27;123456&#x27;;<br>CREATE ROLE<br><br>[root@ubuntu2004 ~]#vim /pgsql/data/pg_hba.conf<br>local 		all 	 	all			ident<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务，然后测试连接</span><br>[23:29:38 root@Master-DNS ~]#su - dba<br>[23:30:47 dba@Master-DNS ~]$psql<br><br></code></pre></td></tr></table></figure>

<p>范例：操作系统用户和数据库用户不同名</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell">postgres=# create user dba with password &#x27;123456&#x27;;<br><br>[23:35:59 root@Master-DNS ~]#useradd -s /bin/bash -m test<br>[23:36:12 root@Master-DNS ~]#vim /pgsql/data/pg_ident.conf <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">MAPNAME       SYSTEM-USERNAME         PG-USERNAME</span><br>map1            test                    dba<br><br>[23:37:17 root@Master-DNS ~]#vim /pgsql/data/pg_hba.conf <br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-string">&quot;local&quot;</span> is <span class="hljs-keyword">for</span> Unix domain socket connections only</span><br>local   all             all             ident                   map=map1<br>local   all             all            trust<br><br>[23:41:37 root@Master-DNS ~]#su - test<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">直接登录失败</span><br>[23:41:47 test@Master-DNS ~]$psql<br>psql: error: FATAL:  Peer authentication failed for user &quot;postgres&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">需要指定映射的数据库的用户和数据库</span><br>[23:41:53 test@Master-DNS ~]$psql -Udba postgres<br>psql (12.9)<br>Type &quot;help&quot; for help.<br><br><br></code></pre></td></tr></table></figure>

<h3 id="4-4-4数据文件"><a href="#4-4-4数据文件" class="headerlink" title="4.4.4数据文件"></a>4.4.4数据文件</h3><p>PostgresQL中的每个索引和表都是一个单独的文件，称为Segment。默认是每个大于1G的Segment会被分割pg_class.efilenode.1这样的文件。Segment的大小可以在initdb时通过选项—with-segsize=SEGSIZE指定</p>
<p>注意：truncate表之后relfilenode会变。对应的物理文件名字也会变。</p>
<p>Segment 物理位置</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">$PGDATA/BASE/DATABASE_OID/PG_CLASS.RELFILENODE<br></code></pre></td></tr></table></figure>

<p>范例：数据文件路径</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell">[23:46:28 root@Master-DNS postgresql-12.9]#./configure --help | grep size<br>  --with-blocksize=BLOCKSIZE<br>                          set table block size in kB [8]<br>  --with-segsize=SEGSIZE  set table segment size in GB [1]<br>  --with-wal-blocksize=BLOCKSIZE<br>                          set WAL block size in kB [8]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看数据目录路径</span><br>postgres=# show data_directory;<br> data_directory <br>----------------<br> /pgsql/data<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看数据库的OID</span><br>testdb=# select oid,datname from pg_database ;<br>  oid  |  datname  <br>-------+-----------<br> 12726 | postgres<br>     1 | template1<br> 12725 | template0<br> 16386 | db2<br> 16425 | hellodb<br> 16385 | testdb<br> 16499 | zabbix<br> 16500 | pinxixi<br>(8 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看表的node</span><br>testdb=# select relfilenode from pg_class where relname=&#x27;tb1&#x27;;<br> relfilenode <br>-------------<br>       16421<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看指定表的目录路径</span><br>testdb=# select pg_relation_filepath(&#x27;tb1&#x27;);<br> pg_relation_filepath <br>----------------------<br> base/16385/16421<br>(1 row)<br><br><br>[23:53:35 root@Master-DNS ~]#ls -l $PGDATA/base/16385/16421<br>-rw------- 1 postgres postgres 0 Sep 18 22:14 /pgsql/data/base/16385/16421<br></code></pre></td></tr></table></figure>

<h3 id="4-4-5控制文件"><a href="#4-4-5控制文件" class="headerlink" title="4.4.5控制文件"></a>4.4.5控制文件</h3><p>控制文件存放了数据库当前的状态，存放在PGDATA/global/pg_control</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">PG12版的控制文件</span><br>[23:53:50 root@Master-DNS ~]#file /pgsql/data/global/pg_control <br>/pgsql/data/global/pg_control: data<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看控制文件内容</span><br>[23:55:05 root@Master-DNS ~]#pg_controldata $PGDATA<br>pg_control version number:            1201<br>Catalog version number:               201909212<br>Database system identifier:           7279343838565676768<br>Database cluster state:               in production<br>pg_control last modified:             Thu 28 Sep 2023 11:54:48 PM CST<br>Latest checkpoint location:           0/160BBA60<br>Latest checkpoint&#x27;s REDO location:    0/160BBA28<br>Latest checkpoint&#x27;s REDO WAL file:    000000010000000000000016<br>Latest checkpoint&#x27;s TimeLineID:       1<br>Latest checkpoint&#x27;s PrevTimeLineID:   1<br>Latest checkpoint&#x27;s full_page_writes: on<br>Latest checkpoint&#x27;s NextXID:          0:572<br>Latest checkpoint&#x27;s NextOID:          16505<br>Latest checkpoint&#x27;s NextMultiXactId:  1<br>Latest checkpoint&#x27;s NextMultiOffset:  0<br>Latest checkpoint&#x27;s oldestXID:        479<br>Latest checkpoint&#x27;s oldestXID&#x27;s DB:   1<br>Latest checkpoint&#x27;s oldestActiveXID:  572<br>Latest checkpoint&#x27;s oldestMultiXid:   1<br>Latest checkpoint&#x27;s oldestMulti&#x27;s DB: 1<br>Latest checkpoint&#x27;s oldestCommitTsXid:0<br>Latest checkpoint&#x27;s newestCommitTsXid:0<br>Time of latest checkpoint:            Thu 28 Sep 2023 11:54:48 PM CST<br>Fake LSN counter for unlogged rels:   0/3E8<br>Minimum recovery ending location:     0/0<br>Min recovery ending loc&#x27;s timeline:   0<br>Backup start location:                0/0<br>Backup end location:                  0/0<br>End-of-backup record required:        no<br>wal_level setting:                    replica<br>wal_log_hints setting:                off<br>max_connections setting:              100<br>max_worker_processes setting:         8<br>max_wal_senders setting:              10<br>max_prepared_xacts setting:           0<br>max_locks_per_xact setting:           64<br>track_commit_timestamp setting:       off<br>Maximum data alignment:               8<br>Database block size:                  8192<br>Blocks per segment of large relation: 131072<br>WAL block size:                       8192<br>Bytes per WAL segment:                16777216<br>Maximum length of identifiers:        64<br>Maximum columns in an index:          32<br>Maximum size of a TOAST chunk:        1996<br>Size of a large-object chunk:         2048<br>Date/time type storage:               64-bit integers<br>Float4 argument passing:              by value<br>Float8 argument passing:              by value<br>Data page checksum version:           0<br>Mock authentication nonce:            0252a000a90d5b92c4693733806542ce09fc290e6763a9c90b14ab4989e19352<br><br></code></pre></td></tr></table></figure>

<h3 id="4-4-6日志文件"><a href="#4-4-6日志文件" class="headerlink" title="4.4.6日志文件"></a>4.4.6日志文件</h3><h4 id="4-4-6-1日志种类"><a href="#4-4-6-1日志种类" class="headerlink" title="4.4.6.1日志种类"></a>4.4.6.1日志种类</h4><ul>
<li>运行日志：$PGDATA/log(pg10之前为$PGDATA/pg_log),默认不存在，需要开启配置项logging_collector</li>
<li>在线重做日志：$PGDATA/pg_wal(pg10之前为$PGDATA/pg_xlog)</li>
<li>事务提交日志：$PGDATA/pg_xact(pg10之前为$PGDATA/pg_clog)</li>
<li>服务器日志：可以在启动的时候指定：pg_ctl start-I./logfile</li>
</ul>
<h4 id="4-4-6-2运行日志"><a href="#4-4-6-2运行日志" class="headerlink" title="4.4.6.2运行日志"></a>4.4.6.2运行日志</h4><h5 id="4-4-6-2-1运行日志配置项"><a href="#4-4-6-2-1运行日志配置项" class="headerlink" title="4.4.6.2.1运行日志配置项"></a>4.4.6.2.1运行日志配置项</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs shell">logging_collector:这个参数启用日志收集器，它是一个捕捉被发送到stderr的日志消息的后台进程，并且它会将这些消息重定向到日志文件中；默认是OFF，修改参数需要重启。<br><br>log_destination:有三种输出方法,stderr,csvlog,syslog:在windows上还支持eventlog。默认是stderr,如果使用csvlog的话，logging_collector必须开启。也可以同时使用csvlog和stderr,会记录两种格式的日志。<br><br>1og_directory:指定日志的存放位置,默认是$PGDATA/<br><br>loglog_filename:日志的命名格式,默认是postgresql-%Y-%m-%d_%H%M%s.log。支持strftime格式<br><br>log_file_mode:当logging_collector被启用时,这个参数设置日志文件的权限(在 windows 上这个参数将被忽略）。这个参数值应当是一个数字形式的模式，它可以被chmod和umask系统调用接受（要使用通常的十进制格式，该数字必须以一个0（零）开始）。默认的权限是0600，表示只有服务器拥有者才能读取或写入日志文件。其他常用的设置是0640，它允许拥有者的组成员读取文件。不过要注意你需要修改log_directory为将文件存储在集簇数据目录之外的某个位置，才能利用这个设置。<br><br>1og_rotation_age:当1ogging_col1ector被启用时,这个参数决定一个个体日志文件的最长生命期。当这些分钟过去后，一个新的日志文件将被创建。将这个参数设置为零将禁用基于时间的新日志文件创建。<br><br>1og_rotation_size:当1ogging_co11ector被启用时,这个参数决定一个个体日志文件的最大尺寸。当这么多千字节被发送到一个日志文件后，将创建一个新的日志文件。将这个参数设置为零将禁用基于尺寸的新日志文件创建。log_truncate_on_rotation:默认为off,设置为on的话,如果新建了一个同名的日志文件，则会清空原来的文件，再写入日志，而不是在后面追加。<br><br>1og_min_messages:控制哪些消息级别被写入到服务器日志。有效值是DEBUG5、DEBUG4、DEBUG3、DEBUG2、DEBUG1、INFO、NOTICE、WARNING、ERROR、LOG、FATAL和 PANIC。每个级别都包括以后的所有级别。级别越靠后，被发送的消息越少。默认值是WARNING。<br><br>1og_min_error_statement:控制哪些导致错误情况的 sQL 语句被记录在服务器日志中。。默认值是ERROR，要有效地关闭记录错误语句，将这个参数设置为PANIC。<br><br>log_min_duration_statement:相当于mysql的long_query_time,记录慢sQL,超过这个时间的sQL将会被记录到日志里。以ms为单位<br><br>log_checkpoints：导致检查点和重启点被记录在服务器日志中。一些统计信息也被包括在日志消息中，包括写入缓冲区的数据和写它们所花的时间。<br><br>log_connections：导致每一次尝试对服务器的连接被记录，客户端认证的成功完成也会被记录。只有超级用户能在会话开始时更改这个参数，在会话中它不能被更改。默认为off。<br><br>log_disconnections:导致会话终止也会被记录。日志输出提供的信息类似于 log_connections,不过还外加会话的持续时间。只有超级用户能在会话开始时更改这个参数，在会话中它不能被更改。默认为off。<br><br>1og_duration:导致每一个完成的语句的持续时间被记录。默认值是off。如果log_duration为on并且<br><br>log_min_duration_statement为正值，所有持续时间都将被记录，但是只有超过阈值的语句才会被记录查询文本。这种行为有助于在高负载安装中收集统计信息。<br><br>log_error_verbosity:有效值是TERSE、DEFAULT和VERBOSE,默认值是default,控制每条日志信息的详细程度，VERBOSE输出包括SQLSTATE错误码，以及产生错误的源代码文件名、函数名和行号<br><br>log_hostname:默认情况下，连接日志消息只显示连接主机的IP 地址。打开这个参数将导致也记录主机名。注意根据你的主机名解析设置，这可能会导致很微小的性能损失。<br><br>1og_line_prefix：设置日志输出格式(能够记录时间，用户名称，数据库名称，客户端IP和端口，方便定位问题）默认值是’%m [%p]’，它记录时间戳和进程ID。<br><br>log_lock_waits:控制当一个会话为获得一个锁等到超过deadlock_timeout时,是否要产生一个日志消息。这有助于决定是否锁等待造成了性能低下。默认值是off<br><br>1og_statement:控制哪些 sQL语句被记录。有效值是 none(off)、dd1、mod和 al1(所有语句）。默认值是none<br><br>log_replication_commands:每一个复制命令都被记录在服务器日志中。<br><br>log_temp_files:控制记录临时文件名和尺寸。临时文件可以被创建用来排序、哈希和存储临时查询结果。一个零值记录所有临时文件信息，而正值只记录尺寸大于或等于指定千字节数的文件。默认设置为-1，它禁用这种记录。<br><br>log_timezone：设置在服务器日志中写入的时间戳的时区。默认值是GMT。<br></code></pre></td></tr></table></figure>

<h5 id="4-4-6-2-2将csv格式运行日志存储至数据库"><a href="#4-4-6-2-2将csv格式运行日志存储至数据库" class="headerlink" title="4.4.6.2.2将csv格式运行日志存储至数据库"></a>4.4.6.2.2将csv格式运行日志存储至数据库</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell">[23:56:39 root@Master-DNS ~]#vim /pgsql/data/postgresql.conf<br>log_destination = &#x27;csvlog&#x27; <br>logging_collector = on<br><br>[00:05:38 root@Master-DNS ~]#systemctl restart postgresql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先创建对应的表结构，只适用于PG12</span><br>testdb=#CREATE TABLE pg_log(<br>log_time timestamp(3) with time zone,<br>user_name text,<br>database_name text,<br>process_id integer,<br>connection_from text,<br>session_id text,<br>session_line_num bigint,<br>command_tag text,<br>session_start_time timestamp with time zone,<br>virtual_transaction_id text,<br>transaction_id bigint,<br>error_severity text,<br>sql_state_code text,<br>message text,<br>detail text,<br>hint text,<br>interna7_query text,<br>interna7_query_pos integer,<br>context text,<br>query text,<br>query_pos integer,<br>location text,<br>application_name text,<br>PRIMARY KEY (session_id,session_line_num)<br>);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">将csv文件中的日志导入到表中</span><br>testdb=# copy pg_log from &#x27;/pgsql/data/log/postgresql-2023-09-29_000620.csv&#x27; with csv;<br>COPY 4<br></code></pre></td></tr></table></figure>

<h4 id="4-4-6-3在线WAL日志"><a href="#4-4-6-3在线WAL日志" class="headerlink" title="4.4.6.3在线WAL日志"></a>4.4.6.3在线WAL日志</h4><p>Online WAL（WRITE-AHEAD LOG）日志功能是为了保证崩溃后的安全，如果系统崩溃，可以“重放“从最后一次检查点以来的日志项来恢复数据库的一致性。但是也存在日志膨胀的问题，相当于MySQL的事务日志redo log</p>
<p>参考文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://www.postgresql.org/docs/12/runtime-config-wal.html<br></code></pre></td></tr></table></figure>

<h5 id="4-4-6-3-1-Online-WAL日志文件位置"><a href="#4-4-6-3-1-Online-WAL日志文件位置" class="headerlink" title="4.4.6.3.1 Online WAL日志文件位置"></a>4.4.6.3.1 Online WAL日志文件位置</h5><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">wal文件存放在$PGDATA/pg_wal下。PG10之前为pg_xlog<br></code></pre></td></tr></table></figure>



<h5 id="4-4-6-3-2设置Online-WAL日志的大小"><a href="#4-4-6-3-2设置Online-WAL日志的大小" class="headerlink" title="4.4.6.3.2设置Online WAL日志的大小"></a>4.4.6.3.2设置Online WAL日志的大小</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">初始化实例时，可以指定单个WAL文件的大小，默认16</span><br>Minitdb --wal-segsize=SIZE<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">WAL日志总的大小默认值</span><br>max_wal_size = 1GB<br>min_wal_size = 80MB<br><br>max_wal_size (integer)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">在自动WAL检查点之间允许WAL增长到的最大尺寸。这是一个软限制，在特殊的情况下WAL尺寸可能会超过max_wal_size,例如在重度负荷下、archive_command失败或者高的wal keep_segments设置。如果指定值时没有单位，则以兆字节为单位。默认为1GB。增加这个参数可能导致崩溃恢复所需的时间。这个参数只能在postgresql.conf 或者服务器命令行中设置。</span><br><br><br>min_wal_size (integer)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">只要WAL磁盘用量保持在这个设置之下，在检查点时旧的WAL文件总是被回收以便未来使用，而不是直接被删除。这可以被用来确保有足够的WAL空间被保留来应付WAL使用的高峰，例如运行大型的批处理任务。如果指定值时没有单位，则以兆字节为单位。默认是80MB。这个参数只能在postgresql.conf或者服务器命令行中设置。</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：PG9.4之前版本中的checkout_segments可以指定在自动的wAL检查点之间的日志文件段的最大数量(通常每个段16兆字节)。缺省是3。从pG9.5开始淘汰此配置项,用max_wal_size和min_wal_size代替</span><br></code></pre></td></tr></table></figure>

<h5 id="4-4-6-3-3-LSN和Online-WAL文件命名格式"><a href="#4-4-6-3-3-LSN和Online-WAL文件命名格式" class="headerlink" title="4.4.6.3.3 LSN和Online WAL文件命名格式"></a>4.4.6.3.3 LSN和Online WAL文件命名格式</h5><p>LSN:Log Sequence Number用于记录WAL文件当前的位置，这是WAL日志唯一的、全局的标识。WAL日志中写入是有顺序的，所以必须得记录WAL日志的写入顺序。而LSN就是负责给每条产生的WAL日志记录唯一的编号</p>
<p>WAL日志LSN编号规则：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">高32位/低32位<br></code></pre></td></tr></table></figure>

<p>WAL文件名称为16进制的24个字符组成，每8个字符一组</p>
<p>每组的意义如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs http">00000001 00000000 00000001<br>时间线    逻辑id    物理id<br>其中前8位：00000001表示time1ine<br>中间8位：00000000表示1ogid,即LSN高32位<br>最后8位：00000001表示1ogSeg，即LSN低32位/（2**24）的值，即低32位中最高8位，16进制的高2位<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前LSN</span><br>testdb=# select pg_current_wal_lsn();<br> pg_current_wal_lsn <br>--------------------<br> 0/160D8FB0<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#查看当前LSN对应的WAL日志文件</span></span><br>testdb=# select pg_walfile_name(pg_current_wal_lsn());<br>     pg_walfile_name      <br>--------------------------<br> 000000010000000000000016<br>(1 row)<br><br></code></pre></td></tr></table></figure>

<h5 id="4-4-6-3-4查看LSN和WAL文件对应关系"><a href="#4-4-6-3-4查看LSN和WAL文件对应关系" class="headerlink" title="4.4.6.3.4查看LSN和WAL文件对应关系"></a>4.4.6.3.4查看LSN和WAL文件对应关系</h5><p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前事务的ID</span><br>postgres=# select txid_current();<br> txid_current <br>--------------<br>          574<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前LSN号</span><br>postgres=# select pg_current_wal_lsn();<br> pg_current_wal_lsn <br>--------------------<br> 0/160D90C0<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前LSN对应的WAL日志文件</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">wAL日志文件中的最后8位的1ogSeg前6位始终是0,最后两位是LSN的低32位的前两位。如上例中1ogseg最后两位是61，LSN低32位的前两位也是61。</span><br>postgres=# select pg_walfile_name(pg_current_wal_lsn());<br>     pg_walfile_name      <br>--------------------------<br> 000000010000000000000016<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前WAL日志偏移量</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">LSN在WAL日志文件中的偏移量即LSN低32位中后24位对应的十进制值。如上面0001CO对应十进制即下面的448</span><br>postgres=# select pg_walfile_NAME_OFFSET(pg_current_wal_lsn());<br>      pg_walfile_name_offset       <br>-----------------------------------<br> (000000010000000000000016,889256)<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">按时间排序显示WAL文件名</span><br>postgres=# select * from pg_ls_waldir() order by modification asc;<br>           name           |   size   |      modification      <br>--------------------------+----------+------------------------<br> 000000010000000000000019 | 16777216 | 2023-09-18 21:32:47+08<br> 000000010000000000000017 | 16777216 | 2023-09-18 21:32:47+08<br> 000000010000000000000018 | 16777216 | 2023-09-18 21:32:47+08<br> 00000001000000000000001A | 16777216 | 2023-09-18 21:32:47+08<br> 00000001000000000000001C | 16777216 | 2023-09-18 21:32:48+08<br> 00000001000000000000001B | 16777216 | 2023-09-18 21:32:48+08<br> 00000001000000000000001D | 16777216 | 2023-09-18 21:33:15+08<br> 00000001000000000000001F | 16777216 | 2023-09-18 21:33:16+08<br> 00000001000000000000001E | 16777216 | 2023-09-18 21:33:16+08<br> 000000010000000000000020 | 16777216 | 2023-09-18 21:33:16+08<br> 000000010000000000000022 | 16777216 | 2023-09-18 21:33:17+08<br> 000000010000000000000021 | 16777216 | 2023-09-18 21:33:17+08<br> 000000010000000000000023 | 16777216 | 2023-09-18 21:33:17+08<br> 000000010000000000000026 | 16777216 | 2023-09-18 21:33:18+08<br> 000000010000000000000024 | 16777216 | 2023-09-18 21:33:18+08<br> 000000010000000000000025 | 16777216 | 2023-09-18 21:33:18+08<br> 000000010000000000000016 | 16777216 | 2023-10-01 13:22:17+08<br>(17 rows)<br><br><br><br></code></pre></td></tr></table></figure>



<h5 id="4-4-6-3-5切换WAL日志"><a href="#4-4-6-3-5切换WAL日志" class="headerlink" title="4.4.6.3.5切换WAL日志"></a>4.4.6.3.5切换WAL日志</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">默认WAL文件达到16M，自动切换另一个WAL</span><br>postgres=# select pg_switch_wal();<br> pg_switch_wal <br>---------------<br> 0/160D91C0<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">PG10版本前用下面命令</span><br>postgres=# select pg_switch_xlog();<br><br></code></pre></td></tr></table></figure>

<h5 id="4-4-6-3-6查看WAL文件内容命令"><a href="#4-4-6-3-6查看WAL文件内容命令" class="headerlink" title="4.4.6.3.6查看WAL文件内容命令"></a>4.4.6.3.6查看WAL文件内容命令</h5><p>pg_waldump可以查看WAL日志的具体内容</p>
<p>注意：pg_waldump执行结果中tx:：后面的数字是txid,即事务ID，WAL中同一个事务的记录此值是相同的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[13:29:28 root@Master-DNS ~]#pg_waldump /pgsql/data/pg_wal/000000010000000000000017<br>rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/17000028, prev 0/160D91A8, desc: RUNNING_XACTS nextXid 575 latestCompletedXid 574 oldestRunningXid 575<br>rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/17000060, prev 0/17000028, desc: RUNNING_XACTS nextXid 575 latestCompletedXid 574 oldestRunningXid 575<br>rmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/17000098, prev 0/17000060, desc: CHECKPOINT_ONLINE redo 0/17000060; tli 1; prev tli 1; fpw true; xid 0:575; oid 16513; multi 1; offset 0; oldest xid 479 in DB 1; oldest multi 1 in DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 575; online<br>rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/17000110, prev 0/17000098, desc: RUNNING_XACTS nextXid 575 latestCompletedXid 574 oldestRunningXid 575<br>pg_waldump: fatal: error in WAL record at 0/17000110: invalid record length at 0/17000148: wanted 24, got 0<br><br></code></pre></td></tr></table></figure>

<h5 id="4-4-6-3-7创建恢复点"><a href="#4-4-6-3-7创建恢复点" class="headerlink" title="4.4.6.3.7创建恢复点"></a>4.4.6.3.7创建恢复点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">事先创建恢复点，将来可用它进行还原，相当于快照</span><br>postgres=# select pg_create_restore_point(&#x27;test-restore-point&#x27;);<br></code></pre></td></tr></table></figure>

<h4 id="4-4-6-4归档WAL日志"><a href="#4-4-6-4归档WAL日志" class="headerlink" title="4.4.6.4归档WAL日志"></a>4.4.6.4归档WAL日志</h4><p>归档日志记录的是checkpoint前的WAL日志，即数据的历史日志,即把pg_wal里面的在线日志备份出来，功能上归档日志相当于MySQL的二进制日志</p>
<p>生产环境中为了保证数据高可用性，通常需要开启归档，当系统故障后可以通过归档的日志文件对数据进行恢复</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置归档需要开启如下参数：</span><br>wal_level = replica<br><span class="hljs-meta prompt_">#</span><span class="language-bash">该参数的可选的值有minimal，replica和logical，wal的级别依次增高，在wal的信息也越多。由于minimal这一级别的wal不包含从基础的备份和wal日志重建数据的足够信息，在该模式下，无法开启wal日志归档</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">从PostgresQL10开始，默认使用的replica此级别，也建议使用此级别，之前版本默认是最小级别minimal</span><br><br>archive_mode = on<br><span class="hljs-meta prompt_">#</span><span class="language-bash">上述参数为on,表示打开归档备份，可选的参数为on,off,always 默认值为off,所以要手动打开，需要重启服务生效</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在 PostgresQL中配置归档的方法是配置参数 archive_command,参数的配置值可以是一个unix命令,此命令把WAL日志文档拷贝到其他地方</span><br>archive_command = &#x27;[ ! -f /archive/%f ] &amp;&amp; cp %p /archive/%f&#x27;<br>archive_command = &#x27;DIR=/archive/ date +%F&#x27;;[ -d $DIR ] || mkdir -p $DIR;cp %p $DIR/%f&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">该参数的默认值是一个空字符串，值可以是一条shel1命令或者一个复杂的she11脚本<span class="hljs-comment">#用&quot;%p&quot;表示将要归档的wal文件包含完整路径的信息的文件名</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">用<span class="hljs-string">&quot;%f&quot;</span>代表不包含路径信息的wa1文件的文件名</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：wal_level和archive_mode参数修改都需要重新启动数据库才可以生效。而修改archive_command则不需要。</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">无论当时是否需要归档，这要建议将上面两个参数开启</span><br></code></pre></td></tr></table></figure>

<hr>
<p>示例：本地归档备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">archive_mode = on<br>archive_command = &#x27;cp %p /pgsq1/backup/%f&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">上面的命令中“archive_mode =on”表示打开归档备份</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">参数archive_command的配置值是一个unix的<span class="hljs-built_in">cp</span>命令</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">命令中的%p表示在线WAL日志文件的全路径名称</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">%f表示不包括路径的WAL日志文件名。</span><br></code></pre></td></tr></table></figure>

<p>在实际执行时备份时，PostgreSQL会把%p替换成实际在线WAL日志文件的全路径名，并把%f替换成不包括路径的 WAL日志名。</p>
<p>使用操作系统命令scp还可以把WAL日志拷贝到其他机器上，从而实现对归档日志进行远程备份</p>
<p>示例：远程归档备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">archive_mode =on<br>archive_command = &#x27;scp %p postgres@10.0.0.200:/pgsq1/backup/%f&#x27;<br></code></pre></td></tr></table></figure>

<p>使用上面拷贝WAL文件的方式来同步主、备数据库之间数据时，备库会落后主库一个WAL日志文件，具体落后多长时间取决于主库上生成一个完整的WAL文件所需要的时间。</p>
<p>范例：启用归档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">配置参数</span><br>vim /pgsql/data/postgresql.conf<br>wal_level=replica #此为默认值可以不做修改<br><span class="hljs-meta prompt_">#</span><span class="language-bash">- Archiving -</span><br>archive_mode = on<br>archive_command = &#x27;DIR=/archive/`date +%F`;[-d $DIR] || mkdir -p $DIR;cp %p $DIR/%f&#x27;<br><br>mkdir /archive<br>chown -R postgres. /archive<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启数据库</span><br>pg_ctl restart -mf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">插入数据，查看归档</span><br>\c testdb<br>create table t1(id int);<br>insert into t1 values (generate_series(1,1000000));<br>select ctid,* from t1;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">说明:ctid表示数据所在的数据块的编号及位移</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">比如（0，1）表示第0个块中的第一条记录，块从0开始编号，记录从1开始编号</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">触发检查点</span><br>checkpoint<br><span class="hljs-meta prompt_">#</span><span class="language-bash">切换日志，即使当前日志文件不再使用，而切换使用下一个日志文件，如果开启归档，会自动触发对当前日志文件的归档</span><br>select pg_switch_wal（）;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">检查归档</span><br>[14:04:58 root@Master-DNS ~]#tree /archive/<br>/archive/<br>└── 2023-10-01<br><br></code></pre></td></tr></table></figure>

<p>范例：远程归档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在10.0.0.4的备份服务器上创建目录</span><br>[15:39:43 root@rocky8 ~]#mkdir -p /pgsql/backup<br>[15:39:52 root@rocky8 ~]#chown -R postgres. /pgsql/backup/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在postgreSQL服务器上实现到10.0.0.3备份服务器上的key验证</span><br>[14:07:31 root@Master-DNS ~]#ssh-keygen <br>[15:17:49 root@Master-DNS ~]#ssh-copy-id postgres@10.0.0.4<br><br><br>[15:18:12 root@Master-DNS ~]#vim /pgsql/data/postgresql.conf <br>archive_mode = on<br>archive_command = &#x27;scp %p 10.0.0.4:/pgsql/backup/%f&#x27;<br><br>[15:21:50 root@Master-DNS ~]#systemctl restart postgresql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在postgresQL服务器上执行大量数据更新</span><br>[15:57:08 root@Master-DNS ~]#cat for_loop.sql <br>\c hellodb<br>create table emp(id int,name char(10),age int);<br><br>create or replace function for_loop()<br>returns void as $$<br>begin<br>    for i in 1..1000000 loop<br>        INSERT INTO emp(&quot;id&quot;,&quot;name&quot;, &quot;age&quot;) VALUES (i,&#x27;wang&#x27;,20);<br>    end loop;<br>end; <br><span class="hljs-meta prompt_">$</span><span class="language-bash">$ language plpgsql;</span><br><br>select for_loop();<br><br>select count(*) from emp;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在10.0.0.3的备份服务器上可看到日志的备份出现</span><br>[15:57:19 root@rocky8 ~]#ls /pgsql/backup/<br>000000010000000000000020  000000010000000000000022  000000010000000000000024  000000010000000000000026<br>000000010000000000000021  000000010000000000000023  000000010000000000000025  000000010000000000000027<br><br><br></code></pre></td></tr></table></figure>

<h1 id="5-PostgreSQL备份恢复"><a href="#5-PostgreSQL备份恢复" class="headerlink" title="5 PostgreSQL备份恢复"></a>5 PostgreSQL备份恢复</h1><h2 id="5-1备份说明"><a href="#5-1备份说明" class="headerlink" title="5.1备份说明"></a>5.1备份说明</h2><p>防止数据丢失的最重要方法就是备份。这些数据丢失有的是因硬件损坏导致的，有的是因人为原因(如误操作）而导致的，也有因为应用程序的bug而误删数据等情况。</p>
<p>备份的内容包括：</p>
<ul>
<li>数据（配置文件）</li>
<li>归档WAL日志</li>
<li>表空间目录</li>
</ul>
<p>数据库备份方式</p>
<ul>
<li>逻辑备份：适用于跨版本和跨平台的备份恢复</li>
<li>物理备份：适用于小版本的恢复，但不支持跨平台和大版本</li>
</ul>
<h2 id="5-2逻辑备份"><a href="#5-2逻辑备份" class="headerlink" title="5.2逻辑备份"></a>5.2逻辑备份</h2><p>PostgreSQL提供了pg_dump、pg_dumpall 命令进行数据库的逻辑备份。</p>
<p>两者的功能差不多，只是pg_dumpall是将一个PostgresQL数据库集群全部转储到一个脚本文件中，而pg_dump命令可以选择一个数据库或部分表进行备份。</p>
<p>另外利用COPY命令也能对表和SQL子集进行备份，实现表的还原</p>
<h3 id="5-2-1-pg-dump和pg-dumpall"><a href="#5-2-1-pg-dump和pg-dumpall" class="headerlink" title="5.2.1 pg_dump和pg_dumpall"></a>5.2.1 pg_dump和pg_dumpall</h3><p>pg_dump是PostgreSQL提供的一个非常有用的数据库备份工具。它甚至可以在数据库正在使用的时候进行完整一致的备份。pg_dump工具执行时，可以将数据库备份成一个文本文件或归档文件，该文件中实际上包含了多个CREATE和INSERT语句，使用这些语句可以重新创建表和插入数据。</p>
<p>pg_dumpall工具可以存储一个数据库集群里的所有数据库到一个脚本文件。本质上pg_dumpall是通过对数据库集群里的每个数据库调用pg_dump实现这个功能。</p>
<p>pg_dumpall还可以备份出所有数据库公用的全局元数据对象。这些信息包括：数据库用户和组，密码以及适用于整个数据库的访问权限。而pg_dump并不保存这些对象。</p>
<p>pg_dump可生成归档格式的备份文件，然后与pg_restore配合使用，从而提供一种灵活的备份和恢复机制。</p>
<p>pg_dump可以将整个数据库备份到一个归档格式的备份文件中，而pg_restore则可从这个归档格式的备份文件中选择性地恢复部分表或数据库对象。归档格式的备份文件又分为两种，最灵活的输出文件格式是”custom”自定义格式（使用命令项参数-Fc来指定)，它允许对归档元素进行选取和重新排列，并且默认时是压缩的；另一种格式是tar格式(使用命令项参数-Ft来指定)，这种格式的文件不是压缩的，并且加载时不能重排列，但是它也很灵活，可以用标准UNIX下的tar工具进行处理。</p>
<p>pg_dumpall只支持文本格式</p>
<p>pg_dump 的具体使用语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">pg_dump [connection-option...] [option...] [dbname]<br><span class="hljs-meta prompt_">#</span><span class="language-bash">连接选项和psq1基本相同，pg_dump连接选项的参数如下</span><br>-h host或--host=host #指定运行服务器的主机名。如果以斜杠开头，则被用作到UNIX域套接字的路径。默认情况下，如果设置了SPGHOST环境变量，则从此环境变量中获取，否则尝试一个UNIX域套接字连接。<br>-P port或--Port=port#指定服务器正在侦听的TCP端口或本地UNIx域套接字文件的扩展。默认情况下，如果设置了$PGPORT环境变量，则从此环境变量中获取，否则取值为默认端口5432（编译时可以改变这个默认端口）。<br>-U username或--username=username指定要连接的用户名。<br>-w 或--no-password#从不提示密码。密码可以通过其他方式如~/.pgpass文件获取dbname #指定连接的数据库名，实际上也是要备份的数据库名。如果没有使用这个参数，则使用环境变量SPGDATABASE。如果SPGDATABASE 也没声明，那么可使用发起连接的用户名。<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">pg_dump专用选项</span><br>-a或--data-only #这个选项只是对纯文本格式有意义。只输出数据，不输出数据定义的SQL语句。<br>-b或--blobs #在转储中是否包含大对象。除非指定了选择性转储的选项--schema、--table、--schema-only开关，否则默认会转储大对象。此选项仅用于选择性转储时控制是否转储大对象。<br>-c或一clean #这个选项只对纯文本格式有意义。指定输出的脚本中是否生成清理该数据库对象语句（如droptable命令）。<br>-c或--create #这个选项只对纯文本格式有意义。指定脚本中是否输出一条create database语句和连接到该数据库的语句。一般在备份的源数据库与恢复的目标数据库的名称一致时，才指定这个参数。<br>-E encoding或--encoding=encoding #以指定的字符集编码创建转储。默认转储是依据数据库编码创建的。如果不指定此参数，可以通过设置环境变量SPGCLIENTENCODING达到相同的目的<br>-f file--file=file#输出到指定的文件中。如果没有指定此参数，则输出到标准输出中。<br>-F format或--format=format #选择输出的格式。format可以是p、c或t。<br>p是plain 的意思，为纯文本sQL 脚本文件的格式，这是默认值。大库不荐c是custom的意思，以一个适合pg_restore使用的自定义二进制格式输出并归档。这是最灵活的输出格式，在该格式中允许手动查询并且可以在pg restore恢复时重排归档项的顺序。该格式默认是压缩的。t是tar的意思，以一个适合输人pg_restore的 tar格式输出并归档。该输出格式允许手动选择并且在恢复时重排归档项的顺序，但是这个重排序是有限制的，比如，表数据项的相关顺序在恢复时不能更改。同时，tar格式不支持压缩，并且对独立表的大小限制为8GB。<br>-n schema或--schema=schema#只转储匹配 schema的模式内容，包括模式本身以及其中包含的对象。如果没有声明这个选项，所有目标数据库中的非系统模式都会被转储出来。可以使用多个-n选项指定多个模式。<br>-t table或--table=table #只转储出匹配table的表、视图、序列。可以使用多个-t选项匹配多个表。同样table参数将按照psql的\d命令的规则被解释为匹配模式，因此可以使用通配符匹配多个模式。在使用通配符时，最好用引号进行界定，以防止shel1将通配符进行扩展。<br>-T table或--exclude-table=table#不转储任何匹配table模式的表。模式匹配规则与t完全相同。可以指定多个-T以排除多种匹配的表。如果同时指定了-t和-T，那么将只转储匹配-t但不匹配-T的表。如果出现了-T而未出现-t，那么匹配-T的表不会被转储。<br></code></pre></td></tr></table></figure>

<p>使用pg_dump 的自定义备份或tar类型的备份需要使用pg_restore工具来恢复。</p>
<p>pg_restore命令的格式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">pg_restore [connection-option.….] [option.….] [filename]<br><br>pg_restore 的连接参数与pg_dump基本相同,如下<br>-h host或--host=host<br>-p port或--port=port<br>-U username或--username=username-w或--no-password<br>-w或--password<br>-d dbname或--dbname=dbname #不同之处在于，pg_restore使用-d的参数来连接指定的数据库并恢复数据至此数据库<br>filename #要恢复的备份文件的位置。如果没有声明，则使用标准输入。<br>-a或--data-only#只恢复数据，而不恢复表模式(数据定义)。<br>-c或--clean#创建数据库对象前先清理（删除）它们。<br>-c或--create#在恢复数据库之前先创建它。如果出现了这个选项，和-d在一起的数据库名只是用于发出最初的CREATE DATABASE命令，所有数据都恢复到名字出现在归档中的数据库中。<br>-F format或--format=format#指定备份文件的格式。pg_restore可自动判断格式,如果一定要指定，它可以是t或c之一。<br>t表示 tar，指备份文件是一个tar文件。<br>c表示custom,备份的格式是来自pg_dump的自定义格式，这是最灵活的格式，因为它允许对数据重新排序，也允许重载表模式元素，默认这个格式是压缩的。<br>-n namespace或--schema=schema #只恢复指定名字的模式里的定义和/或数据。这个选项可以和-t选项一起使用，只恢复一个表的数据。<br>-t table或--table=table #只恢复指定的表的定义和/或数据。可以与-n参数（指定schema)联合使用。<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">备份单个数据库<span class="hljs-built_in">test</span>中的所有表到指定目录</span><br>pg_dump -U postgres -f /backup/test_backup test<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">备份<span class="hljs-built_in">test</span>数据库中的t1表和t2表：</span><br>pg_dump -U postgres -t tl -t t2 -f /backup/test_backup_tl_t2 test<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">备份指定数据库</span><br>pg_dump -d testdb &gt; /backup/testdb.sql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">恢复过程</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：事先需要存在数据库，且删除所有表后才能恢复</span><br>psql -d testdb &lt; /backup/testdb.sq1<br></code></pre></td></tr></table></figure>

<p>范例：使用pg_dumpall备份所有的数据库，其操作和pg_dump类似</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">备份全部数据库，每个数据库都需要输入密码，有N个数据库，就需要输入N次密码</span><br>pg_dumpa11 -U postgres -f fu11_backup.sq1<br>gp_dumpa11 &gt; fu11_backup.sq1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">恢复</span><br>psql &lt; ful1_backup.sql<br></code></pre></td></tr></table></figure>

<p>范例：使用pg_dump 和pg_restore备份还原</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">当连接的是一个本地数据库，并不需要密码时，要对数据库he1lodb进行备份，备份文件的格式是脚本文件格式</span><br>pg_dump -C hellodb &gt; hellodb.sql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">使用pg_dump也可以备份一个远程的数据库，如下面的命令备份10.0.0.200机器上的he11odb数据库</span><br>pg_dump -h 10.0.0.200 -U postgres -C hellodb &gt; hellodb.sql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果想生成的备份文件格式为自定义格式，可以使用下面的命令：</span><br>pg_dump -Fc -h 10.0.0.200 -Upostgres hellodb &gt; hellodb.dump<br><br>Password:<br>file hellodb.dump<br>hellodb.dump: PostgresQL custom database dump - v1.14-0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看备份文件内容</span><br>pg_restore hel1lodb.dump<br><br><br>[16:30:03 root@Master-DNS ~]#pg_restore -l hellodb.dump <br>;<br>; Archive created at 2023-10-01 16:30:03 CST<br>;     dbname: hellodb<br>;     TOC Entries: 28<br>;     Compression: -1<br>;     Dump Version: 1.14-0<br>;     Format: CUSTOM<br>;     Integer: 4 bytes<br>;     Offset: 8 bytes<br>;     Dumped from database version: 12.9<br>;     Dumped by pg_dump version: 12.9<br>;<br>.........<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">把上述备份文件恢复到另一个数据库hel1odb2中</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先创建数据库才能恢复</span><br>psql -U postgres -h 10.0.0.200 -c &quot;create database hellodb2&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">还原</span><br>pg_restore -h 10.0.0.200 -U postgres -d hellodb2 hellodb.dump<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">只备份数据库he11odb中的表students</span><br>pg_dump -h 10.0.0.200 -Upostgres -t students hellodb &gt; students.sq1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">备份schema1模式中所有以job开头的表，但是不包括job_log表</span><br>pg_dump -t &#x27;schemal.job*&#x27; -T schemal.job_log hellodb &gt; schemal.emp.sql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">备份所有数据库对象，但是不包括名字以_log结尾的表</span><br>pg_dump -T &#x27;*_log&#x27; hellodb &gt; log.sq1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先从10.0.0.200备份数据库he11odb，然后恢复到10.0.0.100机器上</span><br>pg_dump -h 10.0.0.200 -U postgres hellodb -Fc &gt; hellodb.dump<br>pg_restore -h 10.0.0.100 -U postgres -C -d postgres hellodb.dump<br><span class="hljs-meta prompt_">#</span><span class="language-bash">在pg-restore命令中，-d中指定的数据库可以是10.0.0.200机器上实例中的任意数据库，pg-restore仅用该数据库名称进行连接，-C 表示先执行CREATE DATABASE命令创建he11odb数据库，然后再重新连接到hellodb数据库，最后把备份的表和其他对象建到hellodb数据库中</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">将备份出来的数据重新加载到一个新建的不同名称的数据库he11odb2中</span><br>createdb -T template0 hellodb2<br>pg_restore -d hellodb2 hel1odb.dump<br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意，上面的命令从templateo而不是template1创建新数据库，确保干净。这里没有使用-c选项，而是直接连接到将要恢复的数据库上。</span><br></code></pre></td></tr></table></figure>

<h3 id="5-2-2COPY命令实现备份还原"><a href="#5-2-2COPY命令实现备份还原" class="headerlink" title="5.2.2COPY命令实现备份还原"></a>5.2.2COPY命令实现备份还原</h3><p>帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://www.postgres.cn/docs/12/sql-copy.html<br></code></pre></td></tr></table></figure>

<p>COPY命令支持在PostgreSQL表和文件之间交换数据。</p>
<p>COPY TO把一个表的所有内容都拷贝到一个文件，而COPY FROM从一个文件里拷贝数据到一个表里（把数据附加到表中已经存在的内容里）。COPY TO还能拷贝SELECT查询的结果。</p>
<p>如果声明了一个字段列表，COPY将只在文件和表之间拷贝已声明字段的数据。如果表中有任何不在字段列表里的字段，那么COPY FROM将为那些字段插入缺省值。</p>
<p>带文件名的COPY指示PostgreSQL服务器直接从文件中读写数据。如果声明了文件名，那么服务器必须可以访问该文件，而且文件名必须从服务器的角度声明。如果使用了PROGRAM选项，则服务器会从指定的这个程序进行输入或是写入该程序作为输出。如果使用了STDIN或STDOUT选项，那么数据将通过客户端和服务器之间的连接来传输。</p>
<p>命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">导出</span><br>COPY &#123; table_name [ ( column_name [, ...] ) ] | ( query ) &#125;<br>    TO &#123; &#x27;filename&#x27; | PROGRAM &#x27;command&#x27; | STDOUT &#125;<br>    [ [ WITH ] ( option [, ...] ) ]<br>    <br><span class="hljs-meta prompt_">#</span><span class="language-bash">导入</span><br>COPY table_name [ ( column_name [, ...] ) ]<br>    FROM &#123; &#x27;filename&#x27; | PROGRAM &#x27;command&#x27; | STDIN &#125;<br>    [ [ WITH ] ( option [, ...] ) ]<br>    [ WHERE condition ]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">常用参数说明：</span><br>table_name 现存表的名字(可以有模式修饰）<br>column_name 可选的待拷贝字段列表。如果没有声明字段列表，那么将使用所有字段<br>query 一个必须用圆括弧包围的SELECT或VALUES命令，其结果将被拷贝<br>filename 输入或输出文件的路径名。输入文件名可以是绝对或是相对的路径，但输出文件名必须是绝对路径。windows用户可能需要使用E”字符串和双反斜线作为路径名称<br>ROGRAM需执行的程序名。在COPY FROM命令中，输入是从程序的标准输出中读取，而在COPY TO中，命令的输出会作为程序的标准输入。注意，程序一般是在命令行界面下执行，当用户需要传递一些变量给程序时，如果这些变量的来源不是可靠的，用户必须小心过滤处理那些对命令行界面来说是有特殊意义的字符。基于安全的原因，最好是使用固定的命令字符串，或者至少是应避免直接使用用户输入（应先过滤特殊字符)<br>STDOUT声明输入将写入客户端应用<br>FORMAT选择被读或者写的数据格式：text、csv(逗号分隔值），或者binary。默认是text<br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：</span><br>opy命令必须在psql命令行执行，执行用户必须为superuser，否则会提示错误如果用普通用户进行执行，需要在copy前面加入“\”，即\copy即可<br></code></pre></td></tr></table></figure>

<p>范例：导出</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">示例：</span><br>COPY students TO &#x27;/tmp/students.csv&#x27; WITH csv;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">可以导出指定的属性：</span><br>COPY students(stuid,name) TO &#x27;/tmp/students.csv&#x27; WITH csv;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">可以使用select 语句：</span><br>COPY (select * from students) TO &#x27;/tmp/students.csv&#x27;WITH csv;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">可以指定要导出哪些字段并带有列名：</span><br>COPY (select stuid,name,age from students) TO &#x27;/tmp/students.csv&#x27; WITH csvheader;<br></code></pre></td></tr></table></figure>

<p>范例：导入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">导入命令基本与导出一样，只是将TO改为FROM</span><br>create table students2 (like students);<br>COPY students2 FROM &#x27;/tmp/students.csv&#x27; WITH csv;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果导出的时候，指定了header属性，那么在导入的时候，也需要指定：</span><br>COPY students(stuid,name,age,gender) TO &#x27;/tmp/students.csv&#x27; wITH csv header;<br>COPY students2(stuid, name,age,gender) FROM &#x27;/tmp/students.csv&#x27; WITH csv header;<br></code></pre></td></tr></table></figure>

<h2 id="5-3物理备份"><a href="#5-3物理备份" class="headerlink" title="5.3物理备份"></a>5.3物理备份</h2><p>物理备份分为冷备份和热备份</p>
<ul>
<li><p>冷备份：最简单的物理备份就是冷备份，也就是把数据库停止，然后把数据库的PGDATA目录拷贝出来即可。</p>
<p>由于PostgreSQL把与数据库实例有关的配置文件和数据文件都放在$PGDATA目录下，所以PostgresQL做冷备份很简单</p>
</li>
<li><p>热备份：不停止数据库的数据库备份，称之为热备份或在线备份。在PostgreSQL中通常的热备份方法有两种。</p>
<ul>
<li>第一种方法：使用数据库的PITR方法利用pg_basebackup工具进行热备份</li>
<li>第二种方法：使用文件系统或块设备级别的快照功能完成备份。因为使用了快照，所以也能让备份出来的数据库与原数据库一致。</li>
</ul>
</li>
</ul>
<p>热备份流程</p>
<ul>
<li>以数据库超级用户身份连接到数据库，发出命令：SELECT pgstart_backup(‘label’);pg_start_backup()主要做了以下两个工作：<ul>
<li>o设置写日志标志为：XLogCtl-&gt;Insert.forcePageWrites = true, 也就是把这个标志设置为true后，数据库会把变化的整个数据块都记录到数据库中，而不仅仅是块中记录的变化。</li>
<li>强制发生一次checkpoint点。</li>
</ul>
</li>
<li>执行备份。使用任何方便的文件系统工具比如tar，或直接把数据目录复制下来。这些操作过程中既不需要关闭数据库，也不需要停止数据库的任何操作。</li>
<li>再次以数据库超级用户身份连接数据库，然后发出命令：SELECT pg_stop_backup（)；</li>
</ul>
<p>这将中止备份模式并自动切换到下一个WAL段。自动切换是为了让在备份间隔中写人的最后一个WAL段文件可以立即为下次备份做好准备。</p>
<ul>
<li>拷贝备份过程中产生的归档WAL日志文件</li>
</ul>
<p>范例：冷备份还原</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">备份</span><br>[root@ubuntu2004 ~]#pg_ctl stop<br>[root@ubuntu2004 ~]#mkdir /backup<br>[root@ubuntu2004 ~]#cp -a $PGDATA/ /backup/pgdata- `date +%F`<br>[root@ubuntu2004 ~]#pg_ctl start<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">还原</span><br>[root@ubuntu2004 ~]#pg_ctl stop<br>[root@ubuntu2004 ~]#rm -rf $PGDATA/*<br>[root@ubuntu2004 ~]#cp -a /backup/pgdata-2022-02-16/* $PGDATA/<br>[root@ubuntu2004 ~]#pg_ctl start<br></code></pre></td></tr></table></figure>

<p>范例：热备份和还原</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">psql -c &quot;select pg_start_backup(now()::text);&quot;	#以当前时间做为标签<br>tar -cf /backup/full_ date +%F .tar /pgsql/data/<br>psql -c &quot;select pg_stop_backup();&quot;<br>tar -rf /backup/full_ date +%F .tar /archive/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">还原</span><br>pg_ct1 stop -D $PGDATA<br>rm -rf $PGDATA<br>tar xf /backup/ful1_ `date +%F`.tar -C /pgsql/data/<br>pg_ct1 start -D $PGDATA<br></code></pre></td></tr></table></figure>

<p>范例：利用LVM快照做备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">如果PGDATA是基于LVM存放的，可以执行基于逻辑卷快照备份</span><br>[root@ubuntu2004 ~]#systemctl stop postgresql ;lvcreate -n pgdata_snapshot -s -L 1G /dev/mapper/ubuntu--vg-ubuntu--lv; systemctl start postgresql<br><br>[root@ubuntu2004 ~]#mount /dev/ubuntu-vg/pgdata_snapshot /mnt<br>[root@ubuntu2004 ~]#cp -a /mnt/pgsql/data/ /backup/pgdata- `date +%F`<br><br>[root@ubuntu2004 ~]#lvremove /dev/ubuntu-vg/pgdata_snapshot<br></code></pre></td></tr></table></figure>

<h2 id="5-4-PITR-Point-in-Time-Recovery-介绍"><a href="#5-4-PITR-Point-in-Time-Recovery-介绍" class="headerlink" title="5.4 PITR(Point-in-Time Recovery)介绍"></a>5.4 PITR(Point-in-Time Recovery)介绍</h2><p>PostgreSQL支持类似于MySQL的主从复制的架构，一个Master 服务器database同步数据到多个Standby Server</p>
<p>PostgreSQL的主从同步是基于WAL(write ahead log预写式日志)日志实现的</p>
<p>PostgreSQL在数据目录的$PGDATA/pg_wal重做日志目录中始终维护着一个WAL日志文件。这个日志文件用于记录数据库数据文件的每次改变。当初设计这个日志文件的主要目的是为了在数据库异常崩溃后，能够通过重放最后一次checkpoint点之后的日志文件，把数据库推到一致状态。</p>
<p>事实上，这种日志文件机制，也提供了一种数据库热备份方案：在把数据库使用文件系统的方式备份出来的同时把相应的在线WAL日志也备份出来。虽然直接拷贝数据库数据文件会导致拷贝出来的文件不一致(比如拷贝的多个数据文件不是同一个时间点文件；拷贝一个8KB的数据块时，也存在不一致的情况：假设刚拷贝完前4KB的块，数据库又写了后4KB的块内容，那么所拷贝的块就不是一个完整的数据块)，但因为有了WAL日志，即使备份出来的数据块不一致，也可以重放备份开始后的WAL日志，把备份的内容推到一致状态。</p>
<p>由此可见，有了WAL日志之后，备份数据库时不再需要完美的一致性备份了，备份中任何数据的非一致性都会被重放WAL日志文件进行纠正，所以在备份数据库时可以通过简单的cp命令或tar等拷贝、备份文件来实现数据库的在线备份。</p>
<p>不停地重放WAL日志就可以把数据推到备份结束后的任意一个时间点，这就是基于时间点的备份Point-in-Time Recovery,缩写为PITR。</p>
<p>使用简单的cp命令或其他命令把数据库给在线拷贝出来的备份，被称为基础备份。后续WAL日志的备份与此基础备份构成一个完整备份。把基础备份恢复到另一台主机，然后不停地从原始数据库机器上接收WAL日志，在新机器上持续重放WAL日志，这样就可以在任何时间内在另一台机器上打开新产生的数据库。它拥有当前数据最新的数据状态。此新主机上的数据库称为Standby数据库，当前的主数据库出现问现故障无法正常提供服务时，可以把Standby数据库打开提供服务，从而实现高可用。</p>
<p>把WAL日志传送到另一台机器上的方法有两种，一种是通过归档WAL日志实现，一种是被称为流复制的方法</p>
<h2 id="5-5-pg-basebackup-实现完全备份和还原"><a href="#5-5-pg-basebackup-实现完全备份和还原" class="headerlink" title="5.5 pg_basebackup 实现完全备份和还原"></a>5.5 pg_basebackup 实现完全备份和还原</h2><p>pg_basebackup是基于流复制协议可以实现完全备份，并支持热备份</p>
<p>这个工具会把整个数据库实例的数据都拷贝出来，而不只是把实例中的部分（如某个数据库或某些表)单独备份出。</p>
<p>该工具使用replication协议连接到数据库实例上，所以主数据库中的pg_hba.conf必须允许replication连接，也就是在pg_hba.conf中必须有类似下面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">local	replication		dba					trust	<br>host	replication		dba		0.0.0.0/0	md5<br><span class="hljs-meta prompt_">#</span><span class="language-bash">上面的dba为备份的用户名，如果指令al1，即所有用户</span><br></code></pre></td></tr></table></figure>

<h3 id="5-5-1-pg-basebackup的命令行参数"><a href="#5-5-1-pg-basebackup的命令行参数" class="headerlink" title="5.5.1 pg_basebackup的命令行参数"></a>5.5.1 pg_basebackup的命令行参数</h3><p>pg_basebackup命令的使用方法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">pg_basebackup [option...]<br>此命令后可以跟多个选项，选项的具体说明如下。<br>-D directory或--pgdata=directory：指定把备份写到哪个目录。如果这个目录或这个目录路径中的各级父目录不存在，则pg_basebackup就会自动创建这个目录。<br>-F format或--format=format：指定输出的格式。“format”指一种格式，它目前又支持两种格式，一种是原样输出，即把主数据库中的各个数据文件、配置文件、目录结构都完全一样地写到备份目录，这种情况下“format”指定为“p”或“plain”；另一种是tar格式，相当于把输出的备份文件打包到一个tar文件中，这种情况下“format”应为“t”或“tar”。<br>-x或--xlog:备份时会把备份中产生的x1og文件也自动备份出来，这样才能在恢复数据库时，应用这些xlog文件把数据库推到一个一致点，然后真正打开这个备份的数据库。这个选项与选项“-xfetch”是完全一样的。使用这个选项，需要设置“wal_keep_segments”参数，以保证在备份过程中，需要的wAL日志文件不会被覆盖。<br>-X method或--xlog-method=method：”method”可以取的值为“f”、“fetch”、“s”.“stream”，其中“f”与“fetch相同，其意义与“-x”参数是一样的。“s”与“stream”表示的意思也相同,表示备份开始后，启动另一个流复制连接从主库接收WAL日志。这种方式避免了使用“-xf”时，主库上的WAL日志有可能被覆盖而导致失败的问题。但这种方式需要与主库建两个连接，因此使用这种方式时，主库的“max_wal_senders”参数至少要设置为2或大于2的值。新版取消此选项<br>-z或--gzip：仅能与tar输出模式配合使用，表明输出的tar备份包是经过gzip压缩的，相当于生成了一个*.tar.gz的备份包。<br>-z level或--compress=level：指定gzip的压缩级别，可以选1~9的数字，与gzip命令中的压缩级别是一样的，9表示最高压缩率，但也最耗CPU。<br><br>-R,--write-recovery-conf #将复制的配置信息保存,生成standby.signal<br>-c fast/spread或--checkpoint=fast|spread:设置checkpoint的模式是fast还是spread。<br>-l 1abel或--1abel=1abel:指定备份的一个标识，备份的标识是一个任意字符串，便于今后维护人员识别这个备份，该标识就是手工做基础备份时运行&quot;select pg_start_backup(‘label’)”传递给pg_start_backup函数的参数。在备份集中有一个文件叫“backup labe1”，这里面除了记录开始备份时WAL日志的起始位置、checkpoint的wAL日志位置、备份的开始时间外，也记录了这个标识串的信息。<br>-P或--progress：允许在备份过程中实时地打印备份的进度。当然这个打印的进度不是百分之百精确的，因为在备份过程中，数据库的数据还会发生变化，还会不断产生一些WAL日志。<br>-v或--verbose:详细模式，使用了-P参数后，还会打印出正在备份的具体文件的信息。<br>-v或--version:打印pg_basebackup的版本后退出。<br>-?或--help：显示帮助信息后退出。控制连接数据库的参数。<br>-h host或--host=host：指定连接的数据库的主机名或IP地址。<br>-p port或--port=port:指定连接的端口。<br>-s interval或--status-interval=interval：指定向服务器端周期反馈状态的秒数，如果服务器上配置了流复制的超时，在使用一-xlog=stream选项时，则需要设置这个参数，默认值为10秒。如果设置为0，表示不向服务器反馈状态。<br>-U username或--username=username:指定连接的用户名。-w或--no-password:指定从来不提示输入密码。<br>-w或--password:强制让pg_basebackup出现输入密码的提示。<br>-R write configuration for replication<br></code></pre></td></tr></table></figure>

<h3 id="5-5-2完全备份"><a href="#5-5-2完全备份" class="headerlink" title="5.5.2完全备份"></a>5.5.2完全备份</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在postgresQL服务器先授权</span><br>[postgres@gpserver ~]$vi /pgsql/data/pg_hba.confhost <br>replication al1 10.0.0.0/24 md5<br>[postgres@gpserver ~]$pg_ctl restart -D $PGDATA<br><span class="hljs-meta prompt_">#</span><span class="language-bash">在备份服务器执行下面操作</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：备份目录/pgsq1/backup/必须为空</span><br>[postgres@gpserver ~]mkdir -p /pgsq1/backup/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">备份</span><br>[postgres@gpserver ~]$pg_basebackup -D /pgsql/backup/ -Ft -pv -Upostgres -h10.0.0.200 -p 5432 -R<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">自动在<span class="hljs-variable">$PGDATA</span>目录下生成备份记录文件</span><br>[postgres@gpserver ~]$cat /pgsq1/data/backup_label.old<br>START WAL LOCATION: 0/45000028 (file 000000010000000000000045)<br>CHECKPOINT LOCATION: 0/45000060<br>BACKUP METHOD: streamed<br>BACKUP FROM: master<br>START TIME: 2020-05-11 10:38:49 UTC<br>LABEL: pg_basebackup base backup<br>START TIMELINE: 1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看备份生成的文件</span><br>[postgres@gpserver ~]$ 1s /pgsq1/backup/base.tar pg_wal.tar<br></code></pre></td></tr></table></figure>

<h3 id="5-5-3利用完全备份实现恢复"><a href="#5-5-3利用完全备份实现恢复" class="headerlink" title="5.5.3利用完全备份实现恢复"></a>5.5.3利用完全备份实现恢复</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在备份服务器上执行下面操作进行还原</span><br>[root@@gpserver ~]#mkdir /archive/<br>root@@gpserver ~]#chown postgres.postgres /archive/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">确认备份文件存在</span><br>[postgres@gpserver ~]$ ls /pgsq1/backup/base.tar pg_wal.tar<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">模拟故障</span><br>[postgres@gpserver ~]$echo $PGDATA/pgsql/data<br>[postgres@gpserver ~]$ pg_ct1 -D $PGDATA stop<br>[postgres@gpserver ~]$ rm -rf $PGDATA/*<br>[postgres@gpserver ~]$ rm -rf /archive/*<br><span class="hljs-meta prompt_">#</span><span class="language-bash">进行还原</span><br>[postgres@gpserver ~]$ tar xf /pgsql/backup/base.tar -C $PGDATA/<br>[postgres@gpserver ~]$ tar xf /pgsql/backup/pg_wal.tar -C /archive<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改配置</span><br>[postgres@gpserver ~]$ vim $PGDATA/postgresqlconf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">添加下面行</span><br>restore_command = &#x27;cp /archive/%f %p&#x27;<br>recovery_target = &#x27;immediate&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果pg_basebackup执行时添加-R选项，可以不执行下面，否则会无法启动服务，执行下面指令创建文件后才能启动</span><br>[postgres@gpserver ~]$touch /pgsql/data/recovery.signal<br>[postgres@gpserver ~]$pg_ctl start -D $PGDATA<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">停止恢复过程，否则为只读</span><br>postgres=# select pg_wal_replay_resume();<br></code></pre></td></tr></table></figure>

<h2 id="5-6利用PITR实现误删除的实战案例"><a href="#5-6利用PITR实现误删除的实战案例" class="headerlink" title="5.6利用PITR实现误删除的实战案例"></a>5.6利用PITR实现误删除的实战案例</h2><h3 id="5-6-1场景说明"><a href="#5-6-1场景说明" class="headerlink" title="5.6.1场景说明"></a>5.6.1场景说明</h3><p>每天2：00备份，第二天10：00误删除数据库，如何恢复？</p>
<h3 id="5-6-2故障恢复过程"><a href="#5-6-2故障恢复过程" class="headerlink" title="5.6.2故障恢复过程"></a>5.6.2故障恢复过程</h3><p>备份数据和归档</p>
<p>还原流程</p>
<ul>
<li>还原完全备份</li>
<li>归档日志恢复<ul>
<li>备份中的归档</li>
<li>恢复2：00到10:00之间的归档</li>
<li>恢复在线redo</li>
</ul>
</li>
</ul>
<h4 id="5-6-2-1备份"><a href="#5-6-2-1备份" class="headerlink" title="5.6.2.1备份"></a>5.6.2.1备份</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在PG服务器开启归档</span><br>[21:42:42 root@rocky8 ~]#vim /pgsql/data/postgresql.conf <br>archive_mode = on<br>archive_command = &#x27;DIR=/archive/`date +%F`;[ -d $DIR ] || mkdir -p $DIR;cp %p $DIR/%f&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#在PG服务器上修改配置</span></span><br>[23:15:06 root@Slave-DNS ~]#vim /pgsql/data/pg_hba.conf <br>host    	all       all         10.0.0.0/24    trust<br>local   replication     all                      trust<br>host    replication     all        0.0.0.0/0     md5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改postgres密码</span><br>testdb=# alter user postgres with password &#x27;123456&#x27;;<br><br><br>[21:47:28 root@rocky8 ~]#mkdir /archive<br>[21:47:30 root@rocky8 ~]#chown -R postgres. /archive<br>[21:47:38 root@rocky8 ~]#systemctl restart postgresql.service <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在PG服务器上创建测试数据</span><br>postgres=# create database testdb;<br>postgres=# \c testdb ;<br>testdb=# create table t1(id int);<br>testdb=# insert into t1 values (1);<br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在备份服务器对PG数据库进行远程完全备份</span><br>[21:52:43 root@PG-backup ~]#mkdir /pgsql/backup/<br>[21:56:33 root@PG-backup ~]#chown -R postgres. /pgsql/backup/<br><br>[22:25:14 root@PG-backup ~]#pg_basebackup -D /pgsql/backup/ -Ft -Pv -Upostgres  -h 10.0.0.4 -p 5432 -R<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在PG服务器上继续生成测数据</span><br>testdb=# insert into t1 values (3);<br>testdb=# insert into t1 values (4);<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">模拟数据删除</span><br>testdb=# \c postgres ;<br>postgres=# drop database testdb;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">发现故障，停止用户访问</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看当前日志文件</span><br>postgres=# select pg_walfile_name(pg_current_wal_lsn());<br>     pg_walfile_name      <br>--------------------------<br> 000000010000000000000003<br>(1 row)<br><br>postgres=# select txid_current();<br> txid_current <br>--------------<br>          741<br>(1 row)<br><br><br></code></pre></td></tr></table></figure>

<h4 id="5-6-2-2故障还原"><a href="#5-6-2-2故障还原" class="headerlink" title="5.6.2.2故障还原"></a>5.6.2.2故障还原</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在PG服务器上切换归档日志</span><br>postgres=# select pg_switch_wal();<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在要还原的服务器停止服务，准备还原</span><br>[23:37:50 root@PG-backup ~]#systemctl stop postgresql<br>[23:38:20 root@PG-backup ~]#rm -rf /pgsql/data/*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在测试的还原服务器进行还原</span><br>[23:52:05 root@PG-backup ~]#mkdir /archive/<br>[00:10:48 root@PG-backup ~]#chown -R postgres. /archive/<br>[00:09:21 postgres@PG-backup ~]$tar xf /pgsql/backup/base.tar -C /pgsql/data/<br><span class="hljs-meta prompt_">#</span><span class="language-bash">此步可以不执行</span><br>[00:10:30 postgres@PG-backup ~]$tar xf /pgsql/backup/pg_wal.tar -C /archive/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">复制PG服务器的归档日志到还原的测试服务器</span><br>[00:16:02 root@PG-backup ~]#rsync -a 10.0.0.4:/archive/ /archive/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看故障点事务ID</span><br>[21:52:01 root@PG-backup ~]#pg_waldump /archive/2023-10-02/000000010000000000000003 | grep -B 10 &quot;DROP dir&quot;<br>rmgr: Heap        len (rec/tot):     54/   150, tx:        737, lsn: 0/03000060, prev 0/03000028, desc: INSERT off 2 flags 0x00, blkref #0: rel 1663/16384/16385 blk 0 FPW<br>rmgr: Transaction len (rec/tot):     34/    34, tx:        737, lsn: 0/030000F8, prev 0/03000060, desc: COMMIT 2023-10-02 21:41:59.669497 CST<br>rmgr: Heap        len (rec/tot):     59/    59, tx:        738, lsn: 0/03000120, prev 0/030000F8, desc: INSERT off 3 flags 0x00, blkref #0: rel 1663/16384/16385 blk 0<br>rmgr: Transaction len (rec/tot):     34/    34, tx:        738, lsn: 0/03000160, prev 0/03000120, desc: COMMIT 2023-10-02 21:42:01.887616 CST<br>rmgr: Heap        len (rec/tot):     59/    59, tx:        739, lsn: 0/03000188, prev 0/03000160, desc: INSERT off 4 flags 0x00, blkref #0: rel 1663/16384/16385 blk 0<br>rmgr: Transaction len (rec/tot):     34/    34, tx:        739, lsn: 0/030001C8, prev 0/03000188, desc: COMMIT 2023-10-02 21:42:05.595895 CST<br>rmgr: Standby     len (rec/tot):     50/    50, tx:          0, lsn: 0/030001F0, prev 0/030001C8, desc: RUNNING_XACTS nextXid 740 latestCompletedXid 739 oldestRunningXid 740<br>rmgr: Heap        len (rec/tot):     59/  1243, tx:        740, lsn: 0/03000228, prev 0/030001F0, desc: DELETE off 4 flags 0x00 KEYS_UPDATED , blkref #0: rel 1664/0/1262 blk 0 FPW<br>rmgr: Standby     len (rec/tot):     54/    54, tx:          0, lsn: 0/03000708, prev 0/03000228, desc: RUNNING_XACTS nextXid 741 latestCompletedXid 739 oldestRunningXid 740; 1 xacts: 740<br>rmgr: XLOG        len (rec/tot):    114/   114, tx:          0, lsn: 0/03000740, prev 0/03000708, desc: CHECKPOINT_ONLINE redo 0/3000708; tli 1; prev tli 1; fpw true; xid 0:741; oid 24576; multi 1; offset 0; oldest xid 726 in DB 1; oldest multi 1 in DB 1; oldest/newest commit timestamp xid: 0/0; oldest running xid 740; online<br>rmgr: Database    len (rec/tot):     38/    38, tx:        740, lsn: 0/030007B8, prev 0/03000740, desc: DROP dir 1663/16384<br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看此指令的事务ID为740，前一个事务为739</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改配置文件postgresq1.conf,或者postgresq1.auto.conf文件也可以</span><br>[21:53:22 root@PG-backup ~]#vim /pgsql/data/postgresql.conf <br><span class="hljs-meta prompt_">#</span><span class="language-bash">加下面两行</span><br>restore_command = &#x27;cp /archive/2023-10-02/%f %p&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">指定还原至上面查到的事务ID</span><br>recovery_target_xid = &#x27;739&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">也可以通过下面方式指定还原至的位置</span><br>recovery_target_name =&#x27;restore_point&#x27; #指定还原点名称<br>recovery_target_time=&#x27;2023-10-02 21:42:05&#x27; #指定还原至时间点<br>recovery_target_1sn=&#x27;0/030001C8&#x27; #指定还原到LSN号的位置<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动服务</span><br>[22:06:09 root@PG-backup ~]#systemctl start postgresql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证数据</span><br>[16:17:23 root@PG-backup ~]#psql<br>psql (14.2)<br>Type &quot;help&quot; for help.<br><br>postgres=# <br>postgres=# \l<br>                                  List of databases<br>   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   <br>-----------+----------+----------+-------------+-------------+-----------------------<br> postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br> template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br> template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +<br>           |          |          |             |             | postgres=CTc/postgres<br> testdb    | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | <br>(4 rows)<br><br>postgres=# \c testdb ;<br>You are now connected to database &quot;testdb&quot; as user &quot;postgres&quot;.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证数据是否还原</span><br>testdb=# select * from t1;<br> id <br>----<br>  1<br>  2<br>  3<br>  4<br>(4 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">当前无法写入</span><br>testdb=# insert into t1 values (5);<br>ERROR:  cannot execute INSERT in a read-only transaction<br>[22:06:43 root@PG-backup ~]#pg_controldata <br>pg_control version number:            1300<br>Catalog version number:               202107181<br>Database system identifier:           7285006788378561368<br>Database cluster state:               in archive recovery<br>pg_control last modified:             Mon 02 Oct 2023 10:06:40 PM CST<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">恢复正常模式</span><br>testdb=# select pg_wal_replay_resume();<br> pg_wal_replay_resume <br>----------------------<br> <br>(1 row)<br>[22:10:40 root@PG-backup ~]#pg_controldata <br>pg_control version number:            1300<br>Catalog version number:               202107181<br>Database system identifier:           7285006788378561368<br>Database cluster state:               in production<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">恢复正常写入</span><br>testdb=# insert into t1 values (5);<br>INSERT 0 1<br><br></code></pre></td></tr></table></figure>

<h1 id="6-PostgreSQL高可用"><a href="#6-PostgreSQL高可用" class="headerlink" title="6 PostgreSQL高可用"></a>6 PostgreSQL高可用</h1><h2 id="6-1流复制介绍"><a href="#6-1流复制介绍" class="headerlink" title="6.1流复制介绍"></a>6.1流复制介绍</h2><p>流复制streaming replication是实现PostgreSQL的高可用的常见技术</p>
<p>PostgresQL流复制相当于MySQL的主从复制，可以实现数据同步和数据备份</p>
<p>官方文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://postgres.cn/docs/12/warm-standby.html#STREAMING-REPLICATION<br></code></pre></td></tr></table></figure>

<h3 id="6-1-1什么是流复制"><a href="#6-1-1什么是流复制" class="headerlink" title="6.1.1什么是流复制"></a>6.1.1什么是流复制</h3><p>PostgreSQL通过WAL日志来传送的方式有两种：基于文件的日志传送和流复制。</p>
<p>不同于基于文件的日志传送，流复制的关键在于“流”，所谓流就是没有界限的一串数据，类似于河里的水流，是连成一片的。</p>
<p>流复制比使用基于文件方式的日志传送更能使一台后备服务器保持最新的状态。后备服务器连接到主服务器，主服务器则在WAL记录产生时即将它们以流式传送给后备服务器而不必等到WAL文件被填充。</p>
<p>比如有一个大文件要从本地主机发送到远程主机，如果是按照“流”接收到的话，我们可以一边接收，一边将文本流存入文件系统。这样，等到“流”接收完了，硬盘写入操作也已经完成。</p>
<h3 id="6-1-2流复制发展历史"><a href="#6-1-2流复制发展历史" class="headerlink" title="6.1.2流复制发展历史"></a>6.1.2流复制发展历史</h3><p>PostgreSQL在流复制出现之前，使用的就是基于文件的日志传送：对WAL日志进行拷贝，因此从库始终落后主库一个日志文件，并且还需要使用rsync工具同步数据目录。</p>
<p>而流复制出现是从2010年推出的PostgreSQL9.0开始的，其历史大致为：</p>
<ul>
<li>起源：PostgreSQL9.0开始支持流式物理复制，用户可以通过流式复制，构建只读备库(主备物理复制，块级别一致)。流式物理复制可以做到极低的延迟(通常在1毫秒以内）。</li>
<li>同步流复制：PostgreSQL9.1开始支持同步复制，但是当时只支持一个同步流复制备节点（例如配置了3个备，只有一个是同步模式的，其他都是异步模式)。同步流复制的出现，保证了数据的0丢失。</li>
<li>级联流复制：PostgreSQL9.2支持级联流复制。即备库还可以再连备库。</li>
<li>流式虚拟备库：PostgreSQL9.2还支持虚拟备库，即就是只有WAL，没有数据文件的备库。</li>
<li>逻辑复制：PostgresQL9.4开始可以实现逻辑复制，逻辑复制可以做到对主库的部分复制，例如表级复制，而不是整个集群的块级一致复制。</li>
<li>增加多种同步级别：PostgreSQL9.6版本开始可以通过synchronous_commit参数，来配置事务的同步级别。</li>
</ul>
<h3 id="6-1-3流复制原理"><a href="#6-1-3流复制原理" class="headerlink" title="6.1.3流复制原理"></a>6.1.3流复制原理</h3><p>备库不断的从主库同步相应的数据，并在备库apply每个WAL record，这里的流复制每次传输单位是WAL日志的record。</p>
<p><img src="image-20231002221940237.png" srcset="/img/loading.gif" lazyload alt="image-20231002221940237"></p>
<h3 id="6-1-4流复制按照同步方式分类流"><a href="#6-1-4流复制按照同步方式分类流" class="headerlink" title="6.1.4流复制按照同步方式分类流"></a>6.1.4流复制按照同步方式分类流</h3><p>复制类似于MySQL的的同步机制，支持以下两种同步机制</p>
<ul>
<li>异步流复制</li>
<li>同步流复制</li>
</ul>
<p>在实际生产环境中，建议需要根据环境的实际情况来选择同步或异步模式，同步模式需要等待备库的写盘才能返回成功，如此一来，在主备库复制正常的情况下，能够保证备库的数据不会丢失，但是带来的一个负面问题，一旦备库宕机，主库就会挂起而无法进行正常操作，即在同步模式中，备库对主库的有很大的影响，而异步模式就不会。因此，在生产环境中，大多会选择异步复制模式，而非同步模式.</p>
<h3 id="6-1-5流复制特点"><a href="#6-1-5流复制特点" class="headerlink" title="6.1.5流复制特点"></a>6.1.5流复制特点</h3><ul>
<li>延迟极低，不怕大事务</li>
<li>支持断点续传</li>
<li>支持多副本</li>
<li>配置简单</li>
<li>备库与主库物理完全一致，并支持只读</li>
</ul>
<h2 id="6-2实现流复制"><a href="#6-2实现流复制" class="headerlink" title="6.2实现流复制"></a>6.2实现流复制</h2><h3 id="6-2-1基础环境准备"><a href="#6-2-1基础环境准备" class="headerlink" title="6.2.1基础环境准备"></a>6.2.1基础环境准备</h3><p>两个主机节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">10.0.0.4 Master<br>10.0.0.3 Standby<br></code></pre></td></tr></table></figure>

<p><img src="image-20231002222230041.png" srcset="/img/loading.gif" lazyload alt="image-20231002222230041"></p>
<h3 id="6-2-2-Master-节点配置"><a href="#6-2-2-Master-节点配置" class="headerlink" title="6.2.2 Master 节点配置"></a>6.2.2 Master 节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在master 10.0.0.4 配置</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建复制的用户并授权</span> <br>[22:26:18 root@PG-Master ~]#psql<br>postgres=# create role repluser with replication login password &#x27;123456&#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改ph_hba.conf进行授权</span><br>[22:26:16 root@PG-Master ~]#vim /pgsql/data/pg_hba.conf <br>host    replication     repluser        0.0.0.0/0               md5<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改配置（可选）：</span><br>[22:31:26 root@PG-Master ~]#vim /pgsql/data/postgresql.conf<br>synchronous_standby_names=&#x27;*&#x27;#开启此项,表示同步方式,需要同时打开synchronous_commit=on，此为默认值，默认是异步方式<br><br>synchronous_commit = on #开启同步模式<br>archive_mode= on #建议打开归档模式，防止长时间无法同步，WAL被覆盖造成数据丢失archive_command = &#x27;[ ! -f /archive/%f ] &amp;&amp; cp %p /archive/%f&#x27;<br>wal_level=replica #设置wal的级别<br>max_wal_senders=5#这个设置可以最多有几个流复制连接，一般有几个从节点就设置几个<br>wal_keep_segments=128#设置流复制保留的最多的WAL文件数目<br>wal_sender_timeout =60s #设置流复制主机发送数据的超时时间<br>max_connections=200#一般查多于写的应用从库的最大连接数要比较大<br>hot_standby=on#对主库无影响，用于将来可能会成为从库,这台机器不仅仅是用于数据归档，也用于数据查询，在从库上配置此项后为只读<br>max_standby_streaming_delay =30s #数据流备份的最大延迟时间<br>wal_receiver_status_interval=10s #多久向主报告一次从的状态,当然从每次数据复制都会向主报告状态，只是设置最长的间隔时间<br>hot_standby_feedback = on #如果有错误的数据复制，是否向主进行反馈<br>wal_log_hints = on	#对非关键更新进行整页写入<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务</span><br>[22:39:28 root@PG-Master ~]#mkdir /archive<br>[22:39:43 root@PG-Master ~]#chown repluser. /archive/<br>[22:40:18 root@PG-Master ~]#systemctl restart postgresql.service<br><br><br></code></pre></td></tr></table></figure>

<h3 id="6-2-3-Standby节点配置"><a href="#6-2-3-Standby节点配置" class="headerlink" title="6.2.3 Standby节点配置"></a>6.2.3 Standby节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在从节点 10.0.0.3上配置</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">清空数据和归档</span><br>[22:26:10 root@PG-Standby ~]#systemctl stop postgresql<br>[22:42:42 root@PG-Standby ~]#rm -rf /pgsql/data/*<br>[22:42:53 root@PG-Standby ~]#mkdir /archive<br>[22:43:14 root@PG-Standby ~]#rm -rf /archive/*<br>[22:43:21 root@PG-Standby ~]#mkdir -p /pgsql/backup<br>[22:44:05 root@PG-Standby ~]#rm -rf /pgsql/backup/*<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">备份主库数据到备库</span><br>[22:44:16 root@PG-Standby ~]#pg_basebackup -D /pgsql/backup/ -Ft -Pv -Urepluser  -h 10.0.0.4 -p 5432 -R<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">还原备份的数据实现初始的主从数据同步</span><br>[22:46:02 root@PG-Standby ~]#tar xf /pgsql/backup/base.tar -C /pgsql/data/<br>[22:47:26 root@PG-Standby ~]#tar xf /pgsql/backup/pg_wal.tar -C /archive/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法1</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改postgresql.conf文件</span><br>[22:47:42 root@PG-Standby ~]#vim /pgsql/data/postgresql.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">添加下面两行</span><br>primary_conninfo = &#x27;host=10.0.0.4 port=5432 user=repluser password=123456&#x27;<br>restore_command = &#x27;cp /archive/%f %p&#x27;  #此行可不配置<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改配置（可选）：</span><br>hot_standby = on	#开启此项，此是默认项<br>recovery_target_timeline =latest #默认<br>max_connections=120 #大于等于主节点，正式环境应当重新考虑此值的大小<br>max_standby_streaming_delay = 30s<br>wal_receiver_status_interval = 10s<br>hot_standby_feedback = on<br>max_wal_senders = 15<br>logging_collector = on<br>1og_directory = &#x27;pg_log&#x27;<br>1og_filename = &#x27;postgresq1-%Y-%m-%d_%H%M%s.1og&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">方法2</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改postgresql.auto.conf文件</span><br>[22:47:42 root@PG-Standby ~]#vim /pgsql/data/postgresql.auto.conf<br>primary_conninfo = &#x27;host=10.0.0.4 port=54321 user=repluser password=123456 sslmode=disable sslcompression=0 gssencmode=disablekrbsrvname=post_session_attrs=any&#x27;#此行自动生成,只修改用户名即可<br>restore_command = &#x27;cp /archive/%f %p&#x27;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务</span><br>[22:51:24 root@PG-Standby ~]#systemctl restart postgresql.service<br><br></code></pre></td></tr></table></figure>

<h3 id="6-2-4监控同步状态"><a href="#6-2-4监控同步状态" class="headerlink" title="6.2.4监控同步状态"></a>6.2.4监控同步状态</h3><h4 id="6-2-4-1在主库查看状态"><a href="#6-2-4-1在主库查看状态" class="headerlink" title="6.2.4.1在主库查看状态"></a>6.2.4.1在主库查看状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在master 10.0.0.4上查看</span><br>[22:42:12 root@PG-Master ~]#pg_controldata <br>pg_control version number:            1300<br>Catalog version number:               202107181<br>Database system identifier:           7285006788378561368<br>Database cluster state:               in production<br><br>postgres=# select pid,state,client_addr,sync_priority,sync_state from pg_stat_replication;<br> pid  |   state   | client_addr | sync_priority | sync_state <br>------+-----------+-------------+---------------+------------<br> 2284 | streaming | 10.0.0.3    |             0 | async<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">下面只在主节点查看同步模式，注意：如果无从节点连接，将无任何显示信息</span><br>postgres=# select pg_current_wal_insert_lsn(),* from pg_stat_replication;<br>pg_current_wal_insert_lsn | 0/3000148	#当前lsn号<br>pid                       | 2284<br>usesysid                  | 16384<br>usename                   | repluser<br>application_name          | walreceiver<br>client_addr               | 10.0.0.3<br>client_hostname           | <br>client_port               | 42434<br>backend_start             | 2023-10-02 22:54:38.290262+08<br>backend_xmin              | <br>state                     | streaming<br>sent_lsn                  | 0/3000148 <br>write_lsn                 | 0/3000148 #同步的lsn号，和上面一致说明同步，有差异表示有延迟<br>flush_lsn                 | 0/3000148<br>replay_lsn                | 0/3000148<br>write_lag                 | <br>flush_lag                 | <br>replay_lag                | <br>sync_priority             | 0<br>sync_state                | async	#当前是异步，同步显示位sync<br>reply_time                | 2023-10-02 23:00:18.669813+08<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">服务器查看数据库是否位备库，f表示主库，t表示位备库</span><br>postgres=# select * from pg_is_in_recovery();<br>pg_is_in_recovery | f<br><br>postgres=# select application_name,client_addr,sync_state from pg_stat_replication;<br> walreceiver      | 10.0.0.3    | async<br><br><br>[23:06:41 root@PG-Master ~]#ps aux | grep walsender<br>postgres    2284  0.0  1.0 173784  8128 ?        Ss   22:54   0:00 postgres: walsender repluser 10.0.0.3(42434) streaming 0/30190E0<br><br></code></pre></td></tr></table></figure>

<h4 id="6-2-4-2在从库查看状态"><a href="#6-2-4-2在从库查看状态" class="headerlink" title="6.2.4.2在从库查看状态"></a>6.2.4.2在从库查看状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在从库10.0.0.3上查看</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">从节点可以读</span><br>testdb=# select * from t1;<br> id <br>----<br>  1<br>  2<br>  3<br>  5<br>(4 rows)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">从节点不支持写</span><br>testdb=# insert into t1 values (4);<br>ERROR:  cannot execute INSERT in a read-only transaction<br><br><br>[22:54:38 root@PG-Standby ~]#pg_controldata <br>pg_control version number:            1300<br>Catalog version number:               202107181<br>Database system identifier:           7285006788378561368<br>Database cluster state:               in archive recovery #备库状态<br>pg_control last modified:             Mon 02 Oct 2023 11:07:38 PM CST<br><br>testdb=# select * from pg_is_in_recovery();<br> pg_is_in_recovery <br>-------------------<br> t<br>(1 row)<br><br><br>testdb=# \x<br>Expanded display is on.<br><br><br>testdb=# select * from pg_stat_wal_receiver;<br>-[ RECORD 1 ]---------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>pid                   | 1797<br>status                | streaming<br>receive_start_lsn     | 0/3000000<br>receive_start_tli     | 1<br>written_lsn           | 0/3019308<br>flushed_lsn           | 0/3019308<br>received_tli          | 1<br>last_msg_send_time    | 2023-10-02 23:13:05.339437+08<br>last_msg_receipt_time | 2023-10-02 23:13:05.339583+08<br>latest_end_lsn        | 0/3019308<br>latest_end_time       | 2023-10-02 23:12:35.320206+08<br>slot_name             | <br>sender_host           | 10.0.0.4<br>sender_port           | 5432<br>conninfo              | user=repluser password=******** channel_binding=disable dbname=replication host=10.0.0.4 port=5432 fallback_application_name=walreceiver sslmode=disable sslcompression=0 sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=disable krbsrvname=postgres target_session_attrs=any<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看进程</span><br>[23:13:52 root@PG-Standby ~]#ps aux | grep postgres<br>postgres    1789  0.0  2.3 172768 17472 ?        Ss   22:54   0:00 /aaps/pgsql/bin/postmaster -D /pgsql/data/<br>postgres    1790  0.0  1.0 172952  8096 ?        Ss   22:54   0:00 postgres: startup recovering 000000010000000000000003	#恢复进程<br>postgres    1793  0.0  0.7 172768  5396 ?        Ss   22:54   0:00 postgres: checkpointer <br>postgres    1794  0.0  0.3 172768  2608 ?        Ss   22:54   0:00 postgres: background writer <br>postgres    1796  0.0  0.3  27552  2736 ?        Ss   22:54   0:00 postgres: stats collector <br>postgres    1797  0.0  0.7 177372  5712 ?        Ss   22:54   0:00 postgres: walreceiver streaming 0/3019308	#接受wal日志进程<br>postgres    1826  0.0  1.8 175144 13748 ?        Ss   23:10   0:00 postgres: postgres testdb [local] idle<br>root        1831  0.0  0.1  12144  1176 pts/0    S+   23:13   0:00 grep --color=auto postgres<br><span class="hljs-meta prompt_">#</span><br></code></pre></td></tr></table></figure>

<h3 id="6-2-5切换主从"><a href="#6-2-5切换主从" class="headerlink" title="6.2.5切换主从"></a>6.2.5切换主从</h3><h4 id="6-2-5-1将从库切换为主库"><a href="#6-2-5-1将从库切换为主库" class="headerlink" title="6.2.5.1将从库切换为主库"></a>6.2.5.1将从库切换为主库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在从库 10.0.0.3上配置</span><br>[23:16:13 postgres@PG-Standby ~]$pg_ctl promote<br>waiting for server to promote.... done<br>server promoted<br>[23:16:26 postgres@PG-Standby ~]$pg_controldata <br>pg_control version number:            1300<br>Catalog version number:               202107181<br>Database system identifier:           7285006788378561368<br>Database cluster state:               in production<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启服务</span><br>[23:18:49 root@PG-Standby ~]#systemctl restart postgresql<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">恢复正常模式</span><br>postgres=# select pg_wal_replay_resume();<br><br></code></pre></td></tr></table></figure>

<h4 id="6-2-5-2原主库切换为从库"><a href="#6-2-5-2原主库切换为从库" class="headerlink" title="6.2.5.2原主库切换为从库"></a>6.2.5.2原主库切换为从库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在原主库服务器10.0.0.4上配置</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在原主库修复故障后，在主库服务器重复上面Standby节点的6.2.3的步骤</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在原主库服务器创建standby.signal文件</span><br>[23:21:29 root@PG-Master ~]#touch $PGDATA/standby.signal<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在原主库服务器启动服务</span><br>[23:34:26 root@PG-Master ~]#systemctl restart postgresql.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在主服务器上查看状态</span><br>[23:35:50 root@PG-Master ~]#pg_controldata <br>pg_control version number:            1300<br>Catalog version number:               202107181<br>Database system identifier:           7285006788378561368<br>Database cluster state:               in archive recovery<br><br>testdb=# select * from pg_is_in_recovery();<br> t<br></code></pre></td></tr></table></figure>

<h4 id="6-2-5-3重新验证同步状态"><a href="#6-2-5-3重新验证同步状态" class="headerlink" title="6.2.5.3重新验证同步状态"></a>6.2.5.3重新验证同步状态</h4><p>在新主库创建数据，验证是否能同步至原主库</p>
<h3 id="6-2-6实现同步的流复制"><a href="#6-2-6实现同步的流复制" class="headerlink" title="6.2.6实现同步的流复制"></a>6.2.6实现同步的流复制</h3><h4 id="6-2-6-1配置同步的流复制"><a href="#6-2-6-1配置同步的流复制" class="headerlink" title="6.2.6.1配置同步的流复制"></a>6.2.6.1配置同步的流复制</h4><p>主节点需要特殊的如下配置，从节点同6.2.3配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[22:31:26 root@PG-Master ~]#vim /pgsql/data/postgresql.conf<br>synchronous_standby_names=&#x27;*&#x27; #开启此项,表示同步方式,需要同时打开<br>synchronous_commit=on #此为默认值，默认是异步方式<br></code></pre></td></tr></table></figure>

<h4 id="6-2-6-2验证同步状态"><a href="#6-2-6-2验证同步状态" class="headerlink" title="6.2.6.2验证同步状态"></a>6.2.6.2验证同步状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在主节点查看<span class="hljs-built_in">sync</span>状态</span><br>postgres=# select pid,state,client_addr,sync_priority,sync_state from pg_stat_replication;<br> pid  |   state   | client_addr | sync_priority | sync_state <br>------+-----------+-------------+---------------+------------<br> 1466 | streaming | 10.0.0.4    |             1 | sync<br>(1 row)<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">从节点停止服务</span><br>[23:36:06 root@PG-Master ~]#systemctl stop postgresql.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">此种状态下主节点只能读，写入时会处于卡顿状态，直至从节点恢复正常同步</span><br>testdb=# delete from t1 where id=8;<br>....<br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第八周作业</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/09/11/%E7%AC%AC%E4%B8%83%E5%91%A8%E4%BD%9C%E4%B8%9A/">
                        <span class="hidden-mobile">第七周作业</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
