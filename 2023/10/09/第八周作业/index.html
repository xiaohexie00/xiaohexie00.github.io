

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
    <meta name="description" content="1、总结 哨兵机制实现原理，并搭建主从哨兵集群。 哨兵机制解决了主从复制存在的以下问题：  master和slave角色的自动切换，且不能影响业务 提升Redis服务整体性能，支持更高并发访问  1.1 哨兵机制实现原理1.1.1 Sentinel 架构和故障转移  专门的Sentinel 服务进程是用于监控redis集群中Master工作的状态，当Master主服务器发生故障的时候，可以实现Ma">
<meta property="og:type" content="article">
<meta property="og:title" content="第八周作业">
<meta property="og:url" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/index.html">
<meta property="og:site_name" content="5-12 23:30">
<meta property="og:description" content="1、总结 哨兵机制实现原理，并搭建主从哨兵集群。 哨兵机制解决了主从复制存在的以下问题：  master和slave角色的自动切换，且不能影响业务 提升Redis服务整体性能，支持更高并发访问  1.1 哨兵机制实现原理1.1.1 Sentinel 架构和故障转移  专门的Sentinel 服务进程是用于监控redis集群中Master工作的状态，当Master主服务器发生故障的时候，可以实现Ma">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231011221943578.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231011163802745.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231011163819031.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231011171747922.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231011225146339.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012150335596.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012150446323.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012151010636.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012152844379.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012153041925.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012153315334.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012154013997.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012154048160.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012154450625.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012154542411.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012154725022.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012154802680.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012160858415.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012213754844.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012223019823.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231012223029776.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231013001749039.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231009213808559.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231009220005364.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231009220327859.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231009222402918.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231009222740904.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231009235721938.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231010154618994.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231010155831327.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231107200906439.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/3203793/202308/3203793-20230829000709007-322144217.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231107210531529.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231109214431993.png">
<meta property="og:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231109214442168.png">
<meta property="article:published_time" content="2023-10-09T21:25:36.000Z">
<meta property="article:modified_time" content="2023-11-21T13:07:39.263Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/10/09/%E7%AC%AC%E5%85%AB%E5%91%A8%E4%BD%9C%E4%B8%9A/image-20231011221943578.png">
  
  
  <title>第八周作业 - 5-12 23:30</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="第八周作业">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-10-09 21:25" pubdate>
        October 9, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      111k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      924 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">第八周作业</h1>
            
            <div class="markdown-body">
              <h1 id="1、总结-哨兵机制实现原理，并搭建主从哨兵集群。"><a href="#1、总结-哨兵机制实现原理，并搭建主从哨兵集群。" class="headerlink" title="1、总结 哨兵机制实现原理，并搭建主从哨兵集群。"></a>1、总结 哨兵机制实现原理，并搭建主从哨兵集群。</h1><p><img src="image-20231011221943578.png" srcset="/img/loading.gif" lazyload alt="image-20231011221943578"></p>
<p>哨兵机制解决了主从复制存在的以下问题：</p>
<ul>
<li>master和slave角色的自动切换，且不能影响业务</li>
<li>提升Redis服务整体性能，支持更高并发访问</li>
</ul>
<h2 id="1-1-哨兵机制实现原理"><a href="#1-1-哨兵机制实现原理" class="headerlink" title="1.1 哨兵机制实现原理"></a>1.1 哨兵机制实现原理</h2><h3 id="1-1-1-Sentinel-架构和故障转移"><a href="#1-1-1-Sentinel-架构和故障转移" class="headerlink" title="1.1.1 Sentinel 架构和故障转移"></a>1.1.1 Sentinel 架构和故障转移</h3><p><img src="image-20231011163802745.png" srcset="/img/loading.gif" lazyload alt="image-20231011163802745"></p>
<p><img src="image-20231011163819031.png" srcset="/img/loading.gif" lazyload alt="image-20231011163819031"></p>
<p>专门的Sentinel 服务进程是用于监控redis集群中Master工作的状态，当Master主服务器发生故障的时候，可以实现Master和Slave的角色的自动切换，从而实现系统的高可用性</p>
<p>Sentinel是一个分布式系统，即需要在多个节点上各自同时运行一个sentinel进程，Sentienl 进程通过流言协议(gossip protocols)来接收关于Master是否下线状态，并使用投票协议（Agreement Protocols)来决定是否执行自动故障转移，并选择合适的Slave作为新的Master</p>
<p>每个Sentinel进程会向其它Sentinel、Master、Slave定时发送消息，来确认对方是否存活，如果发现某个节点在指定配置时间内未得到响应，则会认为此节点已离线，即为主观宕机Subjective Down，简称为SDOWN</p>
<p>如果哨兵集群中的多数Sentinel进程认为Master存在SDown,共同利用is-master-down-by-addr命令互相通知后，则认为客观宕机Objectively Down，简称 ODOWN</p>
<p>接下来利用投票算法，从所有slave节点中，选一台合适的slave将之提升为新Master节点，然后自动修改其它slave相关配置，指向新的master节点，最终实现故障转移failover</p>
<p>Redis Sentinel中的Sentinel节点个数应该为大于等于3且最好为奇数客户端初始化时连接的是Sentinel节点集合，不再是具体的Redis节点，即Sentinel只是配置中心不是代理。</p>
<p>Redis Sentinel 节点与普通 Redis 没有区别，要实现读写分离依赖于客户端程序</p>
<p>Sentinel机制类似于MySQL中的MHA功能，只解决master和slave角色的自动故障转移问题，但单个Master的性能瓶颈问题并没有解决</p>
<p>Redis 3.0之前版本中,生产环境一般使用哨兵模式较多，Redis 3.0后推出Redis cluster功能，可以支持更大规模的高并发环境</p>
<h3 id="1-1-2-Sentinel中的三个定时任务"><a href="#1-1-2-Sentinel中的三个定时任务" class="headerlink" title="1.1.2 Sentinel中的三个定时任务"></a>1.1.2 Sentinel中的三个定时任务</h3><ul>
<li><p>每10秒每个sentinel对master和slave执行info</p>
<ul>
<li>发现slave节点</li>
<li>确认主从关系</li>
</ul>
</li>
<li><p>每2秒每个sentinel通过master节点的channel交换信息(pub/sub)</p>
<ul>
<li>通过sentinel_:hello频道交互</li>
<li>交互对节点的“看法”和自身信息</li>
</ul>
</li>
<li><p>每1秒每个sentinel对其他sentinel和redis执行ping</p>
</li>
</ul>
<h2 id="1-2-搭建主从哨兵集群"><a href="#1-2-搭建主从哨兵集群" class="headerlink" title="1.2 搭建主从哨兵集群"></a>1.2 搭建主从哨兵集群</h2><p>以下案例实现一主两从的基于哨兵的高可用Redis架构</p>
<p><img src="image-20231011171747922.png" srcset="/img/loading.gif" lazyload alt="image-20231011171747922"></p>
<h3 id="1-2-1-哨兵需要先实现主从复制"><a href="#1-2-1-哨兵需要先实现主从复制" class="headerlink" title="1.2.1 哨兵需要先实现主从复制"></a>1.2.1 哨兵需要先实现主从复制</h3><p>哨兵的前提是已经实现了Redis的主从复制</p>
<p>注意：master的配置文件中masterauth和slave都必须相同</p>
<p>所有主从节点的 redis.conf 中关健配置</p>
<p>范例：准备主从环境配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在所有的主从节点执行</span><br>[17:19:41 root@Master-redis ~]#yum -y install redis<br>[17:21:45 root@Master-redis ~]#vim /etc/redis.conf <br>bind 0.0.0.0<br>masterauth &quot;123456&quot;<br>requirepass &quot;123456&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">或者非交互执行</span><br>[20:23:03 root@Slave-redis ~]#sed -i -e &#x27;s/bind 127.0.0.1/bind 0.0.0.0/&#x27; -e &#x27;s/^# masterauth .*/masterauth 123456/&#x27; -e &#x27;s/^# requirepass .*/requirepass 123456/&#x27; /etc/redis.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在所有从节点执行</span><br>[20:28:56 root@Slave-redis ~]#echo &quot;replicaof 10.0.0.128 6379&quot; &gt;&gt; /etc/redis.conf <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在所有的主从节点执行</span><br>[20:16:38 root@Master-redis ~]#systemctl enable --now  redis<br></code></pre></td></tr></table></figure>

<p><strong>master 服务器状态</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">[20:32:29 root@Master-redis ~]#redis-cli -a 123456<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=10.0.0.3,port=6379,state=online,offset=112,lag=0<br>slave1:ip=10.0.0.4,port=6379,state=online,offset=98,lag=1<br>master_replid:63fd06aed1fa325a7b7efd74c2a2e5cbfbfdb59a<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:112<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:112<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>配置 slave1</strong> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">[20:32:33 root@Slave1-redis ~]#redis-cli  -a 123456<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:6379&gt; replicaof 10.0.0.128 6379<br>OK Already connected to specified master<br>127.0.0.1:6379&gt; config set masterauth &quot;123456&quot;<br>OK<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:10.0.0.128<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:9<br>master_sync_in_progress:0<br>slave_repl_offset:350<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:63fd06aed1fa325a7b7efd74c2a2e5cbfbfdb59a<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:350<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:350<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<p><strong>配置 slave2</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell">[20:38:28 root@Slave2-redis ~]#redis-cli -a 123456<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:6379&gt; replicaof 10.0.0.128 6379<br>OK Already connected to specified master<br>127.0.0.1:6379&gt; config set masterauth &quot;123456&quot;<br>OK<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:10.0.0.128<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:7<br>master_sync_in_progress:0<br>slave_repl_offset:588<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:63fd06aed1fa325a7b7efd74c2a2e5cbfbfdb59a<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:588<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:588<br>127.0.0.1:6379&gt; <br></code></pre></td></tr></table></figure>

<h3 id="1-2-2编辑哨兵配置"><a href="#1-2-2编辑哨兵配置" class="headerlink" title="1.2.2编辑哨兵配置"></a>1.2.2编辑哨兵配置</h3><p>sentinel配置</p>
<p>Sentinel实际上是一个特殊的redis服务器，有些redis指令支持，但很多指令并不支持.默认监听在26379/tcp端口.</p>
<p>哨兵服务可以和Redis服务器分开部署在不同主机，但为了节约成本一般会部署在一起</p>
<p>所有redis节点使用相同的以下示例的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">如果是编译安装，在源码目录有sentinel.conf，复制到安装目录即可，如:/apps/redis/etc/sentinel.conf</span><br>[20:32:29 root@Master-redis ~]#cp redis-6.2.5/sentinel.conf /apps/redis/etc/sentinel.conf<br>[20:32:29 root@Master-redis ~]#chown redis.redis /apps/redis/etc/sentinel.conf<br>[20:32:29 root@Master-redis ~]#vim /etc/redis-sentinel.conf<br>bind 0.0.0.0<br>port 26379<br>daemonize yes<br>pidfile &quot;redis-sentinel.pid&quot;<br>logfile &quot;sentinel_26379.log&quot;<br>dir&quot;/tmp&quot;	#工作目录<br><br>sentinel monitor mymaster 10.0.0.8 6379 2<br><span class="hljs-meta prompt_">#</span><span class="language-bash">mymaster是集群的名称，此行指定当前mymaster集群中master服务器的地址和端口</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">2为法定人数限制(quorum)，即有几个sentinel认为master down了就进行故障转移，一般此值是所有sentine1节点（一般总数是&gt;=3的奇数，如：3，5，7等）的一半以上的整数值，比如，总数是3，即3/2=1.5，取整为2,是master的ODOwN客观下线的依据</span><br><br>sentinel auth-pass mymaster 123456<br><span class="hljs-meta prompt_">#</span><span class="language-bash">mymaster集群中master的密码，注意此行要在上面行的下面</span><br><br>sentinel down-after-milliseconds mymaster 30000<br><span class="hljs-meta prompt_">#</span><span class="language-bash">判断mymaster集群中所有节点的主观下线（SDowN）的时间，单位：毫秒，建议3000</span><br><br>sentinel parallel-syncs mymaster 1<br><span class="hljs-meta prompt_">#</span><span class="language-bash">发生故障转移后，可以同时向新master同步数据的slave的数量，数字越小总同步时间越长，但可以减轻新master的负载压力</span><br><br>sentinel failover-timeout mymaster 180000<br><span class="hljs-meta prompt_">#</span><span class="language-bash">所有slaves指向新的master所需的超时时间，单位：毫秒</span><br><br>sentinel deny-scripts-reconfig yes #禁止修改脚本<br><br>logfile /var/log/redis/sentinel.log<br></code></pre></td></tr></table></figure>

<p><strong>三个哨兵服务器的配置如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell">[20:53:15 root@Master-redis ~]#grep -Ev &quot;^#|^$&quot; /etc/redis-sentinel.conf <br>port 26379<br>daemonize no<br>pidfile /var/run/redis-sentinel.pid<br>logfile &quot;&quot;<br>dir /tmp<br>sentinel monitor mymaster 10.0.0.128 6379 2		#修改此行<br>sentinel auth-pass mymaster 123456				#添加此行<br>sentinel down-after-milliseconds mymaster 3000	#修改此行<br>sentinel parallel-syncs mymaster 1<br>sentinel failover-timeout mymaster 180000<br>sentinel deny-scripts-reconfig yes<br>logfile /var/log/redis/sentinel.log<br><br>[21:06:18 root@Master-redis ~]#sed -i -e &#x27;s/^sentinel monitor mymaster 127.0.0.1 6379 2/sentinel monitor mymaster 10.0.0.128 6379 2/&#x27; -e &#x27;s/# sentinel auth-pass &lt;master-name&gt; &lt;password&gt;/sentinel auth-pass mymaster 123456/&#x27; -e &#x27;s/sentinel down-after-milliseconds mymaster 30000/sentinel down-after-milliseconds mymaster 3000/&#x27;  /etc/redis-sentinel.conf <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意此行自动生成必须唯一，一般不需要修改，如果相同则需要修改此值需要重启redis和sentinel服务</span><br>sentinel myid 50547f34ed71fd48c197924969937e738a39975b<br><br>[21:17:37 root@Master-redis ~]#grep &quot;^sentinel&quot;  /etc/redis-sentinel.conf <br>sentinel myid 076fb219d24e911e7e3c29ea938e83ffb7a20f25<br>sentinel deny-scripts-reconfig yes<br>sentinel monitor mymaster 10.0.0.128 6379 2<br>sentinel down-after-milliseconds mymaster 3000<br>sentinel auth-pass mymaster 123456<br>sentinel config-epoch mymaster 0<br>sentinel leader-epoch mymaster 0<br>sentinel known-replica mymaster 10.0.0.4 6379<br>sentinel known-replica mymaster 10.0.0.3 6379<br>sentinel current-epoch 0<br></code></pre></td></tr></table></figure>

<h3 id="1-2-3启动哨兵服务"><a href="#1-2-3启动哨兵服务" class="headerlink" title="1.2.3启动哨兵服务"></a>1.2.3启动哨兵服务</h3><p>将所有哨兵服务器都启动起来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">确保每个哨兵主机myid唯一，如果相同必须手动修改为不同的值</span><br>[21:21:45 root@Master-redis ~]#grep &quot;^sentinel&quot;  /etc/redis-sentinel.conf <br>sentinel myid 076fb219d24e911e7e3c29ea938e83ffb7a20f25<br>[21:20:50 root@Slave1-redis ~]#grep &quot;^sentinel&quot;  /etc/redis-sentinel.conf <br>sentinel myid 5eb8954bea6142ca6a7e409ebf0eb5850c0f2fd8<br>[21:20:59 root@Slave2-redis ~]#grep &quot;^sentinel&quot;  /etc/redis-sentinel.conf <br>sentinel myid f55f6616eb3d0784cb68b38bb185ea487721d8bd<br><br><br><br>[21:15:48 root@Master-redis ~]#systemctl enable --now redis-sentinel.service<br>[21:15:44 root@Slave1-redis ~]#systemctl enable --now redis-sentinel.service<br>[21:15:37 root@Slave2-redis ~]#systemctl enable --now redis-sentinel.service<br></code></pre></td></tr></table></figure>

<p>如果是编译安装,在所有哨兵服务器执行下面操作启动哨兵</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@redis-master ~]#/apps/redis/bin/redis-sentinel/apps/redis/etc/sentinel.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果是编译安装，可以在所有节点生成新的service文件</span><br>[root@redis-master ~]#cat /lib/systemd/system/redis-sentinel.service<br>[unit]<br>Description=Redis Sentinel<br>After=network.target<br><br>[service]<br>ExecStart=/apps/redis/bin/redis-sentinel /apps/redis/etc/sentinel.conf --supervised systemd<br>ExecStop=/bin/ki11 -s QUIT $MAINPID<br>User=redis<br>Group=redis<br>RuntimeDirectory=redis<br>RuntimeDirectoryMode=0755<br><br>[Instal1]<br>WantedBy=multi-user.target<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意所有节点的目录权限，否则无法启动服务[root@redis-master ~]<span class="hljs-comment">#chown -R redis.redis /apps/redis/</span></span><br></code></pre></td></tr></table></figure>

<h3 id="1-2-4验证哨兵服务"><a href="#1-2-4验证哨兵服务" class="headerlink" title="1.2.4验证哨兵服务"></a>1.2.4验证哨兵服务</h3><h4 id="1-2-4-1查看哨兵服务端口状态"><a href="#1-2-4-1查看哨兵服务端口状态" class="headerlink" title="1.2.4.1查看哨兵服务端口状态"></a>1.2.4.1查看哨兵服务端口状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:26:30 root@Master-redis ~]#ss -ntl<br>State        Recv-Q       Send-Q             Local Address:Port              Peer Address:Port      Process       <br>LISTEN       0            128                      0.0.0.0:26379                  0.0.0.0:*                       <br>LISTEN       0            128                      0.0.0.0:6379                   0.0.0.0:*                       <br>LISTEN       0            128                      0.0.0.0:22                     0.0.0.0:*                       <br>LISTEN       0            128                         [::]:26379                     [::]:*                       <br>LISTEN       0            128                         [::]:22                        [::]:*                       <br>    <br></code></pre></td></tr></table></figure>

<h4 id="1-2-4-2-查看哨兵日志"><a href="#1-2-4-2-查看哨兵日志" class="headerlink" title="1.2.4.2 查看哨兵日志"></a>1.2.4.2 查看哨兵日志</h4><p><strong>master的哨兵日志</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:28:11 root@Master-redis ~]#tail -f /var/log/redis/sentinel.log <br>4069:X 11 Oct 2023 21:17:33.903 # Configuration loaded<br>4069:X 11 Oct 2023 21:17:33.903 * supervised by systemd, will signal readiness<br>4069:X 11 Oct 2023 21:17:33.903 * Running mode=sentinel, port=26379.<br>4069:X 11 Oct 2023 21:17:33.903 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.<br>4069:X 11 Oct 2023 21:17:33.907 # Sentinel ID is 076fb219d24e911e7e3c29ea938e83ffb7a20f25<br>4069:X 11 Oct 2023 21:17:33.907 # +monitor master mymaster 10.0.0.128 6379 quorum 2<br>4069:X 11 Oct 2023 21:17:33.907 * +slave slave 10.0.0.3:6379 10.0.0.3 6379 @ mymaster 10.0.0.128 6379<br>4069:X 11 Oct 2023 21:17:33.908 * +slave slave 10.0.0.4:6379 10.0.0.4 6379 @ mymaster 10.0.0.128 6379<br>4069:X 11 Oct 2023 21:20:52.823 * +sentinel sentinel 5eb8954bea6142ca6a7e409ebf0eb5850c0f2fd8 10.0.0.3 26379 @ mymaster 10.0.0.128 6379<br>4069:X 11 Oct 2023 21:21:01.535 * +sentinel sentinel f55f6616eb3d0784cb68b38bb185ea487721d8bd 10.0.0.4 26379 @ mymaster 10.0.0.128 6379<br></code></pre></td></tr></table></figure>

<p><strong>slave的哨兵日志</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:27:12 root@Slave1-redis ~]#tail /var/log/redis/sentinel.log <br>3124:X 11 Oct 2023 21:20:50.728 # Redis version=5.0.3, bits=64, commit=00000000, modified=0, pid=3124, just started<br>3124:X 11 Oct 2023 21:20:50.728 # Configuration loaded<br>3124:X 11 Oct 2023 21:20:50.728 * supervised by systemd, will signal readiness<br>3124:X 11 Oct 2023 21:20:50.729 * Running mode=sentinel, port=26379.<br>3124:X 11 Oct 2023 21:20:50.734 # Sentinel ID is 5eb8954bea6142ca6a7e409ebf0eb5850c0f2fd8<br>3124:X 11 Oct 2023 21:20:50.734 # +monitor master mymaster 10.0.0.128 6379 quorum 2<br>3124:X 11 Oct 2023 21:20:50.735 * +slave slave 10.0.0.3:6379 10.0.0.3 6379 @ mymaster 10.0.0.128 6379<br>3124:X 11 Oct 2023 21:20:50.736 * +slave slave 10.0.0.4:6379 10.0.0.4 6379 @ mymaster 10.0.0.128 6379<br>3124:X 11 Oct 2023 21:20:51.483 * +sentinel sentinel 076fb219d24e911e7e3c29ea938e83ffb7a20f25 10.0.0.128 26379 @ mymaster 10.0.0.128 6379<br>3124:X 11 Oct 2023 21:21:01.537 * +sentinel sentinel f55f6616eb3d0784cb68b38bb185ea487721d8bd 10.0.0.4 26379 @ mymaster 10.0.0.128 6379<br><br></code></pre></td></tr></table></figure>

<h4 id="1-2-4-3当前sentinel状态"><a href="#1-2-4-3当前sentinel状态" class="headerlink" title="1.2.4.3当前sentinel状态"></a>1.2.4.3当前sentinel状态</h4><p>在sentinel状态中尤其是最后一行,涉及到masterlP是多少,有几个slave,有几个sentinels,必须是符合全部服务器数量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:35:51 root@Master-redis ~]#redis-cli -p 26379<br>127.0.0.1:26379&gt; info sentinel<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.128:6379,slaves=2,sentinels=3<br><span class="hljs-meta prompt_">#</span><span class="language-bash">两个slave，三个sentinel服务器，如果sentinels值不符合，检查myid可能冲突</span><br></code></pre></td></tr></table></figure>

<h4 id="1-2-4-5停止Master实现故障转移"><a href="#1-2-4-5停止Master实现故障转移" class="headerlink" title="1.2.4.5停止Master实现故障转移"></a>1.2.4.5停止Master实现故障转移</h4><h5 id="1-2-4-5-1停止Master-节点"><a href="#1-2-4-5-1停止Master-节点" class="headerlink" title="1.2.4.5.1停止Master 节点"></a>1.2.4.5.1停止Master 节点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:38:55 root@Master-redis ~]#systemctl stop redis<br></code></pre></td></tr></table></figure>

<p>查看各节点上哨兵信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:39:21 root@Master-redis ~]#redis-cli -a 123456 -p 26379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:26379&gt; info sentinel<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.3:6379,slaves=2,sentinels=3<br></code></pre></td></tr></table></figure>

<p>故障转移时sentinel的信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:59:16 root@Master-redis ~]#tail -f /var/log/redis/sentinel.log <br>4069:X 11 Oct 2023 21:39:18.735 # +new-epoch 1<br>4069:X 11 Oct 2023 21:39:18.737 # +vote-for-leader f55f6616eb3d0784cb68b38bb185ea487721d8bd 1<br>4069:X 11 Oct 2023 21:39:18.787 # +odown master mymaster 10.0.0.128 6379 #quorum 3/2<br>4069:X 11 Oct 2023 21:39:18.787 # Next failover delay: I will not start a failover before Wed Oct 11 21:45:19 2023<br>4069:X 11 Oct 2023 21:39:19.832 # +config-update-from sentinel f55f6616eb3d0784cb68b38bb185ea487721d8bd 10.0.0.4 26379 @ mymaster 10.0.0.128 6379<br>4069:X 11 Oct 2023 21:39:19.832 # +switch-master mymaster 10.0.0.128 6379 10.0.0.3 6379<br>4069:X 11 Oct 2023 21:39:19.833 * +slave slave 10.0.0.4:6379 10.0.0.4 6379 @ mymaster 10.0.0.3 6379<br>4069:X 11 Oct 2023 21:39:19.833 * +slave slave 10.0.0.128:6379 10.0.0.128 6379 @ mymaster 10.0.0.3 6379<br>4069:X 11 Oct 2023 21:39:22.917 # +sdown slave 10.0.0.128:6379 10.0.0.128 6379 @ mymaster 10.0.0.3 6379<br>4069:X 11 Oct 2023 21:53:13.525 # -sdown slave 10.0.0.128:6379 10.0.0.128 6379 @ mymaster 10.0.0.3 6379<br></code></pre></td></tr></table></figure>

<h5 id="1-2-4-5-2验证故障转移"><a href="#1-2-4-5-2验证故障转移" class="headerlink" title="1.2.4.5.2验证故障转移"></a>1.2.4.5.2验证故障转移</h5><p>故障转移后redis.conf中的replicaof行的master IP会被修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:26:19 root@Slave2-redis ~]#grep ^replicaof /etc/redis.conf <br>replicaof 10.0.0.3 6379<br></code></pre></td></tr></table></figure>

<p>哨兵配置文件的sentinel monitor lP同样也会被修改</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:44:12 root@Slave2-redis ~]#grep &quot;^[a-Z]&quot; /etc/redis-sentinel.conf <br>port 26379<br>daemonize no<br>pidfile &quot;/var/run/redis-sentinel.pid&quot;<br>logfile &quot;/var/log/redis/sentinel.log&quot;<br>dir &quot;/tmp&quot;<br>sentinel myid f55f6616eb3d0784cb68b38bb185ea487721d8bd<br>sentinel deny-scripts-reconfig yes<br>sentinel monitor mymaster 10.0.0.3 6379 2		#此行被自动修改<br>sentinel down-after-milliseconds mymaster 3000<br>sentinel auth-pass mymaster 123456<br>sentinel config-epoch mymaster 1<br>protected-mode no<br>supervised systemd<br>sentinel leader-epoch mymaster 1<br>sentinel known-replica mymaster 10.0.0.4 6379<br>sentinel known-replica mymaster 10.0.0.128 6379<br>sentinel known-sentinel mymaster 10.0.0.128 26379 076fb219d24e911e7e3c29ea938e83ffb7a20f25<br>sentinel known-sentinel mymaster 10.0.0.3 26379 5eb8954bea6142ca6a7e409ebf0eb5850c0f2fd8<br>sentinel current-epoch 1<br><br></code></pre></td></tr></table></figure>

<h5 id="1-2-4-5-3验证Redis各节点状态"><a href="#1-2-4-5-3验证Redis各节点状态" class="headerlink" title="1.2.4.5.3验证Redis各节点状态"></a>1.2.4.5.3验证Redis各节点状态</h5><p>新的master状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:44:55 root@Slave1-redis ~]#redis-cli -a 123456<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.4,port=6379,state=online,offset=369425,lag=0<br>master_replid:75c22bb37e895977d922a8851e1e1a178e0457d7<br>master_replid2:63fd06aed1fa325a7b7efd74c2a2e5cbfbfdb59a<br>master_repl_offset:369425<br>second_repl_offset:234939<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:369425<br></code></pre></td></tr></table></figure>

<p>另一个slave指向新的master</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:44:20 root@Slave2-redis ~]#redis-cli -a 123456<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:10.0.0.3		#指向新的master<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:1<br>master_sync_in_progress:0<br>slave_repl_offset:366251<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:75c22bb37e895977d922a8851e1e1a178e0457d7<br>master_replid2:63fd06aed1fa325a7b7efd74c2a2e5cbfbfdb59a<br>master_repl_offset:366251<br>second_repl_offset:234939<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:366251<br></code></pre></td></tr></table></figure>



<h5 id="1-2-4-3-6原master重新加入Redis集群"><a href="#1-2-4-3-6原master重新加入Redis集群" class="headerlink" title="1.2.4.3.6原master重新加入Redis集群"></a>1.2.4.3.6原master重新加入Redis集群</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:53:28 root@Master-redis ~]#grep replicaof /etc/redis.conf <br><span class="hljs-meta prompt_">#</span><span class="language-bash">sentinel会自动修改下面行指向新的master</span><br>replicaof 10.0.0.3 6379<br><br>[21:54:16 root@Master-redis ~]#redis-cli -a 123456<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:10.0.0.3<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:1<br>master_sync_in_progress:0<br>slave_repl_offset:430712<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:75c22bb37e895977d922a8851e1e1a178e0457d7<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:430712<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:399801<br>repl_backlog_histlen:30912<br><br><br>[21:57:10 root@Master-redis ~]#redis-cli -p 26379<br>127.0.0.1:26379&gt; info sentinel<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Sentinel</span><br>sentinel_masters:1<br>sentinel_tilt:0<br>sentinel_running_scripts:0<br>sentinel_scripts_queue_length:0<br>sentinel_simulate_failure_flags:0<br>master0:name=mymaster,status=ok,address=10.0.0.3:6379,slaves=2,sentinels=3<br><br><br>[21:59:16 root@Master-redis ~]#tail -f /var/log/redis/sentinel.log <br>4069:X 11 Oct 2023 21:39:22.917 # +sdown slave 10.0.0.128:6379 10.0.0.128 6379 @ mymaster 10.0.0.3 6379<br>4069:X 11 Oct 2023 21:53:13.525 # -sdown slave 10.0.0.128:6379 10.0.0.128 6379 @ mymaster 10.0.0.3 6379<br></code></pre></td></tr></table></figure>



<h1 id="2、总结redis-cluster工作原理，并搭建集群实现扩缩容。"><a href="#2、总结redis-cluster工作原理，并搭建集群实现扩缩容。" class="headerlink" title="2、总结redis cluster工作原理，并搭建集群实现扩缩容。"></a>2、总结redis cluster工作原理，并搭建集群实现扩缩容。</h1><h2 id="2-1-Redis-cluster的工作原理"><a href="#2-1-Redis-cluster的工作原理" class="headerlink" title="2.1 Redis cluster的工作原理"></a>2.1 Redis cluster的工作原理</h2><h3 id="2-1-1-Redis-Cluster-介绍"><a href="#2-1-1-Redis-Cluster-介绍" class="headerlink" title="2.1.1 Redis Cluster 介绍"></a>2.1.1 Redis Cluster 介绍</h3><p>使用哨兵sentinel只能解决Redis高可用问题，实现Redis的自动故障转移，但仍然无法解决Redis Master单节点的性能瓶颈问题</p>
<p>为了解决单机性能的瓶颈，提高Redis服务整体性能，可以使用分布式集群的解决方案</p>
<p>Redis 3.0版本之后推出无中心架构的Redis Cluster，支持多个master节点并行写入和故障的自动转移动能.</p>
<h3 id="2-1-2Redis-cluster-架构"><a href="#2-1-2Redis-cluster-架构" class="headerlink" title="2.1.2Redis cluster 架构"></a>2.1.2Redis cluster 架构</h3><p><img src="image-20231011225146339.png" srcset="/img/loading.gif" lazyload alt="image-20231011225146339"></p>
<p>Redis cluster需要至少3个master节点才能实现，slave节点数量不限，当然一般每个master都至少对应的有一个slave节点</p>
<p>如果有三个主节点采用哈希槽hash slot的方式来分配16384个槽位slot</p>
<p>此三个节点分别承担的slot 区间可以是如以下方式分配</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http">节点M1 0-5460<br>节点M2 5461-10922<br>节点M3 10923-16383<br></code></pre></td></tr></table></figure>

<h3 id="2-1-3-Redis-cluster的工作原理"><a href="#2-1-3-Redis-cluster的工作原理" class="headerlink" title="2.1.3 Redis cluster的工作原理"></a>2.1.3 Redis cluster的工作原理</h3><p><img src="image-20231012150335596.png" srcset="/img/loading.gif" lazyload alt="image-20231012150335596"></p>
<h4 id="2-1-3-1数据分区"><a href="#2-1-3-1数据分区" class="headerlink" title="2.1.3.1数据分区"></a>2.1.3.1数据分区</h4><p>如果是单机存储的话，直接将数据存放在单机redis就行了。但是如果是集群存储，就需要考虑到数据分区了。</p>
<p><img src="image-20231012150446323.png" srcset="/img/loading.gif" lazyload alt="image-20231012150446323"></p>
<p>数据分区通常采取顺序分布和hash分布。</p>
<table>
<thead>
<tr>
<th>分布方式</th>
<th>顺序分布</th>
<th>哈希分布</th>
</tr>
</thead>
<tbody><tr>
<td>数据分散度</td>
<td>分布倾斜</td>
<td>分布散列</td>
</tr>
<tr>
<td>顺序访问</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<p>顺序分布保障了数据的有序性，但是离散性低，可能导致某个分区的数据热度高，其他分区数据的热度低，分区访问不均衡。</p>
<p>哈希分布也分为多种分布方式，比如区域哈希分区，一致性哈希分区等。而redis cluster采用的是虚拟槽分区的方式。</p>
<p>虚拟槽分区</p>
<p>redis cluster设置有0~16383的槽，每个槽映射一个数据子集，通过hash函数，将数据存放在不同的槽位中，每个集群的节点保存一部分的槽。</p>
<p>每个key存储时，先经过哈希函数CRC16（key)得到一个整数，然后整数与16384取余，得到槽的数值，然后找到对应的节点，将数据存放入对应的槽中。</p>
<p><img src="image-20231012151010636.png" srcset="/img/loading.gif" lazyload alt="image-20231012151010636"></p>
<p>集群通信</p>
<p>但是寻找槽的过程并不是一次就命中的，比如上图key将要存放在14396槽中，但是并不是一下就锁定了node3节点，可能先去询问node1，然后才访问node3。</p>
<p>而集群中节点之间的通信，保证了最多两次就能命中对应槽所在的节点。因为在每个节点中，都保存了其他节点的信息，知道哪个槽由哪个节点负责。这样即使第一次访问没有命中槽，但是会通知客户端，该槽在哪个节点，这样访问对应节点就能精准命中。</p>
<p><img src="image-20231012152844379.png" srcset="/img/loading.gif" lazyload alt="image-20231012152844379"></p>
<ol>
<li>节点A对节点B发送一个meet操作，B返回后表示A和B之间能够进行沟通。</li>
<li>节点A对节点C发送meet操作，C返回后，A和C之间也能进行沟通</li>
<li>然后B根据对A的了解，就能找到C，B和C之间也建立了联系。</li>
<li>直到所有节点都能建立联系。</li>
</ol>
<p>这样每个节点都能互相知道对方负责哪些槽。</p>
<h4 id="2-1-3-2集群伸缩"><a href="#2-1-3-2集群伸缩" class="headerlink" title="2.1.3.2集群伸缩"></a>2.1.3.2集群伸缩</h4><p>集群并不是建立之后，节点数就固定不变的，也会有新的节点加入集群或者集群中的节点下线，这就是集群的扩容和缩容。但是由于集群节点和槽息息相关，所以集群的伸缩也对应了槽和数据的迁移</p>
<p><img src="image-20231012153041925.png" srcset="/img/loading.gif" lazyload alt="image-20231012153041925"></p>
<p>集群扩容</p>
<p>当有新的节点准备好加入集群时，这个新的节点还是孤立节点，加入有两种方式。一个是通过集群节点执行命令来和孤立节点握手，另一个则是使用脚本来添加节点。</p>
<ol>
<li>cluster_node_ip:port: cluster meet ip port new_node_ip:port</li>
<li>redis-trib.rb add-node new_node_ip:port cluster_node_ip:port</li>
</ol>
<p>通常这个新的节点有两种身份，要么作为主节点，要么作为从节点：</p>
<ul>
<li><p>主节点：分摊槽和数据</p>
</li>
<li><p>从节点：作故障转移备份</p>
</li>
</ul>
<p><img src="image-20231012153315334.png" srcset="/img/loading.gif" lazyload alt="image-20231012153315334"></p>
<p><strong>其中槽的迁移有以下步骤：</strong></p>
<p><img src="image-20231012154013997.png" srcset="/img/loading.gif" lazyload alt="image-20231012154013997"></p>
<p><strong>集群缩容</strong></p>
<p><img src="image-20231012154048160.png" srcset="/img/loading.gif" lazyload alt="image-20231012154048160"></p>
<p>下线节点的流程如下：</p>
<ol>
<li>判断该节点是否持有槽，如果未持有槽就跳转到下一步，持有槽则先迁移槽到其他节点</li>
<li>通知其他节点（cluster forget）忘记该下线节点</li>
<li>关闭下线节点的服务</li>
</ol>
<p>需要注意的是如果先下线主节点，再下线从节点，会进行故障转移，所以要先下线从节点。</p>
<h4 id="2-1-3-3故障转移"><a href="#2-1-3-3故障转移" class="headerlink" title="2.1.3.3故障转移"></a>2.1.3.3故障转移</h4><p><strong>除了手动下线节点外，也会面对突发故障。</strong>下面提到的主要是主节点的故障，因为从节点的故障并不影响主节点工作，对应的主节点只会记住自己哪个从节点下线了，并将信息发送给其他节点。故障的从节点重连后，继续官复原职，复制主节点的数据。</p>
<p>只有主节点才需要进行故障转移。在之前学习主从复制时，我们需要使用redis sentinel来实现故障转移。而redis cluster则不需要redis sentinel,其自身就具备了故障转移功能。</p>
<p>根据前面我们了解到，节点之间是会进行通信的，节点之间通过ping/pong交互消息，所以借此就能发现故障。集群节点发现故障同样是有主观下线和客观下线的</p>
<p><strong>主观下线</strong></p>
<p><img src="image-20231012154450625.png" srcset="/img/loading.gif" lazyload alt="image-20231012154450625"></p>
<p>对于每个节点有一个故障列表，故障列表维护了当前节点接收到的其他所有节点的信息。当半数以上的持有槽的主节点都标记某个节点主观下线，就会尝试客观下线。</p>
<p><strong>客观下线</strong></p>
<p><img src="image-20231012154542411.png" srcset="/img/loading.gif" lazyload alt="image-20231012154542411"></p>
<p>故障转移</p>
<p>集群同样具备了自动转移故障的功能，和哨兵有些类似，在进行客观下线之后，就开始准备让故障节点的从节点“上任”了。</p>
<p>首先是进行资格检查，只有具备资格的从节点才能参加选举：</p>
<ul>
<li>故障节点的所有从节点检查和故障主节点之间的断线时间</li>
<li>超过cluster-node-timeout*cluster-slave-validati-factor(默认10)则取消选举资格</li>
</ul>
<p>然后是准备选举顺序，不同偏移量的节点，参与选举的顺位不同。offset最大的slave节点，选举顺位最高，最优先选举。而offset较低的slave节点，要延迟选举。</p>
<p><img src="image-20231012154725022.png" srcset="/img/loading.gif" lazyload alt="image-20231012154725022"></p>
<p>当有从节点参加选举后，主节点收到信息就开始投票。偏移量最大的节点，优先参与选举就更大可能获得最多的票数，称为主节点。</p>
<p><img src="image-20231012154802680.png" srcset="/img/loading.gif" lazyload alt="image-20231012154802680"></p>
<p>当从节点走马上任变成主节点之后，就要开始进行替换主节点：</p>
<ol>
<li>让该slave节点执行slaveof no one变为master节点</li>
<li>将故障节点负责的槽分配给该节点</li>
<li>向集群中其他节点广播Pong消息，表明已完成故障转移</li>
<li>故障节点重启后，会成为new_master的slave节点</li>
</ol>
<h2 id="2-2-搭建redis-cluster集群，并实现扩、缩容"><a href="#2-2-搭建redis-cluster集群，并实现扩、缩容" class="headerlink" title="2.2 搭建redis cluster集群，并实现扩、缩容"></a>2.2 搭建redis cluster集群，并实现扩、缩容</h2><h3 id="2-2-1-实战案例：基于Redis-5以上版本的redis-cluster部署"><a href="#2-2-1-实战案例：基于Redis-5以上版本的redis-cluster部署" class="headerlink" title="2.2.1 实战案例：基于Redis 5以上版本的redis cluster部署"></a>2.2.1 实战案例：基于Redis 5以上版本的redis cluster部署</h3><p>官方文档：<a target="_blank" rel="noopener" href="https://redis.io/docs/management/scaling/">https://redis.io/docs/management/scaling/</a></p>
<p>cluster 相关命令</p>
<p>范例：查看-cluster 选项帮助</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs shell">[14:52:17 root@Master-redis ~]#redis-cli --cluster help<br>Cluster Manager Commands:<br>  create         host1:port1 ... hostN:portN<br>                 --cluster-replicas &lt;arg&gt;<br>  check          host:port<br>                 --cluster-search-multiple-owners<br>  info           host:port<br>  fix            host:port<br>                 --cluster-search-multiple-owners<br>  reshard        host:port<br>                 --cluster-from &lt;arg&gt;<br>                 --cluster-to &lt;arg&gt;<br>                 --cluster-slots &lt;arg&gt;<br>                 --cluster-yes<br>                 --cluster-timeout &lt;arg&gt;<br>                 --cluster-pipeline &lt;arg&gt;<br>                 --cluster-replace<br>  rebalance      host:port<br>                 --cluster-weight &lt;node1=w1...nodeN=wN&gt;<br>                 --cluster-use-empty-masters<br>                 --cluster-timeout &lt;arg&gt;<br>                 --cluster-simulate<br>                 --cluster-pipeline &lt;arg&gt;<br>                 --cluster-threshold &lt;arg&gt;<br>                 --cluster-replace<br>  add-node       new_host:new_port existing_host:existing_port<br>                 --cluster-slave<br>                 --cluster-master-id &lt;arg&gt;<br>  del-node       host:port node_id<br>  call           host:port command arg arg .. arg<br>  set-timeout    host:port milliseconds<br>  import         host:port<br>                 --cluster-from &lt;arg&gt;<br>                 --cluster-copy<br>                 --cluster-replace<br>  help           <br><br>For check, fix, reshard, del-node, set-timeout you can specify the host and port of any working node in the cluster.<br><br></code></pre></td></tr></table></figure>



<h4 id="2-2-1-1创建redis-cluster集群的环境准备"><a href="#2-2-1-1创建redis-cluster集群的环境准备" class="headerlink" title="2.2.1.1创建redis cluster集群的环境准备"></a>2.2.1.1创建redis cluster集群的环境准备</h4><p><img src="image-20231012160858415.png" srcset="/img/loading.gif" lazyload alt="image-20231012160858415"></p>
<ul>
<li>每个Redis 节点采用相同的相同的Redis版本、相同的密码、硬件配置</li>
<li>所有Redis服务器必须没有任何数据</li>
<li>准备六台主机，地址如下：</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs http">10.0.0.3<br>10.0.0.4<br>10.0.0.6<br>10.0.0.127<br>10.0.0.128<br>10.0.0.129<br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-2启用redis-cluster配置"><a href="#2-2-1-2启用redis-cluster配置" class="headerlink" title="2.2.1.2启用redis cluster配置"></a>2.2.1.2启用redis cluster配置</h4><p>所有6台主机都执行以下配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[16:50:29 root@redis-Master3 ~]#dnf -y install redis<br></code></pre></td></tr></table></figure>

<p>每个节点修改redis配置，必须开启cluster功能的参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[17:02:04 root@redis-Slave3 ~]#vim /etc/redis.conf<br>bind 0.0.0.0<br>masterauth &quot;123456&quot;		#建议配置，否则后期的master和slave主从复制无法成功，还需在配置<br>requirepass &quot;123456&quot;	<br>cluster-enabled yes		#取消此行注释，必须开启集群，开启后redis进程会有cluster标识<br>cluster-config-file nodes-6379.conf	#取消此行注释，此为集权状态文件，记录主从关系及slot范围信息，由redis cluster 集群自动创建和维护<br>cluster-require-full-coverage no	#默认值为yes，设为no可以防止一个节点不可用导致整个cluster不可用<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">或在所有节点上执行以下命令</span><br>[20:23:03 root@Slave-redis ~]#sed -i -e &#x27;s/bind 127.0.0.1/bind 0.0.0.0/&#x27; -e &#x27;s/^# masterauth .*/masterauth 123456/&#x27; -e &#x27;s/^# requirepass .*/requirepass 123456/&#x27;  -e &#x27;s/# cluster-enabled yes/cluster-enabled yes/&#x27; -e &#x27;s/# cluster-config-file nodes-6379.conf/cluster-config-file nodes-6379.conf/&#x27; -e &#x27;s/# cluster-require-full-coverage yes/cluster-require-full-coverage no/&#x27;  /etc/redis.conf<br><br><br>[17:23:57 root@redis-Master1 ~]#systemctl enable --now redis<br></code></pre></td></tr></table></figure>

<p>验证当前Redis服务状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">开启了16379的cluster的端口,实际的端口=redis port+10000</span><br>[17:27:05 root@redis-Master1 ~]#ss -ntl <br>State        Recv-Q       Send-Q             Local Address:Port              Peer Address:Port      Process       <br>LISTEN       0            128                      0.0.0.0:22                     0.0.0.0:*                       <br>LISTEN       0            511                      0.0.0.0:16379                  0.0.0.0:*                       <br>LISTEN       0            511                      0.0.0.0:6379                   0.0.0.0:*                       <br>LISTEN       0            128                         [::]:22                        [::]:*     <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意进程有[cluster]状态</span><br>[17:28:45 root@redis-Master1 ~]#ps -ef | grep redis<br>redis       2947       1  0 17:27 ?        00:00:00 /usr/bin/redis-server 0.0.0.0:6379 [cluster]<br>root        2954    2470  0 17:30 pts/1    00:00:00 grep --color=auto redis<br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-3创建集群"><a href="#2-2-1-3创建集群" class="headerlink" title="2.2.1.3创建集群"></a>2.2.1.3创建集群</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">命令redis-cli的选项--cluster-replicas 1表示每个master对应一个slave节点</span><br>[21:09:09 root@redis-Master1 ~]#redis-cli -a 123456 --cluster create 10.0.0.3:6379 10.0.0.4:6379 10.0.0.6:6379 10.0.0.127:6379 10.0.0.128:6379 10.0.0.129:6379 --cluster-replicas 1<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing <span class="hljs-built_in">hash</span> slots allocation on 6 nodes...</span><br>Master[0] -&gt; Slots 0 - 5460<br>Master[1] -&gt; Slots 5461 - 10922<br>Master[2] -&gt; Slots 10923 - 16383<br>Adding replica 10.0.0.127:6379 to 10.0.0.3:6379<br>Adding replica 10.0.0.128:6379 to 10.0.0.4:6379<br>Adding replica 10.0.0.129:6379 to 10.0.0.6:6379<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379	#带M的为master<br>   slots:[0-5460] (5461 slots) master	#当前master的槽位起始<br>M: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots:[5461-10922] (5462 slots) master<br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[10923-16383] (5461 slots) master<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379	#带s的slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   replicates 9fd92ffbe358bfa8552793f56b3300209e2c4d8b<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes	#输入yes自动创建集群<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Nodes configuration updated</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Assign a different config epoch to each node</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER MEET messages to <span class="hljs-built_in">join</span> the cluster</span><br>Waiting for the cluster to join<br>.....<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.3:6379)</span><br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master	#已经分配的槽位<br>   1 additional replica(s)				#分配了一个slave<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave				#slave没有分配槽位<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e	#对应的master的10.0.0.6的ID<br>S: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots: (0 slots) slave<br>   replicates 9fd92ffbe358bfa8552793f56b3300209e2c4d8b	#对应的master的10.0.0.4的ID<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave				<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c	#对应的master的10.0.0.3的ID<br>M: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration. #所有节点槽位分配完成<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...		<span class="hljs-comment">#检查打开的槽位</span></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...		<span class="hljs-comment">#检查插槽覆盖范围</span></span><br>[OK] All 16384 slots covered.	#所有槽位（16384个）分配完成<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">观察以上结果，可以看到3组master/slave</span><br>master:10.0.0.3---slave:10.0.0.127<br>master:10.0.0.4---slave:10.0.0.128<br>master:10.0.0.6---slave:10.0.0.129<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果节点少于3个会出下面提示错误</span><br>[root@nodel ~]#redis-cli -a 123456 --cluster create 10.0.0.8:6379 10.0.0.18:6379<br>warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interfacemay not be safe<br>.*** ERROR: Invalid configuration for cluster creation<br>.*** Redis Cluster requires at least 3 master nodes.<br>*** This is not possible with 2 nodes and 0 replicas per node.<br>*** At least 3 nodes are required.<br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-4验证集群"><a href="#2-2-1-4验证集群" class="headerlink" title="2.2.1.4验证集群"></a>2.2.1.4验证集群</h4><h5 id="2-2-1-4-1查看主从状态"><a href="#2-2-1-4-1查看主从状态" class="headerlink" title="2.2.1.4.1查看主从状态"></a>2.2.1.4.1查看主从状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:11:48 root@redis-Master1 ~]#redis-cli -a 123456 -c info replication<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.127,port=6379,state=online,offset=1078,lag=1<br>master_replid:20f889c974ca4549d61acde3089811df089f984b<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1078<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1078<br><br>[20:21:16 root@redis-Master2 ~]#redis-cli -a 123456 -c info replication<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.128,port=6379,state=online,offset=1134,lag=1<br>master_replid:20f3b5e4bfd611cad295f077ac4cca396b0ce49c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1148<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1148<br><br>[20:21:48 root@redis-Master3 ~]#redis-cli -a 123456 -c info replication<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.129,port=6379,state=online,offset=1190,lag=1<br>master_replid:13fdac9b1950a34a302b76f8136214a746bdde22<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1190<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1190<br><br>[21:10:29 root@redis-Slave1 ~]#redis-cli -a 123456 -c info replication<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:10.0.0.3<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:3<br>master_sync_in_progress:0<br>slave_repl_offset:1246<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:20f889c974ca4549d61acde3089811df089f984b<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1246<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1246<br><br>[20:22:07 root@redis-Slave2 ~]#redis-cli -a 123456 -c info replication<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:10.0.0.4<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:9<br>master_sync_in_progress:0<br>slave_repl_offset:1288<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:20f3b5e4bfd611cad295f077ac4cca396b0ce49c<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1288<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1288<br><br>[20:22:17 root@redis-Slave3 ~]#redis-cli -a 123456 -c info replication<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:10.0.0.6<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:6<br>master_sync_in_progress:0<br>slave_repl_offset:1330<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:13fdac9b1950a34a302b76f8136214a746bdde22<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:1330<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:1330<br><br></code></pre></td></tr></table></figure>

<p>范例：查看指定master节点的slave节点信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:24:45 root@redis-Master1 ~]#redis-cli -a 123456 cluster nodes<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379@16379 slave 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 0 1697117316188 6 connected<br>e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379@16379 slave 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 0 1697117314171 5 connected<br>71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379@16379 myself,master - 0 1697117313000 1 connected 0-5460<br>241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379@16379 slave 71b6b0ec24e2bbc6b62f581787b9030a5152828c 0 1697117314000 4 connected<br>9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379@16379 master - 0 1697117313163 2 connected 5461-10922<br>6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379@16379 master - 0 1697117315180 3 connected 10923-16383<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">以下命令查看指定master节点的slave节点信息，其中</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">71b6b0ec24e2bbc6b62f581787b9030a5152828c 为master节点的ID</span><br>[21:28:36 root@redis-Master1 ~]#redis-cli -a 123456 cluster slaves 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>1) &quot;241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379@16379 slave 71b6b0ec24e2bbc6b62f581787b9030a5152828c 0 1697117486000 4 connected&quot;<br><br></code></pre></td></tr></table></figure>

<h5 id="2-2-1-4-2验证集群状态"><a href="#2-2-1-4-2验证集群状态" class="headerlink" title="2.2.1.4.2验证集群状态"></a>2.2.1.4.2验证集群状态</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell">21:32:37 root@redis-Master1 ~]#redis-cli -a 123456 -c cluster info<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6		#节点数<br>cluster_size:3				#三个集群<br>cluster_current_epoch:6<br>cluster_my_epoch:1<br>cluster_stats_messages_ping_sent:1255<br>cluster_stats_messages_pong_sent:1204<br>cluster_stats_messages_sent:2459<br>cluster_stats_messages_ping_received:1199<br>cluster_stats_messages_pong_received:1255<br>cluster_stats_messages_meet_received:5<br>cluster_stats_messages_received:2459<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看任意节点的集群状态</span><br>[21:32:46 root@redis-Master1 ~]#redis-cli -a 123456 --cluster info 10.0.0.4:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.4:6379 (9fd92ffb...) -&gt; 0 keys | 5462 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.6:6379 (6780cddc...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>[OK] 0 keys in 3 masters.<br>0.00 keys per slot on average.<br><br></code></pre></td></tr></table></figure>

<h5 id="2-2-1-4-3查看对应关系"><a href="#2-2-1-4-3查看对应关系" class="headerlink" title="2.2.1.4.3查看对应关系"></a>2.2.1.4.3查看对应关系</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:34:21 root@redis-Master1 ~]#redis-cli -a 123456 cluster nodes<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379@16379 slave 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 0 1697117749587 6 connected<br>e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379@16379 slave 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 0 1697117748577 5 connected<br>71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379@16379 myself,master - 0 1697117747000 1 connected 0-5460<br>241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379@16379 slave 71b6b0ec24e2bbc6b62f581787b9030a5152828c 0 1697117747570 4 connected<br>9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379@16379 master - 0 1697117748000 2 connected 5461-10922<br>6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379@16379 master - 0 1697117750596 3 connected 10923-16383<br><br><br>[21:35:50 root@redis-Master1 ~]#redis-cli -a 123456 --cluster check 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 0 keys | 5461 slots | 1 slaves.<br>10.0.0.4:6379 (9fd92ffb...) -&gt; 0 keys | 5462 slots | 1 slaves.<br>[OK] 0 keys in 3 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>M: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>S: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots: (0 slots) slave<br>   replicates 9fd92ffbe358bfa8552793f56b3300209e2c4d8b<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-5测试集群写入数据"><a href="#2-2-1-5测试集群写入数据" class="headerlink" title="2.2.1.5测试集群写入数据"></a>2.2.1.5测试集群写入数据</h4><p><img src="image-20231012213754844.png" srcset="/img/loading.gif" lazyload alt="image-20231012213754844"></p>
<h5 id="3-3-3-5-1-redis-cluster-写入key"><a href="#3-3-3-5-1-redis-cluster-写入key" class="headerlink" title="3.3.3.5.1 redis cluster 写入key"></a>3.3.3.5.1 redis cluster 写入key</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">经过算法计算，当前key的槽位需要写入指定的node</span><br>[21:39:28 root@redis-Master1 ~]#redis-cli -a 123456 -h 10.0.0.3 set key1 values1<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>(error) MOVED 9189 10.0.0.4:6379	#槽位不在当前node所以无法写入<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">指定槽位对应node可写入</span><br>[21:39:40 root@redis-Master1 ~]#redis-cli -a 123456 -h 10.0.0.4 set key1 values1<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>OK<br>[21:41:27 root@redis-Master1 ~]#redis-cli -a 123456 -h 10.0.0.4 get key1 <br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>&quot;values1&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">对应的slave节点可以KEYS*，但GET key1失败，可以到master上执行GET key1</span><br>[21:46:43 root@redis-Master1 ~]#redis-cli -a 123456 -h 10.0.0.128 KEYS &quot;*&quot;<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>1) &quot;key1&quot;<br>[21:46:57 root@redis-Master1 ~]#redis-cli -a 123456 -h 10.0.0.128 get key1<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>(error) MOVED 9189 10.0.0.4:6379<br>[21:47:12 root@redis-Master1 ~]#redis-cli -a 123456 -h 10.0.0.4 get key1<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>&quot;values1&quot;<br></code></pre></td></tr></table></figure>

<h5 id="3-3-3-5-2-redis-cluster-计算key所属的slot"><a href="#3-3-3-5-2-redis-cluster-计算key所属的slot" class="headerlink" title="3.3.3.5.2 redis cluster 计算key所属的slot"></a>3.3.3.5.2 redis cluster 计算key所属的slot</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[21:47:46 root@redis-Master1 ~]#redis-cli -h 10.0.0.3 -a 123456 --no-auth-warning cluster nodes<br>ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379@16379 slave 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 0 1697118541397 6 connected<br>e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379@16379 slave 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 0 1697118541000 5 connected<br>71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379@16379 myself,master - 0 1697118539000 1 connected 0-5460<br>241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379@16379 slave 71b6b0ec24e2bbc6b62f581787b9030a5152828c 0 1697118542403 4 connected<br>9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379@16379 master - 0 1697118543411 2 connected 5461-10922<br>6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379@16379 master - 0 1697118541000 3 connected 10923-16383<br></code></pre></td></tr></table></figure>

<h4 id="2-2-1-6-模拟故障实现故障转移"><a href="#2-2-1-6-模拟故障实现故障转移" class="headerlink" title="2.2.1.6 模拟故障实现故障转移"></a>2.2.1.6 模拟故障实现故障转移</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">模拟master2节点出故障，需要相应的数秒故障转移时间</span><br>[22:16:16 root@redis-Master2 ~]#tail -f  /var/log/redis/redis.log  <br>[21:53:14 root@redis-Master2 ~]#redis-cli -a 123456<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>127.0.0.1:6379&gt; shutdown<br>not connected&gt; exit<br>[22:20:52 root@redis-Master2 ~]#ss -ntl<br>State        Recv-Q       Send-Q             Local Address:Port             Peer Address:Port       Process                          <br>LISTEN       0            128                      0.0.0.0:22                    0.0.0.0:*                                                                     <br>LISTEN       0            128                         [::]:22                       [::]:*                        <br><br><br>[22:20:55 root@redis-Master2 ~]#redis-cli -a 123456 --cluster info 10.0.0.3:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>Could not connect to Redis at 10.0.0.4:6379: Connection refused<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5462 slots | 0 slaves.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5461 slots | 1 slaves.<br>[OK] 10 keys in 3 masters.<br>0.00 keys per slot on average.<br><br><br>[22:22:04 root@redis-Master2 ~]#redis-cli -a 123456 --cluster check 10.0.0.3:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>Could not connect to Redis at 10.0.0.4:6379: Connection refused<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5462 slots | 0 slaves.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5461 slots | 1 slaves.<br>[OK] 10 keys in 3 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.3:6379)</span><br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[5461-10922] (5462 slots) master<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><br><br>[22:23:06 root@redis-Master2 ~]#redis-cli -a 123456 -h 10.0.0.128<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.128:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:0<br>master_replid:00a4e3bd45cc7569400a9f2c64faf59d7f1382e0<br>master_replid2:20f3b5e4bfd611cad295f077ac4cca396b0ce49c<br>master_repl_offset:5922<br>second_repl_offset:5923<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:5922<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">恢复故障节点master2自动成为slave节点</span><br>[22:25:27 root@redis-Master2 ~]#systemctl start redis<br>[22:25:41 root@redis-Master2 ~]#cat /var/lib/redis/nodes-6379.conf <br>9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379@16379 myself,slave e32d1fea077cb8328a6948f7816489ce0a2db96f 0 1697120733950 2 connected<br>e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379@16379 master - 0 1697120733955 7 connected 5461-10922<br>6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379@16379 master - 0 1697120733955 3 connected 10923-16383<br>71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379@16379 master - 0 1697120733955 1 connected 0-5460<br>ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379@16379 slave 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 0 1697120733955 6 connected<br>241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379@16379 slave 71b6b0ec24e2bbc6b62f581787b9030a5152828c 0 1697120733955 4 connected<br>vars currentEpoch 7 lastVoteEpoch 0<br><br>[22:26:47 root@redis-Master2 ~]#redis-cli -a 123456 -h 10.0.0.128<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.128:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:1<br>slave0:ip=10.0.0.4,port=6379,state=online,offset=6090,lag=1<br>master_replid:00a4e3bd45cc7569400a9f2c64faf59d7f1382e0<br>master_replid2:20f3b5e4bfd611cad295f077ac4cca396b0ce49c<br>master_repl_offset:6090<br>second_repl_offset:5923<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:6090<br></code></pre></td></tr></table></figure>

<h3 id="2-2-2-Redis-cluster管理扩容-缩容"><a href="#2-2-2-Redis-cluster管理扩容-缩容" class="headerlink" title="2.2.2 Redis cluster管理扩容/缩容"></a>2.2.2 Redis cluster管理扩容/缩容</h3><h4 id="2-2-2-1集群扩容"><a href="#2-2-2-1集群扩容" class="headerlink" title="2.2.2.1集群扩容"></a>2.2.2.1集群扩容</h4><p><strong>扩容适用场景：</strong></p>
<p>当前客户量激增，现有的Redis cluster架构已经无法满足越来越高的并发访问请求，为解决此问题，新购置两台服务器，要求将其动态添加到现有集群，但不能影响业务的正常访问。</p>
<p>注意：生产环境一般建议master节点为奇数个，比如：3,5,7,以防止脑裂现象</p>
<p><img src="image-20231012223019823.png" srcset="/img/loading.gif" lazyload alt="image-20231012223019823"></p>
<p><img src="image-20231012223029776.png" srcset="/img/loading.gif" lazyload alt="image-20231012223029776"></p>
<h5 id="2-2-2-1-1添加节点准备"><a href="#2-2-2-1-1添加节点准备" class="headerlink" title="2.2.2.1.1添加节点准备"></a>2.2.2.1.1添加节点准备</h5><p>增加Redis新节点，需要与之前的Redis node版本和配置一致，然后分别再启动两台Redis node，应为一主一从。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">Master4节点、Slave4节点</span><br>[23:37:57 root@redis-Master4 ~]#yum install -y redis<br><br>[23:39:55 root@redis-Master4 ~]#sed -i -e &#x27;s/bind 127.0.0.1/bind 0.0.0.0/&#x27; -e &#x27;s/^# masterauth .*/masterauth 123456/&#x27; -e &#x27;s/^# requirepass .*/requirepass 123456/&#x27;  -e &#x27;s/# cluster-enabled yes/cluster-enabled yes/&#x27; -e &#x27;s/# cluster-config-file nodes-6379.conf/cluster-config-file nodes-6379.conf/&#x27; -e &#x27;s/# cluster-require-full-coverage yes/cluster-require-full-coverage no/&#x27;  /etc/redis.conf<br><br><br><br>[23:40:08 root@redis-Master4 ~]#systemctl enable --now redis<br></code></pre></td></tr></table></figure>

<h5 id="2-2-21-2添加新的master节点到集群"><a href="#2-2-21-2添加新的master节点到集群" class="headerlink" title="2.2.21.2添加新的master节点到集群"></a>2.2.21.2添加新的master节点到集群</h5><p>使用以下命令添加新节点，要添加的新redis节点IP和端口添加到的已有的集群中任意节点的IP：端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[--slave --master-idadd-node new_host:new_port existing_host:existing_port&lt;arg&gt;]<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">说明：</span><br>new_host:new_port				#指定新添加的主机的IP和端口<br>existing_host:existing_port		#指定已有的集群中任意节点的IP和端口<br></code></pre></td></tr></table></figure>

<p><strong>Redis 5 以上版本的添加命令：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">将一台新的主机10.0.0.133加入集群，以下示例中10.0.0.6可以是任意存在的集群节点</span><br>[23:01:53 root@redis-Master3 ~]#redis-cli -a 123456 --cluster add-node 10.0.0.9:6379 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Adding node 10.0.0.9:6379 to cluster 10.0.0.6:6379</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Send CLUSTER MEET to node 10.0.0.9:6379 to make it <span class="hljs-built_in">join</span> the cluster.</span><br>[OK] New node added correctly.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">观察到该节点已经加入成功，但此节点上没有slot位，也无从节点，而且新的节点是master</span><br>[23:47:08 root@redis-Master3 ~]#redis-cli -a 123456 --cluster info 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5461 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.9:6379 (96915f53...) -&gt; 0 keys | 0 slots | 0 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5462 slots | 1 slaves.<br>[OK] 10 keys in 4 masters.<br>0.00 keys per slot on average.<br><br><br>[23:48:10 root@redis-Master3 ~]#redis-cli -a 123456 --cluster check 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5461 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.9:6379 (96915f53...) -&gt; 0 keys | 0 slots | 0 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5462 slots | 1 slaves.<br>[OK] 10 keys in 4 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[10923-16383] (5461 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots: (0 slots) master<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[5461-10922] (5462 slots) master<br>   1 additional replica(s)<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><br><br><br>[23:49:14 root@redis-Master3 ~]#cat /var/lib/redis/nodes-6379.conf <br>71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379@16379 master - 0 1697125626772 1 connected 0-5460<br>9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379@16379 slave e32d1fea077cb8328a6948f7816489ce0a2db96f 0 1697125624762 7 connected<br>96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379@16379 master - 0 1697125628583 0 connected<br>e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379@16379 master - 0 1697125625000 7 connected 5461-10922<br>6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379@16379 myself,master - 0 1697125626000 3 connected 10923-16383<br>241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379@16379 slave 71b6b0ec24e2bbc6b62f581787b9030a5152828c 0 1697125625768 4 connected<br>ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379@16379 slave 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 0 1697125627778 6 connected<br>vars currentEpoch 7 lastVoteEpoch 7<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">和上面显示结果一样</span><br>[23:49:58 root@redis-Master3 ~]#redis-cli -a 123456 cluster nodes<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379@16379 master - 0 1697125837000 1 connected 0-5460<br>9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379@16379 slave e32d1fea077cb8328a6948f7816489ce0a2db96f 0 1697125838000 7 connected<br>96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379@16379 master - 0 1697125837000 0 connected<br>e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379@16379 master - 0 1697125838000 7 connected 5461-10922<br>6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379@16379 myself,master - 0 1697125836000 3 connected 10923-16383<br>241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379@16379 slave 71b6b0ec24e2bbc6b62f581787b9030a5152828c 0 1697125839413 4 connected<br>ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379@16379 slave 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 0 1697125838405 6 connected<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看集群状态</span><br>[23:50:40 root@redis-Master3 ~]#redis-cli -a 123456 cluster info<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:7<br>cluster_size:3<br>cluster_current_epoch:7<br>cluster_my_epoch:3<br>cluster_stats_messages_ping_sent:12668<br>cluster_stats_messages_pong_sent:9434<br>cluster_stats_messages_meet_sent:3<br>cluster_stats_messages_fail_sent:4<br>cluster_stats_messages_auth-ack_sent:1<br>cluster_stats_messages_sent:22110<br>cluster_stats_messages_ping_received:9431<br>cluster_stats_messages_pong_received:9535<br>cluster_stats_messages_meet_received:3<br>cluster_stats_messages_fail_received:1<br>cluster_stats_messages_auth-req_received:1<br>cluster_stats_messages_received:18971<br></code></pre></td></tr></table></figure>

<h5 id="2-2-2-1-3在新的master上重新分配槽位"><a href="#2-2-2-1-3在新的master上重新分配槽位" class="headerlink" title="2.2.2.1.3在新的master上重新分配槽位"></a>2.2.2.1.3在新的master上重新分配槽位</h5><p>新的node节点加到集群之后，默认是master节点，但是没有slots，需要重新分配，否则没有槽位将无法访问</p>
<p><strong>注意：重新分配槽位需要清空数据，所以需要先备份数据，扩展后再恢复数据</strong></p>
<p>Redis 5以上版本命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs shell">[23:59:38 root@redis-Master3 ~]#redis-cli -a 123456 --cluster reshard 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br>How many slots do you want to move (from 1 to 16384)? 4096 #新分配多少个槽位=16384/master个数<br>What is the receiving node ID? 96915f53b227e3edfa27dae770b17850f579d8fe	#新的masterID<br>Please enter all the source node IDs.<br>  Type &#x27;all&#x27; to use all the nodes as source nodes for the hash slots.<br>  Type &#x27;done&#x27; once you entered all the source nodes IDs.<br>Source node #1: all	#输入all，将哪些源主机的槽位分配给新的节点，al1是自动在所有的redis node选择划分，如果是从redis cluster删除某个主机可以使用此方式将指定主机上的槽位全部移动到别的redis主机<br>Do you want to proceed with the proposed reshard plan (yes/no)? yes #确认分配<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">确定slot分配成功</span><br>[00:01:09 root@redis-Master3 ~]#redis-cli -a 123456 --cluster check 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.9:6379 (96915f53...) -&gt; 2 keys | 4096 slots | 0 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 4 keys | 4096 slots | 1 slaves.<br>[OK] 10 keys in 4 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master #可以看4096个slots<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br></code></pre></td></tr></table></figure>

<h5 id="2-2-2-1-4为新的master指定新的slave节点"><a href="#2-2-2-1-4为新的master指定新的slave节点" class="headerlink" title="2.2.2.1.4为新的master指定新的slave节点"></a>2.2.2.1.4为新的master指定新的slave节点</h5><p>当前Redis集群中新的master节点存单点问题,还需要给其添加一个对应slave节点，实现高可用功能有</p>
<p>两种方式：</p>
<p><strong>方法1：在新加节点到集群时，直接将之设置为slave</strong></p>
<p>Redis 5 以上版本添加命令：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">redis-cli-a 123456--cluster add-node 10.0.0.78:6379&lt;任意集群节点&gt;:6379--cluster-slave --cluster-master-id  d6eleca6b338b717923f64866bd31d42e52edc98<br></code></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs shell">[00:07:52 root@redis-Master3 ~]#redis-cli -a 123456 --cluster add-node 10.0.0.133:6379 10.0.0.9:6379 --cluster-slave --cluster-master-id 96915f53b227e3edfa27dae770b17850f579d8fe<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Adding node 10.0.0.133:6379 to cluster 10.0.0.6:6379</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Send CLUSTER MEET to node 10.0.0.133:6379 to make it <span class="hljs-built_in">join</span> the cluster.</span><br>Waiting for the cluster to join<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Configure node as replica of 10.0.0.9:6379.</span><br>[OK] New node added correctly.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证是否成功</span><br>[00:08:59 root@redis-Master3 ~]#redis-cli -a 123456 --cluster check 10.0.0.129:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.9:6379 (96915f53...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.6:6379 (6780cddc...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 4 keys | 4096 slots | 1 slaves.<br>[OK] 10 keys in 4 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.129:6379)</span><br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>S: f4e581677b640e84f6990f4193f84fb57c9ee324 10.0.0.133:6379<br>   slots: (0 slots) slave<br>   replicates 96915f53b227e3edfa27dae770b17850f579d8fe<br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><br><br>[00:10:25 root@redis-Master3 ~]#redis-cli -a 123456 -h 10.0.0.9 --no-auth-warning cluster info<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:8<br>cluster_size:4<br>cluster_current_epoch:8<br>cluster_my_epoch:8<br>cluster_stats_messages_ping_sent:1518<br>cluster_stats_messages_pong_sent:1430<br>cluster_stats_messages_meet_sent:6<br>cluster_stats_messages_update_sent:6<br>cluster_stats_messages_sent:2960<br>cluster_stats_messages_ping_received:1429<br>cluster_stats_messages_pong_received:1524<br>cluster_stats_messages_meet_received:1<br>cluster_stats_messages_received:2954<br></code></pre></td></tr></table></figure>

<p><strong>方法2：先将新节点加入集群，再修改为slave</strong></p>
<ul>
<li><strong>为新的master添加slave节点</strong></li>
</ul>
<p>Redis 5以上版本命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">把10.0.0.133：6379添加到集群中：</span><br>[root@redis-nodel ~]#redis-cli -a 123456 --cluster add-node 10.0.0.133:6379 10.0.0.6:6379<br></code></pre></td></tr></table></figure>

<p><strong>更改新节点更改状态为slave：</strong></p>
<p>需要手动将其指定为某个master的slave,否则其默认角色为master。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">[root@redis-node1~]#</span><span class="language-bash">redis-c1i-h 10.0.0.133 -p 6379 -a 123456 <span class="hljs-comment">#登录到新添加节点</span></span><br>10.0.0.78:6380&gt;CLUSTER NODES #查看当前集群节点，找到目标master的ID<br>10.0.0.78:6380&gt;CLUSTER REPLICATE 886338acd50c3015be68a760502b239f4509881c #将其设置slave,命令格式为cluster replicate MASTERID<br>10.0.0.78：6380&gt;CLUSTER NODES #再次查看集群节点状态，验证节点是否已经更改为指定master 的slave<br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-2集群缩容"><a href="#2-2-2-2集群缩容" class="headerlink" title="2.2.2.2集群缩容"></a>2.2.2.2集群缩容</h4><p><strong>缩容适用场景：</strong></p>
<p>随着业务萎缩用户量下降明显，和领导商量决定将现有Redis集群的8台主机中下线两台主机挪做它用，缩容后性能仍能满足当前业务需求</p>
<p><strong>删除节点过程：</strong></p>
<p>扩容时是先添加node到集群，然后再分配槽位，而缩容时的操作相反，是先将被要删除的node上的槽位迁移到集群中的其他node上，然后才能再将其从集群中删除，如果一个node上的槽位没有被完全迁移空，删除该node时也会提示有数据出错导致无法删除。</p>
<p><img src="image-20231013001749039.png" srcset="/img/loading.gif" lazyload alt="image-20231013001749039"></p>
<h5 id="2-2-2-2-1迁移要删除的master节点上面的槽位到其它master"><a href="#2-2-2-2-1迁移要删除的master节点上面的槽位到其它master" class="headerlink" title="2.2.2.2.1迁移要删除的master节点上面的槽位到其它master"></a>2.2.2.2.1迁移要删除的master节点上面的槽位到其它master</h5><p><strong>注意：被迁移Redis master源服务器必须保证没有数据，否则迁移报错并会被强制中断。</strong></p>
<p>Redis 5版本以上命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><code class="hljs shell">[00:27:25 root@redis-Master3 ~]#redis-cli -a 123456 --cluster check 10.0.0.129:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.9:6379 (96915f53...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.6:6379 (6780cddc...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 4096 slots | 1 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 4 keys | 4096 slots | 1 slaves.<br>[OK] 10 keys in 4 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.129:6379)</span><br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>S: f4e581677b640e84f6990f4193f84fb57c9ee324 10.0.0.133:6379<br>   slots: (0 slots) slave<br>   replicates 96915f53b227e3edfa27dae770b17850f579d8fe<br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">连接到任意集群节点，<span class="hljs-comment">#最后1365个slot从10.0.0.9移动到第一个master节点10.0.0.3上</span></span><br>[00:27:33 root@redis-Master3 ~]#redis-cli -a 123456 --cluster reshard 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[12288-16383] (4096 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[1365-5460] (4096 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master<br>   1 additional replica(s)<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[6827-10922] (4096 slots) master<br>   1 additional replica(s)<br>S: f4e581677b640e84f6990f4193f84fb57c9ee324 10.0.0.133:6379<br>   slots: (0 slots) slave<br>   replicates 96915f53b227e3edfa27dae770b17850f579d8fe<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br>How many slots do you want to move (from 1 to 16384)? 1365 #0-1064共4096/3分别给其它三个<br>What is the receiving node ID? 71b6b0ec24e2bbc6b62f581787b9030a5152828c	#Master10.0.0.3的ID <br>Please enter all the source node IDs.<br>  Type &#x27;all&#x27; to use all the nodes as source nodes for the hash slots.<br>  Type &#x27;done&#x27; once you entered all the source nodes IDs.<br>Source node #1: 96915f53b227e3edfa27dae770b17850f579d8fe	#输入要删除节原10.0.0.9的<br>Source node #2: done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">非交互式方式</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">再将1365个slot从10.0.0.9移动到第二个master节点10.0.0.128上</span><br>[root@redis-nodel ~]#redis-cli -a 123456 --cluster reshard 10.0.0.6:6379 --cluster-slots 1365 --cluster-from  96915f53b227e3edfa27dae770b17850f579d8fe --cluster-to e32d1fea077cb8328a6948f7816489ce0a2db96f --cluster-yes<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">最后的s1ot从10.0.0.9移动到第三个master节点10.0.0.6上</span><br>[root@redis-nodel ~]#redis-cli -a 123456 --cluster reshard 10.0.0.6:6379 --cluster-slots 1366 --cluster-from  96915f53b227e3edfa27dae770b17850f579d8fe --cluster-to 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e --cluster-yes<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">确认10.0.0.8的所有slot都移走了，上面的slave也自动删除，成为其它master的slave</span><br>[00:47:56 root@redis-Master3 ~]#redis-cli -a 123456 --cluster check 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5462 slots | 2 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.9:6379 (96915f53...) -&gt; 0 keys | 0 slots | 0 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5461 slots | 1 slaves.<br>[OK] 10 keys in 4 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[6826],[10923-16383] (5462 slots) master<br>   2 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: 96915f53b227e3edfa27dae770b17850f579d8fe 10.0.0.9:6379<br>   slots: (0 slots) master<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[5461-6825],[6827-10922] (5461 slots) master<br>   1 additional replica(s)<br>S: f4e581677b640e84f6990f4193f84fb57c9ee324 10.0.0.133:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><br><br><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">原有的10.0.0.133自动成为10.0.0.6的s1ave</span><br>[00:48:26 root@redis-Master3 ~]#redis-cli -a 123456 -h 10.0.0.6 info replication<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=10.0.0.129,port=6379,state=online,offset=18578,lag=1<br>slave1:ip=10.0.0.133,port=6379,state=online,offset=18578,lag=0<br>master_replid:13fdac9b1950a34a302b76f8136214a746bdde22<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:18578<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:18578<br><br><br><br>[00:51:51 root@redis-Master3 ~]#redis-cli -a 123456 -h 10.0.0.6 cluster info <br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:8		#集群中8个节点<br>cluster_size:3				#少了一个主从的slot<br>cluster_current_epoch:11<br>cluster_my_epoch:11<br>cluster_stats_messages_ping_sent:16314<br>cluster_stats_messages_pong_sent:12826<br>cluster_stats_messages_meet_sent:3<br>cluster_stats_messages_fail_sent:4<br>cluster_stats_messages_auth-ack_sent:1<br>cluster_stats_messages_update_sent:10<br>cluster_stats_messages_sent:29158<br>cluster_stats_messages_ping_received:12822<br>cluster_stats_messages_pong_received:13181<br>cluster_stats_messages_meet_received:4<br>cluster_stats_messages_fail_received:1<br>cluster_stats_messages_auth-req_received:1<br>cluster_stats_messages_received:26009<br><br></code></pre></td></tr></table></figure>

<h5 id="2-2-2-2-2从集群中删除服务器"><a href="#2-2-2-2-2从集群中删除服务器" class="headerlink" title="2.2.2.2.2从集群中删除服务器"></a>2.2.2.2.2从集群中删除服务器</h5><p>上面步骤完成后,槽位已经迁移走，但是节点仍然还属于集群成员，因此还需从集群删除该节点</p>
<p>注意：删除服务器前，必须清除主机上面的槽位，否则会删除主机失败</p>
<p>Redis 5以上版本命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[00:56:08 root@redis-Master3 ~]#redis-cli -a 123456 --cluster del-node 10.0.0.6:6379 96915f53b227e3edfa27dae770b17850f579d8fe<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Removing node 96915f53b227e3edfa27dae770b17850f579d8fe from cluster 10.0.0.6:6379</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; SHUTDOWN the node.</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除节点后，redis进程自动关闭</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除节点信息</span><br>[00:59:01 root@redis-Master4 ~]#rm -rf /var/lib/redis/nodes-6379.conf<br></code></pre></td></tr></table></figure>

<h5 id="2-2-2-2-3删除多余的slave节点验证结果"><a href="#2-2-2-2-3删除多余的slave节点验证结果" class="headerlink" title="2.2.2.2.3删除多余的slave节点验证结果"></a>2.2.2.2.3删除多余的slave节点验证结果</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">验证删除成功</span><br>[00:58:54 root@redis-Master4 ~]#ss -ntl<br>State        Recv-Q       Send-Q             Local Address:Port             Peer Address:Port       Process       <br>LISTEN       0            128                      0.0.0.0:22                    0.0.0.0:*                        <br>LISTEN       0            128                         [::]:22                       [::]:*      <br><br>[01:00:16 root@redis-Master3 ~]#redis-cli -a 123456 --cluster check 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5462 slots | 2 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5461 slots | 1 slaves.<br>[OK] 10 keys in 3 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[6826],[10923-16383] (5462 slots) master<br>   2 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[5461-6825],[6827-10922] (5461 slots) master<br>   1 additional replica(s)<br>S: f4e581677b640e84f6990f4193f84fb57c9ee324 10.0.0.133:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除多余的slave从节点</span><br>[01:00:36 root@redis-Master3 ~]#redis-cli -a 123456 --cluster del-node 10.0.0.6:6379 f4e581677b640e84f6990f4193f84fb57c9ee324<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Removing node f4e581677b640e84f6990f4193f84fb57c9ee324 from cluster 10.0.0.6:6379</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Sending CLUSTER FORGET messages to the cluster...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; SHUTDOWN the node.</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">删除集群文件</span><br><br><br><br>[01:01:48 root@redis-Master3 ~]#redis-cli -a 123456 --cluster check 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5462 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5461 slots | 1 slaves.<br>[OK] 10 keys in 3 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Performing Cluster Check (using node 10.0.0.6:6379)</span><br>M: 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e 10.0.0.6:6379<br>   slots:[6826],[10923-16383] (5462 slots) master<br>   1 additional replica(s)<br>M: 71b6b0ec24e2bbc6b62f581787b9030a5152828c 10.0.0.3:6379<br>   slots:[0-5460] (5461 slots) master<br>   1 additional replica(s)<br>S: 9fd92ffbe358bfa8552793f56b3300209e2c4d8b 10.0.0.4:6379<br>   slots: (0 slots) slave<br>   replicates e32d1fea077cb8328a6948f7816489ce0a2db96f<br>M: e32d1fea077cb8328a6948f7816489ce0a2db96f 10.0.0.128:6379<br>   slots:[5461-6825],[6827-10922] (5461 slots) master<br>   1 additional replica(s)<br>S: 241b0a2e5ceafc7832e1483afe57b0b1b8814a27 10.0.0.127:6379<br>   slots: (0 slots) slave<br>   replicates 71b6b0ec24e2bbc6b62f581787b9030a5152828c<br>S: ee5c967d90ad1138b1ff463fbfe5a5e5273c653c 10.0.0.129:6379<br>   slots: (0 slots) slave<br>   replicates 6780cddc5d7b21255416d7a47ef5ed9addcfcb8e<br>[OK] All nodes agree about slots configuration.<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...</span><br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; Check slots coverage...</span><br>[OK] All 16384 slots covered.<br><br><br><br><br><br>[01:02:08 root@redis-Master3 ~]#redis-cli -a 123456 --cluster info 10.0.0.6:6379<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>10.0.0.6:6379 (6780cddc...) -&gt; 3 keys | 5462 slots | 1 slaves.<br>10.0.0.3:6379 (71b6b0ec...) -&gt; 2 keys | 5461 slots | 1 slaves.<br>10.0.0.128:6379 (e32d1fea...) -&gt; 5 keys | 5461 slots | 1 slaves.<br>[OK] 10 keys in 3 masters.<br>0.00 keys per slot on average.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">查看集群信息</span><br>[01:04:46 root@redis-Master3 ~]#redis-cli -a 123456  -h 10.0.0.6  cluster info<br>Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6		#只有6个节点<br>cluster_size:3<br>cluster_current_epoch:11<br>cluster_my_epoch:11<br>cluster_stats_messages_ping_sent:17078<br>cluster_stats_messages_pong_sent:13560<br>cluster_stats_messages_meet_sent:3<br>cluster_stats_messages_fail_sent:4<br>cluster_stats_messages_auth-ack_sent:1<br>cluster_stats_messages_update_sent:10<br>cluster_stats_messages_sent:30656<br>cluster_stats_messages_ping_received:13556<br>cluster_stats_messages_pong_received:13945<br>cluster_stats_messages_meet_received:4<br>cluster_stats_messages_fail_received:1<br>cluster_stats_messages_auth-req_received:1<br>cluster_stats_messages_received:27507<br><br><br><br></code></pre></td></tr></table></figure>





<h1 id="3、总结-LVS的NAT和DR模型工作原理，并完成DR模型实战。"><a href="#3、总结-LVS的NAT和DR模型工作原理，并完成DR模型实战。" class="headerlink" title="3、总结 LVS的NAT和DR模型工作原理，并完成DR模型实战。"></a>3、总结 LVS的NAT和DR模型工作原理，并完成DR模型实战。</h1><h2 id="3-1-LVS-NAT模型工作原理"><a href="#3-1-LVS-NAT模型工作原理" class="headerlink" title="3.1 LVS-NAT模型工作原理"></a>3.1 LVS-NAT模型工作原理</h2><p>官网：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">http://www.linuxvirtualserver.org/VS-NAT.html<br></code></pre></td></tr></table></figure>

<p><img src="image-20231009213808559.png" srcset="/img/loading.gif" lazyload alt="image-20231009213808559"></p>
<p>lvs-nat：本质上是多目标IP的DNAT，是通过将请求的报文中的目的地址和目的端口转换为其挑选出的真实服务器的IP和port实现转发</p>
<ul>
<li>RIP（real IP）和DIP应该在同一个IP网络，且应使用私网地址；RS的网关要指向DIP</li>
<li>请求报文和响应报文都必须经由Director转发，Director易于成为系统瓶颈</li>
<li>支持端口映射，支持修改请求报文的目标port</li>
<li>VS必须是Linux系统，RS可以是任意OS系统</li>
</ul>
<p><img src="image-20231009220005364.png" srcset="/img/loading.gif" lazyload alt="image-20231009220005364"></p>
<h2 id="3-2-LVS-DR模型工作原理"><a href="#3-2-LVS-DR模型工作原理" class="headerlink" title="3.2 LVS-DR模型工作原理"></a>3.2 LVS-DR模型工作原理</h2><p>官网链接：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">http://www.linuxvirtualserver.org/VS-DRouting.html<br></code></pre></td></tr></table></figure>

<p><img src="image-20231009220327859.png" srcset="/img/loading.gif" lazyload alt="image-20231009220327859"></p>
<p>LVS-DR：Director Routing，直接路由，LVS默认模式，应用最广泛，通过为请求报文重新封装一个MAC头部进行转发，源MAC是DIP所在接口的MAC。目标MAC是其挑选出的真实服务器的RIP所在接口的MAC地址；源IP/PORT，以及目标IP/PORT均保持不变</p>
<p><img src="image-20231009222402918.png" srcset="/img/loading.gif" lazyload alt="image-20231009222402918"></p>
<p><img src="image-20231009222740904.png" srcset="/img/loading.gif" lazyload alt="image-20231009222740904"></p>
<p>DR模式的特点：</p>
<ol>
<li><p>Director和各RS都配置有相同VIP（在回环接口配置）</p>
</li>
<li><p>确保前端路由器将目标IP为VIP的请求报文发往Director</p>
<ul>
<li>在前端网关做静态绑定VIP和Director的MAC地址</li>
<li>在RS上使用arptables工具</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs http">arptables -A IN -d $VIP -j DROP<br>arptables -A OUT -s $VIP -j mangle --mangle-ip-s$RIP<br></code></pre></td></tr></table></figure>

<ul>
<li>在RS上修改内核参数以限制arp通告及应答级别</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">/proc/sys/net/ipv4/conf/al1/arp_ignore/proc/sys/net/ipv4/conf/al1/arp_announce<br></code></pre></td></tr></table></figure></li>
<li><p>RS的RIP可以使用私网地址，也可以是公网地址；RIP与DIP在同一IP网络；RIP的网关不能指向DIP，以确保响应报文不会经由Director</p>
</li>
<li><p>RS和Director要在同一个物理网络</p>
</li>
<li><p>请求报文要经由Director，但响应报文不经由Director，而由RS直接发往Client</p>
</li>
<li><p>不支持端口映射（端口不能修改）</p>
</li>
<li><p>无需开启ip_forward</p>
</li>
<li><p>RS可以使用大多数OS系统</p>
</li>
</ol>
<h2 id="3-3-LVS-DR模型实战"><a href="#3-3-LVS-DR模型实战" class="headerlink" title="3.3 LVS-DR模型实战"></a>3.3 LVS-DR模型实战</h2><h3 id="3-3-1-LVS-DR模式单网段案例实现"><a href="#3-3-1-LVS-DR模式单网段案例实现" class="headerlink" title="3.3.1 LVS-DR模式单网段案例实现"></a>3.3.1 LVS-DR模式单网段案例实现</h3><p>DR模型中各主机上均需要配置VIP，解决地址冲突的方式有三种</p>
<ol>
<li>在前端网关做静态绑定</li>
<li>在各RS使用arptables</li>
<li>在各RS修改内核参数，来限制arp响应和通告级别</li>
</ol>
<p>限制响应级别：arp_ignore</p>
<ul>
<li>0：默认值，表示可使用本地任意接口上配置的任意地址进行响应</li>
<li>1：仅在请求的目标IP配置在本地主机上，且接收到请求报文接囗的IP就是请求目标IP时，才给予响应</li>
</ul>
<p>限制通告级别：arp_announce</p>
<ul>
<li>0：默认值，把本机所有接囗的所有信息向每个接口的网络进行通告</li>
<li>1：尽量避免将接口信息向非直接连接网络进行通告</li>
<li>2：必须避免将接口信息向非本网络进行通告</li>
</ul>
<p><strong>配置要点</strong></p>
<ol>
<li>Director服务器采用双IP桥接网络，一个是VIP,一个DIP</li>
<li>Web服务器采用和DIP相同的网段和Director连接</li>
<li>每个Web服务器配置VIP</li>
<li>每个web服务器可以出外网</li>
</ol>
<p>范例：</p>
<p><img src="image-20231009235721938.png" srcset="/img/loading.gif" lazyload alt="image-20231009235721938"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs html">环境：五台主机<br>第一台：internet-client<br>eth0：仅主机192.168.0.7/24 GW：192.168.0.5<br><br>第二台：router<br>eth0：NAT 10.0.0.129/24<br>eth1：仅主机192.168.0.5/24<br>启用：IP_FORWARD<br><br>第三台：LVS<br>eth0：NAT：DIP：10.0.0.128/24 GW：10.0.0.129<br><br>第四台：RS1<br>RS1：eth0：NAT:10.0.0.3/24  GW：10.0.0.129<br><br>第五台：RS2<br>RS2：eth0：NAT:10.0.0.4/24  GW：10.0.0.129<br></code></pre></td></tr></table></figure>



<h4 id="3-3-1-1-LVS的网络配置"><a href="#3-3-1-1-LVS的网络配置" class="headerlink" title="3.3.1.1 LVS的网络配置"></a>3.3.1.1 LVS的网络配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">所有主机禁用iptables和SElinux</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">internet-client主机环境</span><br>[08:10:47 root@internet-client ~]#hostname -I<br>192.168.0.7 <br><br>[08:19:44 root@internet-client ~]#route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.0.5     0.0.0.0         UG    0      0        0 ens37<br>192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 ens37<br><br>[22:24:15 root@internet-client ~]#cat  /etc/sysconfig/network-scripts/ifcfg-ens33 <br>TYPE=&quot;Ethernet&quot;<br>BOOTPROTO=static<br>IPADDR=192.168.0.7<br>NETMASK=255.255.255.0<br>DNS1=223.6.6.6<br>DNS2=114.114.114.114<br>GATEWAY=192.168.0.5<br>DEFROUTE=&quot;yes&quot;<br>NAME=&quot;ens37&quot;<br>UUID=&quot;b7b43824-3aba-417e-badc-190cdff2f31e&quot;<br>DEVICE=&quot;ens37&quot;<br>ONBOOT=&quot;yes&quot;<br><br><br><br>[08:50:46 root@internet-client ~]#ping 10.0.0.4<br>PING 10.0.0.4 (10.0.0.4) 56(84) bytes of data.<br>64 bytes from 10.0.0.4: icmp_seq=204 ttl=63 time=0.224 ms<br><br>[08:31:41 root@internet-client ~]#ping 10.0.0.3<br>PING 10.0.0.3 (10.0.0.3) 56(84) bytes of data.<br>64 bytes from 10.0.0.3: icmp_seq=1 ttl=63 time=1.09 ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">############################################################################</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">路由器的网络配置</span><br>[00:37:16 root@Router ~]#sysctl -a | grep ip_forward<br>net.ipv4.ip_forward = 0<br>net.ipv4.ip_forward_update_priority = 1<br>net.ipv4.ip_forward_use_pmtu = 0<br>[00:40:29 root@Router ~]#echo &#x27;net.ipv4.ip_forward = 1&#x27; &gt;&gt; /etc/sysctl.conf <br>[00:41:29 root@Router ~]#sysctl -p<br>net.ipv4.ip_forward = 1<br><br>[00:41:37 root@Router ~]#ip a<br>2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:24:99:c9 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.129/24 brd 10.0.0.255 scope global dynamic noprefixroute ens160<br>       valid_lft 1040sec preferred_lft 1040sec<br>    inet6 fe80::20c:29ff:fe24:99c9/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br>3: ens224: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:24:99:d3 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.0.5/24 brd 192.168.0.255 scope global dynamic noprefixroute ens224<br>       valid_lft 1040sec preferred_lft 1040sec<br>    inet6 fe80::cfc0:2e36:e0ef:d54c/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">####################################################################</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">RS1的网络配置</span><br>[00:51:51 root@RS1 ~]#hostname -I<br>10.0.0.3<br>[00:50:24 root@RS1 ~]#cat /etc/sysconfig/network-scripts/ifcfg-ens160 <br>TYPE=Ethernet<br>BOOTPROTO=static<br>IPADDR=10.0.0.3<br>PREFIX=24<br>GATEWAY=10.0.0.129<br>NAME=ens160<br>DEVICE=ens160<br>ONBOOT=yes<br>[00:52:08 root@RS1 ~]#route -n <br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.129      0.0.0.0         UG    100    0        0 ens160<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 ens160<br><br><br>[01:00:50 root@RS1 ~]#yum install -y httpd<br>[01:01:10 root@RS1 ~]#systemctl enable --now httpd<br>Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.<br>[01:01:34 root@RS1 ~]#hostname -I &gt; /var/www/html/index.html<br>[01:02:30 root@RS1 ~]#ping 192.168.0.7<br>PING 192.168.0.7 (192.168.0.7) 56(84) bytes of data.<br>64 bytes from 192.168.0.7: icmp_seq=1 ttl=63 time=0.418 ms<br>64 bytes from 192.168.0.7: icmp_seq=2 ttl=63 time=1.13 ms<br>^C<br>--- 192.168.0.7 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1061ms<br>rtt min/avg/max/mdev = 0.418/0.773/1.129/0.356 ms<br>[01:03:50 root@RS1 ~]#curl 10.0.0.4<br>10.0.0.4 <br>[01:04:13 root@RS1 ~]#curl 10.0.0.3<br>10.0.0.3 <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#########################################################################</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">RS2的网络配置</span><br>[00:57:25 root@RS2 ~]#hostname -I<br>10.0.0.4<br>[00:57:06 root@RS2 ~]#cat  /etc/sysconfig/network-scripts/ifcfg-ens160 <br>TYPE=Ethernet<br>PROXY_METHOD=none<br>BROWSER_ONLY=no<br>BOOTPROTO=static<br>IPADDR=10.0.0.4<br>PREFIX=24<br>GATEWAY=10.0.0.129<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>[00:57:12 root@RS2 ~]#route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.129      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br>[01:00:50 root@RS2 ~]#yum install -y httpd<br>[01:01:10 root@RS2 ~]#systemctl enable --now httpd<br>Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.<br>[01:01:34 root@RS2 ~]#hostname -I &gt; /var/www/html/index.html<br>[01:02:21 root@RS2 ~]#ping 192.168.0.7<br>PING 192.168.0.7 (192.168.0.7) 56(84) bytes of data.<br>64 bytes from 192.168.0.7: icmp_seq=1 ttl=63 time=0.513 ms<br>64 bytes from 192.168.0.7: icmp_seq=2 ttl=63 time=1.01 ms<br>^C<br>--- 192.168.0.7 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1020ms<br>rtt min/avg/max/mdev = 0.513/0.760/1.008/0.249 ms<br>[01:05:07 root@RS2 ~]#curl 10.0.0.3<br>10.0.0.3 <br>[01:05:14 root@RS2 ~]#curl 10.0.0.4<br>10.0.0.4 <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">####################################################################</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">LVS的网络配置</span><br>[13:10:02 root@LVS ~]#hostname -I<br>10.0.0.128 <br>[13:10:12 root@LVS ~]#route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.129      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br>[13:10:17 root@LVS ~]#cat   /etc/sysconfig/network-scripts/ifcfg-ens160 <br>TYPE=Ethernet<br>BOOTPROTO=static<br>IPADDR=10.0.0.128<br>GATEWAY=10.0.0.129<br>PREFIX=24<br>DEFROUTE=yes<br>IPV4_FAILURE_FATAL=no<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>[13:10:25 root@LVS ~]#ping 192.168.0.7<br>PING 192.168.0.7 (192.168.0.7) 56(84) bytes of data.<br>64 bytes from 192.168.0.7: icmp_seq=1 ttl=63 time=0.406 ms<br><br></code></pre></td></tr></table></figure>



<h4 id="3-3-1-2-后端RS的IPVS配置"><a href="#3-3-1-2-后端RS的IPVS配置" class="headerlink" title="3.3.1.2 后端RS的IPVS配置"></a>3.3.1.2 后端RS的IPVS配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">RS1的IPVS配置</span><br>[01:04:16 root@RS1 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore <br>[01:13:09 root@RS1 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce <br>[01:13:25 root@RS1 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore <br>[01:13:34 root@RS1 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce <br>[14:10:05 root@RS1 ~]#ifconfig lo:1 10.0.0.100/32<br>[14:10:32 root@RS1 ~]#ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:99:e8:44 brd ff:ff:ff:ff:ff:ff<br>    altname enp3s0<br>    inet 10.0.0.3/24 brd 10.0.0.255 scope global noprefixroute ens160<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe99:e844/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br>[14:10:34 root@RS1 ~]#<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">RS2的IPVS配置</span><br>01:05:16 root@RS2 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore <br>[01:16:22 root@RS2 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore <br>[01:16:38 root@RS2 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce <br>[01:16:48 root@RS2 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce <br>[01:16:52 root@RS2 ~]#ifconfig lo:1 10.0.0.100/32<br>[01:17:16 root@RS2 ~]#ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:2c:30:b9 brd ff:ff:ff:ff:ff:ff<br>    altname enp3s0<br>    altname ens160<br>    inet 10.0.0.4/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe2c:30b9/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h4 id="3-3-1-3-LVS主机的配置"><a href="#3-3-1-3-LVS主机的配置" class="headerlink" title="3.3.1.3 LVS主机的配置"></a>3.3.1.3 LVS主机的配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在LVS上添加VIP</span><br>[13:11:06 root@LVS ~]#ifconfig lo:1 10.0.0.100/32<br>[13:18:46 root@LVS ~]#ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:e9:f4:40 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.128/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fee9:f440/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">实现LVS规则</span><br>[13:18:48 root@LVS ~]#dnf -y install ipvsadm<br>[13:19:57 root@LVS ~]#ipvsadm -A -t 10.0.0.100:80 -s rr <br>[13:20:54 root@LVS ~]#ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.3:80 -g <br>[13:21:19 root@LVS ~]#ipvsadm -a -t 10.0.0.100:80 -r 10.0.0.4:80 -g <br>[13:21:26 root@LVS ~]#ipvsadm -Ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br>TCP  10.0.0.100:80 rr<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">10.0.0.3:80                  Route   1      0          0</span>         <br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">10.0.0.4:80                  Route   1      0          0</span>         <br></code></pre></td></tr></table></figure>

<h4 id="3-3-1-4-测试访问"><a href="#3-3-1-4-测试访问" class="headerlink" title="3.3.1.4 测试访问"></a>3.3.1.4 测试访问</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">[09:10:07 root@internet-client ~]#curl 10.0.0.100<br>10.0.0.4 <br>[09:22:40 root@internet-client ~]#curl 10.0.0.100<br>10.0.0.3 <br>[09:22:41 root@internet-client ~]#curl 10.0.0.100<br>10.0.0.4 <br>[09:22:42 root@internet-client ~]#curl 10.0.0.100<br>10.0.0.3 <br>[09:22:43 root@internet-client ~]#curl 10.0.0.100<br>10.0.0.4 <br><br><br>[01:15:41 root@RS1 ~]#tail -f /var/log/httpd/access_log -n0<br>192.168.0.7 - - [10/Oct/2023:01:23:39 +0800] &quot;GET / HTTP/1.1&quot; 200 10 &quot;-&quot; &quot;curl/7.29.0&quot;<br>192.168.0.7 - - [10/Oct/2023:01:23:40 +0800] &quot;GET / HTTP/1.1&quot; 200 10 &quot;-&quot; &quot;curl/7.29.0&quot;<br>192.168.0.7 - - [10/Oct/2023:01:23:42 +0800] &quot;GET / HTTP/1.1&quot; 200 10 &quot;-&quot; &quot;curl/7.29.0&quot;<br><br><br><br></code></pre></td></tr></table></figure>

<p><img src="image-20231010154618994.png" srcset="/img/loading.gif" lazyload alt="image-20231010154618994"></p>
<h3 id="3-3-2-LVS-DR模式多网段案例实现"><a href="#3-3-2-LVS-DR模式多网段案例实现" class="headerlink" title="3.3.2 LVS-DR模式多网段案例实现"></a>3.3.2 LVS-DR模式多网段案例实现</h3><p><img src="image-20231010155831327.png" srcset="/img/loading.gif" lazyload alt="image-20231010155831327"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs html">环境：五台主机<br>第一台：internet-client<br>eth0：仅主机192.168.0.7/24 GW：192.168.0.5<br><br>第二台：router<br>eth0：NAT 10.0.0.129/24<br>eth0:1：NAT 172.16.0.200/24<br>eth1：仅主机192.168.0.5/24<br>启用：IP_FORWARD<br><br>第三台：LVS<br>eth0：NAT：DIP：10.0.0.128/24 GW：10.0.0.129<br>lo:1:VIP :172.16.0.100/32<br><br>第四台：RS1<br>RS1：eth0：NAT:10.0.0.3/24  GW：10.0.0.129<br>lo:1:VIP :172.16.0.100/32<br><br>第五台：RS2<br>RS2：eth0：NAT:10.0.0.4/24  GW：10.0.0.129<br>lo:1:VIP :172.16.0.100/32<br></code></pre></td></tr></table></figure>



<h4 id="3-3-2-1-LVS的网络配置"><a href="#3-3-2-1-LVS的网络配置" class="headerlink" title="3.3.2.1 LVS的网络配置"></a>3.3.2.1 LVS的网络配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">所有主机禁用iptables和SElinux</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">internet-client主机环境</span><br>[08:10:47 root@internet-client ~]#hostname -I<br>192.168.0.7 <br><br>[08:19:44 root@internet-client ~]#route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         192.168.0.5     0.0.0.0         UG    0      0        0 ens37<br>192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 ens37<br><br>[22:24:15 root@internet-client ~]#cat  /etc/sysconfig/network-scripts/ifcfg-ens33 <br>TYPE=&quot;Ethernet&quot;<br>BOOTPROTO=static<br>IPADDR=192.168.0.7<br>NETMASK=255.255.255.0<br>DNS1=223.6.6.6<br>DNS2=114.114.114.114<br>GATEWAY=192.168.0.5<br>DEFROUTE=&quot;yes&quot;<br>NAME=&quot;ens37&quot;<br>UUID=&quot;b7b43824-3aba-417e-badc-190cdff2f31e&quot;<br>DEVICE=&quot;ens37&quot;<br>ONBOOT=&quot;yes&quot;<br><br><br><br>[08:50:46 root@internet-client ~]#ping 10.0.0.4<br>PING 10.0.0.4 (10.0.0.4) 56(84) bytes of data.<br>64 bytes from 10.0.0.4: icmp_seq=204 ttl=63 time=0.224 ms<br><br>[08:31:41 root@internet-client ~]#ping 10.0.0.3<br>PING 10.0.0.3 (10.0.0.3) 56(84) bytes of data.<br>64 bytes from 10.0.0.3: icmp_seq=1 ttl=63 time=1.09 ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">############################################################################</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">路由器的网络配置</span><br>[00:37:16 root@Router ~]#sysctl -a | grep ip_forward<br>net.ipv4.ip_forward = 0<br>net.ipv4.ip_forward_update_priority = 1<br>net.ipv4.ip_forward_use_pmtu = 0<br>[00:40:29 root@Router ~]#echo &#x27;net.ipv4.ip_forward = 1&#x27; &gt;&gt; /etc/sysctl.conf <br>[00:41:29 root@Router ~]#sysctl -p<br>net.ipv4.ip_forward = 1<br><br><br>[16:02:59 root@Router ~]#ip addr add 172.16.0.200/24 dev ens160<br>[16:03:58 root@Router ~]#ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:24:99:c9 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.129/24 brd 10.0.0.255 scope global dynamic noprefixroute ens160<br>       valid_lft 1152sec preferred_lft 1152sec<br>    inet 172.16.0.200/24 scope global ens160<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe24:99c9/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br>3: ens224: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:24:99:d3 brd ff:ff:ff:ff:ff:ff<br>    inet 192.168.0.5/24 brd 192.168.0.255 scope global dynamic noprefixroute ens224<br>       valid_lft 1152sec preferred_lft 1152sec<br>    inet6 fe80::cfc0:2e36:e0ef:d54c/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">####################################################################</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">LVS的网络配置</span><br>[13:10:02 root@LVS ~]#hostname -I<br>10.0.0.128 <br>[13:10:12 root@LVS ~]#route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.129      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br>[13:10:17 root@LVS ~]#cat   /etc/sysconfig/network-scripts/ifcfg-ens160 <br>TYPE=Ethernet<br>BOOTPROTO=static<br>IPADDR=10.0.0.128<br>GATEWAY=10.0.0.129<br>PREFIX=24<br>DEFROUTE=yes<br>IPV4_FAILURE_FATAL=no<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>[13:10:25 root@LVS ~]#ping 192.168.0.7<br>PING 192.168.0.7 (192.168.0.7) 56(84) bytes of data.<br>64 bytes from 192.168.0.7: icmp_seq=1 ttl=63 time=0.406 ms<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">####################################################################</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">RS1的网络配置</span><br>[00:51:51 root@RS1 ~]#hostname -I<br>10.0.0.3<br>[00:50:24 root@RS1 ~]#cat /etc/sysconfig/network-scripts/ifcfg-ens160 <br>TYPE=Ethernet<br>BOOTPROTO=static<br>IPADDR=10.0.0.3<br>PREFIX=24<br>GATEWAY=10.0.0.129<br>NAME=ens160<br>DEVICE=ens160<br>ONBOOT=yes<br>[00:52:08 root@RS1 ~]#route -n <br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.129      0.0.0.0         UG    100    0        0 ens160<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 ens160<br><br><br>[01:00:50 root@RS1 ~]#yum install -y httpd<br>[01:01:10 root@RS1 ~]#systemctl enable --now httpd<br>Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.<br>[01:01:34 root@RS1 ~]#hostname -I &gt; /var/www/html/index.html<br>[01:02:30 root@RS1 ~]#ping 192.168.0.7<br>PING 192.168.0.7 (192.168.0.7) 56(84) bytes of data.<br>64 bytes from 192.168.0.7: icmp_seq=1 ttl=63 time=0.418 ms<br>64 bytes from 192.168.0.7: icmp_seq=2 ttl=63 time=1.13 ms<br>^C<br>--- 192.168.0.7 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1061ms<br>rtt min/avg/max/mdev = 0.418/0.773/1.129/0.356 ms<br>[01:03:50 root@RS1 ~]#curl 10.0.0.4<br>10.0.0.4 <br>[01:04:13 root@RS1 ~]#curl 10.0.0.3<br>10.0.0.3 <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#########################################################################</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">RS2的网络配置</span><br>[00:57:25 root@RS2 ~]#hostname -I<br>10.0.0.4<br>[00:57:06 root@RS2 ~]#cat  /etc/sysconfig/network-scripts/ifcfg-ens160 <br>TYPE=Ethernet<br>PROXY_METHOD=none<br>BROWSER_ONLY=no<br>BOOTPROTO=static<br>IPADDR=10.0.0.4<br>PREFIX=24<br>GATEWAY=10.0.0.129<br>NAME=eth0<br>DEVICE=eth0<br>ONBOOT=yes<br>[00:57:12 root@RS2 ~]#route -n<br>Kernel IP routing table<br>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface<br>0.0.0.0         10.0.0.129      0.0.0.0         UG    100    0        0 eth0<br>10.0.0.0        0.0.0.0         255.255.255.0   U     100    0        0 eth0<br><br>[01:00:50 root@RS2 ~]#yum install -y httpd<br>[01:01:10 root@RS2 ~]#systemctl enable --now httpd<br>Created symlink /etc/systemd/system/multi-user.target.wants/httpd.service → /usr/lib/systemd/system/httpd.service.<br>[01:01:34 root@RS2 ~]#hostname -I &gt; /var/www/html/index.html<br>[01:02:21 root@RS2 ~]#ping 192.168.0.7<br>PING 192.168.0.7 (192.168.0.7) 56(84) bytes of data.<br>64 bytes from 192.168.0.7: icmp_seq=1 ttl=63 time=0.513 ms<br>64 bytes from 192.168.0.7: icmp_seq=2 ttl=63 time=1.01 ms<br>^C<br>--- 192.168.0.7 ping statistics ---<br>2 packets transmitted, 2 received, 0% packet loss, time 1020ms<br>rtt min/avg/max/mdev = 0.513/0.760/1.008/0.249 ms<br>[01:05:07 root@RS2 ~]#curl 10.0.0.3<br>10.0.0.3 <br>[01:05:14 root@RS2 ~]#curl 10.0.0.4<br>10.0.0.4 <br><br><br><br><br></code></pre></td></tr></table></figure>



<h4 id="3-3-2-2-后端RS的IPVS配置"><a href="#3-3-2-2-后端RS的IPVS配置" class="headerlink" title="3.3.2.2 后端RS的IPVS配置"></a>3.3.2.2 后端RS的IPVS配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">RS1的IPVS配置</span><br>[01:04:16 root@RS1 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore <br>[01:13:09 root@RS1 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce <br>[01:13:25 root@RS1 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore <br>[01:13:34 root@RS1 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce <br>[14:10:05 root@RS1 ~]#ifconfig lo:1 172.16.0.100/32<br>[14:10:32 root@RS1 ~]#ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: ens160: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:99:e8:44 brd ff:ff:ff:ff:ff:ff<br>    altname enp3s0<br>    inet 10.0.0.3/24 brd 10.0.0.255 scope global noprefixroute ens160<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe99:e844/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br>[14:10:34 root@RS1 ~]#<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">RS2的IPVS配置</span><br>01:05:16 root@RS2 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore <br>[01:16:22 root@RS2 ~]#echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore <br>[01:16:38 root@RS2 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce <br>[01:16:48 root@RS2 ~]#echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce <br>[01:16:52 root@RS2 ~]#ifconfig lo:1 172.16.0.100/32<br>[01:17:16 root@RS2 ~]#ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:2c:30:b9 brd ff:ff:ff:ff:ff:ff<br>    altname enp3s0<br>    altname ens160<br>    inet 10.0.0.4/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fe2c:30b9/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-3-LVS主机的配置"><a href="#3-3-2-3-LVS主机的配置" class="headerlink" title="3.3.2.3 LVS主机的配置"></a>3.3.2.3 LVS主机的配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在LVS上添加VIP</span><br>[13:11:06 root@LVS ~]#ifconfig lo:1 172.16.0.100/32<br>[13:18:46 root@LVS ~]#ip a<br>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>    inet 127.0.0.1/8 scope host lo<br>       valid_lft forever preferred_lft forever<br>    inet 10.0.0.100/0 scope global lo:1<br>       valid_lft forever preferred_lft forever<br>    inet6 ::1/128 scope host <br>       valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>    link/ether 00:0c:29:e9:f4:40 brd ff:ff:ff:ff:ff:ff<br>    inet 10.0.0.128/24 brd 10.0.0.255 scope global noprefixroute eth0<br>       valid_lft forever preferred_lft forever<br>    inet6 fe80::20c:29ff:fee9:f440/64 scope link noprefixroute <br>       valid_lft forever preferred_lft forever<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">实现LVS规则</span><br>[13:18:48 root@LVS ~]#dnf -y install ipvsadm<br>[04:18:39 root@LVS ~]#ipvsadm -A -t 172.16.0.100:80 -s rr<br>[04:20:55 root@LVS ~]#ipvsadm -a -t 172.16.0.100:80 -r 10.0.0.3:80 <br>[04:21:53 root@LVS ~]#ipvsadm -a -t 172.16.0.100:80 -r 10.0.0.4:80 <br>[04:21:56 root@LVS ~]#ipvsadm -Ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br>TCP  172.16.0.100:80 rr<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">10.0.0.3:80                  Route   1      0          0</span>         <br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">10.0.0.4:80                  Route   1      0          0</span>         <br>         <br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-4-测试访问"><a href="#3-3-2-4-测试访问" class="headerlink" title="3.3.2.4 测试访问"></a>3.3.2.4 测试访问</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[00:22:17 root@internet-client ~]#curl 172.16.0.100<br>10.0.0.4 <br>[00:22:23 root@internet-client ~]#curl 172.16.0.100<br>10.0.0.3 <br>[00:22:25 root@internet-client ~]#curl 172.16.0.100<br>10.0.0.4 <br>[00:22:26 root@internet-client ~]#curl 172.16.0.100<br>10.0.0.3 <br>[00:22:26 root@internet-client ~]#curl 172.16.0.100<br>10.0.0.4 <br><br></code></pre></td></tr></table></figure>

<h2 id="3-4-脚本实现DR模型实战"><a href="#3-4-脚本实现DR模型实战" class="headerlink" title="3.4 脚本实现DR模型实战"></a>3.4 脚本实现DR模型实战</h2><h3 id="3-4-1-VS的配置脚本："><a href="#3-4-1-VS的配置脚本：" class="headerlink" title="3.4.1 VS的配置脚本："></a>3.4.1 VS的配置脚本：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#***************************************************************************</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Author:		tangbeiting</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">QQ:			306876058</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Date:			2023-10-10</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">FileName:		lvs_dr.sh</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">URL:			https://xiaohexie00.github.io/</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Description:		The <span class="hljs-built_in">test</span> script</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Copyright (C):	2023 ALL rights reserved</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">**************************************************************************</span><br><br>iface=&#x27;lo:1&#x27;<br>mask=&#x27;255.255.255.255&#x27;<br>RIP1=&#x27;10.0.0.3&#x27;<br>RIP2=&#x27;10.0.0.4&#x27;<br>VIP=&#x27;172.16.0.100&#x27;<br>PORT=&#x27;80&#x27;<br>scheduler=&#x27;rr&#x27;<br>rpm -q ipvsadm &amp;&gt; /dev/null || yum install -y ipvsadm &amp;&gt; /dev/null<br><br>case $1 in<br>start)<br>    ifconfig $iface $VIP netmask $mask <br>    iptables -F<br><br>    ipvsadm -A -t $&#123;VIP&#125;:$&#123;PORT&#125; -s rr<br>    ipvsadm -a -t $&#123;VIP&#125;:$&#123;PORT&#125; -r $&#123;RIP1&#125;<br>    ipvsadm -a -t $&#123;VIP&#125;:$&#123;PORT&#125; -r $&#123;RIP2&#125; <br>    echo &quot;VS server is ready!&quot;<br>    ;;<br><br>stop)<br>    ipvsadm -C<br>    ifconfig $iface down<br>    echo &quot;VS server is canceled!&quot;<br>    ;;<br>*)<br>    echo &quot;Usage $(basename $0) start|stop&quot;<br>    exit 1<br>esac<br></code></pre></td></tr></table></figure>



<h3 id="3-4-2-RS的配置脚本"><a href="#3-4-2-RS的配置脚本" class="headerlink" title="3.4.2 RS的配置脚本"></a>3.4.2 RS的配置脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#***************************************************************************</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Author:		tangbeiting</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">QQ:			306876058</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Date:			2023-10-10</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">FileName:		lvs_rs.sh</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">URL:			https://xiaohexie00.github.io/</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Description:		The <span class="hljs-built_in">test</span> script</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Copyright (C):	2023 ALL rights reserved</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">**************************************************************************</span><br><br>iface=&#x27;lo:1&#x27;<br>mask=&#x27;255.255.255.255&#x27;<br>VIP=&#x27;172.16.0.100&#x27;<br><br>rpm -q httpd &amp;&gt; /dev/null || yum -y install httpd &amp;&gt; /dev/null<br>systemctl enabled --now httpd &amp;&gt; /dev/null &amp;&amp; echo &quot;the httpd server is ready!&quot;<br><br><br>case $1 in <br>start)<br>    ifconfig $iface $VIP netmask $mask<br>    iptables -F<br>    <br>    echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br>    echo 1 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore <br>    echo 2 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce <br>    echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce <br>    echo &quot;RS server is ready!&quot;<br>    ;;<br>stop)<br>    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore<br>    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore <br>    echo 0 &gt; /proc/sys/net/ipv4/conf/lo/arp_announce <br>    echo 0 &gt; /proc/sys/net/ipv4/conf/all/arp_announce <br>    echo &quot;RS server is canceled!&quot;<br>    ;;<br>*)<br>    echo &quot;Usage $(basename $0)&quot;<br>    exit 1<br>    ;;<br>esac<br></code></pre></td></tr></table></figure>



<h1 id="4、总结-http协议的通信过程详解"><a href="#4、总结-http协议的通信过程详解" class="headerlink" title="4、总结 http协议的通信过程详解"></a>4、总结 http协议的通信过程详解</h1><p><img src="image-20231107200906439.png" srcset="/img/loading.gif" lazyload alt="image-20231107200906439"></p>
<p><strong>web http协议通信过程</strong></p>
<ol>
<li>DNS解析</li>
<li>CDN</li>
<li>TCP三次握手</li>
<li>web服务处理<ul>
<li>建立连接</li>
<li>接受请求</li>
<li>处理请求</li>
<li>获取资源</li>
<li>构建响应报文</li>
<li>发送响应</li>
<li>记录日志</li>
</ul>
</li>
<li>浏览器接受请求报文，进行页面渲染</li>
</ol>
<h1 id="5、总结-网络IO模型和nginx架构"><a href="#5、总结-网络IO模型和nginx架构" class="headerlink" title="5、总结 网络IO模型和nginx架构"></a>5、总结 网络IO模型和nginx架构</h1><p><strong>I/O模型相关概念</strong></p>
<p>同步/异步：关注的是消息通信机制，即调用者在等待一件事情的处理结果时，被调用者是否提供完成状态的通知。</p>
<ul>
<li>同步：synchronous，被调用者并不提供事件的处理结果相关的通知消息，需要调用者主动询问事情是否处理完成</li>
<li>异步：asynchronous,被调用者通过状态、通知或回调机制主动通知调用者被调用者的运行状态</li>
</ul>
<p>阻塞/非阻塞：关注调用者在等待结果返回之前所处的状态</p>
<ul>
<li>阻塞：blocking，指IO操作需要彻底完成后才返回到用户空间，调用结果返回之前，调用者被挂起，干不了别的事情。</li>
<li>非阻塞：nonblocking，指IO操作被调用后立即返回给用户一个状态值，而无需等到IO操作彻底完成，在最终的调用结果返回之前，调用者不会被挂起，可以去做别的事情。</li>
</ul>
<h2 id="5-1-网络I-O模型"><a href="#5-1-网络I-O模型" class="headerlink" title="5.1 网络I/O模型"></a>5.1 网络I/O模型</h2><p>阻塞型、非阻塞型、复用型、信号驱动型、异步</p>
<h3 id="5-1-1-阻塞型I-0模型（blocking-10）"><a href="#5-1-1-阻塞型I-0模型（blocking-10）" class="headerlink" title="5.1.1 阻塞型I/0模型（blocking 10）"></a>5.1.1 阻塞型I/0模型（blocking 10）</h3><p>阻塞IO模型是最简单的I/O模型，用户线程在内核进行IO操作时被阻塞 用户线程通过系统调用read发起I/O读操作，由用户空间转到内核空间。内核等到数据包到达后，然后将接收的数据拷贝到用户空间，完成read操作 用户需要等待read将数据读取到buffer后，才继续处理接收的数据。整个I/O请求的过程中，用户线程是被阻塞的，这导致用户在发起IO请求时，不能做任何事情，对CPU的资源利用率不够 优点：程序简单，在阻塞等待数据期间进程/线程挂起，基本不会占用 CPU 资源 缺点：每个连接需要独立的进程/线程单独处理，当并发请求量大时为了维护程序，内存、线程切换开销较大，apache 的prefork使用的是这种模式。</p>
<h3 id="5-1-2-非阻塞型-I-O-模型-nonblocking-IO"><a href="#5-1-2-非阻塞型-I-O-模型-nonblocking-IO" class="headerlink" title="5.1.2 非阻塞型 I/O 模型 (nonblocking IO)"></a>5.1.2 非阻塞型 I/O 模型 (nonblocking IO)</h3><p>用户线程发起IO请求时立即返回。但并未读取到任何数据，用户线程需要不断地发起IO请求，直到数据到达后，才真正读取到数据，继续执行。即 “轮询”机制存在两个问题：如果有大量文件描述符都要等，那么就得一个一个的read。这会带来大量的Context Switch（read是系统调用，每调用一次就得在用户态和核心态切换一次）。轮询的时间不好把握。这里是要猜多久之后数据才能到。等待时间设的太长，程序响应延迟就过大;设的太短，就会造成过于频繁的重试，干耗CPU而已，是比较浪费CPU的方式，一般很少直接使用这种模型，而是在其他IO模型中使用非阻塞IO这一特性。</p>
<h3 id="5-1-3-多路复用型-I-O-multiplexing"><a href="#5-1-3-多路复用型-I-O-multiplexing" class="headerlink" title="5.1.3 多路复用型 (I/O multiplexing)"></a>5.1.3 多路复用型 (I/O multiplexing)</h3><p>多路复用IO指一个线程可以同时（实际是交替实现，即并发完成）监控和处理多个文件描述符对应各自的IO，即复用同一个线程 一个线程之所以能实现同时处理多个IO,是因为这个线程调用了内核中的SELECT,POLL或EPOLL等系统调用，从而实现多路复用IO</p>
<p>1、select(轮训–IO数量越多速度越慢) 2、epoll(IO完成内核立刻主动发生主动地通报) I/O multiplexing 主要包括:select，poll，epoll三种系统调用，select/poll/epoll的好处就在于单个process就可以同时处理多个网络连接的IO。 它的基本原理就是select/poll/epoll这个function会不断的轮询所负责的所有socket，当某个socket有数据到达了，就通知用户进程。 当用户进程调用了select，那么整个进程会被block，而同时，kernel会“监视”所有select负责的socket，当任何一个socket中的数据准备好了，select就会返回。这个时候用户进程再调用read操作，将数据从kernel拷贝到用户进程。 Apache prefork是此模式的select，worker是poll模式。</p>
<h3 id="5-1-4-信号驱动式-I-O-模型-signal-driven-IO"><a href="#5-1-4-信号驱动式-I-O-模型-signal-driven-IO" class="headerlink" title="5.1.4 信号驱动式 I/O 模型 (signal-driven IO)"></a>5.1.4 信号驱动式 I/O 模型 (signal-driven IO)</h3><p>信号驱动I/O的意思就是进程现在不用傻等着，也不用去轮询。而是让内核在数据就绪时，发送信号通知进程。 调用的步骤是，通过系统调用 sigaction ，并注册一个信号处理的回调函数，该调用会立即返回，然后主程序可以继续向下执行，当有I/O操作准备就绪,即内核数据就绪时，内核会为该进程产生一个 SIGIO信号，并回调注册的信号回调函数，这样就可以在信号回调函数中系统调用 recvfrom 获取数据,将用户进程所需要的数据从内核空间拷贝到用户空间 此模型的优势在于等待数据报到达期间进程不被阻塞。用户主程序可以继续执行，只要等待来自信号处理函数的通知。 在信号驱动式 I/O 模型中，应用程序使用套接口进行信号驱动 I/O，并安装一个信号处理函数，进程继续运行并不阻塞 当数据准备好时，进程会收到一个 SIGIO 信号，可以在信号处理函数中调用 I/O 操作函数处理数据。优点：线程并没有在等待数据时被阻塞，内核直接返回调用接收信号，不影响进程继续处理其他请求因此可以提高资源的利用率 缺点：信号 I/O 在大量 IO 操作时可能会因为信号队列溢出导致没法通知</p>
<h3 id="5-1-5-异步-I-O-模型-asynchronous-IO"><a href="#5-1-5-异步-I-O-模型-asynchronous-IO" class="headerlink" title="5.1.5 异步 I/O 模型 (asynchronous IO)"></a>5.1.5 异步 I/O 模型 (asynchronous IO)</h3><p>异步1/O与信号驱动I/O最大区别在于，信号驱动是内核通知用户进程何时开始一个1/0操作，而异步1/O是由内核通知用户进程1/O操作何时完成，两者有本质区别，相当于不用去饭店场吃饭，直接点个外卖，把等待上菜的时间也给省了</p>
<p>相对于同步I/O，异步l/o不是顺序执行。用户进程进行aio_read系统调用之后，无论内核数据是否准备好，都会直接返回给用户进程，然后用户态进程可以去做别的事情。等到socket数据准备好了，内核直接复制数据给进程，然后从内核向进程发送通知。lO两个阶段，进程都是非阻塞的。</p>
<p>信号驱动IO当内核通知触发信号处理程序时，信号处理程序还需要阻塞在从内核空间缓冲区拷贝数据到用户空间缓冲区这个阶段，而异步10直接是在第二个阶段完成后，内核直接通知用户线程可以进行后续操作了</p>
<p>优点：异步I/O能够充分利用DMA特性，让I/O操作与计算重叠</p>
<p>缺点：要实现真正的异步I/O，操作系统需要做大量的工作。目前Windows下通过IOCP实现了真正的异步I/O，在Linux系统下，Linux2.6才引入，目前AlO并不完善，因此在Linux下实现高并发网络编程时以I0复用模型模式+多线程任务的架构基本可以满足需求</p>
<p>Linux提供了AlO库函数实现异步，但是用的很少。目前有很多开源的异步IO库，例如libevent、libev、libuv。</p>
<h2 id="5-2-nginx架构"><a href="#5-2-nginx架构" class="headerlink" title="5.2 nginx架构"></a>5.2 nginx架构</h2><p><img src="https://img2023.cnblogs.com/blog/3203793/202308/3203793-20230829000709007-322144217.png" srcset="/img/loading.gif" lazyload alt="img"></p>
<h3 id="5-2-1-Nginx进程结构"><a href="#5-2-1-Nginx进程结构" class="headerlink" title="5.2.1 Nginx进程结构"></a>5.2.1 Nginx进程结构</h3><p>web请求处理机制</p>
<ul>
<li>多进程方式：服务器每接收到一个客户端请求就有服务器的主进程生成一个子进程响应客户端，直到用户关闭连接，这样的优势是处理速度快，子进程之间相互独立，但是如果访问过大会导致服务器资源耗尽而无法提供请求。</li>
<li> 多线程方式：与多进程方式类似，但是每收到一个客户端请求会有服务进程派生出一个线程和此客户端进行交互，一个线程的开销远远小于一个进程，因此多线程方式在很大程度减轻了web服务器对系统资源的要求，但是多线程也有自己的缺点，即当多个线程位于同一个进程内工作的时候，可以相互访问同样的内存地址空间，所以他们相互影响，一旦主进程挂掉则所有子线程都不能工作了，IIS服务器使用了多线程的方式，需要间隔一段时间就重启一次才能稳定。</li>
</ul>
<p>Nginx是多进程组织模型，而且是一个由Master主进程和Worker工作进程组成。</p>
<p><img src="image-20231107210531529.png" srcset="/img/loading.gif" lazyload alt="image-20231107210531529"></p>
<p>主进程(master process)的功能：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs http">对外接口：接收外部的操作（信号） <br>对内转发：根据外部的操作的不同，通过信号管理 Worker <br>监控：监控 worker 进程的运行状态，worker 进程异常终止后，自动重启 worker 进程 <br>读取Nginx 配置文件并验证其有效性和正确性 <br>建立、绑定和关闭socket连接 <br>按照配置生成、管理和结束工作进程 <br>接受外界指令，比如重启、升级及退出服务器等指令 <br>不中断服务，实现平滑升级，重启服务并应用新的配置 <br>开启日志文件，获取文件描述符 <br>不中断服务，实现平滑升级，升级失败进行回滚处理 <br>编译和处理perl脚本<br></code></pre></td></tr></table></figure>

<p>工作进程（worker process）的功能：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http">所有 Worker 进程都是平等的 <br>实际处理：网络请求，由 Worker <br>进程处理 Worker进程数量：一般设置为核心数，充分利用CPU资源，同时避免进程数量过多，导致进程竞争CPU资源， <br>增加上下文切换的损耗 <br>接受处理客户的请求 <br>将请求依次送入各个功能模块进行处理 I/O调用，获取响应数据 <br>与后端服务器通信，接收后端服务器的处理结果 <br>缓存数据，访问缓存索引，查询和调用缓存数据 <br>发送请求结果，响应客户的请求 <br>接收主程序指令，比如重启、升级和退出等<br></code></pre></td></tr></table></figure>



<h1 id="6、完成nginx编译安装脚本"><a href="#6、完成nginx编译安装脚本" class="headerlink" title="6、完成nginx编译安装脚本"></a>6、完成nginx编译安装脚本</h1><h2 id="6-1实战案例：一键安装nginx脚本"><a href="#6-1实战案例：一键安装nginx脚本" class="headerlink" title="6.1实战案例：一键安装nginx脚本"></a>6.1实战案例：一键安装nginx脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"></span><br><span class="language-bash"><span class="hljs-comment">#***************************************************************************</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Author:		tangbeiting</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">QQ:			306876058</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Date:			2023-10-15</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">FileName:		nginx_install.sh</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">URL:			https://xiaohexie00.github.io/</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Description:		The <span class="hljs-built_in">test</span> script</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">Copyright (C):	2023 ALL rights reserved</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">**************************************************************************</span><br><br>USER=&#x27;nginx&#x27;<br>INSTALL_DIR=&#x27;/apps/nginx&#x27;<br>NGINX_VERSION=&#x27;1.22.1&#x27;<br>CPUS=`lscpu | awk &#x27;/^CPU\(s\)/&#123;print $2&#125;&#x27;`<br><br>. /etc/os-release<br><br>color () &#123;<br>    RES_COL=60<br>    MOVE_TO_COL=&quot;echo -en \\033[$&#123;RES_COL&#125;G&quot;<br>    SETCOLOR_SUCCESS=&quot;echo -en \\033[1;32m&quot;<br>    SETCOLOR_FAILURE=&quot;echo -en \\033[1;31m&quot;<br>    SETCOLOR_WARNING=&quot;echo -en \\033[1;33m&quot;<br>    SETCOLOR_NORMAL=&quot;echo -en \E[0m&quot;<br>    echo -n &quot;$1&quot; &amp;&amp; $MOVE_TO_COL<br>    echo -n &quot;[&quot;<br>    if [ $2 = &quot;success&quot; -o $2 = &quot;0&quot; ] ;then<br>        $&#123;SETCOLOR_SUCCESS&#125;<br>        echo -n $&quot;  OK  &quot;    <br>    elif [ $2 = &quot;failure&quot; -o $2 = &quot;1&quot;  ] ;then <br>        $&#123;SETCOLOR_FAILURE&#125;<br>        echo -n $&quot;FAILED&quot;<br>    else<br>        $&#123;SETCOLOR_WARNING&#125;<br>        echo -n $&quot;WARNING&quot;<br>    fi<br>    $&#123;SETCOLOR_NORMAL&#125;<br>    echo -n &quot;]&quot;<br>    echo <br>&#125;<br><br><br>install_nginx () &#123;<br>    color &quot;开始安装 nginx&quot; 0<br>    if id $&#123;USER&#125; &amp;&gt; /dev/null ;then<br>        color &quot; $USER用户已存在&quot; 1<br>    else<br>        useradd -s /sbin/nologin -r $&#123;USER&#125;<br>        color &quot; 创建$&#123;USER&#125;用户&quot; 0<br>    fi<br>    <br>    color &quot; 开始安装依赖包&quot; 0    <br>    if [ $ID = &#x27;rocky&#x27; -o $ID = &#x27;centos&#x27; ] ; then<br>        yum -y install gcc pcre-devel openssl-devel zlib-devel wget make &amp;&gt; /dev/null<br>    elif [ $ID = &#x27;ubuntu&#x27; ] ;then<br>        apt update  &amp;&gt; /dev/null<br>        apt install -y make gcc libpcre3 libpcre3-dev openssl libssl-dev  zlib1g-dev wget  &amp;&gt; /dev/null<br>    else<br>        color &quot;不支持此操作系统，退出！&quot; 1<br>        exit<br>    fi<br>    <br>    if [ ! -f nginx-$&#123;NGINX_VERSION&#125;.tar.gz  ] ; then<br>        wget https://nginx.org/download/nginx-$&#123;NGINX_VERSION&#125;.tar.gz<br>    fi<br>    <br>    cp  nginx-$&#123;NGINX_VERSION&#125;.tar.gz /usr/local/src/<br>    cd /usr/local/src/<br>    tar xf nginx-$&#123;NGINX_VERSION&#125;.tar.gz<br>    cd nginx-$&#123;NGINX_VERSION&#125;/<br>    ./configure --prefix=$&#123;INSTALL_DIR&#125; --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module<br>    make -j $CPUS &amp;&amp; make install<br>    [ $? -eq 0 ] &amp;&amp; color &quot;nginx 编译安装成功&quot; 0 || &#123; color &quot;nginx 编译安装失败，退出！&quot; 1 ;exit; &#125;<br>     <br>    <br>    chown -R $&#123;USER&#125;.$&#123;USER&#125; $&#123;INSTALL_DIR&#125;<br>    <br>    ln -s $&#123;INSTALL_DIR&#125;/sbin/nginx /usr/sbin/<br>    <br><br>    cat &gt; /usr/lib/systemd/system/nginx.service &lt;&lt;EOF<br>[Unit]<br>Description=The nginx HTTP and reverse proxy server<br>After=network.target remote-fs.target nss-lookup.target<br><br>[Service]<br>Type=forking<br>PIDFile=$&#123;INSTALL_DIR&#125;/run/nginx.pid<br>ExecStartPre=/usr/bin/rm -f $&#123;INSTALL_DIR&#125;/run/nginx.pid<br>ExecStartPre=$&#123;INSTALL_DIR&#125;/sbin/nginx -t<br>ExecStart=$&#123;INSTALL_DIR&#125;/sbin/nginx -c $&#123;INSTALL_DIR&#125;/conf/nginx.conf<br>ExecReload=/bin/kill -s HUP $MAINPID<br>Execstop=/bin/kill -s TERM $MAINPID<br>KillSignal=SIGQUIT<br>TimeoutStopSec=5<br>KillMode=process<br>PrivateTmp=true<br>LimitNOFILE=100000<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br>    <br>    mkdir /apps/nginx/run<br>    echo &quot;pid        $&#123;INSTALL_DIR&#125;/run/nginx.pid;&quot; &gt;&gt; $&#123;INSTALL_DIR&#125;/conf/nginx.conf<br>    systemctl daemon-reload<br>    systemctl enable --now nginx &amp;&gt; /dev/null<br>    systemctl is-active nginx &amp;&gt; /dev/null || &#123; color &quot;nginx 启动失败，退出&quot; 1 ; exit; &#125; <br>    color &quot; nginx 安装完成 &quot; 0<br>    <br>&#125;    <br><br>install_nginx <br></code></pre></td></tr></table></figure>



<h1 id="7、总结nginx核心配置，并实现nginx多虚拟主机"><a href="#7、总结nginx核心配置，并实现nginx多虚拟主机" class="headerlink" title="7、总结nginx核心配置，并实现nginx多虚拟主机"></a>7、总结nginx核心配置，并实现nginx多虚拟主机</h1><h2 id="7-1-nginx核心配置"><a href="#7-1-nginx核心配置" class="headerlink" title="7.1 nginx核心配置"></a>7.1 nginx核心配置</h2><h3 id="7-1-1-配置文件说明"><a href="#7-1-1-配置文件说明" class="headerlink" title="7.1.1 配置文件说明"></a>7.1.1 配置文件说明</h3><p>nginx官方帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://nginx.org/en/docs/<br></code></pre></td></tr></table></figure>

<p>tengine 帮助文档</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://tengine.taobao.org/nginx_docs/cn/docs/<br></code></pre></td></tr></table></figure>

<p>Nginx的配置文件的组成部分：</p>
<ul>
<li>主配置文件：nginx.conf</li>
<li>子配置文件：include conf.d/*.conf</li>
<li>fastcgi,uwsgi,scgi等协议相关的配置文件</li>
<li>mime.types:支持的mime类型，MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型，MIME消息能包含文本、图像、音频、视频以及其他应用程序专用的数据，是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。MIME参考文档：<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types">MIME 类型（IANA 媒体类型） - HTTP | MDN (mozilla.org)</a></li>
</ul>
<p>nginx配置文件格式说明</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http">配置文件由指令与指令块构成<br>每条指令以；分号结尾，指令与值之间以空格符号分隔<br>可以将多条指令放在同一行，用分号分隔即可，但可读性差，不推荐<br>指令块以&#123;&#125;大括号将多条指令组织在一起，且可以嵌套指令块<br>include语句允许组合多个配置文件以提升可维护性<br>使用#符号添加注释，提高可读性<br>使用$符号使用变量<br>部分指令的参数支持正则表达式<br></code></pre></td></tr></table></figure>

<p>Nginx主配置文件的配置指令方式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">directive value [value2 .……];<br><br>注意<br>（1）指令必须以分号结尾<br>(2）支持使用配置变量内建变量：<br>	由Nginx模块引入，可直接引用<br>	自定义变量：由用户使用set命令定义,格式：set variable_name value;<br>	引用变量：$variable_name<br></code></pre></td></tr></table></figure>

<p>主配置文件结构：四部分</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">main block：主配置段，即全局配置段，对http，mail都有效<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">事件驱动相关的配置</span><br>event &#123;<br>			.....<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">http/https 协议相关配置段</span><br>http &#123;<br>			.....<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">默认配置文件不包括下面两个块</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">mail协议相关配置段</span><br>mail &#123;<br>			.....<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">stream 服务器相关配置段</span><br>stream &#123;<br>			.....<br>&#125;<br></code></pre></td></tr></table></figure>

<p>默认的nginx.conf 配置文件格式说明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">全局配置端，对全局生效，主要设置nginx的启动用户/组，启动的工作进程数量，工作模式，Nginx的PID路径，日志路径等。</span><br>nginx nginx;user<br>worker_processes 1;		#启动工作进程数数量<br>events&#123;	#events设置快，主要影响nginx服务器与用户的网络连接，比如是否允许同时接受多个网络连接，使用哪种事件驱动模型处理请求，每个工作进程可以同时支持的最大连接数，是否开启对多工作进程下的网络连接进行序列化等。<br><span class="hljs-meta prompt_">	#</span><span class="language-bash">设置单个nginx工作进程可以接受的最大并发，作为web服务器worker_connections 1024;的时候最大并发数为worker_connections* worker_processes,作为反向代理的时候为(worker_connections * worker_processes)/2</span><br>&#125;<br>http&#123;	#http块是Nginx服务器配置中的重要部分，缓存、代理和日志格式定义等绝大多数功能和第三方模块都可以在这设置，http块可以包含多个server块，而一个server块中又可以包含多个1ocation块，server块可以配置文件引入、MIME-Type定义、日志自定义、是否启用sendfile、连接超时时间和单个链接的请求上限等。<br>	include			mime.types;<br>	default_type	application/octet-stream;<br>	sendfile		on；#作为web服务器的时候打开sendfile加快静态文件传输，指定是否使用sendfile系统调用来传输文件，sendfile系统调用在两个文件描述符之间直接传递数据(完全在内核中操作），从而避免了数据在内核缓冲区和用户缓冲区之间的拷贝，操作效率很高，被称之为零拷贝，硬盘&gt;&gt;kernel buffer(快速拷贝到kernelsocket buffer)&gt;&gt;协议栈。<br>	keepalive_timeout 65； #长连接超时时间，单位是秒<br>	server&#123;#设置一个虚拟机主机，可以包含自己的全局快，同时也可以包含多个location模块。比如本虚拟机监听的端口、本虚拟机的名称和IP配置，多个server 可以使用一个端口，比如都使用80端口提供web服务、<br>	listen		80;	#配置server监听的端口<br>	server_name localhost；#本server的名称,当访问此名称的时候nginx会调用当前serevr内部的配置进程匹配。<br>	location / &#123;#location其实是server的一个指令，为nginx服务器提供比较多而且灵活的指令，都是在location中体现的，主要是基于nginx接受到的请求字符串，对用户请求的uIL进行匹配，并对特定的指令进行处理，包括地址重定向、数据缓存和应答控制等功能都是在这部分实现，另外很多第三方模块的配置也是在location模块中配置。<br>		root 	html；#相当于默认页面的目录名称，默认是安装目录的相对路径，可以使用绝对路径配置。<br>		index 	index.html index.htm;#默认的页面文件名称<br>	&#125;<br>	error_page	500 502 503504 /50x.htm1；#错误页面的文件名称<br>	location= /50x.html&#123; #location处理对应的不同错误码的页面定义到/50x.html,这个跟对应其server中定义的目录下。<br>		root	html;	#定义默认页面所在的目录<br>	&#125;<br> &#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">和邮件相关的配置</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">mail&#123;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">			....</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">		&#125;	mail 协议相关配置段</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">tcp代理配置，1.9版本以上支持</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">stream &#123;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">				....</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">		&#125;		stream 服务器相关配置段</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">导入其他路径的配置文件</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">include /apps/nginx/conf.d/*.conf</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="7-1-2-全局配置"><a href="#7-1-2-全局配置" class="headerlink" title="7.1.2 全局配置"></a>7.1.2 全局配置</h3><p>Main全局配置段常见的配置指令分类</p>
<ul>
<li>正常运行必备的配置</li>
<li>优化性能相关的配置</li>
<li>用于调试及定位问题相关的配置</li>
<li>事件驱动相关的配置</li>
</ul>
<p><strong>全局配置说明：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs shell">user nginx nginx；#启动Nginx工作进程的用户和组<br>worker_processes [number| auto]；#启动Nginx工作进程的数量,一般设为和cpu核心数相同<br>worker_cpu_affinity 00000001 00000010 00000100 00001000| auto;#将Nginx工作进程绑定到指定的CPU核心，默认Nginx是不进行进程绑定的，绑定并不是意味着当前nginx进程独占以一核心CPU，但是可以保证此进程不会运行在其他核心上，这就极大减少了nginx的工作进程在不同的cpu核心上的来回跳转，减少了CPU对进程的资源分配与回收以及内存管理等，因此可以有效的提升nginx服务器的性能。<br>CPU MASK:	00000001:0号CPU<br>			00000010:1号CPU<br>			10000000:7号CPU<br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例：</span><br>worker_processes	4;<br>worker_cpu_affinity 00000010 0000100000100000 10000000;<br>[root@centos8 ~]# ps axo pid,cmd,psr | grep nginx<br>31093 nginx: master process /apps		1<br>34474 nginx: worker process 			1<br>34475 nginx: worker process 			3<br>34476 nginx: worker process 			5<br>34477 nginx: worker process 			7<br>35751 grep nginx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">auto绑定CPU</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">The special value auto (1.9.10) allows binding worker processes automatically toavailable CPUs:</span><br>worker_processes auto;<br>worker_cpu_affinity auto;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">The optional mask parameter can be used to <span class="hljs-built_in">limit</span> the CPUs available forautomatic binding:</span><br>worker_cpu_affinity auto 01010101;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">错误日志记录配置，语法：error_log file  [debug | info | notice | warn | error | crit| alert | emerg]</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">error_loglogs/error.log;</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">error_loglogs/error.log notice;</span><br>error_log 	/apps/nginx/logs/error.log error;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">pid文件保存路径</span><br>pid		/apps/nginx/logs/nginx.pid;<br><br>worker_priority 0;#工作进程优先级，-20~20(19)<br>worker_rlimit_nofile 65536;#所有worker进程能打开的文件数量上限,包括:Nginx的所有连接(例如与代理服务器的连接等)，而不仅仅是与客户端的连接，另一个考虑因素是实际的并发连接数不能超过系统级别的最大打开文件数的限制.最好与ulimit-n 或者limits.conf的值保持一致，<br><br>daemon off；#前台运行Nginx服务用于测试、或者以容器运行时，需要设为off<br>master_process offlon;#是否开启Nginx的master-worker工作模式,仅用于开发调试场景,默认为on<br><br>events &#123;<br>		worker_connections 65536;	#设置单个工作进程的最大并发连接<br>		use epo11; #使用epo11事件驱动,Nginx支持众多的事件驱动,比如：select、po11、epo11,只能设置在events模块中设置。<br>		accept_mutex on; #on为同一时刻一个请求轮流由worker进程处理，而防止被同时唤醒所有worker，避免多个睡眠进程被唤醒的设置，默认为off，新请求会唤醒所有worker进程，此过程也称为&quot;惊群”，因此nginx刚安装完以后要进行适当的优化。建议设置为on<br>		multi_accept on；#on时Nginx服务器的每个工作进程可以同时接受多个新的网络连接，此指令默认为off，即默认为一个工作进程只能一次接受一个新的网络连接，打开后几个同时接受多个。建议设置为on<br>&#125;<br></code></pre></td></tr></table></figure>

<p>范例：实现nginx的高并发配置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">[15:34:14 root@rocky8 ~]#ulimit -n 102400<br>[15:32:31 root@rocky8 ~]#yum install -y httpd-tools<br>[15:34:43 root@rocky8 ~]#while true; do ab -c 5000 -n 10000 http://10.0.0.4/;sleep 0.5;done<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">默认配置不支持高并发，会出现以下错误日志</span><br>[16:44:14 root@rocky8 ~]#tail /apps/nginx/logs/error.log -f<br>2020/09/24 21:19:33 [crit] 41006#0: *1105860 open0O &quot;/apps/nginx/htm1/50x.html&quot;failed (24: Too many open files), client: 10.0.0.3, server: localhost, request:&quot;GET / HTTP/1.0&quot;, host:&quot;10.0.0.4&quot;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果systemd启动，则需要修改nginx.service文件中加LimitNOFILE=100000,才能有效</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果非systemd启动，可以修改下面pam限制</span><br>[16:53:35 root@rocky8 ~]#vim /etc/security/limits.conf<br>*					soft	nofile		1000000<br>*					hard	nofile		1000000<br><br><br>[17:06:04 root@rocky8 ~]#vim /apps/nginx/conf/nginx.conf<br>worker_rlimit_nofile 100000;<br>[16:50:00 root@rocky8 ~]#systemctl restart nginx<br>[16:50:00 root@rocky8 ~]#watch -n1 &#x27;ps -axo pid,cmd,nice | grep nginx&#x27; #验证进程优先级<br></code></pre></td></tr></table></figure>

<h3 id="7-1-3-http-配置块"><a href="#7-1-3-http-配置块" class="headerlink" title="7.1.3 http 配置块"></a>7.1.3 http 配置块</h3><p>http 协议相关的配置结构</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">http &#123; <br>	.......<br>	.......#各server的公共配置<br>	server&#123; #每个server用于定义一个虚拟主机，第一个server为默认虚拟服务器<br>		....<br>	&#125;<br>	server&#123;<br>		...<br>		server_name  #虚拟主机名<br>		root	#主目录<br>		alias	#路径别名<br>		location [OPERATOR]URL &#123; 		#指定URL的特性<br>			...<br>			if CONDITION &#123;<br>				...<br>			&#125;<br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>http 协议配置说明</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs shell">http &#123; <br>	include		mime.types; #导入支持的文件类型，是相对于/apps/nginx/conf的目录<br>	default_type	application/octet-stream;	#除mime.types中文件类型外，设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">日志配置部分</span><br>    #log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;<br>    #                  &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;<br>    #                  &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;<br><br>    #access_log  logs/access.log  main;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">自定义优化参数</span><br>    sendfile        on;<br>    #tcp_nopush     on;	#在开启了sendfile的情况下，合并请求后统一发送给客户端，必须开启<br><span class="hljs-meta prompt_">	#</span><span class="language-bash">tcp_nodelay	off;<span class="hljs-comment">#在开启了keepalived模式下的连接是否启用TCP_NODELAY选项,当为off时，延迟O.2s发送，默认on时，不延迟发送，立即发送用户响应报文。</span></span><br>    #keepalive_timeout  0;<br>    keepalive_timeout  65 65;	#设置会话保持时间，第二个值为响应首部：keep-Alived:timeout=65,可以和第一个值不同<br><br>    #gzip  on;	#开启文件压缩<br><br>    server &#123;<br>        listen       80; #设置监听地址和端口<br>        server_name  localhost;	#设置server name，可以以空格隔开写多个并支持正则表达式，如：*.magedu.comwww.magedu.*~Awww\d+\.magedu\.com$ default_server<br><br>        #charset koi8-r;	#设置编码格式，默认是俄语格式，建议改为utf-8<br><br>        #access_log  logs/host.access.log  main;<br><br>        location / &#123;<br>            root   html;<br>            index  index.html index.htm;<br>        &#125;<br><br>        #error_page  404              /404.html;<br><br>        # redirect server error pages to the static page /50x.html<br>        #<br>        error_page   500 502 503 504  /50x.html; #定义错误页面<br>        location = /50x.html &#123;<br>            root   html;<br>        &#125;<br><br>        # proxy the PHP scripts to Apache listening on 127.0.0.1:80<br>        #<br>        #location ~ \.php$ &#123; #以http的方式转发php请求到指定web服务器<br>        #    proxy_pass   http://127.0.0.1;<br>        #&#125;<br><br>        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000<br>        #<br>        #location ~ \.php$ &#123; #以fastcgi的方式转发php请求到php处理<br>        #    root           html;<br>        #    fastcgi_pass   127.0.0.1:9000;<br>        #    fastcgi_index  index.php;<br>        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;<br>        #    include        fastcgi_params;<br>        #&#125;<br><br>        # deny access to .htaccess files, if Apache&#x27;s document root<br>        # concurs with nginx&#x27;s one<br>        #<br>        #location ~ /\.ht &#123; #拒绝web形式访问指定文件，如很多的网站都是通过.htaccess文件来改变自己的重定向等功能。<br>        #    deny  all;<br>        #&#125;<br>    &#125;<br><br><br>    # another virtual host using mix of IP-, name-, and port-based configuration<br>    #<br>    #server &#123;<br>    #    listen       8000;<br>    #    listen       somename:8080;<br>    #    server_name  somename  alias  another.alias;<br><br>    #    location / &#123;<br>    #        root   html;<br>    #        index  index.html index.htm;<br>    #    &#125;<br>    #&#125;<br><br><br>    # HTTPS server<br>    #<br>    #server &#123; #自定义虚拟server<br>    #    listen       443 ssl;<br>    #    server_name  localhost;<br><br>    #    ssl_certificate      cert.pem;<br>    #    ssl_certificate_key  cert.key;<br><br>    #    ssl_session_cache    shared:SSL:1m;<br>    #    ssl_session_timeout  5m;<br><br>    #    ssl_ciphers  HIGH:!aNULL:!MD5;<br>    #    ssl_prefer_server_ciphers  on;<br><br>    #    location / &#123;<br>    #        root   html;<br>    #        index  index.html index.htm; #指定默认网页文件，此指令由ngx_http_index_module模块提供<br>    #    &#125;<br>    #&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-1-3-1MIME"><a href="#7-1-3-1MIME" class="headerlink" title="7.1 .3.1MIME"></a>7.1 .3.1MIME</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">在响应报文中将指定的文件扩展名映射至MIME对应的类型</span><br>include		mime.types; #导入支持的文件类型，是相对于/apps/nginx/conf的目录<br>	default_type	application/octet-stream;	#除mime.types中文件类型外，设置其它文件默认类型，访问其它类型时会提示下载不匹配的类型文件<br>types &#123;<br>    text/html  html ;<br>    image/gif  gif;<br>    image/jpeg  jpg;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">MIME参考文档：</span><br>https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_Types<br></code></pre></td></tr></table></figure>

<h4 id="7-1-3-2指定响应报文server首部"><a href="#7-1-3-2指定响应报文server首部" class="headerlink" title="7.1.3.2指定响应报文server首部"></a>7.1.3.2指定响应报文server首部</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">是否在响应报文中的Content-Type显示指定的字符集，默认off不显示</span><br>charset charset | off;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">示例</span><br>charset utf-8;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">是否在响应报文的server首部显示nginx版本</span><br>server_tokens on | off | build | string;<br></code></pre></td></tr></table></figure>

<p>范例：修改server字段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">如果想自定义响应报文的nginx版本信息，需要修改源码文件，重新编译<br>如果server_tokens on,修改 src/core/nginx.h 修改第13-14行,如下示例<br><span class="hljs-meta prompt_">#</span><span class="language-bash">define NGINX_VERSION			<span class="hljs-string">&quot;1.68.9&quot;</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">define NGINX_VER				<span class="hljs-string">&quot;wanginx/&quot;</span> NGINX_VERSION</span><br><br>如果server_tokens off,修改 src/http/ngx_http_header_filter_module.c第49行，如下示例：<br>static char ngx_http_server_string[] = &quot;server: nginx&quot; CRLF;<br>把其中的nginx改为自己想要的文字即可，如：wanginx<br></code></pre></td></tr></table></figure>

<h2 id="7-2-nginx多虚拟主机"><a href="#7-2-nginx多虚拟主机" class="headerlink" title="7.2 nginx多虚拟主机"></a>7.2 nginx多虚拟主机</h2><p>基于不同的IP、不同的端口以及不用得域名实现不同的虚拟主机，依赖于核心模块ngx_http_core_module实现。</p>
<h3 id="7-2-1-新建一个PC-web和一个mobile-web站点"><a href="#7-2-1-新建一个PC-web和一个mobile-web站点" class="headerlink" title="7.2.1 新建一个PC web和一个mobile web站点"></a>7.2.1 新建一个PC web和一个mobile web站点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">定义子配置文件路径</span><br>[21:23:13 root@rocky8 ~]#mkdir  /apps/nginx/conf/conf.d/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建pc web站点和，mobile web站点的配置文件</span><br>[21:25:27 root@rocky8 ~]#vim   /apps/nginx/conf/conf.d/pc.conf<br>server  &#123;<br>        server_name www.xiaohexie.org;<br>        root /data/nginx/html/pc;<br>&#125;<br><br>[21:25:36 root@rocky8 ~]#vim   /apps/nginx/conf/conf.d/mobile.conf<br>server  &#123;<br>        server_name m.xiaohexie.org;<br>        root /data/nginx/html/mobile;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建站点主页存放路径</span><br>[21:26:15 root@rocky8 ~]#mkdir -p /data/nginx/html/mobile<br>[21:26:49 root@rocky8 ~]#mkdir -p /data/nginx/html/pc<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">主页显示文件</span><br>[21:26:54 root@rocky8 ~]#vim  /data/nginx/html/pc/index.html<br>&lt;h1&gt; pc web &lt;/h1&gt;<br><br>[21:27:51 root@rocky8 ~]#vim  /data/nginx/html/mobile/index.html<br>&lt;h1&gt; mobile web &lt;/h1&gt;<br><br><br>[21:28:30 root@rocky8 ~]#vim /apps/nginx/conf/nginx.conf<br>http&#123;<br>	....<br>	include /apps/nginx/conf/conf.d/*.conf; #在配置文件的最后面添加此行，注意不要放在最前面，会导致前面的命令无法生效<br>&#125;<br><br>[21:29:17 root@rocky8 ~]#nginx -s reload<br><br>测试：<br>[21:29:22 root@rocky8 ~]#curl www.xiaohexie.org<br>&lt;h1&gt;  pc web &lt;/h1&gt;<br>[21:30:19 root@rocky8 ~]#curl m.xiaohexie.org<br>&lt;h1&gt;  mobile web &lt;/h1&gt;<br><br></code></pre></td></tr></table></figure>

<p>测试：</p>
<p><img src="image-20231109214431993.png" srcset="/img/loading.gif" lazyload alt="image-20231109214431993"></p>
<p><img src="image-20231109214442168.png" srcset="/img/loading.gif" lazyload alt="image-20231109214442168"></p>
<h1 id="8、总结nginx日志格式定制"><a href="#8、总结nginx日志格式定制" class="headerlink" title="8、总结nginx日志格式定制"></a>8、总结nginx日志格式定制</h1><p>器运行时的日志保存路径和记录日志的level，因此两者是不同的，而且Nginx的错误日志一般只有一个，但是访问日志可以在不同server中定义多个，定义一个日志需要使用access_log指定日志的保存路径，使用log_format指定日志的格式，格式中定义要保存的具体日志内容。</p>
<p>访问日志由 ngx_http_log_module模块实现</p>
<p>官方帮助文档：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">http://nginx.org/en/docs/http/ngx_http_log_module.html<br></code></pre></td></tr></table></figure>

<p>语法格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">Syntax:	access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];<br>access_log off;<br>Default:	<br>access_log logs/access.log combined;<br>Context:	http, server, location, if in location, limit_except<br></code></pre></td></tr></table></figure>

<h2 id="8-1-自定义默认格式日志"><a href="#8-1-自定义默认格式日志" class="headerlink" title="8.1 自定义默认格式日志"></a>8.1 自定义默认格式日志</h2><p>如果是要保留日志的源格式，只是添加相应的日志内容，则配置如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：此指令只支持http块，不支持server块</span><br>[20:36:58 root@rocky8 ~]#vim /apps/nginx/conf/nginx.conf<br><br>log_format  pclog  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; $status $body_bytes_sent &quot;$http_referer&quot; &quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot; &#x27;;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注意：此指令一定要在放在log_format命令后，或者子文件下面</span><br>access_log 		logs/access.log 	nginx_formatl;<br>[20:08:26 root@rocky8 ~]#vim /apps/nginx/conf/conf.d/pc.conf <br>server  &#123;<br>        listen 80;<br>        server_name www.xiaohexie.org;<br>        root /data/nginx/html/pc;<br>        access_log /apps/nginx/logs/xiaohexie-org_access_pc.log pclog;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启nginx并访问测试日志格式</span><br>[20:33:32 root@rocky8 ~]#tail -f   /apps/nginx/logs/xiaohexie-org_access_pc.log <br>10.0.0.1 - - [21/Nov/2023:20:33:46 +0800] &quot;GET / HTTP/1.1&quot; 304 0 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36&quot; &quot;-&quot; <br>10.0.0.3 - - [21/Nov/2023:20:34:28 +0800] &quot;GET / HTTP/1.1&quot; 200 18 &quot;-&quot; &quot;curl/7.61.1&quot; &quot;-&quot; <br></code></pre></td></tr></table></figure>

<h2 id="8-2-自定义json格式日志"><a href="#8-2-自定义json格式日志" class="headerlink" title="8.2 自定义json格式日志"></a>8.2 自定义json格式日志</h2><p>Nginx的默认访问日志记录内容相对比较单一，默认的格式也不方便后期做日志统计分析，生产环境中通常将nginx日志转换为json日志，然后配合使用ELK做日志收集，统计和分析。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell"> log_format access_json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27; &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27; &#x27;&quot;clientip&quot;:&quot;$remote_addr&quot;,&#x27; &#x27;&quot;size&quot;:$body_bytes_sent,&#x27; &#x27;&quot;responsetime&quot;:$request_time,&#x27; &#x27;&quot;upstreamtime&quot;:&quot;$upstream_response_time&quot;,&#x27; &#x27;&quot;upstreamhost&quot;:&quot;$upstream_addr&quot;,&#x27; &#x27;&quot;http_host&quot;:&quot;$host&quot;,&#x27; &#x27;&quot;uri&quot;:&quot;$uri&quot;,&#x27; &#x27;&quot;xff&quot;:&quot;$http_x_forwarded_for&quot;,&#x27; &#x27;&quot;referer&quot;:&quot;$http_referer&quot;,&#x27; &#x27;&quot;tcp_xff&quot;:&quot;$proxy_protocol_addr&quot;,&#x27; &#x27;&quot;http_user_agent&quot;:&quot;$http_user_agent&quot;,&#x27; &#x27;&quot;status&quot;:&quot;$status&quot;&#125;&#x27;;<br>    access_log  /apps/nginx/logs/access_json.log  access_json;<br><br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启Nginx并访问测试日志格式，参考链接：http：//json.cn/</span><br>[20:55:31 root@PG-backup ~]#curl www.xiaohexie.org<br>&lt;h1&gt; pc web &lt;/h1&gt;<br><br>[21:04:53 root@rocky8 ~]#tail -f /apps/nginx/logs/access_pc_json.log <br>&#123;&quot;@timestamp&quot;:&quot;2023-11-21T21:05:33+08:00&quot;,&quot;host&quot;:&quot;10.0.0.4&quot;,&quot;clientip&quot;:&quot;10.0.0.3&quot;,&quot;size&quot;:18,&quot;responsetime&quot;:0.000,&quot;upstreamtime&quot;:&quot;-&quot;,&quot;upstreamhost&quot;:&quot;-&quot;,&quot;http_host&quot;:&quot;www.xiaohexie.org&quot;,&quot;uri&quot;:&quot;/index.html&quot;,&quot;xff&quot;:&quot;-&quot;,&quot;referer&quot;:&quot;-&quot;,&quot;tcp_xff&quot;:&quot;-&quot;,&quot;http_user_agent&quot;:&quot;curl/7.61.1&quot;,&quot;status&quot;:&quot;200&quot;&#125;<br><br></code></pre></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/11/21/%E7%AC%AC%E4%B9%9D%E5%91%A8%E4%BD%9C%E4%B8%9A/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">第九周作业</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/10/04/PostgreSQL-%E6%95%B0%E6%8D%AE%E5%BA%93/">
                        <span class="hidden-mobile">PostgreSQL 数据库</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
